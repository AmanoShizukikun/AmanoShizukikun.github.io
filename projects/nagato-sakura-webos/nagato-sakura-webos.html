<!DOCTYPE html>
<html lang="zh-TW">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="description" content="天野靜樹的 OS 網頁模擬器" />
        <meta name="author" content="天野靜樹" />
        <meta name="keywords" content="天野靜樹" />
        <title>天野靜樹 - WEB OS</title>
        <link rel="icon" href="../../assets/images/logo.png" type="image/png" />

        <!-- 圖示庫 (Font Awesome) -->
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        />
        <!-- 全域樣式 (確保 header / settings-panel 使用全域樣式) -->
        <link rel="stylesheet" href="../../assets/css/core.css" />
        <link rel="stylesheet" href="../../assets/css/components.css" />
        <link rel="stylesheet" href="../../assets/css/animations.css" />

        <!-- 字體 -->
        <link
            href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;600;700&display=swap"
            rel="stylesheet"
        />
        <link
            href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap"
            rel="stylesheet"
        />

        <style>
            :root {
                /* 顏色 */
                --primary-cyan: #00d4ff;
                --primary-magenta: #ff0080;
                --accent-cyan: #00ffff;
                --accent-pink: #ff69b4;
                --accent-purple: #8b5cf6;
                --primary-yellow: #ffff00;

                --dark-bg: #0a0a0f;
                --darker-bg: #050507;

                /* 改良的毛玻璃/Mica效果 */
                --mica-bg: rgba(30, 30, 45, 0.7);
                --mica-bg-light: rgba(45, 45, 60, 0.7);
                --mica-bg-dark: rgba(20, 20, 30, 0.8);
                --mica-blur: 20px;

                /* 字體 */
                --font-display: "Orbitron", monospace;
                --font-body: "Rajdhani", sans-serif;
                --font-ui: "Noto Sans TC", sans-serif;

                /* UI 尺寸 */
                --taskbar-height: 50px;
                --taskbar-icon-size: 24px; /* New: icon size used by both font & image icons */
                --window-border-radius: 8px;

                /* Z-Index Hierarchy (Highest to Lowest) */
                --z-header: 5000;
                --z-taskbar: 4000;
                --z-start-menu: 3900;
                --z-widgets: 3800; /* Calendar & Widgets */
                --z-window-active: 3000;
                --z-snap-preview: 2000;
                --z-window-base: 1000; /* Inactive windows start here */

                --z-window: var(--z-window-base); /* Legacy support */
                --z-context-menu: 6000; /* Above everything */
                --z-loader: 9999;

                /* 新增：混合佈局尺寸 */
                --header-height: 60px;
                --sidebar-width: 280px;
                --text: #e6e6e6; /* general text color */
                --card: rgba(255, 255, 255, 0.03);
                --bd: rgba(0, 0, 0, 0.2);
                --s3d: rgba(0, 0, 0, 0.35);
                --mm: rgba(0, 212, 255, 0.14);
                --theme-1: #00d4ff;
                --theme-2: #4caf50;
                /* 顯示/夜間光線控制 */
                --simulator-brightness: 1; /* 0.5 ~ 1.2 - controlled by亮度滑桿 */
                --background-brightness: 1; /* 0..1 - independent background brightness (slider 0..100 -> 0..1) */
                /* overlay alpha (0..1) used to dim background with a black overlay. Computed by JS as: 1 - background-brightness */
                --background-overlay: 0;
                --nightlight-opacity: 0; /* 0~0.5 - controlled by夜間光線 */

                /* 視窗透明效果 */
                --window-bg: rgba(25, 25, 40, 0.8);
                --window-backdrop: blur(20px) saturate(180%);
            }

            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            html,
            body {
                height: 100%;
                width: 100%;
                overflow: hidden;
                font-family: var(--font-ui), sans-serif;
                background-color: var(--dark-bg);
                color: #f0f0f0;

                /* 新增：為混合佈局修改 */
                display: flex;
                flex-direction: column;
                /* 防止 navigation.js 中 toggleSettings 設定的 paddingTop 影響佈局 */
                padding-top: 0 !important;
                margin-top: 0 !important;
            }

            header {
                /* 此頁面為固定視窗模擬器，header 必須始終固定，覆蓋 navigation.js 的動態設定 */
                position: fixed !important;
                top: 0 !important;
                left: 0;
                right: 0;
                z-index: 20000; /* 確保 header 高於 nav-overlay (19998) */
                flex-shrink: 0;
                transform: none !important; /* 防止 navigation.js 的 transform 影響 */
            }

            /* 針對此頁面的 nav-overlay 調整，確保低於 header */
            .nav-overlay {
                z-index: 19998;
                top: var(--header-height, 60px); /* 從 header 下方開始 */
            }

            /* 1. 頂部導航欄 (use global header styles to match other pages) */
            .header-logo a {
                font-size: 1.5rem;
                color: var(--primary-cyan);
                text-decoration: none;
                font-weight: 700;
            }
            .header-nav a {
                color: #eee;
                text-decoration: none;
                margin-left: 25px;
                font-size: 0.9rem;
                font-family: var(--font-body);
                transition: color 0.2s ease;
            }
            .header-nav a:hover {
                color: var(--primary-cyan);
            }

            /* 2. 主內容包裝器 */
            .main-wrapper {
                display: flex;
                width: 100%;
                /* height: 100vh; */
                flex-grow: 1; /* 填滿剩餘空間 */
                margin-top: var(
                    --header-height,
                    60px
                ); /* 為固定的 header 預留空間 */
                min-height: calc(100vh - var(--header-height, 60px));
                overflow: hidden; /* 防止視窗超出時產生滾動位移 */
            }

            /* 3. 右側邊欄 */
            .cyber-sidebar {
                width: var(--sidebar-width);
                flex-shrink: 0;
                z-index: 5;
                z-index: 5;
                background: rgba(10, 10, 15, 0.7);
                backdrop-filter: blur(15px);
                border-left: 1px solid rgba(255, 255, 255, 0.1); /* 改為左邊框 */
                z-index: 1500;
                padding: 20px;
                font-family: var(--font-body);
                color: #ccc;
                overflow-y: auto;
            }
            .cyber-sidebar h3 {
                color: var(--primary-cyan);
                font-family: var(--font-display);
                margin-bottom: 15px;
                border-bottom: 1px solid var(--primary-cyan);
                padding-bottom: 5px;
            }
            .cyber-sidebar ul {
                list-style: none;
                padding: 0;
            }
            .cyber-sidebar li {
                padding: 12px 10px;
                border-radius: 4px;
                cursor: pointer;
                transition: background 0.2s ease;
                font-size: 1.1rem;
            }
            .cyber-sidebar li:hover {
                background: rgba(0, 212, 255, 0.1);
                color: #fff;
            }
            .cyber-sidebar li i {
                margin-right: 12px;
                width: 20px;
                text-align: center;
            }

            /* 4. 模擬器容器 */
            .simulator-container {
                flex-grow: 1;
                position: relative; /* 關鍵：使所有子元素相對於此定位 */
                height: calc(100vh - var(--header-height, 60px));
                overflow: hidden;
                margin-top: 0; /* 防止任何其他邊距導致空隙 */
                /* Apply overall brightness using CSS variable */
                filter: brightness(var(--simulator-brightness));
            }

            /* Desktop background layer: sits below UI content and above the page background
           to allow independent brightness control for wallpapers & gradients */
            #desktop-bg {
                position: absolute;
                inset: 0 0 0 0;
                z-index: calc(
                    var(--z-window) - 50
                ); /* behind windows/desktop content */
                background-position: center;
                background-size: cover;
                background-repeat: no-repeat;
                filter: brightness(var(--background-brightness));
                /* Hint browser to use GPU compositing for smoother updates */
                transform: translateZ(0);
                will-change: filter, transform;
                backface-visibility: hidden;
                pointer-events: none; /* don't block clicks */
                /* allow background & opacity fade rather than a sliding animation */
                opacity: 1;
                transition: background 0.18s ease, filter 0.18s ease,
                    opacity 0.32s ease;
            }

            /* Video background element - occupies same space as desktop-bg and supports brightness control */
            #desktop-video {
                position: absolute;
                inset: 0 0 0 0;
                z-index: calc(var(--z-window) - 49);
                width: 100%;
                height: 100%;
                object-fit: cover;
                filter: brightness(var(--background-brightness));
                opacity: 0; /* hidden until set by JS */
                transition: opacity 0.32s ease, filter 0.18s ease;
                pointer-events: none;
            }

            /* Shared overlay placed above desktop background (image/video) but beneath windows/desktop UI */
            #desktop-overlay {
                position: absolute;
                inset: 0;
                z-index: calc(
                    var(--z-window) - 40
                ); /* sits above bg & video but below UI windows */
                pointer-events: none;
                background: rgba(0, 0, 0, 1);
                opacity: var(--background-overlay, 0);
                transition: opacity 120ms linear;
            }

            /* Use a dimming overlay on the background layer to avoid changing expensive filter properties
           while sliding brightness. The overlay's opacity is controlled via CSS var --background-overlay. */
            #desktop-bg::after {
                content: "";
                position: absolute;
                inset: 0;
                background: rgba(0, 0, 0, 1);
                opacity: var(--background-overlay, 0);
                pointer-events: none;
                transition: opacity 120ms linear;
                will-change: opacity;
                z-index: 0;
            }

            /* Night light overlay sits on top of simulator content but below menus/overlays */
            #nightlight-overlay {
                position: absolute;
                inset: 0 0 0 0; /* top/right/bottom/left */
                pointer-events: none;
                z-index: calc(
                    var(--z-start-menu) - 1
                ); /* just beneath start menu */
                background: rgba(255, 137, 73, var(--nightlight-opacity));
                mix-blend-mode: overlay;
                transition: opacity 0.18s ease, background 0.18s ease;
                opacity: 0;
            }

            /* 1. 啟動加載器 */
            /* ========== 現代化開機動畫系統 ========== */
            #boot-loader {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(
                    135deg,
                    #000000 0%,
                    #0a0a1a 50%,
                    #000510 100%
                );
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                z-index: var(--z-loader);
                transition: opacity 0.8s ease-out, transform 0.8s ease-out;
                overflow: hidden;
            }

            #boot-loader.fade-out {
                opacity: 0;
                transform: scale(1.05);
            }

            /* 動態背景網格 */
            .boot-grid-bg {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-image: linear-gradient(
                        rgba(0, 212, 255, 0.03) 1px,
                        transparent 1px
                    ),
                    linear-gradient(
                        90deg,
                        rgba(0, 212, 255, 0.03) 1px,
                        transparent 1px
                    );
                background-size: 50px 50px;
                animation: gridMove 20s linear infinite;
            }

            @keyframes gridMove {
                0% {
                    transform: translate(0, 0);
                }
                100% {
                    transform: translate(50px, 50px);
                }
            }

            /* 粒子背景 */
            .boot-particles {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                overflow: hidden;
                pointer-events: none;
            }

            .boot-particle {
                position: absolute;
                width: 3px;
                height: 3px;
                background: var(--primary-cyan);
                border-radius: 50%;
                box-shadow: 0 0 10px var(--primary-cyan),
                    0 0 20px var(--primary-cyan);
                animation: bootParticleFloat 8s infinite ease-in-out;
                opacity: 0;
            }

            @keyframes bootParticleFloat {
                0%,
                100% {
                    transform: translateY(100vh) scale(0);
                    opacity: 0;
                }
                10% {
                    opacity: 0.8;
                }
                90% {
                    opacity: 0.8;
                }
                100% {
                    transform: translateY(-100vh) scale(1);
                    opacity: 0;
                }
            }

            /* 環形光暈背景 */
            .boot-rings {
                position: absolute;
                width: 600px;
                height: 600px;
                pointer-events: none;
            }

            .boot-ring {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                border-radius: 50%;
                border: 1px solid rgba(0, 212, 255, 0.1);
                animation: ringPulse 4s infinite ease-out;
            }

            .boot-ring:nth-child(1) {
                width: 200px;
                height: 200px;
                animation-delay: 0s;
            }
            .boot-ring:nth-child(2) {
                width: 300px;
                height: 300px;
                animation-delay: 0.5s;
            }
            .boot-ring:nth-child(3) {
                width: 400px;
                height: 400px;
                animation-delay: 1s;
            }
            .boot-ring:nth-child(4) {
                width: 500px;
                height: 500px;
                animation-delay: 1.5s;
            }

            @keyframes ringPulse {
                0% {
                    transform: translate(-50%, -50%) scale(0.8);
                    opacity: 0;
                    border-color: rgba(0, 212, 255, 0.3);
                }
                50% {
                    opacity: 1;
                    border-color: rgba(0, 212, 255, 0.2);
                }
                100% {
                    transform: translate(-50%, -50%) scale(1.2);
                    opacity: 0;
                    border-color: rgba(0, 212, 255, 0);
                }
            }

            /* 主要內容容器 */
            .boot-content {
                position: relative;
                z-index: 10;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
            }

            /* Logo 容器 */
            .boot-logo-container {
                position: relative;
                margin-bottom: 40px;
                width: 180px;
                height: 180px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            #boot-logo {
                width: 120px;
                height: 120px;
                object-fit: contain;
                filter: drop-shadow(0 0 30px rgba(0, 212, 255, 0.5));
                animation: logoFloat 3s ease-in-out infinite,
                    logoGlow 2s ease-in-out infinite;
                position: relative;
                z-index: 2;
            }

            @keyframes logoFloat {
                0%,
                100% {
                    transform: translateY(0);
                }
                50% {
                    transform: translateY(-10px);
                }
            }

            @keyframes logoGlow {
                0%,
                100% {
                    filter: drop-shadow(0 0 30px rgba(0, 212, 255, 0.5));
                }
                50% {
                    filter: drop-shadow(0 0 50px rgba(0, 212, 255, 0.8))
                        drop-shadow(0 0 80px rgba(255, 0, 128, 0.3));
                }
            }

            /* Logo 周圍的旋轉環 - 外環 */
            .boot-logo-ring {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                border-radius: 50%;
                border: 2px solid transparent;
                border-top-color: var(--primary-cyan);
                border-right-color: rgba(0, 212, 255, 0.3);
                box-sizing: border-box;
                animation: logoRingSpinOuter 3s linear infinite;
            }

            /* Logo 周圍的旋轉環 - 內環 */
            .boot-logo-ring::before {
                content: "";
                position: absolute;
                top: 10px;
                left: 10px;
                right: 10px;
                bottom: 10px;
                border-radius: 50%;
                border: 2px solid transparent;
                border-bottom-color: var(--primary-magenta);
                border-left-color: rgba(255, 0, 128, 0.3);
                box-sizing: border-box;
                animation: logoRingSpinInner 2s linear infinite;
            }

            @keyframes logoRingSpinOuter {
                0% {
                    transform: rotate(0deg);
                }
                100% {
                    transform: rotate(360deg);
                }
            }

            @keyframes logoRingSpinInner {
                0% {
                    transform: rotate(0deg);
                }
                100% {
                    transform: rotate(-360deg);
                }
            }

            /* 系統名稱 */
            .boot-system-name {
                font-family: var(--font-display);
                font-size: 2rem;
                font-weight: 700;
                letter-spacing: 8px;
                color: transparent;
                background: linear-gradient(
                    90deg,
                    #00d4ff,
                    #66e0ff,
                    #ffffff,
                    #ffb6d9,
                    #ff69b4,
                    #d98cb3,
                    #a8a4ff,
                    #66b3ff,
                    #00d4ff
                );
                background-clip: text;
                -webkit-background-clip: text;
                margin-bottom: 8px;
                text-transform: uppercase;
                animation: textShimmer 4s ease-in-out infinite;
                background-size: 150% auto;
            }

            @keyframes textShimmer {
                0% {
                    background-position: 0% center;
                }
                50% {
                    background-position: 100% center;
                }
                100% {
                    background-position: 0% center;
                }
            }

            .boot-system-version {
                font-family: var(--font-body);
                font-size: 0.9rem;
                color: rgba(255, 255, 255, 0.5);
                letter-spacing: 4px;
                margin-bottom: 50px;
            }

            /* 進度條容器 */
            .boot-progress-container {
                width: 350px;
                margin-bottom: 30px;
            }

            .boot-progress-bar {
                width: 100%;
                height: 4px;
                background: rgba(255, 255, 255, 0.1);
                border-radius: 2px;
                overflow: hidden;
                position: relative;
            }

            .boot-progress-fill {
                height: 100%;
                width: 0%;
                background: linear-gradient(
                    90deg,
                    var(--primary-cyan),
                    var(--primary-magenta)
                );
                border-radius: 2px;
                transition: width 0.3s ease-out;
                position: relative;
                box-shadow: 0 0 10px var(--primary-cyan),
                    0 0 20px rgba(0, 212, 255, 0.5);
            }

            .boot-progress-fill::after {
                content: "";
                position: absolute;
                right: 0;
                top: -3px;
                width: 10px;
                height: 10px;
                background: #fff;
                border-radius: 50%;
                box-shadow: 0 0 10px var(--primary-cyan),
                    0 0 20px var(--primary-cyan);
            }

            .boot-progress-text {
                display: flex;
                justify-content: space-between;
                margin-top: 10px;
                font-family: var(--font-body);
                font-size: 0.85rem;
                color: rgba(255, 255, 255, 0.6);
            }

            .boot-progress-percent {
                color: var(--primary-cyan);
                font-family: var(--font-display);
            }

            /* 底部版權信息 */
            .boot-footer {
                position: absolute;
                bottom: 30px;
                font-family: var(--font-body);
                font-size: 0.75rem;
                color: rgba(255, 255, 255, 0.3);
                letter-spacing: 2px;
            }

            /* 響應式調整 */
            @media (max-width: 768px) {
                .boot-system-name {
                    font-size: 1.5rem;
                    letter-spacing: 4px;
                }

                .boot-progress-container {
                    width: 280px;
                }

                .boot-logo-container {
                    width: 150px;
                    height: 150px;
                }

                #boot-logo {
                    width: 100px;
                    height: 100px;
                }

                .boot-rings {
                    width: 400px;
                    height: 400px;
                }

                .boot-ring:nth-child(1) {
                    width: 150px;
                    height: 150px;
                }
                .boot-ring:nth-child(2) {
                    width: 220px;
                    height: 220px;
                }
                .boot-ring:nth-child(3) {
                    width: 290px;
                    height: 290px;
                }
                .boot-ring:nth-child(4) {
                    width: 360px;
                    height: 360px;
                }
            }

            /* 2. 桌面 */
            #desktop {
                position: absolute;
                z-index: calc(var(--z-window) - 40);
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: radial-gradient(
                    ellipse at bottom,
                    #0a192f 0%,
                    #05080f 100%
                );
                overflow: hidden;
                padding: 0;
            }

            .desktop-icon {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                padding: 8px 5px;
                width: 80px;
                height: 90px;
                border-radius: 6px;
                text-align: center;
                cursor: pointer;
                transition: background 0.2s ease, box-shadow 0.2s ease;
                user-select: none;
                position: absolute;
                box-sizing: border-box;
            }
            .desktop-icon:hover {
                background: rgba(255, 255, 255, 0.1);
            }
            .desktop-icon.selected {
                background: rgba(0, 212, 255, 0.15);
                border: 1px solid rgba(0, 212, 255, 0.4);
            }
            .desktop-icon.dragging {
                opacity: 0;
                pointer-events: none;
            }
            /* 桌面拖動預覽圖示 */
            .desktop-drag-preview {
                position: absolute;
                pointer-events: none;
                z-index: 10000;
                opacity: 0.9;
                transform: scale(1.05);
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
                background: rgba(0, 212, 255, 0.2);
                border-radius: 6px;
            }
            /* 桌面格子預覽指示器 */
            .desktop-grid-indicator {
                position: absolute;
                width: 80px;
                height: 90px;
                border: 2px dashed rgba(0, 212, 255, 0.6);
                border-radius: 6px;
                background: rgba(0, 212, 255, 0.15);
                pointer-events: none;
                z-index: 999;
                transition: left 0.15s ease, top 0.15s ease;
            }
            /* 桌面右鍵選單 */
            .desktop-context-menu {
                position: absolute;
                background: rgba(30, 30, 50, 0.95);
                backdrop-filter: blur(20px);
                border: 1px solid rgba(255, 255, 255, 0.1);
                border-radius: 8px;
                padding: 6px 0;
                min-width: 200px;
                z-index: 10001;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
                display: none;
            }
            .desktop-context-menu.show {
                display: block;
            }
            .desktop-context-menu-item {
                padding: 8px 16px;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 10px;
                color: #fff;
                font-size: 13px;
            }
            .desktop-context-menu-item:hover {
                background: rgba(0, 212, 255, 0.2);
            }
            .desktop-context-menu-item i {
                width: 16px;
                text-align: center;
                font-size: 14px;
            }
            .desktop-context-menu-divider {
                height: 1px;
                background: rgba(255, 255, 255, 0.1);
                margin: 6px 0;
            }
            .desktop-context-menu-item.has-submenu {
                position: relative;
            }
            .desktop-context-menu-item.has-submenu::after {
                content: "▶";
                font-size: 10px;
                margin-left: auto;
            }
            .desktop-context-submenu {
                position: absolute;
                left: 100%;
                top: 0;
                background: rgba(30, 30, 50, 0.95);
                backdrop-filter: blur(20px);
                border: 1px solid rgba(255, 255, 255, 0.1);
                border-radius: 8px;
                padding: 6px 0;
                min-width: 150px;
                display: none;
            }
            .desktop-context-menu-item.has-submenu:hover
                .desktop-context-submenu {
                display: block;
            }
            .desktop-context-submenu-item {
                padding: 8px 16px;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 10px;
                color: #fff;
                font-size: 13px;
            }
            .desktop-context-submenu-item:hover {
                background: rgba(0, 212, 255, 0.2);
            }
            .desktop-context-submenu-item.active::before {
                content: "✓";
                margin-right: 5px;
            }
            .desktop-icon i {
                font-size: 2.5rem;
                margin-bottom: 8px;
                color: #fff;
                text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
            }
            .desktop-icon span {
                font-size: 0.85rem;
                color: #f0f0f0;
                text-shadow: 0 1px 2px rgba(0, 0, 0, 0.7);
                word-break: break-all;
                display: -webkit-box;
                -webkit-box-orient: vertical;
                overflow: hidden;
            }

            /* 3. 任務欄 */
            #taskbar {
                position: absolute; /* 修改 */
                bottom: 0;
                left: 0;
                width: 100%;
                height: var(--taskbar-height);
                display: flex;
                justify-content: space-between;
                align-items: center;
                z-index: var(--z-taskbar);

                background: var(--mica-bg-dark);
                backdrop-filter: blur(var(--mica-blur)) saturate(180%);
                border-top: 1px solid rgba(255, 255, 255, 0.15);
            }

            .taskbar-group {
                display: flex;
                height: 100%;
                align-items: center;
                padding: 0 4px; /* reduced outer padding for tighter layout */
                gap: 4px; /* reduce spacing between icon groups */
            }
            .taskbar-group.center {
                justify-content: center;
                flex-grow: 1;
                gap: 4px; /* tighter gap between center icons */
            }
            .taskbar-group.right {
                justify-content: flex-end;
            }

            .taskbar-icon {
                font-size: 1.2rem; /* baseline font for FA icons */
                color: #e0e0e0;
                /* shrink the clickable area and reduce spacing while maintaining tappable size */
                min-width: calc(var(--taskbar-icon-size) + 16px);
                padding: 0 4px; /* reduced horizontal padding, tighter spacing */
                height: 100%;
                display: inline-flex; /* inline to avoid full-width flex children issues */
                align-items: center;
                justify-content: center;
                position: relative;
                transition: background-color 0.18s ease;
                cursor: pointer;
                box-sizing: border-box;
            }
            .taskbar-icon:hover {
                background: rgba(255, 255, 255, 0.15);
            }

            /* 點擊反饋動畫 */
            .taskbar-icon:active {
                transform: scale(0.92);
                background: rgba(255, 255, 255, 0.25);
            }

            /* 漣漪效果容器 */
            .taskbar-icon {
                overflow: hidden;
            }

            .taskbar-icon .ripple {
                position: absolute;
                border-radius: 50%;
                background: radial-gradient(
                    circle,
                    rgba(0, 212, 255, 0.4) 0%,
                    transparent 70%
                );
                transform: scale(0);
                animation: ripple-effect 0.5s ease-out forwards;
                pointer-events: none;
            }

            @keyframes ripple-effect {
                0% {
                    transform: scale(0);
                    opacity: 1;
                }
                100% {
                    transform: scale(3);
                    opacity: 0;
                }
            }

            /* 點擊彈跳效果 */
            .taskbar-icon.click-bounce {
                animation: click-bounce 0.3s ease-out;
            }

            @keyframes click-bounce {
                0% {
                    transform: scale(1);
                }
                30% {
                    transform: scale(0.88);
                }
                60% {
                    transform: scale(1.05);
                }
                100% {
                    transform: scale(1);
                }
            }

            /* Make sure FA icons and images match in size */
            .taskbar-icon i {
                font-size: var(--taskbar-icon-size);
                line-height: 1;
                display: inline-block;
            }
            .taskbar-icon img {
                width: var(--taskbar-icon-size);
                height: var(--taskbar-icon-size);
                display: inline-block;
                object-fit: contain;
            }
            /* For apps that are open (in background) */
            .taskbar-icon.open-app::after {
                content: "";
                position: absolute;
                bottom: 6px; /* keep gap from bottom */
                left: 50%;
                transform: translateX(-50%);
                width: 6px;
                height: 3px; /* 較短 */
                background: var(--primary-cyan);
                opacity: 0.6;
                border-radius: 999px; /* pill */
                transition: all 0.15s ease;
            }

            /* For apps active in foreground */
            .taskbar-icon.active-app {
                background: rgba(255, 255, 255, 0.08);
            }
            .taskbar-icon.active-app::after {
                content: "";
                position: absolute;
                bottom: 6px; /* keep gap from bottom */
                left: 50%;
                transform: translateX(-50%);
                width: 16px; /* 較長 */
                height: 3px;
                background: var(--primary-cyan);
                opacity: 1;
                border-radius: 999px; /* pill */
                box-shadow: 0 0 6px rgba(0, 212, 255, 0.15);
            }
            [data-theme="light"] .taskbar-icon.open-app::after {
                background: var(--primary-cyan);
                box-shadow: none;
            }
            [data-theme="light"] .taskbar-icon.active-app::after {
                box-shadow: none;
            }

            /* ========== 淺色模式完整樣式 ========== */
            [data-theme="light"] {
                --dark-bg: #f5f5f7;
                --darker-bg: #e8e8ec;
                --mica-bg: rgba(255, 255, 255, 0.85);
                --mica-bg-light: rgba(255, 255, 255, 0.9);
                --mica-bg-dark: rgba(245, 245, 247, 0.92);
                --text: #1a1a1a;
                --card: rgba(0, 0, 0, 0.03);
                --bd: rgba(0, 0, 0, 0.1);
                --s3d: rgba(0, 0, 0, 0.15);
                --mm: rgba(0, 160, 200, 0.12);
            }

            /* 頁面與桌面背景 */
            [data-theme="light"] body {
                background-color: #f5f5f7;
                color: #1a1a1a;
            }

            [data-theme="light"] #desktop {
                background: linear-gradient(
                    135deg,
                    #e8f4f8 0%,
                    #d4e6ed 50%,
                    #c8dce6 100%
                );
            }

            [data-theme="light"] #desktop-bg {
                background: linear-gradient(
                    135deg,
                    #e8f4f8 0%,
                    #d4e6ed 50%,
                    #c8dce6 100%
                );
            }

            /* 側邊欄 - 與設定面板風格保持一致 */
            [data-theme="light"] .cyber-sidebar {
                background: rgba(255, 255, 255, 0.92);
                backdrop-filter: blur(20px);
                border-left: 2px solid rgba(0, 153, 204, 0.3);
                box-shadow: -3px 0 10px rgba(0, 0, 0, 0.06);
                color: #1a1a1a;
            }

            [data-theme="light"] .cyber-sidebar h3 {
                color: #0099cc;
                border-bottom: 1px solid rgba(0, 153, 204, 0.3);
            }

            [data-theme="light"] .cyber-sidebar li {
                color: #333;
            }

            [data-theme="light"] .cyber-sidebar li:hover {
                background: rgba(0, 153, 204, 0.08);
                color: #0099cc;
            }

            [data-theme="light"] .cyber-sidebar li i {
                color: #0099cc;
            }

            /* 任務欄 - 與整體風格保持一致 */
            [data-theme="light"] #taskbar {
                background: rgba(255, 255, 255, 0.92);
                backdrop-filter: blur(20px) saturate(180%);
                border-top: 1px solid rgba(0, 153, 204, 0.12);
                box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.04);
            }

            [data-theme="light"] .taskbar-icon {
                color: #555;
            }

            [data-theme="light"] .taskbar-icon:hover {
                background: rgba(0, 153, 204, 0.08);
            }

            [data-theme="light"] .taskbar-icon:active {
                background: rgba(0, 153, 204, 0.18);
            }

            [data-theme="light"] .taskbar-icon .ripple {
                background: radial-gradient(
                    circle,
                    rgba(0, 153, 204, 0.35) 0%,
                    transparent 70%
                );
            }

            [data-theme="light"] #start-button {
                color: #0099cc;
            }

            [data-theme="light"] #taskbar-time {
                color: #1a1a1a;
            }

            [data-theme="light"] #taskbar-time:hover {
                background: rgba(0, 153, 204, 0.08);
            }

            /* 開始功能表 - 與整體風格保持一致 */
            [data-theme="light"] #start-menu {
                background: rgba(255, 255, 255, 0.95);
                border: 1px solid rgba(0, 153, 204, 0.15);
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
            }

            [data-theme="light"] .search-bar {
                background: rgba(0, 153, 204, 0.04);
                border: 1px solid rgba(0, 153, 204, 0.15);
            }

            [data-theme="light"] .search-bar input {
                color: #1a1a1a;
            }

            [data-theme="light"] .search-bar input::placeholder {
                color: #888;
            }

            [data-theme="light"] .search-bar i {
                color: #0099cc;
            }

            [data-theme="light"] .start-section-title {
                color: #0099cc;
            }

            [data-theme="light"] .app-icon:hover {
                background: rgba(0, 153, 204, 0.08);
            }

            [data-theme="light"] .app-icon.dragging {
                opacity: 0.5;
            }

            [data-theme="light"] .app-icon.drag-over {
                background: rgba(0, 153, 204, 0.15);
                border: 2px dashed rgba(0, 153, 204, 0.5);
            }

            [data-theme="light"] .pinned-app-drag-preview {
                background: rgba(0, 153, 204, 0.15);
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
            }

            [data-theme="light"] .app-icon span {
                color: #1a1a1a;
            }

            [data-theme="light"] .recommended-item:hover {
                background: rgba(0, 153, 204, 0.08);
            }

            [data-theme="light"] .recommended-item i {
                color: #0099cc;
            }

            [data-theme="light"] .recommended-item-info {
                color: #1a1a1a;
            }

            [data-theme="light"] .recommended-item-info span {
                color: #666;
            }

            [data-theme="light"] .start-menu-footer {
                background: rgba(0, 153, 204, 0.03);
            }

            [data-theme="light"] .power-button:hover {
                background: rgba(0, 153, 204, 0.1);
            }

            [data-theme="light"] .power-button i {
                color: #0099cc;
            }

            /* 視窗 - 與整體風格保持一致，使用 CSS 變數支援透明度控制 */
            [data-theme="light"] .window {
                background: var(--window-bg);
                backdrop-filter: var(--window-backdrop);
                -webkit-backdrop-filter: var(--window-backdrop);
                border: 1px solid rgba(0, 153, 204, 0.15);
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
            }

            [data-theme="light"] .window.active {
                border-color: rgba(0, 153, 204, 0.4);
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15),
                    0 0 0 1px rgba(0, 153, 204, 0.2);
            }

            [data-theme="light"] .window-header {
                background: linear-gradient(
                    135deg,
                    rgba(255, 255, 255, 0.98),
                    rgba(250, 250, 252, 0.95)
                );
            }

            [data-theme="light"] .window-title {
                color: #1a1a1a;
            }

            [data-theme="light"] .window-control-btn {
                color: #555;
            }

            [data-theme="light"] .window-control-btn:hover {
                background: rgba(0, 0, 0, 0.08);
            }

            [data-theme="light"] .window-control-btn.close:hover {
                background: #e81123;
                color: #fff;
            }

            [data-theme="light"] .window-content {
                color: #1a1a1a;
            }

            [data-theme="light"] .snap-layouts {
                background: rgba(255, 255, 255, 0.95);
                border: 1px solid rgba(0, 153, 204, 0.2);
            }

            [data-theme="light"] .snap-layout-option {
                border-color: rgba(0, 153, 204, 0.3);
                background: rgba(0, 0, 0, 0.02);
            }

            [data-theme="light"] .snap-layout-option:hover {
                border-color: #0099cc;
                background: rgba(0, 153, 204, 0.12);
            }

            /* 設定視窗 (OS 內的設定應用) - 與整體風格保持一致 */
            [data-theme="light"] .settings-sidebar {
                border-right: 1px solid rgba(0, 153, 204, 0.15);
            }

            [data-theme="light"] .settings-menu-item {
                color: #333;
            }

            [data-theme="light"] .settings-menu-item:hover {
                background: rgba(0, 153, 204, 0.06);
            }

            [data-theme="light"] .settings-menu-item.active {
                background: rgba(0, 153, 204, 0.12);
                color: #0099cc;
            }

            [data-theme="light"] .settings-menu-item i {
                color: #0099cc;
            }

            [data-theme="light"] .setting-section h3 {
                color: #0099cc;
                border-bottom: 1px solid rgba(0, 153, 204, 0.2);
            }

            [data-theme="light"] .setting-item {
                background: rgba(0, 153, 204, 0.02);
            }

            [data-theme="light"] .setting-item-label {
                color: #1a1a1a;
            }

            [data-theme="light"] .setting-item-label span {
                color: #666;
            }

            /* 設定子頁面 (如夜間光線設定) - 淺色模式 */
            [data-theme="light"] .settings-subpage h3 {
                color: #1a1a1a;
            }

            [data-theme="light"] #nightlight-back {
                border-color: rgba(0, 153, 204, 0.2) !important;
                color: #0099cc !important;
            }

            [data-theme="light"] #nightlight-back:hover {
                background: rgba(0, 153, 204, 0.08) !important;
            }

            [data-theme="light"] #personalization_background_back,
            [data-theme="light"] #personalization_font_back,
            [data-theme="light"] #personalization_window_back {
                border-color: rgba(0, 153, 204, 0.2) !important;
                color: #0099cc !important;
            }

            [data-theme="light"] #personalization_background_back:hover,
            [data-theme="light"] #personalization_font_back:hover,
            [data-theme="light"] #personalization_window_back:hover {
                background: rgba(0, 153, 204, 0.08) !important;
            }

            /* 檔案總管 - 與整體風格保持一致 */
            [data-theme="light"] .explorer-content {
                background: #fafafa;
            }

            [data-theme="light"] .explorer-sidebar {
                background: rgba(0, 153, 204, 0.02);
                border-right: 1px solid rgba(0, 153, 204, 0.12);
            }

            [data-theme="light"] .explorer-sidebar h4 {
                color: #0099cc;
            }

            [data-theme="light"] .explorer-item {
                color: #333;
            }

            [data-theme="light"] .explorer-item:hover {
                background: rgba(0, 153, 204, 0.08);
            }

            [data-theme="light"] .explorer-item i {
                color: #0099cc;
            }

            [data-theme="light"] .folder-icon span {
                color: #1a1a1a;
            }

            /* 瀏覽器 - 與整體風格保持一致 */
            [data-theme="light"] .browser-toolbar {
                background: rgba(0, 153, 204, 0.03);
            }

            [data-theme="light"] .browser-toolbar input {
                background: rgba(0, 0, 0, 0.03);
                border: 1px solid rgba(0, 153, 204, 0.15);
                color: #1a1a1a;
            }

            [data-theme="light"] .browser-toolbar i {
                color: #0099cc;
            }

            [data-theme="light"] .favorites-bar {
                background: rgba(0, 153, 204, 0.02);
                border-bottom: 1px solid rgba(0, 153, 204, 0.1);
            }

            [data-theme="light"] .fav-item {
                background: rgba(0, 0, 0, 0.02);
                border: 1px solid rgba(0, 153, 204, 0.1);
                color: #333;
            }

            [data-theme="light"] .fav-item:hover {
                background: rgba(0, 153, 204, 0.08);
            }

            [data-theme="light"] .fav-item .title {
                color: #1a1a1a;
            }

            [data-theme="light"] #win-edge > .tool > input.url {
                background: rgba(0, 0, 0, 0.03);
                border: 1px solid rgba(0, 153, 204, 0.15);
                color: #1a1a1a;
            }

            [data-theme="light"] #win-edge > .tool > .a {
                color: #0099cc;
            }

            [data-theme="light"] #win-edge > .tool > .a:hover {
                background-color: rgba(0, 153, 204, 0.08);
            }

            /* 日曆彈窗 - 與整體風格保持一致 */
            [data-theme="light"] #calendar-flyout {
                background: rgba(255, 255, 255, 0.95);
                border: 1px solid rgba(0, 153, 204, 0.15);
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
            }

            [data-theme="light"] .calendar-header span {
                color: #0099cc;
            }

            [data-theme="light"] .calendar-nav button {
                color: #0099cc;
            }

            [data-theme="light"] .calendar-cell {
                color: #1a1a1a;
            }

            [data-theme="light"] .calendar-cell.day-name {
                color: #0099cc;
            }

            [data-theme="light"] .calendar-cell.other-month {
                color: rgba(150, 150, 150, 0.5);
            }

            [data-theme="light"] .calendar-cell.other-month:hover {
                background: rgba(0, 153, 204, 0.05);
            }

            [data-theme="light"] .calendar-cell.today {
                background: #0099cc;
                color: #fff;
            }

            [data-theme="light"]
                .calendar-cell:not(.day-name):not(.today):hover {
                background: rgba(0, 153, 204, 0.1);
            }

            /* 小工具面板 - 與整體風格保持一致 */
            [data-theme="light"] #widgets-panel {
                background: rgba(255, 255, 255, 0.95);
                border-right: 1px solid rgba(0, 153, 204, 0.2);
                box-shadow: 5px 0 30px rgba(0, 0, 0, 0.08);
            }

            [data-theme="light"] .widget {
                background: linear-gradient(
                    135deg,
                    rgba(255, 255, 255, 0.95),
                    rgba(240, 248, 255, 0.9)
                );
                border: 1px solid rgba(0, 153, 204, 0.2);
            }

            [data-theme="light"] .widget::before {
                background: linear-gradient(
                    90deg,
                    transparent,
                    rgba(0, 153, 204, 0.4),
                    transparent
                );
            }

            [data-theme="light"] .widget::after {
                background: linear-gradient(
                    180deg,
                    rgba(0, 153, 204, 0.2),
                    transparent
                );
            }

            [data-theme="light"] .widget:hover {
                border-color: rgba(0, 153, 204, 0.4);
                box-shadow: 0 4px 20px rgba(0, 153, 204, 0.15);
            }

            [data-theme="light"] .widget-header {
                color: #0099cc;
            }

            /* Light theme: 小工具面板標題列 */
            [data-theme="light"] .widgets-panel-header {
                background: rgba(0, 153, 204, 0.08);
                border-bottom: 1px solid rgba(0, 153, 204, 0.15);
            }

            [data-theme="light"] .widgets-panel-title {
                color: #0088bb;
            }

            [data-theme="light"] .widgets-panel-btn {
                background: rgba(0, 153, 204, 0.1);
                color: #555;
            }

            [data-theme="light"] .widgets-panel-btn:hover {
                background: rgba(0, 153, 204, 0.2);
                color: #0088bb;
            }

            /* Light theme: 小工具控制按鈕 */
            [data-theme="light"] .widget-controls {
                opacity: 0;
            }

            [data-theme="light"] .widget:hover .widget-controls {
                opacity: 1;
            }

            [data-theme="light"] .widget-size-toggle {
                background: rgba(0, 153, 204, 0.15);
                color: #555;
            }

            [data-theme="light"] .widget-size-toggle:hover {
                background: rgba(0, 153, 204, 0.3);
                color: #0088bb;
            }

            [data-theme="light"] .widget-remove-btn {
                background: rgba(0, 153, 204, 0.15);
                color: #555;
            }

            [data-theme="light"] .widget-remove-btn:hover {
                background: rgba(220, 53, 69, 0.3);
                color: #dc3545;
            }

            [data-theme="light"] .widget-add-menu {
                background: rgba(255, 255, 255, 0.95) !important;
                border-color: rgba(0, 153, 204, 0.2) !important;
            }

            /* Light theme: Metro 區域 */
            [data-theme="light"] .metro-header {
                color: #1a1a1a;
            }

            [data-theme="light"] .metro-tile {
                background: linear-gradient(
                    135deg,
                    rgba(0, 153, 204, 0.2),
                    rgba(0, 120, 180, 0.15)
                );
                border: 1px solid rgba(0, 153, 204, 0.2);
            }

            [data-theme="light"] .metro-tile:hover {
                box-shadow: 0 8px 25px rgba(0, 153, 204, 0.25);
            }

            [data-theme="light"] .metro-tile-icon {
                color: #333;
                text-shadow: none;
            }

            [data-theme="light"] .metro-tile-label {
                color: rgba(0, 0, 0, 0.8);
                text-shadow: none;
            }

            [data-theme="light"] .metro-category-title {
                color: rgba(0, 0, 0, 0.5);
            }

            [data-theme="light"] .metro-tile.tile-cyan {
                background: linear-gradient(
                    135deg,
                    rgba(0, 153, 204, 0.35),
                    rgba(0, 130, 180, 0.25)
                );
            }

            [data-theme="light"] .metro-tile.tile-magenta {
                background: linear-gradient(
                    135deg,
                    rgba(233, 30, 99, 0.35),
                    rgba(200, 25, 80, 0.25)
                );
            }

            [data-theme="light"] .metro-tile.tile-green {
                background: linear-gradient(
                    135deg,
                    rgba(76, 175, 80, 0.35),
                    rgba(60, 140, 65, 0.25)
                );
            }

            [data-theme="light"] .metro-tile.tile-purple {
                background: linear-gradient(
                    135deg,
                    rgba(139, 92, 246, 0.35),
                    rgba(110, 70, 200, 0.25)
                );
            }

            [data-theme="light"] .metro-tile.tile-orange {
                background: linear-gradient(
                    135deg,
                    rgba(255, 152, 0, 0.35),
                    rgba(220, 130, 0, 0.25)
                );
            }

            [data-theme="light"] .metro-tile.tile-blue {
                background: linear-gradient(
                    135deg,
                    rgba(33, 150, 243, 0.35),
                    rgba(25, 118, 200, 0.25)
                );
            }

            [data-theme="light"] .metro-tile.tile-red {
                background: linear-gradient(
                    135deg,
                    rgba(244, 67, 54, 0.35),
                    rgba(200, 50, 40, 0.25)
                );
            }

            [data-theme="light"] .metro-tile.tile-yellow {
                background: linear-gradient(
                    135deg,
                    rgba(255, 215, 64, 0.35),
                    rgba(220, 180, 50, 0.25)
                );
            }

            [data-theme="light"] .metro-tile.tile-pink {
                background: linear-gradient(
                    135deg,
                    rgba(233, 30, 99, 0.35),
                    rgba(190, 20, 80, 0.25)
                );
            }

            [data-theme="light"] .weather-controls input[type="text"] {
                background: rgba(0, 153, 204, 0.05);
                border: 1px solid rgba(0, 153, 204, 0.2);
                color: #1a1a1a;
            }

            [data-theme="light"] .weather-controls button {
                background: rgba(0, 153, 204, 0.08);
                border: 1px solid rgba(0, 153, 204, 0.2);
                color: #0099cc;
            }

            [data-theme="light"] .weather-controls button:hover {
                background: rgba(0, 153, 204, 0.15);
            }

            [data-theme="light"] .weather-info .temp {
                background: linear-gradient(135deg, #1a1a1a, #0099cc);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
            }

            [data-theme="light"] .weather-info .desc {
                color: #555;
            }

            [data-theme="light"] .weather-info .meta {
                color: rgba(0, 153, 204, 0.7);
            }

            [data-theme="light"] .weather-visual i {
                color: #0099cc;
                filter: drop-shadow(0 0 8px rgba(0, 153, 204, 0.3));
            }

            [data-theme="light"] .weather-forecast .forecast-item {
                background: linear-gradient(
                    135deg,
                    rgba(0, 153, 204, 0.08),
                    rgba(0, 153, 204, 0.02)
                );
                border: 1px solid rgba(0, 153, 204, 0.15);
            }

            [data-theme="light"] .weather-forecast .forecast-item:hover {
                border-color: rgba(0, 153, 204, 0.35);
            }

            [data-theme="light"] .weather-forecast .forecast-item .date {
                color: rgba(0, 153, 204, 0.7);
            }

            [data-theme="light"] .weather-forecast .forecast-item i {
                color: #0099cc;
            }

            [data-theme="light"] .news-item {
                background: linear-gradient(
                    135deg,
                    rgba(0, 153, 204, 0.05),
                    transparent
                );
                border: 1px solid rgba(0, 153, 204, 0.1);
            }

            [data-theme="light"] .news-item:hover {
                border-color: rgba(0, 153, 204, 0.25);
            }

            [data-theme="light"] .news-item img {
                border-color: rgba(0, 153, 204, 0.2);
            }

            [data-theme="light"] .news-item-info {
                color: #1a1a1a;
            }

            [data-theme="light"] .news-item-info span {
                color: rgba(0, 153, 204, 0.7);
            }

            /* Light theme: 效能監控小工具 */
            [data-theme="light"] .perf-section {
                background: linear-gradient(
                    135deg,
                    rgba(0, 153, 204, 0.05),
                    transparent
                );
                border: 1px solid rgba(0, 153, 204, 0.1);
            }

            [data-theme="light"] .perf-section:hover {
                border-color: rgba(0, 153, 204, 0.2);
            }

            [data-theme="light"] .perf-label-title {
                color: rgba(0, 153, 204, 0.8);
            }

            [data-theme="light"] .perf-label-title i {
                color: #0099cc;
            }

            [data-theme="light"] .perf-label-value {
                color: #1a1a1a;
            }

            [data-theme="light"] .perf-bar {
                background: rgba(0, 153, 204, 0.1);
            }

            [data-theme="light"] .perf-stats {
                border-top-color: rgba(0, 153, 204, 0.15);
            }

            [data-theme="light"] .perf-stat-item {
                background: linear-gradient(
                    135deg,
                    rgba(0, 153, 204, 0.05),
                    transparent
                );
                border: 1px solid rgba(0, 153, 204, 0.08);
            }

            [data-theme="light"] .perf-stat-label {
                color: rgba(0, 153, 204, 0.7);
            }

            [data-theme="light"] .perf-stat-value {
                color: #1a1a1a;
            }

            /* Light theme: 小工具全螢幕模式 */
            [data-theme="light"] #widgets-panel.fullscreen {
                background: rgba(245, 250, 255, 0.98);
            }

            [data-theme="light"]
                #widgets-panel.fullscreen
                .widgets-panel-header {
                background: rgba(0, 153, 204, 0.1);
                border-bottom: 1px solid rgba(0, 153, 204, 0.15);
            }

            [data-theme="light"] #widgets-panel.fullscreen .widgets-content {
                border-right: 1px solid rgba(0, 153, 204, 0.15);
                background: transparent;
            }

            [data-theme="light"] #widgets-panel.fullscreen .metro-area {
                background: transparent;
            }

            [data-theme="light"] #widgets-panel.fullscreen .metro-header {
                color: #1a1a1a;
            }

            [data-theme="light"] .widgets-content::-webkit-scrollbar-thumb {
                background: rgba(0, 153, 204, 0.3);
            }

            [data-theme="light"]
                .widgets-content::-webkit-scrollbar-thumb:hover {
                background: rgba(0, 153, 204, 0.5);
            }

            /* 右鍵選單 - 與整體風格保持一致 */
            [data-theme="light"] #context-menu {
                background: rgba(255, 255, 255, 0.95);
                border: 1px solid rgba(0, 153, 204, 0.15);
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            }

            [data-theme="light"] .context-menu-item {
                color: #1a1a1a;
            }

            [data-theme="light"] .context-menu-item:hover {
                background: rgba(0, 153, 204, 0.1);
            }

            [data-theme="light"] .context-menu-item i {
                color: #0099cc;
            }

            [data-theme="light"] .context-menu-separator {
                background: rgba(0, 153, 204, 0.15);
            }

            [data-theme="light"] #start-context-menu {
                background: rgba(255, 255, 255, 0.95);
                border: 1px solid rgba(0, 153, 204, 0.15);
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            }

            /* 對話/聊天區域 - 與整體風格保持一致 */
            [data-theme="light"] .nagato-messages {
                background: rgba(0, 153, 204, 0.02);
            }

            [data-theme="light"] .message.ai {
                background: rgba(0, 153, 204, 0.08);
                color: #1a1a1a;
            }

            [data-theme="light"] .message.user {
                background: #0099cc;
                color: #fff;
            }

            [data-theme="light"] .message-suggestions .suggestion-btn {
                background: rgba(0, 153, 204, 0.05);
                border: 1px solid rgba(0, 153, 204, 0.15);
                color: #333;
            }

            [data-theme="light"] .message-suggestions .suggestion-btn:hover {
                background: rgba(0, 153, 204, 0.12);
            }

            [data-theme="light"] .nagato-input-area {
                border-top: 1px solid rgba(0, 153, 204, 0.15);
            }

            [data-theme="light"] .nagato-input-area textarea {
                background: rgba(0, 0, 0, 0.02);
                border: 1px solid rgba(0, 153, 204, 0.2);
                color: #1a1a1a;
            }

            [data-theme="light"] .nagato-input-area textarea:focus {
                border-color: rgba(0, 153, 204, 0.5);
            }

            [data-theme="light"] .nagato-input-area .clear-btn {
                color: #0099cc;
            }

            [data-theme="light"] .nagato-input-area .clear-btn:hover {
                background: rgba(0, 153, 204, 0.1);
                color: #0099cc;
            }

            /* 計算機 - 與整體風格保持一致 */
            [data-theme="light"] #win-calc {
                background: #fafafa;
            }

            [data-theme="light"] #calc-input {
                color: #1a1a1a;
            }

            [data-theme="light"] #win-calc > .keyb > .b {
                background: linear-gradient(
                    180deg,
                    rgba(0, 0, 0, 0.02),
                    rgba(0, 0, 0, 0.04)
                );
                border: 1px solid rgba(0, 153, 204, 0.1);
                color: #1a1a1a;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.06);
            }

            [data-theme="light"] #win-calc > .keyb > .b:hover {
                box-shadow: 0 6px 12px rgba(0, 153, 204, 0.15);
                border-color: rgba(0, 153, 204, 0.3);
            }

            [data-theme="light"] #win-calc > .keyb > .b.u {
                background: linear-gradient(
                    180deg,
                    rgba(0, 153, 204, 0.12),
                    rgba(0, 153, 204, 0.06)
                );
                color: #0099cc;
            }

            /* 桌面圖示 - 只調整 hover 背景和文字陰影，圖示顏色保持與開始菜單一致 */
            [data-theme="light"] .desktop-icon:hover {
                background: rgba(255, 255, 255, 0.3);
            }

            [data-theme="light"] .desktop-icon span {
                color: #fff;
                text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
            }

            /* 滾動條 - 與整體風格保持一致 */
            [data-theme="light"] ::-webkit-scrollbar {
                width: 8px;
                height: 8px;
            }

            [data-theme="light"] ::-webkit-scrollbar-track {
                background: rgba(0, 153, 204, 0.03);
            }

            [data-theme="light"] ::-webkit-scrollbar-thumb {
                background: rgba(0, 153, 204, 0.2);
                border-radius: 4px;
            }

            [data-theme="light"] ::-webkit-scrollbar-thumb:hover {
                background: rgba(0, 153, 204, 0.35);
            }

            /* 關於頁面 - 與整體風格保持一致 */
            [data-theme="light"] .about-item {
                background: rgba(0, 153, 204, 0.02);
                border: 1px solid rgba(0, 153, 204, 0.1);
            }

            [data-theme="light"] .about-item-row {
                color: #555;
            }

            [data-theme="light"] .btn {
                background: rgba(0, 153, 204, 0.05);
                border: 1px solid rgba(0, 153, 204, 0.2);
                color: #1a1a1a;
            }

            [data-theme="light"] .btn:hover {
                background: rgba(0, 153, 204, 0.12);
                border-color: rgba(0, 153, 204, 0.4);
            }

            /* 更新頁面 - 與整體風格保持一致 */
            [data-theme="light"] .update-item {
                background: rgba(0, 153, 204, 0.02);
                border: 1px solid rgba(0, 153, 204, 0.1);
            }

            /* Snap 預覽 - 與整體風格保持一致 */
            [data-theme="light"] #snap-preview {
                background: rgba(0, 153, 204, 0.1);
                border: 2px dashed rgba(0, 153, 204, 0.4);
            }

            /* 使用者頭像 */
            [data-theme="light"] .user-profile img.avatar {
                border: 2px solid rgba(0, 153, 204, 0.15);
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
            }

            /* 選擇控制項 - 與全域 components.css 保持一致 */
            [data-theme="light"] .select-control select {
                background: rgba(0, 153, 204, 0.05);
                border: 1px solid rgba(0, 153, 204, 0.3);
                color: rgba(0, 153, 204, 0.9);
            }

            [data-theme="light"] .select-control select:hover {
                background: rgba(0, 153, 204, 0.08);
                box-shadow: none;
            }

            [data-theme="light"] .select-control select:focus {
                border-color: rgba(204, 0, 102, 0.5);
                box-shadow: none;
            }

            [data-theme="light"] .select-control select option {
                background: rgba(255, 255, 255, 0.95);
                color: rgba(51, 51, 51, 0.95);
            }

            [data-theme="light"] .select-control::after {
                color: #0099cc;
            }

            /* 滑桿控制項 - 與全域 components.css 保持一致 */
            [data-theme="light"] .slider-value {
                color: rgba(0, 153, 204, 0.9);
            }

            [data-theme="light"] .slider-marks span {
                color: rgba(0, 153, 204, 0.4);
            }

            [data-theme="light"] .slider-marks span:hover {
                color: #0099cc;
                text-shadow: none;
            }

            [data-theme="light"] .slider-range {
                background: rgba(0, 153, 204, 0.1);
            }

            [data-theme="light"] .slider-range::-webkit-slider-thumb {
                background: rgba(0, 153, 204, 0.85);
                box-shadow: none;
            }

            [data-theme="light"] .slider-range::-webkit-slider-thumb:hover {
                box-shadow: none;
            }

            [data-theme="light"] .slider-range::-moz-range-thumb {
                background: rgba(0, 153, 204, 0.85);
                box-shadow: none;
            }

            [data-theme="light"] .slider-range::-moz-range-thumb:hover {
                box-shadow: none;
            }

            /* 輸入框 - 與整體風格保持一致 */
            [data-theme="light"] input[type="color"] {
                background: rgba(0, 0, 0, 0.03);
                border: 1px solid rgba(0, 153, 204, 0.2);
            }

            [data-theme="light"] input[type="text"],
            [data-theme="light"] input[type="url"],
            [data-theme="light"] input[type="number"] {
                background: rgba(0, 0, 0, 0.03);
                border: 1px solid rgba(0, 153, 204, 0.2);
                color: #1a1a1a;
            }

            [data-theme="light"] input[type="text"]:focus,
            [data-theme="light"] input[type="url"]:focus,
            [data-theme="light"] input[type="number"]:focus {
                border-color: rgba(0, 153, 204, 0.5);
                outline: none;
            }

            /* 設定面板 (主頁面側邊設定) - 與全域 components.css 保持一致 */
            [data-theme="light"] .settings-panel {
                background: rgba(255, 255, 255, 0.92);
                backdrop-filter: blur(20px);
                border-left: 2px solid rgba(204, 0, 102, 0.4);
                box-shadow: -3px 0 10px rgba(0, 0, 0, 0.06);
            }

            [data-theme="light"] .settings-title {
                color: #cc0066;
                text-shadow: none;
            }

            [data-theme="light"] .settings-section-title {
                color: #0099cc;
                text-shadow: none;
            }

            [data-theme="light"] .setting-label {
                color: #1a1a1a;
            }

            [data-theme="light"] .setting-description {
                color: #666666;
            }

            [data-theme="light"] .setting-item {
                background: rgba(0, 153, 204, 0.02);
                border: 1px solid rgba(0, 153, 204, 0.15);
            }

            [data-theme="light"] .setting-item:hover {
                background: rgba(0, 153, 204, 0.05);
                border-color: rgba(0, 153, 204, 0.4);
                box-shadow: none;
            }

            /* 淺色模式 Toggle Switch - 與全域保持一致 */
            [data-theme="light"] .toggle-switch {
                background: rgba(200, 200, 200, 0.2);
                border: 2px solid rgba(0, 153, 204, 0.25);
            }

            [data-theme="light"] .toggle-switch::before {
                background: rgba(153, 153, 153, 0.7);
            }

            [data-theme="light"] .toggle-switch.active {
                background: linear-gradient(
                    135deg,
                    rgba(0, 153, 204, 0.12),
                    rgba(204, 0, 102, 0.12)
                );
                border-color: rgba(0, 153, 204, 0.5);
                box-shadow: none;
            }

            [data-theme="light"] .toggle-switch.active::before {
                background: rgba(0, 153, 204, 0.8);
                box-shadow: none;
            }

            /* 淺色模式設定按鈕 - 與全域保持一致 */
            [data-theme="light"] .settings-toggle::before {
                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%230099cc' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z'/%3E%3Ccircle cx='12' cy='12' r='3'/%3E%3C/svg%3E");
                filter: none;
            }

            [data-theme="light"] .settings-toggle:hover::before {
                filter: none;
            }

            /* 淺色模式漢堡選單 - 與全域保持一致 */
            [data-theme="light"] .menu-toggle span {
                background: #0099cc;
            }

            /* 淺色模式遮罩 - 與全域保持一致 */
            [data-theme="light"] .nav-overlay {
                background: rgba(0, 0, 0, 0.3);
                backdrop-filter: blur(3px);
            }

            /* FPS 監控 - 與全域 components.css 保持一致 */
            [data-theme="light"] .fps-display {
                background: rgba(0, 153, 204, 0.08);
                border-color: rgba(0, 153, 204, 0.3);
            }

            [data-theme="light"] .fps-value {
                color: #0099cc;
                text-shadow: none;
            }

            [data-theme="light"] .fps-value.fps-excellent {
                color: #00aa66;
                text-shadow: none;
            }

            [data-theme="light"] .fps-value.fps-good {
                color: #0099cc;
                text-shadow: none;
            }

            [data-theme="light"] .fps-value.fps-moderate {
                color: #cc8800;
                text-shadow: none;
            }

            [data-theme="light"] .fps-value.fps-poor {
                color: #cc3333;
                text-shadow: none;
            }

            [data-theme="light"] .fps-unit {
                color: rgba(26, 26, 26, 0.5);
            }

            /* 頁眉 - 與全域 components.css 保持一致 */
            [data-theme="light"] header {
                background: linear-gradient(
                    135deg,
                    rgba(255, 255, 255, 0.96),
                    rgba(240, 240, 245, 0.96)
                );
                box-shadow: 0 8px 20px rgba(0, 153, 204, 0.08),
                    0 4px 12px rgba(204, 0, 102, 0.06),
                    inset 0 1px 0px rgba(0, 153, 204, 0.1);
            }

            [data-theme="light"] header a {
                color: #0099cc !important;
                text-shadow: none;
            }

            [data-theme="light"] header a:hover {
                color: #cc0066 !important;
                text-shadow: none;
            }

            /* 淺色模式 Header 掃描動畫 */
            [data-theme="light"] header::before {
                background: linear-gradient(
                    90deg,
                    transparent,
                    rgba(0, 153, 204, 0.03),
                    transparent
                );
            }

            [data-theme="light"] .nav-links a {
                color: #0099cc;
            }

            [data-theme="light"] .nav-links a:hover {
                color: #cc0066;
            }

            /* ========== 淺色模式結束 ========== */

            #start-button {
                font-size: 1.5rem;
                color: var(--primary-cyan);
                /* keep start button visually slightly larger but with consistent vertical sizing */
                padding: 0 8px;
                min-width: calc(var(--taskbar-icon-size) + 20px);
                display: inline-flex;
                align-items: center;
                justify-content: center;
            }
            /* Ensure the time widget fits exactly inside the taskbar and never stretches it.
           Use flexbox to vertically center the two lines (time/date) and limit height.
           Keep fonts/spacing unchanged to avoid altering displayed text sizes. */
            #taskbar-time {
                display: inline-flex; /* make this a flex column so we can center vertically */
                flex-direction: column; /* time above date */
                justify-content: center; /* vertically center within taskbar */
                align-items: flex-end; /* align text to the right */
                height: 100%; /* match parent taskbar height */
                max-height: 100%;
                box-sizing: border-box; /* ensure padding included in height */
                font-family: var(--font-body);
                font-size: 0.9rem;
                text-align: right;
                padding: 0 10px;
                color: #e0e0e0;
                cursor: pointer;
                line-height: 1; /* avoid extra added height from default line height */
                overflow: hidden; /* prevent overflowing elements from stretching it */
            }
            #taskbar-time:hover {
                background: rgba(255, 255, 255, 0.1);
            }

            /* Make sure the inner time/date elements do not have margins that increase height */
            #taskbar-time > div {
                margin: 0;
                padding: 0;
                line-height: 1;
                display: block;
                white-space: nowrap;
            }
            /* Keep AM/PM label same size as numbers and add spacing between them */
            #taskbar-time .ampm {
                margin-right: 3px; /* reduced spacing between AM/PM label and digits */
                /* Make the AM/PM label visually smaller than the numeric time
               while keeping good readability and alignment. Using em so
               it scales with the current font-size. */
                font-size: 0.8em;
                opacity: 0.95;
                line-height: 1; /* keep centered with the digits */
                display: inline-block;
                vertical-align: middle; /* align with digits */
                letter-spacing: 0.01em; /* keep label legible */
            }
            #taskbar-time .time-value {
                font-family: var(--font-body);
                font-size: inherit; /* preserve parent's font size */
                display: inline-block;
            }

            /* 4. 開始功能表 */
            #start-menu {
                position: absolute; /* 修改 */
                bottom: var(--taskbar-height);
                left: 50%;
                transform: translateX(-50%);
                width: 600px;
                max-width: 90vw;
                height: 500px;

                background: var(--mica-bg);
                backdrop-filter: blur(var(--mica-blur)) saturate(180%);

                border-radius: var(--window-border-radius);
                border: 1px solid rgba(255, 255, 255, 0.1);
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);

                display: flex;
                flex-direction: column;
                overflow: hidden;

                opacity: 0;
                visibility: hidden;
                transform: translateX(-50%) translateY(20px);
                transition: opacity 0.2s ease, transform 0.2s ease,
                    visibility 0.2s;
                z-index: var(--z-start-menu);
            }
            #start-menu.show {
                opacity: 1;
                visibility: visible;
                transform: translateX(-50%) translateY(0);
            }

            .start-menu-header {
                padding: 15px 25px;
            }
            .search-bar {
                display: flex;
                background: rgba(0, 0, 0, 0.2);
                border: 1px solid rgba(255, 255, 255, 0.1);
                border-radius: 20px;
                padding: 8px 15px;
            }
            .search-bar i {
                margin-right: 10px;
                color: #aaa;
            }
            .search-bar input {
                flex: 1;
                background: none;
                border: none;
                outline: none;
                color: #fff;
                font-family: var(--font-ui);
                font-size: 0.9rem;
            }
            .start-menu-body {
                flex: 1;
                padding: 10px 25px;
                overflow-y: auto;
            }
            .start-section-title {
                font-size: 0.9rem;
                font-weight: 500;
                color: #bbb;
                margin: 10px 0;
            }
            .pinned-apps {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
                gap: 15px;
                position: relative;
            }
            .app-icon {
                display: flex;
                flex-direction: column;
                align-items: center;
                padding: 10px 5px;
                border-radius: 6px;
                cursor: pointer;
                transition: background-color 0.2s ease, transform 0.15s ease,
                    opacity 0.15s ease;
                user-select: none;
            }
            .app-icon:hover {
                background: rgba(255, 255, 255, 0.1);
            }
            .app-icon.dragging {
                opacity: 0.5;
                transform: scale(0.95);
            }
            .app-icon.drag-over {
                background: rgba(0, 212, 255, 0.2);
                border: 2px dashed rgba(0, 212, 255, 0.5);
            }
            .pinned-app-drag-preview {
                position: fixed;
                pointer-events: none;
                z-index: 10000;
                opacity: 0.9;
                transform: scale(1.05);
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
                background: rgba(0, 212, 255, 0.2);
                border-radius: 6px;
                display: flex;
                flex-direction: column;
                align-items: center;
                padding: 10px 5px;
            }
            .pinned-app-drag-preview i {
                font-size: 1.8rem;
                margin-bottom: 8px;
            }
            .pinned-app-drag-preview span {
                font-size: 0.8rem;
            }
            .pinned-app-drag-preview .app-icon-img {
                width: 36px;
                height: 36px;
            }
            .app-icon i {
                font-size: 1.8rem;
                margin-bottom: 8px;
            }
            .app-icon span {
                font-size: 0.8rem;
            }
            .icon-settings {
                color: #9a9a9a;
            }
            .icon-nagato {
                color: var(--accent-pink);
            }
            /* Image-based app icons */
            .app-icon-img {
                width: 28px;
                height: 28px;
                object-fit: cover;
                border-radius: 6px;
            }
            .desktop-icon .app-icon-img {
                width: 56px;
                height: 56px;
            }
            .pinned-apps .app-icon .app-icon-img {
                width: 36px;
                height: 36px;
            }
            #taskbar .taskbar-icon .app-icon-img {
                width: var(--taskbar-icon-size);
                height: var(--taskbar-icon-size);
            }
            .window-title .app-icon-img {
                width: 18px;
                height: 18px;
                margin-right: 8px;
            }
            .icon-explorer {
                color: #f7d45f;
            }
            .icon-edge {
                color: #0078d7;
            }
            .icon-store {
                color: #00a4ef;
            }
            .icon-notepad {
                color: #ffd740;
            }
            .icon-terminal {
                color: #4caf50;
            }
            .icon-photos {
                color: #ff9800;
            }
            .icon-player {
                color: #e91e63;
            }
            .icon-calculator {
                color: #4caf50;
            }
            .recommended-list {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }
            .recommended-item {
                display: flex;
                align-items: center;
                padding: 8px;
                border-radius: 6px;
                cursor: pointer;
                transition: background-color 0.2s ease;
            }
            .recommended-item:hover {
                background: rgba(255, 255, 255, 0.1);
            }
            .recommended-item i {
                font-size: 1.2rem;
                margin-right: 10px;
                color: #ccc;
            }
            .recommended-item-info {
                font-size: 0.85rem;
            }
            .recommended-item-info span {
                display: block;
                color: #aaa;
                font-size: 0.75rem;
            }
            .start-menu-footer {
                padding: 15px 25px;
                background: rgba(0, 0, 0, 0.1);
                display: flex;
                justify-content: space-between;
                align-items: center;
                font-size: 0.9rem;
            }
            .user-profile {
                display: flex;
                align-items: center;
                cursor: pointer;
            }
            .user-profile i {
                font-size: 1.5rem;
                margin-right: 10px;
                background: var(--accent-purple);
                padding: 5px;
                border-radius: 50%;
            }
            /* Avatar image styles */
            .user-profile img.avatar {
                width: 36px;
                height: 36px;
                border-radius: 50%;
                object-fit: cover;
                margin-right: 10px;
                border: 2px solid rgba(255, 255, 255, 0.06);
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25);
                background-color: rgba(255, 255, 255, 0.03);
            }
            .power-button {
                font-size: 1.2rem;
                padding: 5px;
                cursor: pointer;
                border-radius: 4px;
            }
            .power-button:hover {
                background: rgba(255, 255, 255, 0.1);
            }

            /* 5. 視窗系統 */
            .window {
                position: absolute;
                width: 700px;
                height: 500px;
                min-width: 300px;
                min-height: 200px;

                background: var(--window-bg);
                backdrop-filter: var(--window-backdrop);
                -webkit-backdrop-filter: var(--window-backdrop);
                border-radius: var(--window-border-radius);
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
                border: 1px solid rgba(255, 255, 255, 0.1);

                display: flex;
                flex-direction: column;
                overflow: hidden;

                opacity: 0;
                visibility: hidden;
                transform: scale(0.95);
                transition: opacity 0.2s ease, transform 0.2s ease,
                    visibility 0.2s, background 0.3s ease,
                    backdrop-filter 0.3s ease;
            }
            .window.show {
                opacity: 1;
                visibility: visible;
                transform: scale(1);
            }
            /* Ensure active window stacks above other windows (calc for correct value) */
            .window.active {
                z-index: var(--z-window-active) !important;
                border-color: rgba(0, 212, 255, 0.5);
            }
            .window.minimized {
                display: none;
            }

            .window-header {
                height: 35px;
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 0 5px 0 15px;
                cursor: move;

                background: var(--mica-bg-light);
                backdrop-filter: blur(var(--mica-blur)) saturate(180%);
                flex-shrink: 0;
                /* Ensure the header (and its overlays like .snap-layouts) sits above window content (iframes/inputs) */
                position: relative;
                z-index: calc(var(--z-window) + 20);
            }
            .window-title {
                font-family: var(--font-body);
                font-weight: 500;
                font-size: 0.9rem;
                display: flex;
                align-items: center;
            }
            .window-title i {
                margin-right: 8px;
                font-size: 0.9rem;
            }

            .window-controls {
                display: flex;
                height: 100%;
            }
            .window-control-btn {
                width: 40px;
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 0.9rem;
                cursor: pointer;
                transition: background-color 0.2s ease;
                position: relative;
            }
            .window-control-btn:hover {
                background: rgba(255, 255, 255, 0.1);
            }
            .window-control-btn.close:hover {
                background: #e81123;
            }
            .snap-layouts {
                position: absolute;
                top: calc(100% - 2px);
                right: 0;
                width: 130px;
                background: var(--mica-bg-dark);
                backdrop-filter: blur(var(--mica-blur));
                border: 1px solid rgba(255, 255, 255, 0.2);
                border-radius: 6px;
                padding: 8px;
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 6px;
                opacity: 0;
                visibility: hidden;
                transition: opacity 0.2s ease, visibility 0.2s ease;
                z-index: calc(var(--z-context-menu) + 2);
                pointer-events: auto;
                will-change: opacity;
            }
            /* Keep snap-layouts visible when the maximize button or the overlay itself is hovered/focused */
            .window-control-btn.maximize:hover .snap-layouts,
            .window-control-btn.maximize:focus-within .snap-layouts,
            .window-control-btn.maximize .snap-layouts:hover {
                opacity: 1;
                visibility: visible;
            }
            .snap-layout-option {
                height: 30px;
                border: 2px solid #888;
                border-radius: 4px;
                background: rgba(255, 255, 255, 0.1);
                cursor: pointer;
                pointer-events: auto;
                z-index: calc(var(--z-context-menu) + 3);
            }
            .snap-layout-option:hover {
                border-color: var(--primary-cyan);
                background: rgba(0, 212, 255, 0.2);
            }

            /* Snap preview overlay used when dragging windows near edges */
            #snap-preview {
                position: absolute;
                z-index: var(
                    --z-snap-preview
                ); /* above windows but below start-menu overlays */
                background: rgba(0, 212, 255, 0.12);
                border: 2px dashed rgba(0, 212, 255, 0.35);
                border-radius: var(--window-border-radius);
                pointer-events: none;
                transition: opacity 0.12s ease, transform 0.12s ease;
                opacity: 0;
                visibility: hidden;
            }
            #snap-preview.show {
                opacity: 1;
                visibility: visible;
            }

            .window-content {
                flex: 1;
                padding: 15px;
                overflow: auto;
                font-family: var(--font-ui);
                font-size: 0.95rem;
                line-height: 1.6;
            }

            .resize-handle {
                position: absolute;
                background: transparent;
                z-index: calc(var(--z-window) + 30);
                pointer-events: auto;
            }
            .resize-handle.n {
                top: 0;
                left: 5px;
                right: 5px;
                height: 5px;
                cursor: n-resize;
            }
            .resize-handle.s {
                bottom: 0;
                left: 5px;
                right: 5px;
                height: 5px;
                cursor: s-resize;
            }
            .resize-handle.e {
                top: 5px;
                bottom: 5px;
                right: 0;
                width: 5px;
                cursor: e-resize;
            }
            .resize-handle.w {
                top: 5px;
                bottom: 5px;
                left: 0;
                width: 5px;
                cursor: w-resize;
            }
            .resize-handle.nw {
                top: 0;
                left: 0;
                width: 5px;
                height: 5px;
                cursor: nw-resize;
            }
            .resize-handle.ne {
                top: 0;
                right: 0;
                width: 5px;
                height: 5px;
                cursor: ne-resize;
            }
            .resize-handle.sw {
                bottom: 0;
                left: 0;
                width: 5px;
                height: 5px;
                cursor: sw-resize;
            }
            .resize-handle.se {
                bottom: 0;
                right: 0;
                width: 5px;
                height: 5px;
                cursor: se-resize;
            }

            /* 6. 應用程式內容 */
            .settings-content {
                display: flex;
                height: 100%;
            }
            /* 設定視窗主滾動條箭頭 - 只顯示單一按鈕 */
            #window-settings
                .window-content::-webkit-scrollbar-button:vertical:start:increment,
            #window-settings
                .window-content::-webkit-scrollbar-button:vertical:end:decrement,
            #window-settings
                .settings-main::-webkit-scrollbar-button:vertical:start:increment,
            #window-settings
                .settings-main::-webkit-scrollbar-button:vertical:end:decrement {
                display: none;
            }
            .settings-sidebar {
                width: 200px;
                flex-shrink: 0;
                border-right: 1px solid rgba(255, 255, 255, 0.1);
                padding: 10px 0;
            }
            .settings-menu-item {
                display: flex;
                align-items: center;
                padding: 12px 20px;
                cursor: pointer;
                font-size: 0.9rem;
            }
            .settings-menu-item:hover {
                background: rgba(255, 255, 255, 0.05);
            }
            .settings-menu-item.active {
                background: rgba(0, 212, 255, 0.1);
                border-left: 3px solid var(--primary-cyan);
                padding-left: 17px;
            }
            .settings-menu-item i {
                margin-right: 15px;
                width: 20px;
                text-align: center;
            }
            .settings-page {
                display: none;
            }
            .settings-page.active {
                display: block;
            }
            .settings-subpage {
                display: none;
            }
            .settings-subpage.active {
                display: block;
            }
            .settings-main {
                width: 100%;
            }
            .settings-main {
                flex: 1;
                padding: 20px;
                overflow-y: auto;
            }
            .setting-section {
                margin-bottom: 30px;
            }
            .setting-section h3 {
                font-family: var(--font-body);
                font-size: 1.5rem;
                color: var(--primary-cyan);
                border-bottom: 1px solid rgba(255, 255, 255, 0.2);
                padding-bottom: 10px;
                margin-bottom: 15px;
            }
            .setting-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 15px;
                padding: 10px;
                background: rgba(0, 0, 0, 0.1);
                border-radius: 4px;
            }
            .setting-item-label {
                font-size: 0.9rem;
            }
            .setting-item-label span {
                display: block;
                font-size: 0.8rem;
                color: #aaa;
            }

            /* 設定項目磁貼式佈局 - 支援不同高度 */
            .setting-item-large {
                display: flex;
                flex-direction: column;
                margin-bottom: 15px;
                padding: 15px;
                background: rgba(0, 0, 0, 0.1);
                border-radius: 8px;
                border: 1px solid rgba(255, 255, 255, 0.06);
            }
            .setting-item-large .setting-item-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 12px;
            }
            .setting-item-large .setting-item-label {
                flex: 1;
            }
            .setting-item-large .setting-item-controls {
                display: flex;
                gap: 8px;
                align-items: center;
            }
            .setting-item-large .setting-item-body {
                width: 100%;
            }

            /* 桌布/影片選擇網格 */
            .media-selection-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
                gap: 12px;
                max-height: 320px;
                overflow-y: auto;
                padding: 10px;
                background: rgba(0, 0, 0, 0.15);
                border-radius: 6px;
                scrollbar-width: thin;
                scrollbar-color: rgba(255, 255, 255, 0.3) transparent;
            }
            .media-selection-grid::-webkit-scrollbar {
                width: 6px;
            }
            .media-selection-grid::-webkit-scrollbar-track {
                background: transparent;
            }
            .media-selection-grid::-webkit-scrollbar-thumb {
                background: rgba(255, 255, 255, 0.3);
                border-radius: 3px;
            }
            .media-thumb-item {
                position: relative;
                border-radius: 8px;
                overflow: hidden;
                cursor: pointer;
                border: 2px solid rgba(255, 255, 255, 0.08);
                transition: transform 0.25s ease, box-shadow 0.25s ease,
                    border-color 0.25s ease;
                background: linear-gradient(
                    135deg,
                    rgba(20, 25, 40, 0.9),
                    rgba(30, 35, 50, 0.85)
                );
            }
            .media-thumb-item::before {
                content: "";
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 2px;
                background: linear-gradient(
                    90deg,
                    transparent,
                    rgba(0, 212, 255, 0.5),
                    transparent
                );
                opacity: 0;
                transition: opacity 0.25s;
                z-index: 2;
            }
            .media-thumb-item:hover::before {
                opacity: 1;
            }
            .media-thumb-item:hover {
                transform: translateY(-4px) scale(1.02);
                box-shadow: 0 12px 28px rgba(0, 212, 255, 0.3),
                    0 0 0 1px rgba(0, 212, 255, 0.2);
                border-color: rgba(0, 212, 255, 0.5);
                z-index: 10;
            }
            .media-thumb-item.selected {
                border-color: var(--primary-cyan);
                box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.3);
            }
            .media-thumb-item img,
            .media-thumb-item video {
                width: 100%;
                height: auto;
                display: block;
                transition: transform 0.3s ease;
            }
            .media-thumb-item:hover img,
            .media-thumb-item:hover video {
                transform: scale(1.03);
            }
            .media-thumb-item .media-thumb-overlay {
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                padding: 4px 6px;
                background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
                font-size: 0.7rem;
                color: #fff;
                text-overflow: ellipsis;
                overflow: hidden;
                white-space: nowrap;
                opacity: 0;
                transition: opacity 0.2s ease;
            }
            .media-thumb-item:hover .media-thumb-overlay {
                opacity: 1;
            }
            .media-thumb-item .media-type-badge {
                position: absolute;
                top: 4px;
                right: 4px;
                background: rgba(0, 0, 0, 0.6);
                color: #fff;
                font-size: 0.65rem;
                padding: 2px 5px;
                border-radius: 3px;
            }

            .nagato-content {
                display: flex;
                flex-direction: column;
                height: 100%;
                padding: 0;
            }
            .nagato-messages {
                flex: 1;
                padding: 15px;
                overflow-y: auto;
                background: rgba(0, 0, 0, 0.1);
            }
            .message {
                margin-bottom: 15px;
                padding: 10px 15px;
                border-radius: 10px;
                max-width: 80%;
                line-height: 1.5;
            }
            .message.user {
                background: var(--primary-cyan);
                color: #000;
                align-self: flex-end;
                margin-left: auto;
                border-bottom-right-radius: 2px;
            }
            .message.ai {
                background: rgba(255, 255, 255, 0.1);
                color: #f0f0f0;
                align-self: flex-start;
                border-bottom-left-radius: 2px;
            }
            .message-suggestions {
                margin-top: 8px;
                display: flex;
                gap: 6px;
            }
            .message-suggestions .suggestion-btn {
                background: rgba(255, 255, 255, 0.04);
                border: 1px solid rgba(255, 255, 255, 0.04);
                color: #f0f0f0;
                padding: 6px 8px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 0.85rem;
            }
            .message-suggestions .suggestion-btn:hover {
                background: rgba(255, 255, 255, 0.08);
            }
            .nagato-input-area {
                display: flex;
                padding: 10px;
                border-top: 1px solid rgba(255, 255, 255, 0.1);
            }
            .nagato-input-area textarea {
                flex: 1;
                padding: 10px;
                background: rgba(0, 0, 0, 0.2);
                border: 1px solid rgba(255, 255, 255, 0.2);
                border-radius: 4px;
                outline: none;
                color: #fff;
                font-family: var(--font-ui);
                resize: none;
            }
            .nagato-input-area button {
                background: var(--accent-pink);
                border: none;
                color: #000;
                padding: 0 15px;
                margin-left: 10px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 1.1rem;
            }
            .nagato-input-area .clear-btn {
                background: transparent;
                border: none;
                color: #f0f0f0;
                padding: 0 10px;
                margin-left: 8px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 1rem;
                height: 36px;
                align-self: center;
            }
            .nagato-input-area .clear-btn:hover {
                background: rgba(255, 255, 255, 0.04);
                color: #fff;
            }
            .message.ai.typing {
                opacity: 0.9;
            }
            .typing-dots {
                display: inline-block;
                width: 36px;
                text-align: left;
            }
            .typing-dots span {
                display: inline-block;
                width: 6px;
                height: 6px;
                background: rgba(255, 255, 255, 0.3);
                border-radius: 50%;
                margin: 0 2px;
                animation: dots 1.2s infinite;
            }
            .typing-dots span:nth-child(2) {
                animation-delay: 0.15s;
            }
            .typing-dots span:nth-child(3) {
                animation-delay: 0.3s;
            }
            @keyframes dots {
                0% {
                    transform: translateY(0);
                }
                50% {
                    transform: translateY(-4px);
                }
                100% {
                    transform: translateY(0);
                }
            }
            .explorer-content {
                display: flex;
                height: 100%;
                padding: 0;
                background: transparent;
            }
            .explorer-sidebar {
                width: 220px;
                flex-shrink: 0;
                background: transparent;
                padding: 10px;
                border-right: 1px solid rgba(255, 255, 255, 0.06);
            }
            .explorer-sidebar h4 {
                font-size: 0.9rem;
                color: #aaa;
                margin: 15px 0 5px 5px;
            }
            .explorer-item {
                display: flex;
                align-items: center;
                padding: 8px 10px;
                font-size: 0.9rem;
                border-radius: 4px;
                cursor: pointer;
            }
            .explorer-item:hover {
                background: rgba(255, 255, 255, 0.05);
            }
            .explorer-item i {
                margin-right: 10px;
                color: #ccc;
            }

            .explorer-main {
                flex: 1;
                padding: 15px;
                overflow-y: auto;
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
                gap: 20px;
                align-content: start;
            }
            /* 檔案總管滾動條箭頭 - 只顯示單一按鈕 */
            .explorer-main::-webkit-scrollbar-button:vertical:start:increment,
            .explorer-main::-webkit-scrollbar-button:vertical:end:decrement {
                display: none;
            }
            .folder-icon {
                display: flex;
                flex-direction: column;
                align-items: center;
                cursor: pointer;
            }
            .folder-icon i {
                font-size: 3rem;
                color: #f7d45f;
                margin-bottom: 5px;
            }
            .folder-icon span {
                font-size: 0.85rem;
            }
            .browser-content {
                padding: 0;
                overflow: hidden;
                display: flex;
                flex-direction: column;
            }
            /* Browser toolbar: slightly more compact to reduce vertical spacing to favorites bar below */
            /* Compact browser toolbar - reduce bottom margin to tighten spacing to favorites bar */
            .browser-toolbar {
                display: flex;
                align-items: center;
                padding: 6px 8px;
                background: transparent;
                margin-bottom: 0;
                border-bottom: 1px solid rgba(255, 255, 255, 0.06);
            }
            .browser-toolbar input {
                flex: 1;
                padding: 5px 8px;
                background: rgba(255, 255, 255, 0.05);
                border: 1px solid rgba(255, 255, 255, 0.1);
                border-radius: 20px;
                color: #fff;
                margin: 0 8px;
                font-size: 0.9rem;
            }
            .browser-toolbar i {
                padding: 5px;
                cursor: pointer;
                color: #ccc;
            }
            .browser-toolbar i.disabled {
                opacity: 0.35;
                cursor: not-allowed;
            }
            #bookmark-toggle {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                width: 36px;
                height: 36px;
                border-radius: 8px;
            }
            #bookmark-toggle i.fa-solid {
                color: var(--primary-cyan);
            }
            /* Favorites bar (bookmarks) */
            /* Compact favorites bar - reduced height while keeping scroll capability; hide scrollbar visually */
            /* Compact favorites bar - smaller height and padding for tighter layout under the toolbar */
            /* Compact favorites bar - smaller padding and height for tighter layout under the toolbar */
            .favorites-bar {
                display: flex;
                gap: 6px;
                padding: 2px 8px;
                overflow-x: auto;
                align-items: center;
                height: 34px;
                background: rgba(0, 0, 0, 0.08);
                border-bottom: 1px solid rgba(255, 255, 255, 0.04);
                -ms-overflow-style: none;
                scrollbar-width: none;
                margin-top: 0;
            }
            .favorites-bar::-webkit-scrollbar {
                display: none;
            }
            .fav-item {
                display: inline-flex;
                align-items: center;
                gap: 8px;
                padding: 4px 8px;
                border-radius: 8px;
                background: rgba(255, 255, 255, 0.02);
                color: #ddd;
                cursor: pointer;
                transition: background-color 0.15s ease;
                white-space: nowrap;
                border: 1px solid rgba(255, 255, 255, 0.02);
                font-size: 0.9rem;
            }
            .fav-item:hover {
                background: rgba(255, 255, 255, 0.06);
            }
            .fav-item i {
                font-size: 1rem;
            }
            .fav-item .title {
                font-size: 0.85rem;
                color: #f3f3f3;
            }
            /* Small favicon placeholder to the left of each fav item */
            .fav-item .favicon {
                width: 16px;
                height: 16px;
                display: inline-block;
                border-radius: 4px;
                object-fit: cover;
                background: rgba(255, 255, 255, 0.04);
            }
            #win-edge {
                display: flex;
                flex-direction: column;
                height: 100%;
            }
            /* Edge-like toolbar: reduce padding and gap to make it more compact */
            /* Edge-like toolbar: reduce padding and gap to make it more compact */
            #win-edge > .tool {
                display: flex;
                gap: 6px;
                padding: 4px 6px;
                align-items: center;
                position: relative;
                z-index: 2;
                margin-bottom: 0;
            }
            #win-edge > .tool > .a {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                width: 36px;
                height: 36px;
                border-radius: 6px;
                color: var(--text);
                cursor: pointer;
                transition: 50ms;
                background: transparent;
                text-decoration: none;
            }
            #win-edge > .tool > .a:hover {
                background-color: rgba(255, 255, 255, 0.04);
            }
            #win-edge > .tool > .a.disabled {
                opacity: 0.25;
                pointer-events: none;
            }
            #win-edge > .tool > input.url {
                flex-grow: 1;
                background: rgba(255, 255, 255, 0.03);
                padding: 6px 12px;
                border-radius: 20px;
                border: 1px solid rgba(255, 255, 255, 0.06);
                color: #fff;
            }
            /* Show/hide iframe depending on class 'show' to replicate edge.css pattern */
            #win-edge > iframe {
                width: calc(100% - 4px);
                flex-grow: 1;
                margin: 2px;
                border-radius: 10px;
                display: none;
                background: #ffffff;
            }
            #win-edge > iframe.show {
                display: block;
            }
            .browser-iframe {
                flex: 1;
                border: none;
                background: #fff;
            }
            .store-content {
                text-align: center;
                padding-top: 50px;
            }
            .store-content i {
                font-size: 4rem;
                color: var(--accent-purple);
                margin-bottom: 20px;
            }

            /* 7. 日曆彈窗 */
            #calendar-flyout {
                position: absolute; /* 修改 */
                bottom: var(--taskbar-height);
                right: 0;
                width: 320px;
                background: var(--mica-bg);
                backdrop-filter: blur(var(--mica-blur)) saturate(180%);
                border-radius: var(--window-border-radius);
                border: 1px solid rgba(255, 255, 255, 0.1);
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
                padding: 15px;

                opacity: 0;
                visibility: hidden;
                transform: translateY(20px);
                transition: opacity 0.2s ease, transform 0.2s ease,
                    visibility 0.2s;
                z-index: var(--z-widgets);
            }
            #calendar-flyout.show {
                opacity: 1;
                visibility: visible;
                transform: translateY(0);
            }
            .calendar-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 10px;
            }
            .calendar-header span {
                font-family: var(--font-body);
                font-size: 1.1rem;
                font-weight: 500;
            }
            .calendar-nav button {
                background: none;
                border: none;
                color: #f0f0f0;
                font-size: 1.2rem;
                cursor: pointer;
                padding: 5px;
            }
            .calendar-grid {
                display: grid;
                grid-template-columns: repeat(7, 1fr);
                grid-template-rows: auto repeat(6, 1fr);
                gap: 5px;
            }
            .calendar-cell {
                text-align: center;
                padding: 8px;
                font-size: 0.85rem;
                border-radius: 50%;
                cursor: pointer;
                aspect-ratio: 1;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            .calendar-cell.day-name {
                font-weight: 600;
                color: #aaa;
                font-size: 0.75rem;
                cursor: default;
                aspect-ratio: auto;
            }
            .calendar-cell.other-month {
                color: rgba(150, 150, 150, 0.5);
            }
            .calendar-cell.other-month:hover {
                background: rgba(255, 255, 255, 0.05);
            }
            .calendar-cell.today {
                background: var(--primary-cyan);
                color: #000;
                font-weight: 700;
            }
            .calendar-cell:not(.day-name):not(.today):not(.other-month):hover {
                background: rgba(255, 255, 255, 0.1);
            }

            /* 8. 小工具面板 (Widgets) */
            #widgets-panel {
                position: absolute;
                top: 0;
                left: 0;
                width: 360px;
                height: calc(100% - var(--taskbar-height));

                background: var(--mica-bg-dark);
                backdrop-filter: blur(var(--mica-blur)) saturate(180%);

                border-right: 1px solid rgba(255, 255, 255, 0.1);
                box-shadow: 5px 0 30px rgba(0, 0, 0, 0.3);

                z-index: var(--z-widgets);
                padding: 0; /* 移除 padding，由子元素處理 */
                padding-top: 50px; /* 僅標題列空間 */
                overflow: hidden;
                display: flex;
                flex-direction: column;

                transform: translateX(-100%);
                transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1),
                    width 0.35s cubic-bezier(0.4, 0, 0.2, 1);
                will-change: transform, width;
                backface-visibility: hidden;
                -webkit-backface-visibility: hidden;
            }
            #widgets-panel.show {
                transform: translateX(0);
            }

            /* 小工具面板標題列 */
            .widgets-panel-header {
                position: absolute;
                top: 0;
                left: 0;
                width: 360px;
                height: 50px;
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 0 15px;
                background: rgba(0, 0, 0, 0.2);
                border-bottom: 1px solid rgba(255, 255, 255, 0.08);
                z-index: 10;
                box-sizing: border-box;
                transition: width 0.35s cubic-bezier(0.4, 0, 0.2, 1); /* 標題列寬度跟隨面板動畫 */
            }

            .widgets-panel-title {
                font-family: var(--font-body);
                font-size: 1.1rem;
                font-weight: 500;
                color: var(--primary-cyan);
            }

            .widgets-panel-actions {
                display: flex;
                gap: 8px;
            }

            .widgets-panel-btn {
                width: 32px;
                height: 32px;
                border: none;
                border-radius: 6px;
                background: rgba(255, 255, 255, 0.08);
                color: #ccc;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.2s ease;
            }

            .widgets-panel-btn:hover {
                background: rgba(0, 212, 255, 0.2);
                color: var(--primary-cyan);
            }

            /* 全螢幕 Metro 模式 - 作為新桌面，z-index 高於桌面但低於所有視窗 */
            #widgets-panel.fullscreen {
                width: 100%;
                display: flex;
                flex-direction: row;
                z-index: calc(
                    var(--z-window-base) - 1
                ); /* 高於桌面，但低於所有視窗(1000+) */
                padding: 0; /* 移除 padding，由子元素處理 */
                padding-top: 50px; /* 只保留標題列空間 */
                overflow: hidden;
            }

            #widgets-panel.fullscreen .widgets-panel-header {
                width: 100%; /* 全螢幕時標題列擴展 */
                background: rgba(0, 0, 0, 0.4);
                z-index: calc(var(--z-taskbar) + 1);
            }

            /* 全螢幕模式下顯示收合按鈕 */
            #widgets-panel.fullscreen #widgets-collapse-btn {
                display: flex !important;
            }

            /* 小工具內容區域 - 基礎樣式 */
            .widgets-content {
                display: flex;
                flex-direction: column;
                flex: 1;
                overflow-y: auto;
                overflow-x: hidden;
                padding: 15px 20px 20px 20px;
                scrollbar-width: thin;
                scrollbar-color: rgba(255, 255, 255, 0.3) transparent;
            }

            .widgets-content::-webkit-scrollbar {
                width: 6px;
            }

            .widgets-content::-webkit-scrollbar-track {
                background: transparent;
            }

            .widgets-content::-webkit-scrollbar-thumb {
                background: rgba(255, 255, 255, 0.3);
                border-radius: 3px;
            }

            .widgets-content::-webkit-scrollbar-thumb:hover {
                background: rgba(255, 255, 255, 0.5);
            }

            /* 小工具內容區域 - 全螢幕模式 */
            #widgets-panel.fullscreen .widgets-content {
                width: 360px;
                min-width: 360px;
                max-width: 360px; /* 固定最大寬度 */
                flex: 0 0 360px; /* 不擴展、不收縮、固定 360px */
                padding: 15px 20px 20px 20px;
                border-right: 1px solid rgba(255, 255, 255, 0.1);
                overflow-y: auto;
                overflow-x: hidden;
                box-sizing: border-box;
                transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                    min-width 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                    max-width 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                    flex 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                    padding 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease,
                    border 0.3s ease;
            }

            /* 全螢幕模式下小工具保持原有尺寸 */
            #widgets-panel.fullscreen .widget {
                /* 保持與非全螢幕時相同的尺寸和樣式 */
                max-width: none;
                width: auto;
                flex-shrink: 0; /* 確保不被壓縮 */
                transition: box-shadow 0.2s ease, opacity 0.2s ease,
                    border 0.2s ease, height 0.3s ease; /* 移除 transform transition 避免退出動畫時變形 */
            }

            /* 全螢幕收合狀態 - 隱藏小工具區域 */
            #widgets-panel.fullscreen.collapsed .widgets-content {
                width: 0;
                min-width: 0;
                max-width: 0;
                flex: 0 0 0;
                padding: 0;
                opacity: 0;
                overflow: hidden;
                border-right: none;
            }

            /* Metro 區域 */
            .metro-area {
                flex: 1;
                padding: 20px 30px;
                overflow-y: auto;
                height: 100%;
                opacity: 0;
                visibility: hidden;
                pointer-events: none;
                position: absolute;
                left: 360px;
                right: 0;
                top: 0;
                bottom: 0;
                transition: none; /* 退出時立即隱藏，無動畫 */
            }

            #widgets-panel.fullscreen .metro-area {
                visibility: visible;
                opacity: 1;
                pointer-events: auto;
                position: relative;
                left: auto;
                right: auto;
                transition: opacity 0.3s ease 0.1s, visibility 0s linear 0s,
                    flex 0.3s ease; /* 進入時延遲淡入 */
            }

            /* 收合時 Metro 區域自動擴展填充空間 */
            #widgets-panel.fullscreen.collapsed .metro-area {
                flex: 1;
                width: 100%;
            }

            /* 收合按鈕圖示旋轉 */
            #widgets-panel.fullscreen.collapsed #widgets-collapse-btn i {
                transform: rotate(180deg);
            }

            #widgets-collapse-btn i {
                transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }

            .metro-header {
                font-family: var(--font-display);
                font-size: 1.8rem;
                font-weight: 600;
                color: #fff;
                margin-bottom: 25px;
                text-transform: uppercase;
                letter-spacing: 2px;
            }

            .metro-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                gap: 12px;
                max-width: 1200px;
            }

            /* Metro 磚塊 */
            .metro-tile {
                aspect-ratio: 1;
                border-radius: 8px;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                position: relative;
                overflow: hidden;
                transition: transform 0.2s ease, box-shadow 0.2s ease;
                background: linear-gradient(
                    135deg,
                    rgba(0, 212, 255, 0.15),
                    rgba(255, 0, 128, 0.1)
                );
                border: 1px solid rgba(255, 255, 255, 0.1);
            }

            .metro-tile::before {
                content: "";
                position: absolute;
                inset: 0;
                background: linear-gradient(
                    135deg,
                    transparent 0%,
                    rgba(255, 255, 255, 0.05) 100%
                );
                opacity: 0;
                transition: opacity 0.2s ease;
            }

            .metro-tile:hover {
                transform: scale(1.05);
                box-shadow: 0 8px 25px rgba(0, 212, 255, 0.3);
            }

            .metro-tile:hover::before {
                opacity: 1;
            }

            .metro-tile:active {
                transform: scale(0.98);
            }

            .metro-tile-icon {
                font-size: 2.5rem;
                margin-bottom: 10px;
                color: #fff;
                text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            }

            .metro-tile-icon img {
                width: 48px;
                height: 48px;
                object-fit: contain;
                filter: drop-shadow(0 2px 5px rgba(0, 0, 0, 0.3));
            }

            .metro-tile-label {
                font-family: var(--font-ui);
                font-size: 0.85rem;
                color: rgba(255, 255, 255, 0.9);
                text-align: center;
                padding: 0 8px;
                text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
            }

            /* 不同大小的磚塊 */
            .metro-tile.wide {
                grid-column: span 2;
                aspect-ratio: 2/1;
            }

            .metro-tile.large {
                grid-column: span 2;
                grid-row: span 2;
            }

            /* 不同顏色主題的磚塊 */
            .metro-tile.tile-cyan {
                background: linear-gradient(
                    135deg,
                    rgba(0, 212, 255, 0.4),
                    rgba(0, 180, 220, 0.3)
                );
            }

            .metro-tile.tile-magenta {
                background: linear-gradient(
                    135deg,
                    rgba(255, 0, 128, 0.4),
                    rgba(200, 0, 100, 0.3)
                );
            }

            .metro-tile.tile-green {
                background: linear-gradient(
                    135deg,
                    rgba(76, 175, 80, 0.4),
                    rgba(60, 140, 65, 0.3)
                );
            }

            .metro-tile.tile-purple {
                background: linear-gradient(
                    135deg,
                    rgba(139, 92, 246, 0.4),
                    rgba(110, 70, 200, 0.3)
                );
            }

            .metro-tile.tile-orange {
                background: linear-gradient(
                    135deg,
                    rgba(255, 152, 0, 0.4),
                    rgba(220, 130, 0, 0.3)
                );
            }

            .metro-tile.tile-blue {
                background: linear-gradient(
                    135deg,
                    rgba(33, 150, 243, 0.4),
                    rgba(25, 118, 200, 0.3)
                );
            }

            .metro-tile.tile-red {
                background: linear-gradient(
                    135deg,
                    rgba(244, 67, 54, 0.4),
                    rgba(200, 50, 40, 0.3)
                );
            }

            .metro-tile.tile-yellow {
                background: linear-gradient(
                    135deg,
                    rgba(255, 215, 64, 0.4),
                    rgba(220, 180, 50, 0.3)
                );
            }

            .metro-tile.tile-pink {
                background: linear-gradient(
                    135deg,
                    rgba(233, 30, 99, 0.4),
                    rgba(190, 20, 80, 0.3)
                );
            }

            /* Metro 類別分隔 */
            .metro-category {
                margin-bottom: 30px;
            }

            .metro-category-title {
                font-family: var(--font-body);
                font-size: 1rem;
                color: rgba(255, 255, 255, 0.6);
                margin-bottom: 15px;
                text-transform: uppercase;
                letter-spacing: 1px;
            }
            .widget {
                background: linear-gradient(
                    135deg,
                    rgba(20, 25, 40, 0.9),
                    rgba(30, 35, 50, 0.85)
                );
                border-radius: var(--window-border-radius);
                padding: 15px;
                margin-bottom: 15px;
                overflow: hidden;
                cursor: grab;
                user-select: none;
                transition: box-shadow 0.2s ease, opacity 0.2s ease,
                    border 0.2s ease, height 0.3s ease;
                border: 1px solid rgba(0, 212, 255, 0.15);
                position: relative;
                box-sizing: border-box;
                flex-shrink: 0;
                width: 320px; /* 固定寬度，防止容器變化時變形 */
                min-width: 320px;
                backdrop-filter: blur(12px);
                -webkit-backdrop-filter: blur(12px);
            }

            /* 磁貼科技感光暈效果 */
            .widget::before {
                content: "";
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 1px;
                background: linear-gradient(
                    90deg,
                    transparent,
                    rgba(0, 212, 255, 0.5),
                    transparent
                );
                opacity: 0.6;
            }

            .widget::after {
                content: "";
                position: absolute;
                top: 0;
                left: 0;
                width: 1px;
                height: 100%;
                background: linear-gradient(
                    180deg,
                    rgba(0, 212, 255, 0.3),
                    transparent
                );
            }

            .widget:hover {
                border-color: rgba(0, 212, 255, 0.4);
                box-shadow: 0 4px 20px rgba(0, 212, 255, 0.15),
                    inset 0 0 20px rgba(0, 212, 255, 0.03);
            }

            /* 小工具固定大小 - 小(1) */
            .widget.widget-size-1 {
                height: 90px !important;
                min-height: 90px !important;
                max-height: 90px !important;
                flex: 0 0 90px !important;
            }

            /* 小工具固定大小 - 中(2) 預設 */
            .widget.widget-size-2 {
                height: 160px !important;
                min-height: 160px !important;
                max-height: 160px !important;
                flex: 0 0 160px !important;
            }

            /* 小工具固定大小 - 大(3) */
            .widget.widget-size-3 {
                height: 300px !important;
                min-height: 300px !important;
                max-height: 300px !important;
                flex: 0 0 300px !important;
            }

            /* 小工具內容區域 - 禁止溺出和滾動 */
            .widget-body {
                height: calc(100% - 24px);
                overflow: hidden;
                display: flex;
                flex-direction: column;
            }

            /* 小工具控制按鈕群組 */
            .widget-controls {
                position: absolute;
                top: 8px;
                right: 8px;
                display: flex;
                gap: 4px;
                opacity: 0;
                transition: opacity 0.2s ease;
                z-index: 10;
            }

            .widget:hover .widget-controls {
                opacity: 1;
            }

            /* 小工具大小設定按鈕 */
            .widget-size-toggle {
                width: 24px;
                height: 24px;
                border: none;
                border-radius: 4px;
                background: rgba(255, 255, 255, 0.1);
                color: rgba(255, 255, 255, 0.6);
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 0.7rem;
                font-weight: 700;
                transition: background 0.2s ease, color 0.2s ease;
            }

            .widget-size-toggle:hover {
                background: rgba(0, 212, 255, 0.3);
                color: var(--primary-cyan);
            }

            /* 小工具移除按鈕 */
            .widget-remove-btn {
                width: 24px;
                height: 24px;
                border: none;
                border-radius: 4px;
                background: rgba(255, 255, 255, 0.1);
                color: rgba(255, 255, 255, 0.6);
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 0.7rem;
                transition: background 0.2s ease, color 0.2s ease;
            }

            .widget-remove-btn:hover {
                background: rgba(244, 67, 54, 0.4);
                color: #ff6b6b;
            }

            .widget:active {
                cursor: grabbing;
            }
            .widget.dragging {
                opacity: 0.9;
                transform: scale(1.02);
                transform-origin: top left;
                box-shadow: 0 8px 25px rgba(0, 212, 255, 0.3);
                cursor: grabbing;
                z-index: 100;
            }
            .widget-drag-placeholder {
                border: 1px dashed rgba(0, 212, 255, 0.5);
                border-radius: var(--window-border-radius);
                background: rgba(0, 212, 255, 0.03);
                margin-bottom: 15px;
                min-height: 80px;
                transition: height 0.2s ease;
                box-shadow: inset 0 0 20px rgba(0, 212, 255, 0.05);
            }
            .widget-header {
                font-family: var(--font-display);
                font-size: 0.75rem;
                font-weight: 600;
                margin-bottom: 8px;
                cursor: grab;
                padding-right: 30px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                color: var(--primary-cyan);
                text-transform: uppercase;
                letter-spacing: 1px;
                display: flex;
                align-items: center;
                gap: 6px;
                height: 16px;
                flex-shrink: 0;
            }

            .widget-header i {
                font-size: 0.8rem;
                opacity: 0.8;
            }

            .widget-header .small {
                font-family: var(--font-body);
                font-size: 0.7rem;
                color: rgba(255, 255, 255, 0.6);
                text-transform: none;
                letter-spacing: 0;
            }
            .weather-widget {
                display: block;
                overflow: hidden;
            }
            .weather-widget .widget-body {
                overflow: hidden;
            }
            .weather-controls {
                display: flex;
                gap: 4px;
                margin-bottom: 6px;
                flex-shrink: 0;
            }
            .weather-controls input[type="text"] {
                flex: 1;
                padding: 5px 8px;
                border-radius: 4px;
                background: rgba(0, 212, 255, 0.05);
                border: 1px solid rgba(0, 212, 255, 0.2);
                color: #fff;
                outline: none;
                cursor: text;
                font-size: 0.75rem;
                font-family: var(--font-body);
            }
            .weather-controls input[type="text"]:focus {
                border-color: rgba(0, 212, 255, 0.5);
            }
            .weather-controls button {
                background: rgba(0, 212, 255, 0.1);
                border: 1px solid rgba(0, 212, 255, 0.2);
                color: var(--primary-cyan);
                padding: 4px 8px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 0.8rem;
            }
            .weather-controls button:hover {
                background: rgba(0, 212, 255, 0.2);
            }
            .weather-controls button[disabled] {
                opacity: 0.4;
                cursor: not-allowed;
            }
            .weather-main {
                display: flex;
                align-items: center;
                gap: 10px;
                flex-shrink: 0;
            }
            .weather-visual i {
                font-size: 2rem;
                color: var(--primary-cyan);
                filter: drop-shadow(0 0 8px rgba(0, 212, 255, 0.4));
            }
            .weather-visual img {
                width: 40px;
                height: 40px;
                object-fit: cover;
                border-radius: 6px;
            }
            .weather-info .temp {
                font-size: 1.5rem;
                font-weight: 700;
                font-family: var(--font-display);
                background: linear-gradient(135deg, #fff, var(--primary-cyan));
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
            }
            .weather-info .desc {
                font-size: 0.75rem;
                color: rgba(255, 255, 255, 0.7);
                font-family: var(--font-body);
            }
            .weather-info .meta {
                font-size: 0.65rem;
                color: rgba(0, 212, 255, 0.6);
                margin-top: 2px;
                font-family: var(--font-mono);
            }
            .weather-forecast {
                display: flex;
                gap: 6px;
                margin-top: 8px;
                align-items: stretch;
                overflow: hidden;
                flex-wrap: nowrap;
            }
            .weather-forecast .forecast-item {
                background: linear-gradient(
                    135deg,
                    rgba(0, 212, 255, 0.08),
                    rgba(0, 212, 255, 0.02)
                );
                border: 1px solid rgba(0, 212, 255, 0.15);
                padding: 6px 8px;
                border-radius: 6px;
                flex: 1;
                min-width: 0;
                text-align: center;
            }
            .weather-forecast .forecast-item:hover {
                border-color: rgba(0, 212, 255, 0.4);
            }
            .weather-forecast .forecast-item .date {
                font-size: 0.6rem;
                color: rgba(0, 212, 255, 0.7);
                font-family: var(--font-mono);
            }
            .weather-forecast .forecast-item .temp {
                font-weight: 700;
                font-size: 0.75rem;
                font-family: var(--font-display);
            }
            .weather-forecast .forecast-item i {
                font-size: 0.9rem;
                color: var(--primary-cyan);
                margin: 2px 0;
                display: block;
            }

            /* ===== 天氣小工具 - 大小 1 (90px) - 只顯示圖標和溫度 ===== */
            .widget.widget-size-1.weather-widget {
                padding: 8px 12px;
            }
            .widget.widget-size-1.weather-widget .widget-header {
                display: none;
            }
            .widget.widget-size-1.weather-widget .widget-body {
                height: 100%;
                flex-direction: row;
                align-items: center;
                justify-content: center;
                gap: 12px;
            }
            .widget.widget-size-1.weather-widget .weather-controls {
                display: none;
            }
            .widget.widget-size-1.weather-widget .weather-forecast {
                display: none;
            }
            .widget.widget-size-1.weather-widget .weather-main {
                justify-content: center;
                gap: 12px;
            }
            .widget.widget-size-1.weather-widget .weather-info .desc {
                display: none;
            }
            .widget.widget-size-1.weather-widget .weather-info .meta {
                display: none;
            }

            /* ===== 天氣小工具 - 大小 2 (160px) - 顯示主要天氣+按鈕 ===== */
            .widget.widget-size-2.weather-widget {
                padding: 8px 12px;
            }
            .widget.widget-size-2.weather-widget .weather-controls {
                display: flex;
                margin-bottom: 4px;
            }
            .widget.widget-size-2.weather-widget
                .weather-controls
                input[type="text"] {
                display: block;
                flex: 1;
            }
            .widget.widget-size-2.weather-widget .weather-main {
                gap: 8px;
            }
            .widget.widget-size-2.weather-widget .weather-info .temp {
                font-size: 1.3rem;
            }
            .widget.widget-size-2.weather-widget .weather-info .desc {
                font-size: 0.7rem;
            }
            .widget.widget-size-2.weather-widget .weather-info .meta {
                font-size: 0.6rem;
            }
            .widget.widget-size-2.weather-widget .weather-forecast {
                display: none;
            }

            /* ===== 天氣小工具 - 大小 3 (260px) - 顯示完整內容 ===== */
            .widget.widget-size-3.weather-widget .weather-forecast {
                display: flex;
            }

            .news-item {
                display: flex;
                margin-bottom: 8px;
                flex-shrink: 0;
                align-items: center;
                padding: 6px 8px;
                background: linear-gradient(
                    135deg,
                    rgba(0, 212, 255, 0.05),
                    transparent
                );
                border: 1px solid rgba(0, 212, 255, 0.1);
                border-radius: 6px;
            }
            .news-item:hover {
                border-color: rgba(0, 212, 255, 0.3);
            }
            .news-item:last-child {
                margin-bottom: 0;
            }
            .news-item img {
                width: 36px;
                height: 36px;
                object-fit: cover;
                border-radius: 4px;
                margin-right: 8px;
                flex-shrink: 0;
                border: 1px solid rgba(0, 212, 255, 0.2);
            }
            .news-item-info {
                font-size: 0.75rem;
                overflow: hidden;
                flex: 1;
                font-family: var(--font-body);
                color: rgba(255, 255, 255, 0.9);
                line-height: 1.3;
                display: -webkit-box;
                -webkit-line-clamp: 2;
                line-clamp: 2;
                -webkit-box-orient: vertical;
            }
            .news-item-info span {
                font-size: 0.65rem;
                color: rgba(0, 212, 255, 0.6);
                display: block;
                margin-top: 2px;
                font-family: var(--font-mono);
            }

            /* ===== 新聞小工具 - 大小 1 (90px) - 單條新聞 ===== */
            .widget.widget-size-1.news-widget {
                padding: 8px 12px;
            }
            .widget.widget-size-1.news-widget .widget-header {
                display: none;
            }
            .widget.widget-size-1.news-widget .widget-body {
                height: 100%;
            }
            .widget.widget-size-1.news-widget .news-item {
                margin-bottom: 0;
                height: 100%;
                padding: 6px;
            }
            .widget.widget-size-1.news-widget .news-item img {
                width: 50px;
                height: 50px;
            }
            .widget.widget-size-1.news-widget .news-item:nth-child(n + 2) {
                display: none;
            }

            /* ===== 新聞小工具 - 大小 2 (160px) - 2條新聞 ===== */
            .widget.widget-size-2.news-widget .news-item:nth-child(n + 3) {
                display: none;
            }

            /* ===== 新聞小工具 - 大小 3 (260px) - 4條新聞 ===== */
            .widget.widget-size-3.news-widget .news-item:nth-child(n + 5) {
                display: none;
            }

            /* 效能監控小工具 */
            .performance-widget {
                padding: 10px 12px;
            }

            .performance-widget .widget-body {
                overflow: hidden;
            }

            .perf-section {
                margin-bottom: 6px;
                flex-shrink: 0;
                padding: 4px 8px;
                background: linear-gradient(
                    135deg,
                    rgba(0, 212, 255, 0.05),
                    transparent
                );
                border: 1px solid rgba(0, 212, 255, 0.1);
                border-radius: 4px;
            }

            .perf-section:hover {
                border-color: rgba(0, 212, 255, 0.25);
            }

            .perf-section:last-child {
                margin-bottom: 0;
            }

            .perf-label {
                display: flex;
                justify-content: space-between;
                align-items: center;
                font-size: 0.7rem;
                margin-bottom: 3px;
            }

            .perf-label-title {
                color: rgba(0, 212, 255, 0.8);
                display: flex;
                align-items: center;
                gap: 6px;
                font-family: var(--font-body);
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            .perf-label-title i {
                font-size: 0.85rem;
                width: 16px;
                text-align: center;
                color: var(--primary-cyan);
            }

            .perf-label-value {
                font-weight: 600;
                font-family: var(--font-display);
                font-size: 0.85rem;
                color: #fff;
            }

            .perf-bar {
                height: 4px;
                background: rgba(0, 212, 255, 0.1);
                border-radius: 2px;
                overflow: hidden;
            }

            /* ===== 效能監控小工具 - 大小 1 (90px) - 只顯示數值 ===== */
            .widget.widget-size-1.performance-widget {
                padding: 8px 12px;
            }
            .widget.widget-size-1.performance-widget .widget-header {
                display: none;
            }
            .widget.widget-size-1.performance-widget .widget-body {
                height: 100%;
                flex-direction: row;
                flex-wrap: nowrap;
                gap: 8px;
                align-items: center;
                justify-content: space-around;
            }
            .widget.widget-size-1.performance-widget .perf-section {
                flex: 1;
                margin-bottom: 0;
                padding: 4px 6px;
                text-align: center;
            }
            .widget.widget-size-1.performance-widget .perf-label {
                flex-direction: column;
                margin-bottom: 0;
                gap: 2px;
            }
            .widget.widget-size-1.performance-widget .perf-label-title {
                justify-content: center;
                font-size: 0.6rem;
            }
            .widget.widget-size-1.performance-widget .perf-label-title i {
                font-size: 0.7rem;
            }
            .widget.widget-size-1.performance-widget .perf-label-value {
                font-size: 0.75rem;
            }
            .widget.widget-size-1.performance-widget .perf-bar {
                display: none;
            }
            .widget.widget-size-1.performance-widget .perf-stats {
                display: none;
            }

            /* ===== 效能監控小工具 - 大小 2 (160px) - 顯示進度條 ===== */
            .widget.widget-size-2.performance-widget {
                padding: 8px 10px;
            }
            .widget.widget-size-2.performance-widget .widget-header {
                margin-bottom: 4px;
                font-size: 0.7rem;
            }
            .widget.widget-size-2.performance-widget .perf-section {
                margin-bottom: 4px;
                padding: 3px 6px;
            }
            .widget.widget-size-2.performance-widget .perf-label {
                font-size: 0.65rem;
                margin-bottom: 2px;
            }
            .widget.widget-size-2.performance-widget .perf-label-title i {
                font-size: 0.7rem;
            }
            .widget.widget-size-2.performance-widget .perf-label-value {
                font-size: 0.7rem;
            }
            .widget.widget-size-2.performance-widget .perf-bar {
                height: 3px;
            }
            .widget.widget-size-2.performance-widget .perf-stats {
                display: none;
            }

            /* ===== 效能監控小工具 - 大小 3 (260px) - 顯示統計 ===== */
            .widget.widget-size-3.performance-widget .perf-stats {
                display: grid;
                margin-top: 8px;
                padding-top: 8px;
                gap: 6px;
            }
            .widget.widget-size-3.performance-widget .perf-stat-item {
                padding: 4px 6px;
            }
            .widget.widget-size-3.performance-widget .perf-stat-label {
                font-size: 0.6rem;
            }
            .widget.widget-size-3.performance-widget .perf-stat-value {
                font-size: 0.75rem;
            }

            .perf-bar-fill {
                height: 100%;
                border-radius: 2px;
                transition: width 0.3s ease;
            }

            .perf-bar-fill.cpu {
                background: linear-gradient(
                    90deg,
                    var(--primary-cyan),
                    #00a8cc
                );
            }
            .perf-bar-fill.memory {
                background: linear-gradient(90deg, var(--accent-pink), #ff6b9d);
            }
            .perf-bar-fill.fps {
                background: linear-gradient(90deg, #4caf50, #8bc34a);
            }

            .perf-bar-fill.warning {
                background: linear-gradient(90deg, #ff9800, #ffc107);
            }
            .perf-bar-fill.critical {
                background: linear-gradient(90deg, #f44336, #ff5722);
            }

            .perf-stats {
                display: none;
                grid-template-columns: 1fr 1fr;
                gap: 6px;
                margin-top: 8px;
                padding-top: 8px;
                border-top: 1px solid rgba(0, 212, 255, 0.15);
            }

            .perf-stat-item {
                display: flex;
                flex-direction: column;
                gap: 2px;
                padding: 4px 6px;
                background: linear-gradient(
                    135deg,
                    rgba(0, 212, 255, 0.05),
                    transparent
                );
                border: 1px solid rgba(0, 212, 255, 0.08);
                border-radius: 4px;
            }

            .perf-stat-label {
                font-size: 0.6rem;
                color: rgba(0, 212, 255, 0.6);
                text-transform: uppercase;
                letter-spacing: 0.5px;
                font-family: var(--font-body);
            }

            .perf-stat-value {
                font-size: 0.75rem;
                font-weight: 600;
                font-family: var(--font-display);
                color: #fff;
            }
            /* ------------------------------------------------------------------ */
            /* Calc: Ensure calculator window does not show scrollbars when sized */
            /* - Use flexbox to let inner #win-calc fill the window-content area
           - Prevent min-height from causing overflow in flex children
           - Prevent inner scroll via overflow:hidden on the window content */
            /* ------------------------------------------------------------------ */
            #window-calculator .window-content {
                overflow: hidden; /* prevent scrollbars */
                -ms-overflow-style: none; /* IE/Edge */
                scrollbar-width: none; /* Firefox */
                display: flex; /* create a flex container so children can scale */
                flex-direction: column; /* stack input above keypad */
                padding: 10px; /* slightly smaller padding for tighter fit */
            }

            /* Hide scrollbar on webkit-based browsers as extra precaution */
            #window-calculator .window-content::-webkit-scrollbar {
                display: none;
            }

            /* Make the win-calc element stretch to available height and be allowed to shrink */
            #window-calculator #win-calc {
                flex: 1 1 auto; /* grow and shrink to available space */
                min-height: 0; /* allow shrinking inside flex container */
                display: flex;
                flex-direction: column;
            }

            /* Let keypad rows stretch proportionally so they always fit inside the
           window without forcing a scrollbar while keeping the buttons usable */
            #window-calculator #win-calc > .keyb {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                grid-template-rows: repeat(
                    5,
                    minmax(48px, 1fr)
                ); /* use fractional rows to scale but keep minimum */
                gap: 6px;
            }

            /* Override fixed widths coming from calc.css to ensure responsive layout */
            #window-calculator #win-calc > .keyb > span {
                width: auto;
                margin: 0;
                height: auto;
            }

            /* Keep input area stable while allowing it to reduce when space is needed */
            #window-calculator #win-calc > .container {
                height: 90px;
                flex: 0 0 auto;
                display: flex;
                align-items: center;
            }

            /* Calc input tweaks */
            #window-calculator #calc-input {
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                font-size: clamp(20px, 3.5vw, 35px);
                padding-right: 8px;
            }

            /* Ensure the calculator window can't be resized smaller than default size
           so the keypad never gets folded or clipped vertically. Also ensure the 
           minimum width is not larger than the default width (default inline width is 340px). */
            #window-calculator {
                min-height: 430px; /* match default window height so buttons won't be clipped */
                min-width: 320px; /* smaller or equal to default width (340px) */
                width: 340px; /* set default width as desired; inline style already sets this */
            }

            /* Improve button look & feel for a tactile impression */
            #window-calculator #win-calc > .keyb > .b {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                height: auto; /* allow grid to control the height */
                min-height: 48px; /* keep buttons comfortably tappable */
                font-size: 1.05rem;
                padding: 0 8px;
                border-radius: 8px;
                border: 1px solid rgba(255, 255, 255, 0.04);
                background: linear-gradient(
                    180deg,
                    rgba(255, 255, 255, 0.02),
                    rgba(0, 0, 0, 0.03)
                );
                box-shadow: 0 6px 12px rgba(0, 0, 0, 0.35),
                    inset 0 -2px 0 rgba(255, 255, 255, 0.02);
                cursor: pointer;
                transition: transform 60ms ease, box-shadow 60ms ease,
                    background 60ms ease;
                box-sizing: border-box; /* prevent padding from causing overflow */
                white-space: nowrap; /* prevent label wrapping */
                overflow: hidden; /* ensure text doesn't wrap and will be ellipsed */
                text-overflow: ellipsis;
            }
            #window-calculator #win-calc > .keyb > .b:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 18px rgba(0, 0, 0, 0.42),
                    inset 0 -2px 0 rgba(255, 255, 255, 0.02);
            }
            #window-calculator #win-calc > .keyb > .b:active {
                transform: translateY(0);
                box-shadow: 0 3px 8px rgba(0, 0, 0, 0.25),
                    inset 0 -1px 0 rgba(255, 255, 255, 0.01);
            }
            #window-calculator #win-calc > .keyb > .b:focus {
                outline: none;
                box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.12);
            }
            #window-calculator #win-calc > .keyb > .b {
                user-select: none;
                -webkit-user-select: none;
                -webkit-tap-highlight-color: transparent;
            }

            /* Make special function keys visually distinct */
            #window-calculator #win-calc > .keyb > .b.u {
                background: linear-gradient(
                    180deg,
                    rgba(0, 212, 255, 0.06),
                    rgba(0, 212, 255, 0.02)
                );
            }
            #window-calculator #win-calc > .keyb > .b.ans {
                background-image: linear-gradient(
                    120deg,
                    var(--theme-1),
                    var(--theme-2)
                );
                color: #fff;
                border: none;
            }

            /* 9. 右鍵選單 */
            #context-menu {
                position: absolute; /* 修改 */
                width: 200px;
                background: var(--mica-bg-dark);
                backdrop-filter: blur(var(--mica-blur)) saturate(180%);
                border: 1px solid rgba(255, 255, 255, 0.15);
                border-radius: 6px;
                padding: 5px;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);

                opacity: 0;
                visibility: hidden;
                transform: scale(0.95);
                transition: opacity 0.1s ease, transform 0.1s ease;
                z-index: var(--z-context-menu);
            }
            #context-menu.show {
                opacity: 1;
                visibility: visible;
                transform: scale(1);
            }
            .context-menu-item {
                display: flex;
                align-items: center;
                padding: 8px 12px;
                font-size: 0.9rem;
                border-radius: 4px;
                cursor: pointer;
            }
            .context-menu-item:hover {
                background: rgba(0, 212, 255, 0.2);
            }
            .context-menu-item i {
                width: 25px;
                text-align: center;
                margin-right: 8px;
                font-size: 0.9rem;
            }
            .context-menu-separator {
                height: 1px;
                background: rgba(255, 255, 255, 0.1);
                margin: 5px 0;
            }

            /* Start-menu-specific context menu */
            #start-context-menu {
                position: absolute;
                width: 220px;
                background: var(--mica-bg-dark);
                backdrop-filter: blur(var(--mica-blur)) saturate(180%);
                border: 1px solid rgba(255, 255, 255, 0.15);
                border-radius: 6px;
                padding: 5px;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
                opacity: 0;
                visibility: hidden;
                transform: scale(0.95);
                transition: opacity 0.1s ease, transform 0.1s ease,
                    visibility 0.1s ease;
                z-index: var(--z-context-menu); /* higher than start menu */
                pointer-events: auto;
            }
            #start-context-menu.show {
                opacity: 1;
                visibility: visible;
                transform: scale(1);
            }

            /* --- Personalization styles (taskbar, fonts, background preview) --- */
            :root {
                --font-scale: 1;
            }
            html {
                font-size: calc(16px * var(--font-scale));
            }
            /* Taskbar positions */
            #taskbar.center {
                justify-content: center;
            }
            #taskbar.left {
                justify-content: flex-start;
            }
            #taskbar.right {
                justify-content: flex-end;
            }
            /* Autohide (hidden state) */
            .taskbar-autohide {
                transition: transform 0.18s ease;
            }
            .taskbar-autohide.taskbar-hidden {
                transform: translateY(100%);
            }
            /* Accent color preview (used by a small swatch if needed) */
            .accent-swatch {
                width: 18px;
                height: 18px;
                border-radius: 4px;
                border: 1px solid rgba(255, 255, 255, 0.06);
                display: inline-block;
            }
            /* Thumbnail styling for background images */
            .bg-thumb {
                box-sizing: border-box;
                overflow: hidden;
                width: 160px;
                height: 90px;
                border-radius: 6px;
                border: 1px solid rgba(255, 255, 255, 0.06);
                cursor: pointer;
            }
            .bg-thumb:hover {
                outline: 2px solid rgba(255, 255, 255, 0.06);
                transform: scale(1.02);
                transition: transform 120ms ease, outline 120ms ease;
            }
            /* Small preview video inside bgPreview */
            #personalization_bgPreview {
                position: relative;
                overflow: hidden;
            }
            #personalization_bgPreview video.bg-preview-video {
                position: absolute;
                inset: 0;
                width: 100%;
                height: 100%;
                object-fit: cover;
                border-radius: 6px;
                display: block;
            }
            /* Ensure favorites/toolbar scale with font scale variable where needed */
            .settings-panel,
            .window,
            .start-menu,
            .taskbar,
            .desktop-icon {
                font-size: inherit;
            }
            /* About page styles */
            .about-header {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }
            /* Place the header logo to the right of text on wider screens. Stack vertically on small screens. */
            .about-header .about-logo {
                width: 56px;
                height: 56px;
                border-radius: 8px;
                object-fit: cover;
                margin-left: 12px;
                flex: 0 0 auto;
            }
            @media (max-width: 640px) {
                .about-header > div {
                    display: flex;
                    flex-direction: column;
                    gap: 8px;
                    align-items: flex-start;
                }
                .about-header .about-logo {
                    margin-left: 0;
                    margin-top: 8px;
                    align-self: flex-start;
                }
            }
            .about-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 12px;
                margin-top: 10px;
            }
            .about-item {
                background: var(--card);
                padding: 12px;
                border-radius: 8px;
                border: 1px solid rgba(255, 255, 255, 0.04);
            }
            .about-item h4 {
                margin: 0 0 8px 0;
                color: var(--primary-cyan);
                font-family: var(--font-body);
            }
            .about-item-row {
                color: #ccc;
                margin: 4px 0;
                font-size: 0.9rem;
            }
            .about-actions {
                margin-top: 14px;
                display: flex;
                align-items: center;
                gap: 10px;
                flex-wrap: wrap;
            }
            .btn {
                padding: 8px 12px;
                border-radius: 8px;
                background: rgba(255, 255, 255, 0.02);
                border: 1px solid rgba(255, 255, 255, 0.04);
                color: #fff;
                cursor: pointer;
            }
            .btn:hover {
                background: rgba(255, 255, 255, 0.04);
            }
            /* Update page styles */
            .update-item {
                background: var(--card);
                padding: 12px;
                border-radius: 8px;
                border: 1px solid rgba(255, 255, 255, 0.04);
            }
            .update-controls .btn {
                min-width: 120px;
            }
            #update-release-notes {
                white-space: pre-wrap;
                font-family: var(--font-ui);
            }
            /* Rectangular buttons for update actions (override global .btn parallelogram style) */
            .btn-rect,
            #update-check-btn,
            #update-open-release-btn {
                clip-path: none !important;
                border-radius: 8px !important;
                background: transparent !important;
                border: 2px solid rgba(0, 212, 255, 0.12) !important;
                color: var(--primary-cyan) !important;
                text-transform: uppercase !important;
                font-family: var(--font-display) !important;
                font-weight: 600 !important;
                letter-spacing: 1px !important;
                padding: 8px 14px !important;
                box-shadow: 0 1px 4px rgba(0, 0, 0, 0.45) !important;
                transition: all 160ms ease !important;
                min-width: 120px; /* keep button width inline with update controls */
            }
            .btn-rect::before,
            #update-check-btn::before,
            #update-open-release-btn::before {
                left: -100%;
            }
            .btn-rect:hover,
            #update-check-btn:hover,
            #update-open-release-btn:hover {
                background: linear-gradient(
                    90deg,
                    rgba(0, 212, 255, 0.06),
                    rgba(255, 0, 128, 0.03)
                ) !important;
                border-color: var(--primary-cyan) !important;
                color: #fff !important;
                box-shadow: 0 8px 28px rgba(0, 212, 255, 0.12) !important;
                transform: translateY(-2px) !important;
            }
            .btn-rect:focus,
            #update-check-btn:focus,
            #update-open-release-btn:focus {
                outline: none;
                box-shadow: 0 0 0 4px rgba(0, 212, 255, 0.08) !important;
            }
            .btn-rect:disabled,
            #update-open-release-btn:disabled {
                opacity: 0.55;
                cursor: not-allowed;
                transform: none !important;
                box-shadow: none !important;
            }
            /* --- 動畫 --- */
            @keyframes spin {
                from {
                    transform: rotate(0deg);
                }
                to {
                    transform: rotate(360deg);
                }
            }
            @keyframes pulse {
                0%,
                100% {
                    opacity: 1;
                    color: var(--primary-cyan);
                }
                50% {
                    opacity: 0.7;
                    color: var(--accent-cyan);
                }
            }
            @keyframes shine {
                0% {
                    border-color: #111;
                }
                49% {
                    border-color: #111;
                }
                51% {
                    border-color: transparent;
                }
                98% {
                    border-color: transparent;
                }
                100% {
                    border-color: #111;
                }
            }

            /* Core calc layout */
            #win-calc {
                display: flex;
                flex-direction: column;
                padding: 5px;
            }
            #calc-input {
                border: none;
                border-right: 2px solid transparent;
                outline: none;
                background-color: transparent;
                font-size: 35px;
                text-align: end;
                color: var(--text);
                width: 100%;
            }
            #win-calc > .container {
                height: 90px;
                display: flex;
                align-items: center;
            }
            #calc-input:focus {
                border-color: #111;
                animation-name: shine;
                animation-duration: 1s;
                animation-iteration-count: infinite;
            }

            /* Key grid + button appearance */
            #win-calc > .keyb {
                flex-grow: 1;
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                grid-template-rows: repeat(5, minmax(48px, 1fr));
                gap: 6px;
            }
            #win-calc > .keyb > .b {
                height: auto;
                min-height: 48px;
                font-size: 1.05rem;
                text-align: center;
                transition: transform 60ms ease, box-shadow 60ms ease,
                    background 60ms ease;
                border-radius: 8px;
                border: 1px solid rgba(255, 255, 255, 0.04);
                background: linear-gradient(
                    180deg,
                    rgba(255, 255, 255, 0.02),
                    rgba(0, 0, 0, 0.03)
                );
                box-shadow: 0 6px 12px rgba(0, 0, 0, 0.35),
                    inset 0 -2px 0 rgba(255, 255, 255, 0.02);
                padding: 0 8px;
            }
            #win-calc > .keyb > .b:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 18px rgba(0, 0, 0, 0.42),
                    inset 0 -2px 0 rgba(255, 255, 255, 0.02);
            }
            #win-calc > .keyb > .b:active {
                transform: translateY(0);
                box-shadow: 0 3px 8px rgba(0, 0, 0, 0.25),
                    inset 0 -1px 0 rgba(255, 255, 255, 0.01);
            }
            #win-calc > .keyb > .b.ans {
                background-image: linear-gradient(
                    120deg,
                    var(--theme-1),
                    var(--theme-2)
                );
                color: #fff;
                border: none;
            }
            #win-calc > .keyb > .b.u {
                padding-top: 5px;
            }
            #win-calc > .keyb > .b.checked {
                background-color: var(--mm) !important;
            }
            #win-calc > .keyb > span {
                width: auto;
                margin: 0;
                height: auto;
            }

            /* Make keypad accessible: clickable and keyboard focusable */
            #win-calc .b {
                cursor: pointer;
                user-select: none;
                -webkit-user-select: none;
                -webkit-tap-highlight-color: transparent;
            }

            /* ========== 記事本視窗樣式 ========== */
            .notepad-content {
                display: flex;
                flex-direction: column;
                height: 100%;
                padding: 0;
                overflow: hidden;
            }
            .notepad-toolbar {
                display: flex;
                align-items: center;
                gap: 4px;
                padding: 8px 12px;
                background: transparent;
                border-bottom: 1px solid rgba(255, 255, 255, 0.06);
                flex-shrink: 0;
            }
            .notepad-toolbar-group {
                display: flex;
                align-items: center;
                gap: 2px;
            }
            .notepad-toolbar-separator {
                width: 1px;
                height: 24px;
                background: rgba(255, 255, 255, 0.1);
                margin: 0 8px;
            }
            .notepad-btn {
                padding: 6px 10px;
                background: transparent;
                border: 1px solid transparent;
                border-radius: 4px;
                color: var(--text);
                cursor: pointer;
                transition: all 0.15s ease;
                font-size: 0.85rem;
                display: flex;
                align-items: center;
                gap: 6px;
            }
            .notepad-btn:hover {
                background: rgba(255, 255, 255, 0.08);
                border-color: rgba(255, 255, 255, 0.1);
            }
            .notepad-btn:active {
                background: rgba(255, 255, 255, 0.04);
                transform: scale(0.98);
            }
            .notepad-btn i {
                font-size: 0.9rem;
                opacity: 0.9;
            }
            .notepad-status {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 4px 12px;
                background: transparent;
                border-top: 1px solid rgba(255, 255, 255, 0.06);
                font-size: 0.75rem;
                color: rgba(255, 255, 255, 0.6);
                flex-shrink: 0;
            }
            .notepad-status-left,
            .notepad-status-right {
                display: flex;
                align-items: center;
                gap: 12px;
            }
            #win-notepad {
                overflow: hidden;
                padding: 0;
                flex: 1;
                display: flex;
                flex-direction: column;
            }
            #win-notepad > .text-box {
                border: none;
                background: transparent;
                outline: none;
                padding: 16px 20px;
                resize: none;
                font-size: 14px;
                line-height: 1.7;
                color: var(--text);
                width: 100%;
                flex: 1;
                transition: background 0.2s;
                overflow-y: auto;
                font-family: "Consolas", "Monaco", "Segoe UI", monospace;
            }
            #win-notepad > .text-box:focus {
                background: rgba(255, 255, 255, 0.02);
            }
            #win-notepad > .text-box p {
                margin: 0 0 8px 0;
            }
            [data-theme="light"] .notepad-toolbar {
                background: rgba(0, 0, 0, 0.03);
                border-bottom-color: rgba(0, 0, 0, 0.08);
            }
            [data-theme="light"] .notepad-btn {
                color: #333;
            }
            [data-theme="light"] .notepad-btn:hover {
                background: rgba(0, 0, 0, 0.06);
                border-color: rgba(0, 0, 0, 0.1);
            }
            [data-theme="light"] .notepad-status {
                background: rgba(0, 0, 0, 0.02);
                border-top-color: rgba(0, 0, 0, 0.06);
                color: rgba(0, 0, 0, 0.6);
            }

            /* ========== 終端機視窗樣式 ========== */
            #win-terminal {
                overflow-y: auto;
                overflow-x: hidden;
                padding: 20px;
                background: transparent;
                font-family: "Consolas", "Monaco", "Courier New", monospace;
                color: var(--text);
                font-size: 14px;
                line-height: 1.6;
            }
            #win-terminal > pre {
                color: var(--text);
                margin: 0 0 8px 0;
                font-family: "Consolas", "Monaco", monospace;
                user-select: text;
                white-space: pre-wrap;
            }
            #win-terminal .text-cmd {
                display: block;
                margin-bottom: 8px;
            }
            #win-terminal .prompt {
                color: var(--theme-1);
                font-weight: 700;
                white-space: nowrap;
                text-shadow: 0 0 10px rgba(0, 212, 255, 0.8);
            }
            #win-terminal *::selection {
                background: rgba(0, 212, 255, 0.3);
                color: var(--text);
            }

            /* ========== 相簿視窗樣式 (Metro 瀑布流風格) ========== */
            .photos-content {
                display: flex;
                flex-direction: column;
                height: 100%;
                padding: 0;
                overflow: hidden;
            }
            .photos-sidebar {
                width: 180px;
                flex-shrink: 0;
                background: transparent;
                border-right: 1px solid rgba(255, 255, 255, 0.06);
                padding: 12px 0;
                overflow-y: auto;
            }
            .photos-sidebar-item {
                display: flex;
                align-items: center;
                gap: 10px;
                padding: 10px 16px;
                color: var(--text);
                cursor: pointer;
                transition: all 0.15s;
                font-size: 0.85rem;
            }
            .photos-sidebar-item:hover {
                background: rgba(255, 255, 255, 0.06);
            }
            .photos-sidebar-item.active {
                background: rgba(0, 212, 255, 0.1);
                border-left: 3px solid var(--primary-cyan);
            }
            .photos-sidebar-item i {
                width: 18px;
                text-align: center;
                opacity: 0.8;
            }
            .photos-main {
                flex: 1;
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }
            .photos-toolbar {
                display: flex;
                align-items: center;
                gap: 6px;
                padding: 10px 16px;
                background: rgba(0, 0, 0, 0.1);
                border-bottom: 1px solid rgba(255, 255, 255, 0.06);
                flex-shrink: 0;
            }
            .photos-toolbar-group {
                display: flex;
                align-items: center;
                gap: 4px;
            }
            .photos-toolbar-separator {
                width: 1px;
                height: 24px;
                background: rgba(255, 255, 255, 0.1);
                margin: 0 8px;
            }
            .photos-btn {
                padding: 6px 12px;
                background: transparent;
                border: 1px solid transparent;
                border-radius: 4px;
                color: var(--text);
                cursor: pointer;
                transition: all 0.15s;
                font-size: 0.85rem;
                display: flex;
                align-items: center;
                gap: 6px;
            }
            .photos-btn:hover {
                background: rgba(255, 255, 255, 0.08);
                border-color: rgba(255, 255, 255, 0.1);
            }
            .photos-btn:active {
                transform: scale(0.98);
            }
            .photos-btn.active {
                background: rgba(0, 212, 255, 0.15);
                border-color: rgba(0, 212, 255, 0.3);
            }
            .photos-view-toggle {
                margin-left: auto;
                display: flex;
                gap: 4px;
            }
            .photos-grid-wrapper {
                flex: 1;
                overflow-y: auto;
                padding: 16px;
            }
            /* Masonry 瀑布流佈局 - JS 控制 */
            .photos-grid {
                position: relative;
                width: 100%;
                margin: 0 auto;
            }
            /* Masonry 磚塊風格照片項目 - 原始比例 */
            .photo-item {
                position: absolute;
                border-radius: 8px;
                overflow: hidden;
                cursor: grab;
                transition: top 0.4s cubic-bezier(0.25, 1, 0.5, 1),
                    left 0.4s cubic-bezier(0.25, 1, 0.5, 1),
                    transform 0.25s ease, box-shadow 0.25s ease,
                    opacity 0.2s ease;
                background: linear-gradient(
                    135deg,
                    rgba(20, 25, 40, 0.9),
                    rgba(30, 35, 50, 0.85)
                );
                border: 2px solid rgba(255, 255, 255, 0.08);
                user-select: none;
                -webkit-user-drag: element;
                width: 200px; /* JS will override this */
            }
            .photo-item img {
                pointer-events: none;
                -webkit-user-drag: none;
                user-select: none;
            }
            .photo-item * {
                user-select: none;
            }
            .photo-item::before {
                content: "";
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 2px;
                background: linear-gradient(
                    90deg,
                    transparent,
                    rgba(0, 212, 255, 0.5),
                    transparent
                );
                opacity: 0;
                transition: opacity 0.25s;
            }
            .photo-item:hover::before {
                opacity: 1;
            }
            .photo-item:hover {
                transform: translateY(-4px) scale(1.02);
                box-shadow: 0 12px 28px rgba(0, 212, 255, 0.3),
                    0 0 0 1px rgba(0, 212, 255, 0.2);
                border-color: rgba(0, 212, 255, 0.5);
                z-index: 10;
            }
            .photo-item:active {
                cursor: grabbing;
            }
            .photo-item.dragging {
                opacity: 0.6;
                transform: scale(1.05);
                box-shadow: 0 20px 40px rgba(0, 212, 255, 0.4),
                    0 0 0 2px rgba(0, 212, 255, 0.6);
                z-index: 1000;
                pointer-events: none;
            }
            .photo-item.drag-over {
                transform: scale(0.96);
                border-color: rgba(0, 212, 255, 0.8);
                box-shadow: 0 0 20px rgba(0, 212, 255, 0.4);
            }
            .photo-item.selected {
                border-color: var(--primary-cyan);
                box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.3);
            }
            /* 圖片保持原始比例 */
            .photo-item img {
                width: 100%;
                height: auto;
                display: block;
                transition: transform 0.3s ease;
            }
            .photo-item:hover img {
                transform: scale(1.03);
            }
            .photo-overlay {
                position: absolute;
                inset: 0;
                background: linear-gradient(
                    180deg,
                    transparent 50%,
                    rgba(0, 0, 0, 0.7) 100%
                );
                display: flex;
                flex-direction: column;
                justify-content: flex-end;
                align-items: stretch;
                opacity: 0;
                transition: opacity 0.2s;
                padding: 8px;
            }
            .photo-item:hover .photo-overlay {
                opacity: 1;
            }
            .photo-info {
                display: flex;
                align-items: center;
                justify-content: space-between;
            }
            .photo-name {
                font-size: 0.75rem;
                color: rgba(255, 255, 255, 0.9);
                text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                flex: 1;
            }
            .photo-actions {
                display: flex;
                gap: 4px;
            }
            .photo-action-btn {
                padding: 6px;
                background: rgba(0, 212, 255, 0.2);
                border: none;
                border-radius: 4px;
                color: #fff;
                cursor: pointer;
                font-size: 0.8rem;
                transition: all 0.15s;
            }
            .photo-action-btn:hover {
                background: rgba(0, 212, 255, 0.4);
                transform: scale(1.1);
            }
            /* 拖動占位符 */
            .photo-placeholder {
                border: 2px dashed rgba(0, 212, 255, 0.5);
                border-radius: 8px;
                background: rgba(0, 212, 255, 0.08);
                min-height: 100px;
                margin-bottom: 12px;
                break-inside: avoid;
            }
            /* 回應式調整 */
            @media (max-width: 800px) {
                .photos-grid {
                    column-count: 3;
                }
                .photos-grid.view-large {
                    column-count: 2;
                }
                .photos-grid.view-small {
                    column-count: 4;
                }
            }
            @media (max-width: 500px) {
                .photos-grid {
                    column-count: 2;
                }
                .photos-grid.view-large {
                    column-count: 1;
                }
                .photos-grid.view-small {
                    column-count: 3;
                }
            }
            /* 淺色模式 */
            [data-theme="light"] .photos-sidebar {
                background: rgba(0, 0, 0, 0.03);
                border-right-color: rgba(0, 0, 0, 0.08);
            }
            [data-theme="light"] .photos-sidebar-item {
                color: #333;
            }
            [data-theme="light"] .photos-sidebar-item:hover {
                background: rgba(0, 0, 0, 0.05);
            }
            [data-theme="light"] .photos-sidebar-item.active {
                background: rgba(0, 153, 204, 0.1);
            }

            /* ========== 播放器視窗樣式 ========== */
            .player-content {
                display: flex;
                flex-direction: column;
                padding: 0;
                overflow: hidden;
                height: 100%;
            }
            .player-video-container {
                position: relative;
                flex: 1;
                min-height: 0;
                background: #000;
                display: flex;
                align-items: center;
                justify-content: center;
                overflow: hidden;
            }
            .player-video {
                width: 100%;
                height: 100%;
                object-fit: contain;
                background: #000;
            }
            .player-overlay {
                position: absolute;
                inset: 0;
                background: transparent;
                display: flex;
                align-items: center;
                justify-content: center;
                pointer-events: none;
            }
            .player-overlay.hidden {
                display: none;
            }
            .player-message {
                text-align: center;
                color: rgba(255, 255, 255, 0.6);
            }
            .player-message i {
                font-size: 4rem;
                margin-bottom: 16px;
            }
            .player-message p {
                font-size: 1.2rem;
                margin: 0;
            }
            .player-controls {
                background: rgba(0, 0, 0, 0.4);
                padding: 12px;
                border-top: 1px solid rgba(255, 255, 255, 0.08);
                flex-shrink: 0;
            }
            .player-toolbar {
                display: flex;
                align-items: center;
                gap: 8px;
                margin-bottom: 8px;
            }
            .player-btn {
                padding: 8px 12px;
                background: rgba(255, 255, 255, 0.1);
                border: 1px solid rgba(255, 255, 255, 0.1);
                border-radius: 6px;
                color: var(--text);
                cursor: pointer;
                transition: all 0.2s;
                font-size: 0.9rem;
            }
            .player-btn:hover {
                background: rgba(255, 255, 255, 0.15);
            }
            .player-btn:active {
                transform: scale(0.95);
            }
            .player-volume-slider {
                width: 100px;
                margin: 0 8px;
            }
            .player-time {
                margin-left: auto;
                color: rgba(255, 255, 255, 0.8);
                font-size: 0.9rem;
                white-space: nowrap;
            }
            .player-progress {
                width: 100%;
            }
            .player-progress-bar {
                width: 100%;
                height: 6px;
                background: rgba(255, 255, 255, 0.1);
                border-radius: 3px;
                outline: none;
                cursor: pointer;
                -webkit-appearance: none;
                appearance: none;
            }
            .player-progress-bar::-webkit-slider-thumb {
                -webkit-appearance: none;
                appearance: none;
                width: 14px;
                height: 14px;
                background: #00d4ff;
                border-radius: 50%;
                cursor: pointer;
            }
            .player-progress-bar::-moz-range-thumb {
                width: 14px;
                height: 14px;
                background: #00d4ff;
                border-radius: 50%;
                cursor: pointer;
                border: none;
            }
            .player-volume-slider {
                -webkit-appearance: none;
                appearance: none;
                background: rgba(255, 255, 255, 0.1);
                border-radius: 3px;
                height: 6px;
                outline: none;
            }
            .player-volume-slider::-webkit-slider-thumb {
                -webkit-appearance: none;
                appearance: none;
                width: 12px;
                height: 12px;
                background: #00d4ff;
                border-radius: 50%;
                cursor: pointer;
            }
            .player-volume-slider::-moz-range-thumb {
                width: 12px;
                height: 12px;
                background: #00d4ff;
                border-radius: 50%;
                cursor: pointer;
                border: none;
            }

            /* 淺色模式適配 */
            [data-theme="light"] #win-notepad > .text-box {
                background-color: transparent;
                color: #333;
            }
            [data-theme="light"] #win-notepad > .text-box:focus {
                background: rgba(0, 0, 0, 0.02);
            }
            [data-theme="light"] #win-terminal {
                background: transparent;
                color: #333;
            }
            [data-theme="light"] #win-terminal > pre {
                color: #333;
            }
            [data-theme="light"] #win-terminal .prompt {
                color: #2196f3;
                text-shadow: 0 0 8px rgba(33, 150, 243, 0.4);
            }
            [data-theme="light"] .photos-toolbar,
            [data-theme="light"] .player-toolbar {
                background: rgba(0, 0, 0, 0.02);
                border-bottom-color: rgba(0, 0, 0, 0.06);
            }
            [data-theme="light"] .photos-btn,
            [data-theme="light"] .player-btn {
                background: rgba(0, 0, 0, 0.04);
                border-color: rgba(0, 0, 0, 0.06);
                color: #333;
            }
            [data-theme="light"] .photos-btn:hover,
            [data-theme="light"] .player-btn:hover {
                background: rgba(0, 0, 0, 0.08);
            }
            [data-theme="light"] .photo-item {
                background: rgba(0, 0, 0, 0.05);
            }
            [data-theme="light"] .player-controls {
                background: transparent;
                border-top-color: rgba(0, 0, 0, 0.06);
            }
            [data-theme="light"] .player-time {
                color: rgba(0, 0, 0, 0.8);
            }
        </style>
    </head>
    <body>
        <!-- 1. 頂部導航 (使用全域 Header) -->
        <header>
            <a href="../../index.html">
                <div
                    style="
                        margin-left: 30px;
                        font-family: 'Orbitron', sans-serif;
                    "
                >
                    『 AMANO SHIZUKI 』
                </div>
            </a>
            <div class="nav-container">
                <ul class="nav-links">
                    <div class="nav-header">
                        <h2 class="nav-title">選單導航</h2>
                    </div>

                    <div class="search-box">
                        <input
                            type="text"
                            id="navSearch"
                            class="search-input"
                            placeholder="搜尋頁面..."
                        />
                        <button class="search-btn" aria-label="Search">
                            <svg
                                width="18"
                                height="18"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                            >
                                <circle cx="11" cy="11" r="8"></circle>
                                <path d="m21 21-4.35-4.35"></path>
                            </svg>
                        </button>
                    </div>

                    <div class="nav-section">
                        <h3 class="nav-section-title">主要頁面</h3>
                        <li>
                            <a href="../../pages/about.html" class="active"
                                >◆ ABOUT</a
                            >
                        </li>
                        <li>
                            <a href="../../pages/experience.html"
                                >◆ EXPERIENCE</a
                            >
                        </li>
                        <li><a href="../../pages/skills.html">◆ SKILLS</a></li>
                        <li>
                            <a href="../../pages/contact.html">◆ CONTACT</a>
                        </li>
                    </div>

                    <div class="nav-section">
                        <h3 class="nav-section-title">特別內容</h3>
                        <li>
                            <a href="../game-center/game-center.html"
                                >◆ GAME CENTER</a
                            >
                        </li>
                        <li>
                            <a href="nagato-sakura-webos.html" class="active"
                                >◆ WEB OS</a
                            >
                        </li>
                    </div>

                    <div class="nav-section">
                        <h3 class="nav-section-title">更多連結</h3>
                        <li>
                            <a
                                href="https://www.youtube.com/@Amano_Shizuki_Kun"
                                target="_blank"
                                rel="noopener noreferrer"
                                class="social-link"
                            >
                                <svg
                                    width="20"
                                    height="20"
                                    viewBox="0 0 24 24"
                                    fill="currentColor"
                                    style="
                                        margin-right: 8px;
                                        vertical-align: middle;
                                    "
                                >
                                    <path
                                        d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"
                                    />
                                </svg>
                                YouTube
                            </a>
                        </li>
                        <li>
                            <a
                                href="https://github.com/AmanoShizukikun"
                                target="_blank"
                                rel="noopener noreferrer"
                                class="social-link"
                            >
                                <svg
                                    width="20"
                                    height="20"
                                    viewBox="0 0 24 24"
                                    fill="currentColor"
                                    style="
                                        margin-right: 8px;
                                        vertical-align: middle;
                                    "
                                >
                                    <path
                                        d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"
                                    />
                                </svg>
                                GitHub
                            </a>
                        </li>
                        <li>
                            <a
                                href="https://discord.gg/jac8eAFzjz"
                                target="_blank"
                                rel="noopener noreferrer"
                                class="social-link"
                            >
                                <svg
                                    width="20"
                                    height="20"
                                    viewBox="0 0 24 24"
                                    fill="currentColor"
                                    style="
                                        margin-right: 8px;
                                        vertical-align: middle;
                                    "
                                >
                                    <path
                                        d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028c.462-.63.874-1.295 1.226-1.994a.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"
                                    />
                                </svg>
                                Discord
                            </a>
                        </li>
                        <li>
                            <a
                                href="mailto:3b017128@gm.student.ncut.edu.tw"
                                class="social-link"
                            >
                                <svg
                                    width="20"
                                    height="20"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                    style="
                                        margin-right: 8px;
                                        vertical-align: middle;
                                    "
                                >
                                    <path
                                        d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"
                                    ></path>
                                    <polyline
                                        points="22,6 12,13 2,6"
                                    ></polyline>
                                </svg>
                                Email
                            </a>
                        </li>
                    </div>
                </ul>
            </div>
            <div class="header-actions">
                <button class="settings-toggle" aria-label="Settings"></button>
                <button class="menu-toggle" aria-label="Toggle menu">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
        </header>

        <!-- 2. 主內容包裝器 (來自 win.html) -->
        <div class="main-wrapper">
            <!-- 3. 模擬器容器 (取代 main-content) -->
            <main class="simulator-container" id="simulator-container-main">
                <!-- Nightlight overlay: warm color overlay applied when nightlight enabled -->
                <div id="nightlight-overlay" aria-hidden="true"></div>
                <!-- Desktop background layer for independent wallpaper brightness & effects -->
                <div id="desktop-bg" aria-hidden="true"></div>
                <!-- Video background element (hidden until a video is set). autoplay muted to allow auto-play in most browsers -->
                <video
                    id="desktop-video"
                    aria-hidden="true"
                    muted
                    loop
                    playsinline
                    preload="metadata"
                    style="display: none"
                ></video>
                <!-- Overlay used to dim background or apply extra overlay over both image & video backgrounds -->
                <div id="desktop-overlay" aria-hidden="true"></div>

                <!-- 模擬器內容 (來自 win_improved.html) -->

                <!-- 1. 現代化啟動加載器 -->
                <div id="boot-loader">
                    <!-- 背景效果層 -->
                    <div class="boot-grid-bg"></div>
                    <div class="boot-particles" id="bootParticles"></div>

                    <div class="boot-rings">
                        <div class="boot-ring"></div>
                        <div class="boot-ring"></div>
                        <div class="boot-ring"></div>
                        <div class="boot-ring"></div>
                    </div>

                    <!-- 主要內容 -->
                    <div class="boot-content">
                        <div class="boot-logo-container">
                            <div class="boot-logo-ring"></div>
                            <img
                                id="boot-logo"
                                src="../../assets/images/logo.png"
                                alt="Logo"
                            />
                        </div>

                        <div class="boot-system-name">NAGATO SAKURA</div>
                        <div class="boot-system-version">WEB OS v1.0</div>

                        <div class="boot-progress-container">
                            <div class="boot-progress-bar">
                                <div
                                    class="boot-progress-fill"
                                    id="bootProgressFill"
                                ></div>
                            </div>
                            <div class="boot-progress-text">
                                <span id="bootProgressLabel"
                                    >初始化系統...</span
                                >
                                <span
                                    class="boot-progress-percent"
                                    id="bootProgressPercent"
                                    >0%</span
                                >
                            </div>
                        </div>
                    </div>

                    <div class="boot-footer">© 2025 天野靜樹 - CYBER NEXUS</div>
                </div>

                <!-- start 的右鍵選單（開始設定） -->
                <div id="start-context-menu">
                    <div class="context-menu-item" id="start-menu-settings">
                        <i class="fa-solid fa-cog"></i> 開始設定
                    </div>
                </div>

                <!-- 2. 桌面 -->
                <div id="desktop">
                    <!-- 桌面圖示 -->
                    <div class="desktop-icon" data-app="settings">
                        <i class="fa-solid fa-gear icon-settings"></i>
                        <span>設定</span>
                    </div>
                    <div class="desktop-icon" data-app="nagato">
                        <img
                            src="assets/apps/icon/NS-V2.png"
                            alt="長門櫻"
                            class="app-icon-img icon-nagato"
                            loading="lazy"
                        />
                        <span>長門櫻</span>
                    </div>
                    <div class="desktop-icon" data-app="explorer">
                        <i class="fa-solid fa-folder icon-explorer"></i>
                        <span>檔案總管</span>
                    </div>
                    <div class="desktop-icon" data-app="browser">
                        <i class="fa-brands fa-edge icon-edge"></i>
                        <span>瀏覽器</span>
                    </div>
                    <div class="desktop-icon" data-app="store">
                        <i class="fa-solid fa-store icon-store"></i>
                        <span>應用商店</span>
                    </div>
                    <!-- 格子指示器 -->
                    <div
                        class="desktop-grid-indicator"
                        style="display: none"
                    ></div>
                </div>

                <!-- 桌面右鍵選單 -->
                <div class="desktop-context-menu" id="desktop-context-menu">
                    <div class="desktop-context-menu-item has-submenu">
                        <i class="fa-solid fa-arrow-down-a-z"></i> 排序方式
                        <div class="desktop-context-submenu">
                            <div
                                class="desktop-context-submenu-item"
                                data-sort="name"
                            >
                                名稱
                            </div>
                            <div
                                class="desktop-context-submenu-item"
                                data-sort="custom"
                            >
                                自訂
                            </div>
                        </div>
                    </div>
                    <div class="desktop-context-menu-divider"></div>
                    <div class="desktop-context-menu-item" id="desktop-refresh">
                        <i class="fa-solid fa-rotate"></i> 重新整理
                    </div>
                    <div
                        class="desktop-context-menu-item"
                        id="desktop-align-grid"
                    >
                        <i class="fa-solid fa-border-all"></i> 對齊格線
                    </div>
                </div>

                <!-- 3. 任務欄 -->
                <div id="taskbar">
                    <div class="taskbar-group left">
                        <!-- 小工具按鈕 -->
                        <div
                            class="taskbar-icon"
                            id="widgets-button"
                            title="小工具"
                        >
                            <i class="fa-solid fa-table-cells-large"></i>
                        </div>
                    </div>

                    <div class="taskbar-group center">
                        <!-- 開始按鈕 -->
                        <div
                            class="taskbar-icon"
                            id="start-button"
                            title="開始"
                        >
                            <img
                                src="../../assets/images/logo.png"
                                alt="開始"
                                class="app-icon-img"
                                loading="lazy"
                            />
                        </div>
                        <!-- 搜尋 -->
                        <div
                            class="taskbar-icon"
                            id="search-button"
                            title="搜尋"
                        >
                            <i class="fa-solid fa-magnifying-glass"></i>
                        </div>

                        <!-- 任務圖示 (動態) -->

                        <div
                            class="taskbar-icon"
                            id="taskbar-icon-nagato"
                            data-app="nagato"
                            data-pinned="true"
                            title="長門櫻"
                            role="button"
                            tabindex="0"
                            aria-pressed="false"
                        >
                            <img
                                src="assets/apps/icon/NS-V2.png"
                                alt="長門櫻"
                                class="app-icon-img"
                                loading="lazy"
                            />
                        </div>
                        <div
                            class="taskbar-icon"
                            id="taskbar-icon-explorer"
                            data-app="explorer"
                            data-pinned="true"
                            title="檔案總管"
                            role="button"
                            tabindex="0"
                            aria-pressed="false"
                        >
                            <i class="fa-solid fa-folder icon-explorer"></i>
                        </div>
                        <div
                            class="taskbar-icon"
                            id="taskbar-icon-browser"
                            data-app="browser"
                            data-pinned="true"
                            title="瀏覽器"
                            role="button"
                            tabindex="0"
                            aria-pressed="false"
                        >
                            <i class="fa-brands fa-edge icon-edge"></i>
                        </div>
                        <div
                            class="taskbar-icon"
                            id="taskbar-icon-store"
                            data-app="store"
                            data-pinned="true"
                            title="應用商店"
                            role="button"
                            tabindex="0"
                            aria-pressed="false"
                        >
                            <i class="fa-solid fa-store icon-store"></i>
                        </div>
                    </div>

                    <div class="taskbar-group right">
                        <!-- 時間日期 -->
                        <div id="taskbar-time">
                            <div id="time">
                                <span class="ampm">午前</span
                                ><span class="time-value">00:00</span>
                            </div>
                            <div id="date">YYYY/MM/DD</div>
                        </div>
                    </div>
                </div>

                <!-- 4. 開始功能表 -->
                <div id="start-menu">
                    <div class="start-menu-header">
                        <div class="search-bar">
                            <i class="fa-solid fa-magnifying-glass"></i>
                            <input
                                type="text"
                                placeholder="在這裡搜尋應用程式、設定和文件"
                            />
                        </div>
                    </div>

                    <div class="start-menu-body">
                        <div class="start-section-title">已釘選</div>
                        <div class="pinned-apps">
                            <div class="app-icon" data-app="settings">
                                <i class="fa-solid fa-gear icon-settings"></i>
                                <span>設定</span>
                            </div>
                            <div class="app-icon" data-app="nagato">
                                <img
                                    src="assets/apps/icon/NS-V2.png"
                                    alt="長門櫻"
                                    class="app-icon-img"
                                    loading="lazy"
                                />
                                <span>長門櫻</span>
                            </div>
                            <div class="app-icon" data-app="explorer">
                                <i class="fa-solid fa-folder icon-explorer"></i>
                                <span>檔案總管</span>
                            </div>
                            <div class="app-icon" data-app="browser">
                                <i class="fa-brands fa-edge icon-edge"></i>
                                <span>瀏覽器</span>
                            </div>
                            <div class="app-icon" data-app="store">
                                <i class="fa-solid fa-store icon-store"></i>
                                <span>商店</span>
                            </div>
                            <div class="app-icon" data-app="calculator">
                                <i
                                    class="fa-solid fa-calculator icon-calculator"
                                ></i>
                                <span>計算機</span>
                            </div>
                            <div class="app-icon" data-app="notepad">
                                <i
                                    class="fa-solid fa-file-lines icon-notepad"
                                ></i>
                                <span>記事本</span>
                            </div>
                            <div class="app-icon" data-app="terminal">
                                <i
                                    class="fa-solid fa-terminal icon-terminal"
                                ></i>
                                <span>終端機</span>
                            </div>
                            <div class="app-icon" data-app="photos">
                                <i class="fa-solid fa-image icon-photos"></i>
                                <span>相簿</span>
                            </div>
                            <div class="app-icon" data-app="player">
                                <i
                                    class="fa-solid fa-circle-play icon-player"
                                ></i>
                                <span>播放器</span>
                            </div>
                        </div>

                        <div class="start-section-title">建議</div>
                        <div class="recommended-list">
                            <div class="recommended-item">
                                <i
                                    class="fa-solid fa-file-word"
                                    style="color: #2b579a"
                                ></i>
                                <div class="recommended-item-info">
                                    專案報告.docx
                                    <span>15 分鐘前</span>
                                </div>
                            </div>
                            <div class="recommended-item">
                                <i
                                    class="fa-solid fa-image"
                                    style="color: #e81123"
                                ></i>
                                <div class="recommended-item-info">
                                    設計原型.png
                                    <span>1 小時前</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="start-menu-footer">
                        <div class="user-profile">
                            <img
                                src="../../assets/images/avatar.jpg"
                                alt="天野靜樹"
                                class="avatar"
                                width="36"
                                height="36"
                                loading="lazy"
                            />
                            <span>天野靜樹</span>
                        </div>
                        <div class="power-button" title="電源">
                            <i class="fa-solid fa-power-off"></i>
                        </div>
                    </div>
                </div>

                <!-- 5. 視窗 (多個) -->

                <!-- 5.1 設定視窗 -->
                <div class="window" id="window-settings" data-app="settings">
                    <!-- 調整大小 Handles -->
                    <div class="resize-handle n"></div>
                    <div class="resize-handle s"></div>
                    <div class="resize-handle e"></div>
                    <div class="resize-handle w"></div>
                    <div class="resize-handle nw"></div>
                    <div class="resize-handle ne"></div>
                    <div class="resize-handle sw"></div>
                    <div class="resize-handle se"></div>

                    <div class="window-header">
                        <div class="window-title">
                            <i class="fa-solid fa-gear icon-settings"></i>
                            <span>設定</span>
                        </div>
                        <div class="window-controls">
                            <div
                                class="window-control-btn minimize"
                                title="最小化"
                            >
                                <i class="fa-solid fa-minus"></i>
                            </div>
                            <div
                                class="window-control-btn maximize"
                                title="最大化"
                            >
                                <i class="fa-regular fa-square"></i>
                                <!-- 貼齊佈局 (新增) -->
                                <div class="snap-layouts">
                                    <div
                                        class="snap-layout-option"
                                        title="左上角"
                                    ></div>
                                    <div
                                        class="snap-layout-option"
                                        title="右上角"
                                    ></div>
                                    <div
                                        class="snap-layout-option"
                                        title="左下角"
                                    ></div>
                                    <div
                                        class="snap-layout-option"
                                        title="右下角"
                                    ></div>
                                </div>
                            </div>
                            <div class="window-control-btn close" title="關閉">
                                <i class="fa-solid fa-xmark"></i>
                            </div>
                        </div>
                    </div>
                    <div class="window-content settings-content">
                        <div class="settings-sidebar">
                            <div
                                class="settings-menu-item active"
                                data-page="page-display"
                                role="button"
                                tabindex="0"
                            >
                                <i class="fa-solid fa-display"></i> 顯示
                            </div>
                            <div
                                class="settings-menu-item"
                                data-page="page-personalization"
                                role="button"
                                tabindex="0"
                            >
                                <i class="fa-solid fa-palette"></i> 個人化
                            </div>
                            <div
                                class="settings-menu-item"
                                data-page="page-network"
                                role="button"
                                tabindex="0"
                            >
                                <i class="fa-solid fa-wifi"></i> 網路
                            </div>
                            <div
                                class="settings-menu-item"
                                data-page="page-privacy"
                                role="button"
                                tabindex="0"
                            >
                                <i class="fa-solid fa-shield-halved"></i> 隱私權
                            </div>
                            <div
                                class="settings-menu-item"
                                data-page="page-about"
                                role="button"
                                tabindex="0"
                            >
                                <i class="fa-solid fa-circle-info"></i> 關於
                            </div>
                            <div
                                class="settings-menu-item"
                                data-page="page-update"
                                role="button"
                                tabindex="0"
                            >
                                <i
                                    class="fa-solid fa-arrow-up-right-from-square"
                                ></i>
                                更新
                            </div>
                        </div>
                        <div class="settings-main">
                            <!-- Page: Display -->
                            <div id="page-display" class="settings-page">
                                <div class="setting-section">
                                    <h3>顯示</h3>
                                    <div class="setting-item">
                                        <div class="setting-item-label">
                                            亮度
                                            <span>調整內建顯示器的亮度</span>
                                        </div>
                                        <div class="slider-control">
                                            <div
                                                class="slider-value"
                                                id="brightnessValue"
                                            >
                                                70%
                                            </div>
                                            <input
                                                type="range"
                                                class="slider-range"
                                                id="displayBrightness"
                                                min="0"
                                                max="100"
                                                value="70"
                                                step="1"
                                                aria-label="顯示亮度"
                                            />
                                        </div>
                                    </div>
                                    <div
                                        class="setting-item"
                                        id="nightlightItem"
                                        role="button"
                                        tabindex="0"
                                        aria-pressed="false"
                                    >
                                        <div class="setting-item-label">
                                            夜間光線
                                            <span
                                                >使用較暖的色彩以協助睡眠</span
                                            >
                                        </div>
                                        <div
                                            class="toggle-switch"
                                            id="nightLightToggle"
                                            role="switch"
                                            aria-checked="false"
                                            tabindex="0"
                                        ></div>
                                    </div>
                                    <div class="setting-item">
                                        <div class="setting-item-label">
                                            視窗越界允許
                                            <span>視窗移出畫面的百分比</span>
                                        </div>
                                        <div class="slider-control">
                                            <div
                                                class="slider-value"
                                                id="offscreenRatioValue"
                                            >
                                                90%
                                            </div>
                                            <input
                                                type="range"
                                                class="slider-range"
                                                id="offscreenRatio"
                                                min="0"
                                                max="100"
                                                value="90"
                                                step="5"
                                                aria-label="視窗越界允許"
                                            />
                                        </div>
                                    </div>
                                    <div class="setting-item">
                                        <div class="setting-item-label">
                                            隱藏導航欄
                                            <span
                                                >隱藏頁面頂部的導航欄以獲得更大的顯示空間</span
                                            >
                                        </div>
                                        <div
                                            class="toggle-switch"
                                            id="hideNavbarToggle"
                                            role="switch"
                                            aria-checked="false"
                                            tabindex="0"
                                        ></div>
                                    </div>
                                </div>
                                <!-- Nightlight subpage: hidden by default (inside Display page) -->
                                <div
                                    id="nightlight-settings"
                                    class="settings-subpage"
                                    style="display: none"
                                >
                                    <div
                                        style="
                                            display: flex;
                                            align-items: center;
                                            gap: 12px;
                                            margin-bottom: 10px;
                                        "
                                    >
                                        <button
                                            id="nightlight-back"
                                            style="
                                                padding: 6px 8px;
                                                background: transparent;
                                                border: 1px solid
                                                    rgba(255, 255, 255, 0.06);
                                                color: #f0f0f0;
                                                border-radius: 6px;
                                            "
                                        >
                                            ← 返回
                                        </button>
                                        <h3 style="margin: 0">夜間光線設定</h3>
                                    </div>

                                    <div class="setting-item">
                                        <div class="setting-item-label">
                                            開關
                                            <span>在此啟用或停用夜間光線</span>
                                        </div>
                                        <div
                                            class="toggle-switch"
                                            id="nightlightSubToggle"
                                            role="switch"
                                            aria-checked="false"
                                            tabindex="0"
                                        ></div>
                                    </div>

                                    <div class="setting-item">
                                        <div class="setting-item-label">
                                            強度
                                            <span>調整夜間光線強度</span>
                                        </div>
                                        <div class="slider-control">
                                            <div
                                                class="slider-value"
                                                id="nightlightStrengthValue"
                                            >
                                                50%
                                            </div>
                                            <input
                                                type="range"
                                                class="slider-range"
                                                id="nightlightStrength"
                                                min="0"
                                                max="100"
                                                value="50"
                                                step="1"
                                                aria-label="夜間光線強度"
                                            />
                                        </div>
                                    </div>

                                    <div class="setting-item">
                                        <div class="setting-item-label">
                                            排程
                                            <span
                                                >設定自動開啟夜間光線的時間區間</span
                                            >
                                        </div>
                                        <div
                                            style="
                                                display: flex;
                                                align-items: center;
                                                gap: 8px;
                                            "
                                        >
                                            <div
                                                class="toggle-switch"
                                                id="nightlightScheduleToggle"
                                                role="switch"
                                                aria-checked="false"
                                                tabindex="0"
                                            ></div>
                                        </div>
                                    </div>

                                    <div
                                        id="nightlight-schedule-controls"
                                        style="display: none; margin-top: 6px"
                                    >
                                        <div class="setting-item">
                                            <div class="setting-item-label">
                                                開始時間
                                                <span
                                                    >選擇要開始啟用夜間光線的時間</span
                                                >
                                            </div>
                                            <input
                                                type="time"
                                                id="nightlightStart"
                                                value="22:00"
                                                aria-label="夜間光線開始時間"
                                            />
                                        </div>
                                        <div class="setting-item">
                                            <div class="setting-item-label">
                                                結束時間
                                                <span
                                                    >選擇結束夜間光線的時間</span
                                                >
                                            </div>
                                            <input
                                                type="time"
                                                id="nightlightEnd"
                                                value="06:00"
                                                aria-label="夜間光線結束時間"
                                            />
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Page: Personalization -->
                            <div
                                id="page-personalization"
                                class="settings-page"
                                style="display: none"
                            >
                                <div class="setting-section">
                                    <h3>個人化</h3>
                                    <div class="setting-item">
                                        <div class="setting-label">
                                            <span>主題</span>
                                            <span class="setting-description"
                                                >切換深色/淺色模式</span
                                            >
                                        </div>
                                        <div class="select-control">
                                            <select
                                                id="personalization_themeMode"
                                            >
                                                <option value="dark">
                                                    深色模式
                                                </option>
                                                <option value="light">
                                                    淺色模式
                                                </option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="setting-item">
                                        <div class="setting-label">
                                            <span>色彩 (強調色)</span>
                                            <span class="setting-description"
                                                >選擇系統主題色與強調色</span
                                            >
                                        </div>
                                        <div
                                            style="
                                                display: flex;
                                                gap: 8px;
                                                align-items: center;
                                            "
                                        >
                                            <input
                                                type="color"
                                                id="personalization_accentColor"
                                                aria-label="主題色"
                                            />
                                            <span
                                                class="accent-swatch"
                                                id="personalization_accentColor_preview"
                                            ></span>
                                        </div>
                                    </div>

                                    <!-- Background: details in subpage -->
                                    <div class="setting-item">
                                        <div class="setting-label">
                                            <span>背景</span>
                                            <span class="setting-description"
                                                >編輯桌面背景</span
                                            >
                                        </div>
                                        <div
                                            style="
                                                display: flex;
                                                gap: 8px;
                                                align-items: center;
                                            "
                                        >
                                            <div
                                                id="personalization_bgPreview"
                                                title="當前桌面背景預覽"
                                                style="
                                                    width: 56px;
                                                    height: 36px;
                                                    border-radius: 6px;
                                                    background: linear-gradient(
                                                        135deg,
                                                        #0f2027 0%,
                                                        #2c5364 100%
                                                    );
                                                    border: 1px solid
                                                        rgba(
                                                            255,
                                                            255,
                                                            255,
                                                            0.04
                                                        );
                                                "
                                            ></div>
                                        </div>
                                    </div>

                                    <!-- Background panel (moved to page bottom) -->

                                    <!-- Start menu: split into two single-control items -->
                                    <div class="setting-item">
                                        <div class="setting-label">
                                            <span>顯示建議</span>
                                            <span class="setting-description"
                                                >顯示開始功能表中的建議項目</span
                                            >
                                        </div>
                                        <div
                                            class="toggle-switch"
                                            id="personalization_startShowSuggested"
                                        ></div>
                                    </div>
                                    <div class="setting-item">
                                        <div class="setting-label">
                                            <span>顯示最近使用</span>
                                            <span class="setting-description"
                                                >顯示開始功能表中的最近使用項目</span
                                            >
                                        </div>
                                        <div
                                            class="toggle-switch"
                                            id="personalization_startShowRecent"
                                        ></div>
                                    </div>

                                    <!-- Taskbar: separate controls for position and icon size -->
                                    <div class="setting-item">
                                        <div class="setting-label">
                                            <span>工作列位置</span>
                                            <span class="setting-description"
                                                >設定工作列的位置（左右/置中）</span
                                            >
                                        </div>
                                        <div class="select-control">
                                            <select
                                                id="personalization_taskbarPosition"
                                            >
                                                <option value="center">
                                                    置中
                                                </option>
                                                <option value="left">
                                                    靠左
                                                </option>
                                                <option value="right">
                                                    靠右
                                                </option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="setting-item">
                                        <div class="setting-label">
                                            <span>工作列圖示大小</span>
                                            <span class="setting-description"
                                                >調整工作列圖示大小</span
                                            >
                                        </div>
                                        <div class="slider-control">
                                            <div
                                                class="slider-value"
                                                id="personalization_taskbarIconSizeValue"
                                            >
                                                24px
                                            </div>
                                            <input
                                                type="range"
                                                class="slider-range"
                                                id="personalization_taskbarIconSize"
                                                min="12"
                                                max="48"
                                                step="2"
                                                value="24"
                                                aria-label="工作列圖示大小"
                                            />
                                        </div>
                                    </div>

                                    <!-- Window Style: entry point to subpage -->
                                    <div
                                        class="setting-item"
                                        id="windowStyleItem"
                                        role="button"
                                        tabindex="0"
                                    >
                                        <div class="setting-label">
                                            <span>視窗效果</span>
                                            <span class="setting-description"
                                                >設定視窗透明度與背景風格</span
                                            >
                                        </div>
                                        <div
                                            class="toggle-switch"
                                            id="personalization_windowTransparent"
                                        ></div>
                                    </div>

                                    <!-- Fonts: split into font set and font scale -->
                                    <div class="setting-item">
                                        <div class="setting-label">
                                            <span>字型</span>
                                            <span class="setting-description"
                                                >選擇 UI 與文字字型</span
                                            >
                                        </div>
                                        <div class="select-control">
                                            <select
                                                id="personalization_fontSet"
                                            >
                                                <option value="default">
                                                    預設 (Orbitron / Rajdhani /
                                                    Noto Sans TC)
                                                </option>
                                                <option value="system">
                                                    系統字型
                                                </option>
                                                <option value="serif">
                                                    Serif
                                                </option>
                                                <option value="mono">
                                                    等寬字體
                                                </option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Personalization subpages (moved here to remain visible when main section is hidden) -->
                            <div
                                id="personalization_background_panel"
                                class="settings-subpage"
                                style="display: none; margin-top: 10px"
                            >
                                <div
                                    style="
                                        display: flex;
                                        align-items: center;
                                        gap: 12px;
                                        margin-bottom: 10px;
                                    "
                                >
                                    <button
                                        id="personalization_background_back"
                                        style="
                                            padding: 6px 8px;
                                            background: transparent;
                                            border: 1px solid
                                                rgba(255, 255, 255, 0.06);
                                            color: #f0f0f0;
                                            border-radius: 6px;
                                        "
                                    >
                                        ← 返回
                                    </button>
                                    <h3 style="margin: 0">背景設定</h3>
                                </div>
                                <div
                                    class="setting-item"
                                    style="margin-top: 6px"
                                    id="personalization_bg_brightness_item"
                                >
                                    <div class="setting-item-label">
                                        背景亮度
                                        <span>獨立調整桌面背景的亮度</span>
                                    </div>
                                    <div class="slider-control">
                                        <div
                                            class="slider-value"
                                            id="personalization_bgBrightnessValue"
                                        >
                                            100%
                                        </div>
                                        <input
                                            type="range"
                                            class="slider-range"
                                            id="personalization_bgBrightness"
                                            min="0"
                                            max="100"
                                            value="100"
                                            step="1"
                                            aria-label="背景亮度"
                                        />
                                    </div>
                                </div>
                                <div class="setting-item">
                                    <div class="setting-item-label">
                                        模式
                                        <span>選擇桌面背景類型</span>
                                    </div>
                                    <div class="select-control">
                                        <select
                                            id="personalization_backgroundMode"
                                            aria-label="背景模式"
                                        >
                                            <option value="default">
                                                預設
                                            </option>
                                            <option value="gradient">
                                                漸層
                                            </option>
                                            <option value="solid">單色</option>
                                            <option value="image">圖片</option>
                                            <option value="video">影片</option>
                                        </select>
                                    </div>
                                </div>
                                <!-- Solid color control -->
                                <div
                                    id="personalization_background_solid"
                                    class="setting-item"
                                    style="display: none"
                                >
                                    <div class="setting-item-label">
                                        顏色
                                        <span>選擇桌面單色背景</span>
                                    </div>
                                    <div
                                        style="
                                            display: flex;
                                            gap: 8px;
                                            align-items: center;
                                        "
                                    >
                                        <input
                                            type="color"
                                            id="personalization_bgColor"
                                            aria-label="背景顏色"
                                        />
                                    </div>
                                </div>

                                <!-- Gradient control -->
                                <div
                                    id="personalization_background_gradient"
                                    class="setting-item"
                                    style="display: none"
                                >
                                    <div class="setting-item-label">
                                        漸層
                                        <span
                                            >從起始顏色到結束顏色
                                            (線性漸層)</span
                                        >
                                    </div>
                                    <div
                                        style="
                                            display: flex;
                                            gap: 8px;
                                            align-items: center;
                                        "
                                    >
                                        <input
                                            type="color"
                                            id="personalization_bgGradient_start"
                                            aria-label="漸層起始顏色"
                                        />
                                        <input
                                            type="color"
                                            id="personalization_bgGradient_end"
                                            aria-label="漸層結束顏色"
                                        />
                                    </div>
                                </div>

                                <!-- Image control: 磁貼式大型設定項 -->
                                <div
                                    id="personalization_background_image"
                                    class="setting-item-large"
                                    style="display: none"
                                >
                                    <div class="setting-item-header">
                                        <div class="setting-item-label">
                                            圖片桌布
                                            <span
                                                >選擇預設圖片或上傳自訂圖片</span
                                            >
                                        </div>
                                        <div class="setting-item-controls">
                                            <input
                                                type="text"
                                                id="personalization_bgImageUrl"
                                                placeholder="圖片 URL"
                                                style="
                                                    width: 180px;
                                                    padding: 6px 10px;
                                                    border-radius: 6px;
                                                    background: rgba(
                                                        0,
                                                        0,
                                                        0,
                                                        0.2
                                                    );
                                                    border: 1px solid
                                                        rgba(255, 255, 255, 0.1);
                                                    color: #fff;
                                                    font-size: 0.85rem;
                                                "
                                                aria-label="背景圖片 URL"
                                            />
                                            <button
                                                id="personalization_bgUpload"
                                                style="
                                                    padding: 6px 12px;
                                                    border-radius: 6px;
                                                    background: rgba(
                                                        0,
                                                        212,
                                                        255,
                                                        0.15
                                                    );
                                                    border: 1px solid
                                                        rgba(0, 212, 255, 0.3);
                                                    color: #00d4ff;
                                                    font-size: 0.85rem;
                                                    cursor: pointer;
                                                "
                                            >
                                                上傳
                                            </button>
                                            <input
                                                type="file"
                                                id="personalization_bgUploadFile"
                                                accept="image/*"
                                                style="display: none"
                                            />
                                            <button
                                                id="personalization_bgReset"
                                                style="
                                                    padding: 6px 12px;
                                                    border-radius: 6px;
                                                    background: rgba(
                                                        255,
                                                        100,
                                                        100,
                                                        0.15
                                                    );
                                                    border: 1px solid
                                                        rgba(255, 100, 100, 0.3);
                                                    color: #ff9999;
                                                    font-size: 0.85rem;
                                                    cursor: pointer;
                                                "
                                            >
                                                重設
                                            </button>
                                        </div>
                                    </div>
                                    <div class="setting-item-body">
                                        <div
                                            id="personalization_bgThumbs"
                                            class="media-selection-grid"
                                        >
                                            <!-- 圖片縮圖將動態填充 -->
                                        </div>
                                    </div>
                                </div>

                                <!-- Video control: 磁貼式大型設定項 -->
                                <div
                                    id="personalization_background_video"
                                    class="setting-item-large"
                                    style="display: none"
                                >
                                    <div class="setting-item-header">
                                        <div class="setting-item-label">
                                            影片桌布
                                            <span
                                                >選擇預設影片或上傳自訂影片</span
                                            >
                                        </div>
                                        <div class="setting-item-controls">
                                            <input
                                                type="text"
                                                id="personalization_bgVideoUrl"
                                                placeholder="影片 URL"
                                                style="
                                                    width: 180px;
                                                    padding: 6px 10px;
                                                    border-radius: 6px;
                                                    background: rgba(
                                                        0,
                                                        0,
                                                        0,
                                                        0.2
                                                    );
                                                    border: 1px solid
                                                        rgba(255, 255, 255, 0.1);
                                                    color: #fff;
                                                    font-size: 0.85rem;
                                                "
                                                aria-label="背景影片 URL"
                                            />
                                            <button
                                                id="personalization_bgVideoUpload"
                                                style="
                                                    padding: 6px 12px;
                                                    border-radius: 6px;
                                                    background: rgba(
                                                        0,
                                                        212,
                                                        255,
                                                        0.15
                                                    );
                                                    border: 1px solid
                                                        rgba(0, 212, 255, 0.3);
                                                    color: #00d4ff;
                                                    font-size: 0.85rem;
                                                    cursor: pointer;
                                                "
                                            >
                                                上傳
                                            </button>
                                            <input
                                                type="file"
                                                id="personalization_bgVideoUploadFile"
                                                accept="video/*"
                                                style="display: none"
                                            />
                                            <button
                                                id="personalization_bgVideoReset"
                                                style="
                                                    padding: 6px 12px;
                                                    border-radius: 6px;
                                                    background: rgba(
                                                        255,
                                                        100,
                                                        100,
                                                        0.15
                                                    );
                                                    border: 1px solid
                                                        rgba(255, 100, 100, 0.3);
                                                    color: #ff9999;
                                                    font-size: 0.85rem;
                                                    cursor: pointer;
                                                "
                                            >
                                                重設
                                            </button>
                                        </div>
                                    </div>
                                    <div class="setting-item-body">
                                        <div
                                            id="personalization_bgVideoThumbs"
                                            class="media-selection-grid"
                                        >
                                            <!-- 影片縮圖將動態填充 -->
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Window Style subpage: hidden by default -->
                            <div
                                id="personalization_window_panel"
                                class="settings-subpage"
                                style="display: none; margin-top: 10px"
                            >
                                <div
                                    style="
                                        display: flex;
                                        align-items: center;
                                        gap: 12px;
                                        margin-bottom: 10px;
                                    "
                                >
                                    <button
                                        id="personalization_window_back"
                                        style="
                                            padding: 6px 8px;
                                            background: transparent;
                                            border: 1px solid
                                                rgba(255, 255, 255, 0.06);
                                            color: #f0f0f0;
                                            border-radius: 6px;
                                        "
                                    >
                                        ← 返回
                                    </button>
                                    <h3 style="margin: 0">視窗效果設定</h3>
                                </div>

                                <div class="setting-item">
                                    <div class="setting-item-label">
                                        視窗效果
                                        <span
                                            >啟用視窗透明效果（關閉則為不透明）</span
                                        >
                                    </div>
                                    <div
                                        class="toggle-switch"
                                        id="personalization_windowTransparentSub"
                                    ></div>
                                </div>

                                <div
                                    class="setting-item"
                                    id="personalization_windowStyle_item"
                                >
                                    <div class="setting-item-label">
                                        背景風格
                                        <span
                                            >選擇視窗背景效果（純透明或壓克力模糊）</span
                                        >
                                    </div>
                                    <div class="select-control">
                                        <select
                                            id="personalization_windowStyle"
                                        >
                                            <option value="transparent">
                                                純透明
                                            </option>
                                            <option value="acrylic">
                                                壓克力 (模糊效果)
                                            </option>
                                            <option value="mica">
                                                雲母 (Mica 效果)
                                            </option>
                                        </select>
                                    </div>
                                </div>

                                <div
                                    class="setting-item"
                                    id="personalization_windowOpacity_item"
                                >
                                    <div class="setting-item-label">
                                        透明度
                                        <span>調整視窗背景的透明程度</span>
                                    </div>
                                    <div class="slider-control">
                                        <div
                                            class="slider-value"
                                            id="personalization_windowOpacityValue"
                                        >
                                            90%
                                        </div>
                                        <input
                                            type="range"
                                            class="slider-range"
                                            id="personalization_windowOpacity"
                                            min="20"
                                            max="100"
                                            step="5"
                                            value="90"
                                            aria-label="視窗透明度"
                                        />
                                    </div>
                                </div>

                                <div
                                    class="setting-item"
                                    id="personalization_windowBlur_item"
                                >
                                    <div class="setting-item-label">
                                        模糊強度
                                        <span
                                            >調整壓克力/雲母效果的模糊程度</span
                                        >
                                    </div>
                                    <div class="slider-control">
                                        <div
                                            class="slider-value"
                                            id="personalization_windowBlurValue"
                                        >
                                            20px
                                        </div>
                                        <input
                                            type="range"
                                            class="slider-range"
                                            id="personalization_windowBlur"
                                            min="5"
                                            max="50"
                                            step="5"
                                            value="20"
                                            aria-label="模糊強度"
                                        />
                                    </div>
                                </div>
                            </div>

                            <div
                                id="personalization_font_panel"
                                class="settings-subpage"
                                style="display: none; margin-top: 10px"
                            >
                                <div
                                    style="
                                        display: flex;
                                        align-items: center;
                                        gap: 12px;
                                        margin-bottom: 10px;
                                    "
                                >
                                    <button
                                        id="personalization_font_back"
                                        style="
                                            padding: 6px 8px;
                                            background: transparent;
                                            border: 1px solid
                                                rgba(255, 255, 255, 0.06);
                                            color: #f0f0f0;
                                            border-radius: 6px;
                                        "
                                    >
                                        ← 返回
                                    </button>
                                    <h3 style="margin: 0">字型進階設定</h3>
                                </div>
                                <div class="setting-item">
                                    <div class="setting-item-label">
                                        字型
                                        <span>選擇主題字型</span>
                                    </div>
                                    <div class="select-control">
                                        <select
                                            id="personalization_fontSet_panel"
                                            aria-label="字型選擇 (進階)"
                                        >
                                            <option value="default">
                                                預設 (Orbitron / Rajdhani / Noto
                                                Sans TC)
                                            </option>
                                            <option value="system">
                                                系統字型
                                            </option>
                                            <option value="serif">Serif</option>
                                            <option value="mono">
                                                等寬字體
                                            </option>
                                        </select>
                                    </div>
                                </div>
                                <div class="setting-item">
                                    <div class="setting-item-label">
                                        字型縮放
                                        <span>調整整體 UI 字型大小</span>
                                    </div>
                                    <div class="slider-control">
                                        <div
                                            class="slider-value"
                                            id="personalization_fontScaleValue_panel"
                                        >
                                            100%
                                        </div>
                                        <input
                                            type="range"
                                            class="slider-range"
                                            id="personalization_fontScale_panel"
                                            min="80"
                                            max="140"
                                            step="5"
                                            value="100"
                                            aria-label="字型大小縮放"
                                        />
                                    </div>
                                </div>
                            </div>

                            <!-- Page: Network (placeholder) -->
                            <div
                                id="page-network"
                                class="settings-page"
                                style="display: none"
                            >
                                <div class="setting-section">
                                    <h3>網路</h3>
                                    <div class="setting-item">
                                        <div class="setting-item-label">
                                            Wi-Fi
                                            <span
                                                >在此新增或管理 Wi-Fi 網路</span
                                            >
                                        </div>
                                        <div
                                            class="toggle-switch"
                                            id="network_wifi_toggle"
                                        ></div>
                                    </div>
                                </div>
                            </div>
                            <!-- Page: Privacy (placeholder) -->
                            <div
                                id="page-privacy"
                                class="settings-page"
                                style="display: none"
                            >
                                <div class="setting-section">
                                    <h3>隱私權</h3>
                                    <div class="setting-item">
                                        <div class="setting-item-label">
                                            診斷資料
                                            <span
                                                >允許傳送使用情況分析以改善體驗</span
                                            >
                                        </div>
                                        <div
                                            class="toggle-switch"
                                            id="privacy_diagnostics_toggle"
                                        ></div>
                                    </div>
                                </div>
                            </div>
                            <!-- Page: About (placeholder) -->
                            <div
                                id="page-about"
                                class="settings-page"
                                style="display: none"
                            >
                                <div class="setting-section about-header">
                                    <div
                                        style="
                                            display: flex;
                                            align-items: center;
                                            gap: 12px;
                                        "
                                    >
                                        <div>
                                            <h3 style="margin-bottom: 6px">
                                                關於 — 長門櫻 WebOS
                                            </h3>
                                        </div>
                                        <img
                                            src="../../assets/images/logo.png"
                                            alt="長門櫻 - Web OS"
                                            class="about-logo"
                                            loading="lazy"
                                        />
                                    </div>
                                </div>

                                <div class="setting-section about-grid">
                                    <div
                                        class="about-item"
                                        style="grid-column: span 2"
                                    >
                                        <h4>版本資訊</h4>
                                        <div class="about-item-row">
                                            版本:
                                            <strong id="about-version"
                                                >v1.0.0</strong
                                            >
                                        </div>
                                        <div
                                            style="
                                                font-size: 0.9rem;
                                                color: #ccc;
                                            "
                                        >
                                            建構日期:
                                            <span id="about-build-date"
                                                >2025/11/18</span
                                            >
                                        </div>
                                        <div
                                            style="
                                                font-size: 0.9rem;
                                                color: #ccc;
                                            "
                                        >
                                            啟用於:
                                            <span id="about-boot-time">--</span>
                                        </div>
                                    </div>
                                    <div
                                        class="about-item"
                                        style="margin-top: 14px"
                                    >
                                        <h4>系統資訊</h4>
                                        <div class="about-item-row">
                                            瀏覽器:
                                            <span id="about-browser">--</span>
                                        </div>
                                        <div class="about-item-row">
                                            解析度:
                                            <span id="about-resolution"
                                                >--</span
                                            >
                                        </div>
                                        <div class="about-item-row">
                                            語言:
                                            <span id="about-language">--</span>
                                        </div>
                                    </div>
                                    <div
                                        class="about-item"
                                        style="margin-top: 14px"
                                    >
                                        <h4>授權與文件</h4>
                                        <div class="about-item-row">
                                            授權:
                                            <a
                                                href="../../LICENSE"
                                                target="_blank"
                                                rel="noopener"
                                                >檢視 LICENSE</a
                                            >
                                        </div>
                                        <div class="about-item-row">
                                            原始碼與貢獻:
                                            <a
                                                href="https://github.com/AmanoShizukikun/AmanoShizukikun.github.io"
                                                target="_blank"
                                                rel="noopener"
                                                >GitHub</a
                                            >
                                        </div>
                                        <div class="about-item-row">
                                            回報問題:
                                            <a
                                                href="https://github.com/AmanoShizukikun/AmanoShizukikun.github.io/issues"
                                                target="_blank"
                                                rel="noopener"
                                                >Issue</a
                                            >
                                        </div>
                                    </div>

                                    <div
                                        style="
                                            font-size: 0.9rem;
                                            color: #ccc;
                                            margin-top: 14px;
                                        "
                                    >
                                        ©2025 Build By 天野靜樹
                                    </div>
                                </div>
                            </div>
                            <!-- Page: Update -->
                            <div
                                id="page-update"
                                class="settings-page"
                                style="display: none"
                            >
                                <div class="setting-section">
                                    <h3>更新</h3>
                                    <div
                                        class="setting-item update-controls"
                                        style="
                                            margin-top: 12px;
                                            display: flex;
                                            gap: 8px;
                                            align-items: center;
                                            flex-wrap: wrap;
                                        "
                                    >
                                        <button
                                            id="update-check-btn"
                                            type="button"
                                            class="btn btn-rect"
                                            title="檢查更新"
                                        >
                                            檢查更新
                                        </button>
                                        <button
                                            id="update-open-release-btn"
                                            type="button"
                                            class="btn btn-rect"
                                            title="在 GitHub 上檢視發行頁面"
                                            disabled
                                        >
                                            檢視發行頁面
                                        </button>
                                        <div
                                            style="
                                                margin-left: auto;
                                                display: flex;
                                                align-items: center;
                                                gap: 8px;
                                            "
                                        >
                                            <div>自動檢查</div>
                                            <div
                                                class="toggle-switch"
                                                id="update-auto-toggle"
                                                role="switch"
                                                aria-checked="false"
                                                tabindex="0"
                                            ></div>
                                        </div>
                                    </div>
                                    <div class="setting-item update-item">
                                        <div class="setting-item-label">
                                            目前版本
                                            <span
                                                id="update-current-version"
                                                style="
                                                    display: inline-block;
                                                    margin-left: 6px;
                                                    color: #ccc;
                                                "
                                                >v1.0.0</span
                                            >
                                        </div>
                                        <div class="setting-item-label">
                                            最新版本
                                            <span
                                                id="update-latest-version"
                                                style="
                                                    display: inline-block;
                                                    margin-left: 6px;
                                                    color: #ccc;
                                                "
                                                >尚未檢查</span
                                            >
                                        </div>
                                        <div class="setting-item-label">
                                            說明 / 發行說明
                                        </div>
                                        <div
                                            id="update-release-notes"
                                            style="
                                                margin-top: 8px;
                                                color: #ccc;
                                                font-size: 0.9rem;
                                                max-height: 160px;
                                                overflow: auto;
                                            "
                                        >
                                            尚未取得更新資訊
                                        </div>
                                    </div>

                                    <div
                                        style="
                                            margin-top: 8px;
                                            color: #aaa;
                                            font-size: 0.85rem;
                                        "
                                    >
                                        最近檢查：<span id="update-last-checked"
                                            >尚未檢查</span
                                        >
                                    </div>
                                    <div
                                        id="update-status"
                                        style="
                                            margin-top: 8px;
                                            color: #bdbdbd;
                                            font-size: 0.85rem;
                                        "
                                    >
                                        狀態：等待使用者操作
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 5.2 長門櫻 視窗 -->
                <div
                    class="window"
                    id="window-nagato"
                    data-app="nagato"
                    style="width: 400px; height: 600px"
                >
                    <div class="resize-handle n"></div>
                    <div class="resize-handle s"></div>
                    <div class="resize-handle e"></div>
                    <div class="resize-handle w"></div>
                    <div class="resize-handle nw"></div>
                    <div class="resize-handle ne"></div>
                    <div class="resize-handle sw"></div>
                    <div class="resize-handle se"></div>

                    <div class="window-header">
                        <div class="window-title">
                            <img
                                src="assets/apps/icon/NS-V2.png"
                                alt="長門櫻"
                                class="app-icon-img"
                                loading="lazy"
                            />
                            <span>長門櫻</span>
                        </div>
                        <div class="window-controls">
                            <div class="window-control-btn minimize">
                                <i class="fa-solid fa-minus"></i>
                            </div>
                            <div class="window-control-btn maximize">
                                <i class="fa-regular fa-square"></i>
                                <div class="snap-layouts">
                                    <div
                                        class="snap-layout-option"
                                        title="左上角"
                                    ></div>
                                    <div
                                        class="snap-layout-option"
                                        title="右上角"
                                    ></div>
                                    <div
                                        class="snap-layout-option"
                                        title="左下角"
                                    ></div>
                                    <div
                                        class="snap-layout-option"
                                        title="右下角"
                                    ></div>
                                </div>
                            </div>
                            <div class="window-control-btn close">
                                <i class="fa-solid fa-xmark"></i>
                            </div>
                        </div>
                    </div>
                    <div class="window-content nagato-content">
                        <div class="nagato-messages">
                            <div class="message ai">
                                主人您好！我叫長門櫻，您的專屬女僕。請問您有什麼需要長門櫻為您效勞的嗎？
                            </div>
                        </div>
                        <div class="nagato-input-area">
                            <textarea
                                id="nagato-input"
                                rows="1"
                                placeholder="在這裡輸入..."
                                aria-label="輸入訊息"
                            ></textarea>
                            <button
                                id="nagato-clear"
                                class="clear-btn"
                                title="清除對話"
                                aria-label="清除對話"
                            >
                                <i class="fa-solid fa-trash"></i>
                            </button>
                            <button id="nagato-send" title="傳送">
                                <i class="fa-solid fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 5.3 檔案總管視窗 (新增) -->
                <div
                    class="window"
                    id="window-explorer"
                    data-app="explorer"
                    style="width: 800px; height: 550px"
                >
                    <div class="resize-handle n"></div>
                    <div class="resize-handle s"></div>
                    <div class="resize-handle e"></div>
                    <div class="resize-handle w"></div>
                    <div class="resize-handle nw"></div>
                    <div class="resize-handle ne"></div>
                    <div class="resize-handle sw"></div>
                    <div class="resize-handle se"></div>

                    <div class="window-header">
                        <div class="window-title">
                            <i class="fa-solid fa-folder icon-explorer"></i>
                            <span>檔案總管</span>
                        </div>
                        <div class="window-controls">
                            <div class="window-control-btn minimize">
                                <i class="fa-solid fa-minus"></i>
                            </div>
                            <div class="window-control-btn maximize">
                                <i class="fa-regular fa-square"></i>
                                <div class="snap-layouts">
                                    <div
                                        class="snap-layout-option"
                                        title="左上角"
                                    ></div>
                                    <div
                                        class="snap-layout-option"
                                        title="右上角"
                                    ></div>
                                    <div
                                        class="snap-layout-option"
                                        title="左下角"
                                    ></div>
                                    <div
                                        class="snap-layout-option"
                                        title="右下角"
                                    ></div>
                                </div>
                            </div>
                            <div class="window-control-btn close">
                                <i class="fa-solid fa-xmark"></i>
                            </div>
                        </div>
                    </div>
                    <div class="window-content explorer-content">
                        <div class="explorer-sidebar">
                            <h4>快速存取</h4>
                            <div class="explorer-item">
                                <i class="fa-solid fa-desktop"></i> 桌面
                            </div>
                            <div class="explorer-item">
                                <i class="fa-solid fa-download"></i> 下載
                            </div>
                            <div class="explorer-item">
                                <i class="fa-solid fa-file-lines"></i> 文件
                            </div>
                            <h4>本機</h4>
                            <div class="explorer-item">
                                <i class="fa-solid fa-hard-drive"></i> (C:)
                            </div>
                        </div>
                        <div class="explorer-main">
                            <div class="folder-icon">
                                <i class="fa-solid fa-folder"></i
                                ><span>文件</span>
                            </div>
                            <div class="folder-icon">
                                <i class="fa-solid fa-folder"></i
                                ><span>下載</span>
                            </div>
                            <div class="folder-icon">
                                <i class="fa-solid fa-folder"></i
                                ><span>音樂</span>
                            </div>
                            <div class="folder-icon">
                                <i class="fa-solid fa-folder"></i
                                ><span>圖片</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 5.4 瀏覽器視窗 (新增) -->
                <div
                    class="window"
                    id="window-browser"
                    data-app="browser"
                    style="width: 900px; height: 600px"
                >
                    <div class="resize-handle n"></div>
                    <div class="resize-handle s"></div>
                    <div class="resize-handle e"></div>
                    <div class="resize-handle w"></div>
                    <div class="resize-handle nw"></div>
                    <div class="resize-handle ne"></div>
                    <div class="resize-handle sw"></div>
                    <div class="resize-handle se"></div>

                    <div class="window-header">
                        <div class="window-title">
                            <i class="fa-brands fa-edge icon-edge"></i>
                            <span>瀏覽器 (模擬)</span>
                        </div>
                        <div class="window-controls">
                            <div class="window-control-btn minimize">
                                <i class="fa-solid fa-minus"></i>
                            </div>
                            <div class="window-control-btn maximize">
                                <i class="fa-regular fa-square"></i>
                                <div class="snap-layouts">
                                    <div
                                        class="snap-layout-option"
                                        title="左上角"
                                    ></div>
                                    <div
                                        class="snap-layout-option"
                                        title="右上角"
                                    ></div>
                                    <div
                                        class="snap-layout-option"
                                        title="左下角"
                                    ></div>
                                    <div
                                        class="snap-layout-option"
                                        title="右下角"
                                    ></div>
                                </div>
                            </div>
                            <div class="window-control-btn close">
                                <i class="fa-solid fa-xmark"></i>
                            </div>
                        </div>
                    </div>
                    <div class="window-content browser-content">
                        <!-- 使用 Edge 風格的 toolbar 和 favorites bar -->
                        <div id="win-edge">
                            <div class="tool">
                                <a class="a" id="browser-back" title="上一頁"
                                    ><i class="fa-solid fa-arrow-left"></i
                                ></a>
                                <a class="a" id="browser-forward" title="下一頁"
                                    ><i class="fa-solid fa-arrow-right"></i
                                ></a>
                                <a
                                    class="a"
                                    id="browser-refresh"
                                    title="重新整理"
                                    ><i class="fa-solid fa-rotate-right"></i
                                ></a>
                                <input
                                    id="browser-url-input"
                                    class="url"
                                    type="text"
                                    value="https://amanoshizukikun.github.io/"
                                    aria-label="網址列"
                                />
                                <a
                                    class="a"
                                    id="bookmark-toggle"
                                    title="管理最愛"
                                    aria-pressed="false"
                                    ><i class="fa-regular fa-star"></i
                                ></a>
                            </div>

                            <!-- 最愛列 (Favorites bar) - 可滾動的按鈕列 -->
                            <div
                                class="favorites-bar"
                                id="favorites-bar"
                                role="navigation"
                                aria-label="最愛列"
                            >
                                <!-- JS will populate favorite items here -->
                            </div>
                            <iframe
                                class="browser-iframe"
                                src="about:blank"
                                sandbox="allow-scripts allow-same-origin"
                            ></iframe>
                        </div>
                    </div>
                </div>

                <!-- 5.5 應用商店視窗 (新增) -->
                <div
                    class="window"
                    id="window-store"
                    data-app="store"
                    style="width: 800px; height: 600px"
                >
                    <div class="resize-handle n"></div>
                    <div class="resize-handle s"></div>
                    <div class="resize-handle e"></div>
                    <div class="resize-handle w"></div>
                    <div class="resize-handle nw"></div>
                    <div class="resize-handle ne"></div>
                    <div class="resize-handle sw"></div>
                    <div class="resize-handle se"></div>

                    <div class="window-header">
                        <div class="window-title">
                            <i class="fa-solid fa-store icon-store"></i>
                            <span>應用商店</span>
                        </div>
                        <div class="window-controls">
                            <div class="window-control-btn minimize">
                                <i class="fa-solid fa-minus"></i>
                            </div>
                            <div class="window-control-btn maximize">
                                <i class="fa-regular fa-square"></i>
                                <div class="snap-layouts">
                                    <div
                                        class="snap-layout-option"
                                        title="左上角"
                                    ></div>
                                    <div
                                        class="snap-layout-option"
                                        title="右上角"
                                    ></div>
                                    <div
                                        class="snap-layout-option"
                                        title="左下角"
                                    ></div>
                                    <div
                                        class="snap-layout-option"
                                        title="右下角"
                                    ></div>
                                </div>
                            </div>
                            <div class="window-control-btn close">
                                <i class="fa-solid fa-xmark"></i>
                            </div>
                        </div>
                    </div>
                    <div class="window-content store-content">
                        <i class="fa-solid fa-shop"></i>
                        <h3>應用商店即將上線</h3>
                        <p>正在準備更多精彩的應用程式...</p>
                    </div>
                </div>
                <!-- 5.6 計算機視窗 (新增) -->
                <div
                    class="window"
                    id="window-calculator"
                    data-app="calculator"
                    data-min-width="320"
                    data-min-height="430"
                    style="width: 340px; height: 430px"
                >
                    <div class="resize-handle n"></div>
                    <div class="resize-handle s"></div>
                    <div class="resize-handle e"></div>
                    <div class="resize-handle w"></div>
                    <div class="resize-handle nw"></div>
                    <div class="resize-handle ne"></div>
                    <div class="resize-handle sw"></div>
                    <div class="resize-handle se"></div>
                    <div class="window-header">
                        <div class="window-title">
                            <i
                                class="fa-solid fa-calculator icon-calculator"
                                style="color: #4caf50"
                            ></i>
                            <span>計算機</span>
                        </div>
                        <div class="window-controls">
                            <div
                                class="window-control-btn minimize"
                                title="最小化"
                            >
                                <i class="fa-solid fa-minus"></i>
                            </div>
                            <div
                                class="window-control-btn maximize"
                                title="最大化"
                            >
                                <i class="fa-regular fa-square"></i>
                                <div class="snap-layouts">
                                    <div
                                        class="snap-layout-option"
                                        title="左上角"
                                    ></div>
                                    <div
                                        class="snap-layout-option"
                                        title="右上角"
                                    ></div>
                                    <div
                                        class="snap-layout-option"
                                        title="左下角"
                                    ></div>
                                    <div
                                        class="snap-layout-option"
                                        title="右下角"
                                    ></div>
                                </div>
                            </div>
                            <div class="window-control-btn close" title="關閉">
                                <i class="fa-solid fa-xmark"></i>
                            </div>
                        </div>
                    </div>
                    <div class="window-content" id="win-calc">
                        <div class="container">
                            <input
                                id="calc-input"
                                aria-label="計算機輸入"
                                readonly="true"
                                value="0"
                                onkeydown="
                            switch (event.key) {
                                case '+':
                                    appCalculator.func_key(1);
                                    appCalculator.check(document.querySelector('#win-calc>.keyb>.jia'));
                                    break;
                                case '-':
                                    appCalculator.func_key(2);
                                    appCalculator.check(document.querySelector('#win-calc>.keyb>.jian'));
                                    break;
                                case '*':
                                    appCalculator.func_key(3);
                                    appCalculator.check(document.querySelector('#win-calc>.keyb>.cheng'));
                                    break;
                                case '/':
                                    appCalculator.func_key(4);
                                    appCalculator.check(document.querySelector('#win-calc>.keyb>.chu'));
                                    break;
                                case '=':
                                case 'Enter':
                                    appCalculator.eq();
                                    break;
                                case 'Backspace':
                                    appCalculator.backspace();
                                    break;
                                case '.':
                                    appCalculator.point();
                                    break;
                            }
                            if (!isNaN(event.key)) {
                                appCalculator.number_key(Number(event.key));
                            }
                        "
                            />
                        </div>
                        <div class="keyb">
                            <a class="a b" onclick="appCalculator.square()"
                                >𝑥²</a
                            >
                            <a class="a b" onclick="appCalculator.squareRoot()"
                                >√𝑥</a
                            >
                            <a class="a b" onclick="appCalculator.clear_num()"
                                >C</a
                            >
                            <a
                                class="a b u jia"
                                onclick="appCalculator.func_key(1); appCalculator.check(this);"
                                >+</a
                            >
                            <a
                                class="a b"
                                onclick="appCalculator.number_key(7);"
                                >7</a
                            >
                            <a
                                class="a b"
                                onclick="appCalculator.number_key(8);"
                                >8</a
                            >
                            <a
                                class="a b"
                                onclick="appCalculator.number_key(9);"
                                >9</a
                            >
                            <a
                                class="a b u jian"
                                onclick="appCalculator.func_key(2); appCalculator.check(this);"
                                >-</a
                            >
                            <a
                                class="a b"
                                onclick="appCalculator.number_key(4);"
                                >4</a
                            >
                            <a
                                class="a b"
                                onclick="appCalculator.number_key(5);"
                                >5</a
                            >
                            <a
                                class="a b"
                                onclick="appCalculator.number_key(6);"
                                >6</a
                            >
                            <a
                                class="a b u cheng"
                                onclick="appCalculator.func_key(3); appCalculator.check(this);"
                                >×</a
                            >
                            <a
                                class="a b"
                                onclick="appCalculator.number_key(1);"
                                >1</a
                            >
                            <a
                                class="a b"
                                onclick="appCalculator.number_key(2);"
                                >2</a
                            >
                            <a
                                class="a b"
                                onclick="appCalculator.number_key(3);"
                                >3</a
                            >
                            <a
                                class="a b u chu"
                                onclick="appCalculator.func_key(4); appCalculator.check(this);"
                                >÷</a
                            >
                            <a class="a b" onclick="appCalculator.point()">.</a>
                            <a
                                class="a b"
                                onclick="appCalculator.number_key(0);"
                                >0</a
                            >
                            <a class="a b" onclick="appCalculator.backspace()"
                                ><i class="fa-solid fa-delete-left"></i
                            ></a>
                            <a
                                class="a b ans u"
                                onclick="if(!appCalculator.eq()){ appCalculator.clear_num(); }"
                                >=</a
                            >
                        </div>
                    </div>
                </div>

                <!-- 5.7 記事本視窗 -->
                <div
                    class="window"
                    id="window-notepad"
                    data-app="notepad"
                    style="width: 700px; height: 500px"
                >
                    <div class="resize-handle n"></div>
                    <div class="resize-handle s"></div>
                    <div class="resize-handle e"></div>
                    <div class="resize-handle w"></div>
                    <div class="resize-handle nw"></div>
                    <div class="resize-handle ne"></div>
                    <div class="resize-handle sw"></div>
                    <div class="resize-handle se"></div>
                    <div class="window-header">
                        <div class="window-title">
                            <i
                                class="fa-solid fa-file-lines"
                                style="color: #ffd740"
                            ></i>
                            <span>記事本 - 未命名</span>
                        </div>
                        <div class="window-controls">
                            <div
                                class="window-control-btn minimize"
                                title="最小化"
                            >
                                <i class="fa-solid fa-minus"></i>
                            </div>
                            <div
                                class="window-control-btn maximize"
                                title="最大化"
                            >
                                <i class="fa-regular fa-square"></i>
                                <div class="snap-layouts">
                                    <div
                                        class="snap-layout-option"
                                        title="左上角"
                                    ></div>
                                    <div
                                        class="snap-layout-option"
                                        title="右上角"
                                    ></div>
                                    <div
                                        class="snap-layout-option"
                                        title="左下角"
                                    ></div>
                                    <div
                                        class="snap-layout-option"
                                        title="右下角"
                                    ></div>
                                </div>
                            </div>
                            <div class="window-control-btn close" title="關閉">
                                <i class="fa-solid fa-xmark"></i>
                            </div>
                        </div>
                    </div>
                    <div class="window-content notepad-content">
                        <!-- 記事本工具列 -->
                        <div class="notepad-toolbar">
                            <div class="notepad-toolbar-group">
                                <button
                                    class="notepad-btn"
                                    onclick="notepadApp.newFile()"
                                    title="新增 (Ctrl+N)"
                                >
                                    <i class="fa-solid fa-file"></i>
                                </button>
                                <button
                                    class="notepad-btn"
                                    onclick="notepadApp.openFile()"
                                    title="開啟 (Ctrl+O)"
                                >
                                    <i class="fa-solid fa-folder-open"></i>
                                </button>
                                <button
                                    class="notepad-btn"
                                    onclick="notepadApp.saveFile()"
                                    title="儲存 (Ctrl+S)"
                                >
                                    <i class="fa-solid fa-floppy-disk"></i>
                                </button>
                            </div>
                            <div class="notepad-toolbar-separator"></div>
                            <div class="notepad-toolbar-group">
                                <button
                                    class="notepad-btn"
                                    onclick="notepadApp.undo()"
                                    title="復原 (Ctrl+Z)"
                                >
                                    <i class="fa-solid fa-rotate-left"></i>
                                </button>
                                <button
                                    class="notepad-btn"
                                    onclick="notepadApp.redo()"
                                    title="重做 (Ctrl+Y)"
                                >
                                    <i class="fa-solid fa-rotate-right"></i>
                                </button>
                            </div>
                            <div class="notepad-toolbar-separator"></div>
                            <div class="notepad-toolbar-group">
                                <button
                                    class="notepad-btn"
                                    onclick="notepadApp.cut()"
                                    title="剪下 (Ctrl+X)"
                                >
                                    <i class="fa-solid fa-scissors"></i>
                                </button>
                                <button
                                    class="notepad-btn"
                                    onclick="notepadApp.copy()"
                                    title="複製 (Ctrl+C)"
                                >
                                    <i class="fa-solid fa-copy"></i>
                                </button>
                                <button
                                    class="notepad-btn"
                                    onclick="notepadApp.paste()"
                                    title="貼上 (Ctrl+V)"
                                >
                                    <i class="fa-solid fa-paste"></i>
                                </button>
                            </div>
                            <div class="notepad-toolbar-separator"></div>
                            <div class="notepad-toolbar-group">
                                <button
                                    class="notepad-btn"
                                    onclick="notepadApp.selectAll()"
                                    title="全選 (Ctrl+A)"
                                >
                                    <i class="fa-solid fa-check-double"></i>
                                </button>
                                <button
                                    class="notepad-btn"
                                    onclick="notepadApp.find()"
                                    title="尋找 (Ctrl+F)"
                                >
                                    <i class="fa-solid fa-magnifying-glass"></i>
                                </button>
                            </div>
                        </div>
                        <!-- 記事本編輯區 -->
                        <div id="win-notepad">
                            <div
                                class="text-box"
                                id="notepad-editor"
                                contenteditable="true"
                                spellcheck="false"
                            ></div>
                        </div>
                        <!-- 記事本狀態列 -->
                        <div class="notepad-status">
                            <div class="notepad-status-left">
                                <span id="notepad-line-col">行 1, 列 1</span>
                                <span id="notepad-char-count">0 字元</span>
                            </div>
                            <div class="notepad-status-right">
                                <span>UTF-8</span>
                                <span>CRLF</span>
                            </div>
                        </div>
                        <input
                            type="file"
                            id="notepad-file-input"
                            accept=".txt,.md,.js,.css,.html,.json,.xml,.py"
                            style="display: none"
                        />
                    </div>
                </div>

                <!-- 5.8 終端機視窗 -->
                <div
                    class="window terminal-window"
                    id="window-terminal"
                    data-app="terminal"
                    style="width: 800px; height: 500px"
                >
                    <div class="resize-handle n"></div>
                    <div class="resize-handle s"></div>
                    <div class="resize-handle e"></div>
                    <div class="resize-handle w"></div>
                    <div class="resize-handle nw"></div>
                    <div class="resize-handle ne"></div>
                    <div class="resize-handle sw"></div>
                    <div class="resize-handle se"></div>
                    <div class="window-header">
                        <div class="window-title">
                            <i
                                class="fa-solid fa-terminal"
                                style="color: #4caf50"
                            ></i>
                            <span>終端機</span>
                        </div>
                        <div class="window-controls">
                            <div
                                class="window-control-btn minimize"
                                title="最小化"
                            >
                                <i class="fa-solid fa-minus"></i>
                            </div>
                            <div
                                class="window-control-btn maximize"
                                title="最大化"
                            >
                                <i class="fa-regular fa-square"></i>
                                <div class="snap-layouts">
                                    <div
                                        class="snap-layout-option"
                                        title="左上角"
                                    ></div>
                                    <div
                                        class="snap-layout-option"
                                        title="右上角"
                                    ></div>
                                    <div
                                        class="snap-layout-option"
                                        title="左下角"
                                    ></div>
                                    <div
                                        class="snap-layout-option"
                                        title="右下角"
                                    ></div>
                                </div>
                            </div>
                            <div class="window-control-btn close" title="關閉">
                                <i class="fa-solid fa-xmark"></i>
                            </div>
                        </div>
                    </div>
                    <div
                        class="window-content"
                        id="win-terminal"
                        onmouseup="document.getElementById('terminal-input').focus();"
                        ontouchend="document.getElementById('terminal-input').focus();"
                    >
                        <pre>
Nagato Sakura Terminal [版本 1.0.0]
(c) 2025 天野靜樹。保留所有權利。
</pre
                        >
                        <pre class="text-cmd" id="terminal-output"></pre>
                        <pre
                            style="display: flex; align-items: center; gap: 8px"
                        ><span class="prompt" id="terminal-prompt">C:\Users\Guest&gt;</span><input type="text" id="terminal-input" style="flex: 1; background: transparent; border: none; outline: none; color: var(--text); font-family: 'Consolas', 'Monaco', monospace; font-size: 15px;" autocomplete="off" spellcheck="false"></pre>
                    </div>
                </div>

                <!-- 5.9 相簿視窗 -->
                <div
                    class="window"
                    id="window-photos"
                    data-app="photos"
                    style="width: 950px; height: 650px"
                >
                    <div class="resize-handle n"></div>
                    <div class="resize-handle s"></div>
                    <div class="resize-handle e"></div>
                    <div class="resize-handle w"></div>
                    <div class="resize-handle nw"></div>
                    <div class="resize-handle ne"></div>
                    <div class="resize-handle sw"></div>
                    <div class="resize-handle se"></div>
                    <div class="window-header">
                        <div class="window-title">
                            <i
                                class="fa-solid fa-image"
                                style="color: #ff9800"
                            ></i>
                            <span>相簿</span>
                        </div>
                        <div class="window-controls">
                            <div
                                class="window-control-btn minimize"
                                title="最小化"
                            >
                                <i class="fa-solid fa-minus"></i>
                            </div>
                            <div
                                class="window-control-btn maximize"
                                title="最大化"
                            >
                                <i class="fa-regular fa-square"></i>
                                <div class="snap-layouts">
                                    <div
                                        class="snap-layout-option"
                                        title="左上角"
                                    ></div>
                                    <div
                                        class="snap-layout-option"
                                        title="右上角"
                                    ></div>
                                    <div
                                        class="snap-layout-option"
                                        title="左下角"
                                    ></div>
                                    <div
                                        class="snap-layout-option"
                                        title="右下角"
                                    ></div>
                                </div>
                            </div>
                            <div class="window-control-btn close" title="關閉">
                                <i class="fa-solid fa-xmark"></i>
                            </div>
                        </div>
                    </div>
                    <div
                        class="window-content photos-content"
                        style="flex-direction: row"
                    >
                        <!-- 相簿側邊欄 -->
                        <div class="photos-sidebar">
                            <div
                                class="photos-sidebar-item active"
                                data-folder="all"
                            >
                                <i class="fa-solid fa-images"></i>
                                <span>所有照片</span>
                            </div>
                            <div
                                class="photos-sidebar-item"
                                data-folder="wallpaper"
                            >
                                <i class="fa-solid fa-desktop"></i>
                                <span>桌布</span>
                            </div>
                            <div
                                class="photos-sidebar-item"
                                data-folder="screenshots"
                            >
                                <i class="fa-solid fa-camera"></i>
                                <span>螢幕截圖</span>
                            </div>
                            <div
                                class="photos-sidebar-item"
                                data-folder="uploads"
                            >
                                <i class="fa-solid fa-cloud-arrow-up"></i>
                                <span>已上傳</span>
                            </div>
                            <div
                                class="photos-sidebar-item"
                                data-folder="favorites"
                            >
                                <i class="fa-solid fa-heart"></i>
                                <span>最愛</span>
                            </div>
                        </div>
                        <!-- 相簿主區域 -->
                        <div class="photos-main">
                            <!-- 相簿工具列 -->
                            <div class="photos-toolbar">
                                <div class="photos-toolbar-group">
                                    <button
                                        class="photos-btn"
                                        onclick="photosApp.uploadPhoto()"
                                        title="上傳圖片"
                                    >
                                        <i class="fa-solid fa-upload"></i>
                                        <span>上傳</span>
                                    </button>
                                    <button
                                        class="photos-btn"
                                        onclick="photosApp.deletePhoto()"
                                        title="刪除選取的圖片"
                                    >
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                </div>
                                <div class="photos-toolbar-separator"></div>
                                <div class="photos-toolbar-group">
                                    <button
                                        class="photos-btn"
                                        onclick="photosApp.viewSlideshow()"
                                        title="幻燈片播放"
                                    >
                                        <i class="fa-solid fa-play"></i>
                                        <span>幻燈片</span>
                                    </button>
                                    <button
                                        class="photos-btn"
                                        onclick="photosApp.toggleFavorite()"
                                        title="加入最愛"
                                    >
                                        <i class="fa-regular fa-heart"></i>
                                    </button>
                                </div>
                                <div class="photos-toolbar-separator"></div>
                                <div class="photos-toolbar-group">
                                    <button
                                        class="photos-btn"
                                        onclick="photosApp.rotateLeft()"
                                        title="向左旋轉"
                                    >
                                        <i class="fa-solid fa-rotate-left"></i>
                                    </button>
                                    <button
                                        class="photos-btn"
                                        onclick="photosApp.rotateRight()"
                                        title="向右旋轉"
                                    >
                                        <i class="fa-solid fa-rotate-right"></i>
                                    </button>
                                </div>
                                <!-- 檢視模式切換 -->
                                <div class="photos-view-toggle">
                                    <button
                                        class="photos-btn active"
                                        onclick="photosApp.setViewMode('medium')"
                                        title="中圖示"
                                    >
                                        <i class="fa-solid fa-grip"></i>
                                    </button>
                                    <button
                                        class="photos-btn"
                                        onclick="photosApp.setViewMode('large')"
                                        title="大圖示"
                                    >
                                        <i
                                            class="fa-solid fa-table-cells-large"
                                        ></i>
                                    </button>
                                    <button
                                        class="photos-btn"
                                        onclick="photosApp.setViewMode('small')"
                                        title="小圖示"
                                    >
                                        <i class="fa-solid fa-table-cells"></i>
                                    </button>
                                </div>
                            </div>
                            <!-- 照片網格 -->
                            <div class="photos-grid-wrapper">
                                <div class="photos-grid" id="photos-grid">
                                    <!-- 動態載入圖片 -->
                                </div>
                            </div>
                            <input
                                type="file"
                                id="photo-upload-input"
                                accept="image/*"
                                multiple
                                style="display: none"
                            />
                        </div>
                    </div>
                </div>

                <!-- 5.10 播放器視窗 -->
                <div
                    class="window"
                    id="window-player"
                    data-app="player"
                    style="width: 800px; height: 500px"
                >
                    <div class="resize-handle n"></div>
                    <div class="resize-handle s"></div>
                    <div class="resize-handle e"></div>
                    <div class="resize-handle w"></div>
                    <div class="resize-handle nw"></div>
                    <div class="resize-handle ne"></div>
                    <div class="resize-handle sw"></div>
                    <div class="resize-handle se"></div>
                    <div class="window-header">
                        <div class="window-title">
                            <i
                                class="fa-solid fa-circle-play"
                                style="color: #e91e63"
                            ></i>
                            <span>媒體播放器</span>
                        </div>
                        <div class="window-controls">
                            <div
                                class="window-control-btn minimize"
                                title="最小化"
                            >
                                <i class="fa-solid fa-minus"></i>
                            </div>
                            <div
                                class="window-control-btn maximize"
                                title="最大化"
                            >
                                <i class="fa-regular fa-square"></i>
                                <div class="snap-layouts">
                                    <div
                                        class="snap-layout-option"
                                        title="左上角"
                                    ></div>
                                    <div
                                        class="snap-layout-option"
                                        title="右上角"
                                    ></div>
                                    <div
                                        class="snap-layout-option"
                                        title="左下角"
                                    ></div>
                                    <div
                                        class="snap-layout-option"
                                        title="右下角"
                                    ></div>
                                </div>
                            </div>
                            <div class="window-control-btn close" title="關閉">
                                <i class="fa-solid fa-xmark"></i>
                            </div>
                        </div>
                    </div>
                    <div class="window-content player-content">
                        <div class="player-video-container">
                            <video id="player-video" class="player-video">
                                <source
                                    src="assets/videos/demo.mp4"
                                    type="video/mp4"
                                />
                                您的瀏覽器不支援影片播放。
                            </video>
                            <div class="player-overlay" id="player-overlay">
                                <div class="player-message">
                                    <i class="fa-solid fa-film"></i>
                                    <p>請選擇媒體檔案</p>
                                </div>
                            </div>
                        </div>
                        <div class="player-controls">
                            <div class="player-toolbar">
                                <button
                                    class="player-btn"
                                    onclick="playerApp.openFile()"
                                    title="開啟檔案"
                                >
                                    <i class="fa-solid fa-folder-open"></i>
                                </button>
                                <button
                                    class="player-btn"
                                    id="player-play-btn"
                                    onclick="playerApp.togglePlay()"
                                    title="播放/暫停"
                                >
                                    <i class="fa-solid fa-play"></i>
                                </button>
                                <button
                                    class="player-btn"
                                    onclick="playerApp.stop()"
                                    title="停止"
                                >
                                    <i class="fa-solid fa-stop"></i>
                                </button>
                                <div class="toolbar-separator"></div>
                                <button
                                    class="player-btn"
                                    onclick="playerApp.seekBackward()"
                                    title="後退 10 秒"
                                >
                                    <i class="fa-solid fa-backward"></i>
                                </button>
                                <button
                                    class="player-btn"
                                    onclick="playerApp.seekForward()"
                                    title="前進 10 秒"
                                >
                                    <i class="fa-solid fa-forward"></i>
                                </button>
                                <div class="toolbar-separator"></div>
                                <button
                                    class="player-btn"
                                    id="player-volume-btn"
                                    onclick="playerApp.toggleMute()"
                                    title="靜音"
                                >
                                    <i class="fa-solid fa-volume-high"></i>
                                </button>
                                <input
                                    type="range"
                                    class="player-volume-slider"
                                    id="player-volume"
                                    min="0"
                                    max="100"
                                    value="100"
                                    title="音量"
                                />
                                <span class="player-time" id="player-time"
                                    >00:00 / 00:00</span
                                >
                                <button
                                    class="player-btn"
                                    onclick="playerApp.toggleFullscreen()"
                                    title="全螢幕"
                                >
                                    <i class="fa-solid fa-expand"></i>
                                </button>
                                <input
                                    type="file"
                                    id="player-file-input"
                                    accept="video/*,audio/*"
                                    style="display: none"
                                />
                            </div>
                            <div class="player-progress">
                                <input
                                    type="range"
                                    class="player-progress-bar"
                                    id="player-progress"
                                    min="0"
                                    max="100"
                                    value="0"
                                    step="0.1"
                                />
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 6. 日曆彈窗 -->
                <div id="calendar-flyout">
                    <div class="calendar-header">
                        <span id="calendar-month-year"></span>
                        <div class="calendar-nav">
                            <button id="calendar-prev">
                                <i class="fa-solid fa-chevron-left"></i>
                            </button>
                            <button id="calendar-next">
                                <i class="fa-solid fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                    <div class="calendar-grid" id="calendar-grid">
                        <!-- 由 JS 生成 -->
                    </div>
                </div>

                <!-- 7. 小工具面板 (新增) -->
                <div id="widgets-panel">
                    <!-- 小工具面板標題列 -->
                    <div class="widgets-panel-header">
                        <span class="widgets-panel-title">小工具</span>
                        <div class="widgets-panel-actions">
                            <button
                                class="widgets-panel-btn"
                                id="widgets-collapse-btn"
                                title="收合小工具"
                                style="display: none"
                            >
                                <i class="fa-solid fa-angles-left"></i>
                            </button>
                            <button
                                class="widgets-panel-btn"
                                id="widgets-add-btn"
                                title="新增小工具"
                            >
                                <i class="fa-solid fa-plus"></i>
                            </button>
                            <button
                                class="widgets-panel-btn"
                                id="widgets-settings-btn"
                                title="小工具設定"
                            >
                                <i class="fa-solid fa-gear"></i>
                            </button>
                            <button
                                class="widgets-panel-btn"
                                id="widgets-fullscreen-btn"
                                title="全螢幕"
                            >
                                <i class="fa-solid fa-expand"></i>
                            </button>
                        </div>
                    </div>

                    <!-- 原始小工具內容 -->
                    <div class="widgets-content">
                        <!-- 時鐘小工具 -->
                        <div
                            class="widget clock-widget widget-size-1"
                            id="widget-clock"
                            data-widget-size="1"
                            data-widget-type="clock"
                        >
                            <div class="widget-controls">
                                <button
                                    class="widget-size-toggle"
                                    title="調整大小"
                                >
                                    1
                                </button>
                                <button
                                    class="widget-remove-btn"
                                    title="移除小工具"
                                >
                                    <i class="fa-solid fa-xmark"></i>
                                </button>
                            </div>
                            <div class="widget-header">
                                <i class="fa-solid fa-clock"></i> 時鐘
                            </div>
                            <div
                                class="widget-body"
                                style="
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                "
                            >
                                <div
                                    style="
                                        font-family: var(--font-display);
                                        font-size: 1.8rem;
                                        color: var(--primary-cyan);
                                    "
                                    class="clock-display"
                                    id="widget-clock-display"
                                >
                                    --:--:--
                                </div>
                            </div>
                        </div>

                        <!-- 天氣小工具 -->
                        <div
                            class="widget weather-widget widget-size-3"
                            id="widget-weather"
                            data-widget-size="3"
                            data-widget-type="weather"
                        >
                            <div class="widget-controls">
                                <button
                                    class="widget-size-toggle"
                                    title="調整大小"
                                >
                                    3
                                </button>
                                <button
                                    class="widget-remove-btn"
                                    title="移除小工具"
                                >
                                    <i class="fa-solid fa-xmark"></i>
                                </button>
                            </div>
                            <div class="widget-header">
                                天氣
                                <span id="weather-location" class="small"
                                    >台北市</span
                                >
                            </div>
                            <div class="widget-body">
                                <div class="weather-controls">
                                    <input
                                        id="weather-city-input"
                                        type="text"
                                        aria-label="城市"
                                        placeholder="城市 (例如：Taipei / 台北)"
                                    />
                                    <button
                                        id="weather-refresh"
                                        aria-label="刷新天氣"
                                        title="刷新"
                                    >
                                        <i class="fa-solid fa-rotate-right"></i>
                                    </button>
                                    <button
                                        id="weather-geolocate"
                                        aria-label="使用定位"
                                        title="使用定位"
                                    >
                                        <i
                                            class="fa-solid fa-location-crosshairs"
                                        ></i>
                                    </button>
                                </div>
                                <div class="weather-main">
                                    <div class="weather-visual">
                                        <i
                                            id="weather-icon"
                                            class="fa-solid fa-cloud-sun"
                                        ></i>
                                    </div>
                                    <div class="weather-info">
                                        <div class="temp" id="weather-temp">
                                            --°C
                                        </div>
                                        <div class="desc" id="weather-desc">
                                            載入中...
                                        </div>
                                        <div class="meta">
                                            <span
                                                class="weather-humidity"
                                                id="weather-humidity"
                                            ></span>
                                            <span
                                                class="weather-feels"
                                                id="weather-feels"
                                            ></span>
                                            <span
                                                class="weather-updated"
                                                id="weather-updated"
                                                style="
                                                    margin-left: 8px;
                                                    color: #9aa;
                                                    font-size: 0.7rem;
                                                "
                                            ></span>
                                        </div>
                                    </div>
                                </div>
                                <div
                                    class="weather-forecast"
                                    id="weather-forecast"
                                ></div>
                            </div>
                        </div>

                        <!-- 效能監控小工具 -->
                        <div
                            class="widget performance-widget widget-size-3"
                            id="widget-performance"
                            data-widget-size="3"
                            data-widget-type="performance"
                        >
                            <div class="widget-controls">
                                <button
                                    class="widget-size-toggle"
                                    title="調整大小"
                                >
                                    3
                                </button>
                                <button
                                    class="widget-remove-btn"
                                    title="移除小工具"
                                >
                                    <i class="fa-solid fa-xmark"></i>
                                </button>
                            </div>
                            <div class="widget-header">
                                <i class="fa-solid fa-chart-line"></i> 效能監控
                            </div>
                            <div class="widget-body">
                                <!-- CPU 使用率 -->
                                <div class="perf-section">
                                    <div class="perf-label">
                                        <span class="perf-label-title"
                                            ><i
                                                class="fa-solid fa-microchip"
                                            ></i>
                                            CPU</span
                                        >
                                        <span
                                            class="perf-label-value"
                                            id="perf-cpu-value"
                                            >---%</span
                                        >
                                    </div>
                                    <div class="perf-bar">
                                        <div
                                            class="perf-bar-fill cpu"
                                            id="perf-cpu-bar"
                                            style="width: 0%"
                                        ></div>
                                    </div>
                                </div>

                                <!-- 記憶體使用率 -->
                                <div class="perf-section">
                                    <div class="perf-label">
                                        <span class="perf-label-title"
                                            ><i class="fa-solid fa-memory"></i>
                                            記憶體</span
                                        >
                                        <span
                                            class="perf-label-value"
                                            id="perf-memory-value"
                                            >--- MB</span
                                        >
                                    </div>
                                    <div class="perf-bar">
                                        <div
                                            class="perf-bar-fill memory"
                                            id="perf-memory-bar"
                                            style="width: 0%"
                                        ></div>
                                    </div>
                                </div>

                                <!-- FPS -->
                                <div class="perf-section">
                                    <div class="perf-label">
                                        <span class="perf-label-title"
                                            ><i
                                                class="fa-solid fa-gauge-high"
                                            ></i>
                                            FPS</span
                                        >
                                        <span
                                            class="perf-label-value"
                                            id="perf-fps-value"
                                            >-- fps</span
                                        >
                                    </div>
                                    <div class="perf-bar">
                                        <div
                                            class="perf-bar-fill fps"
                                            id="perf-fps-bar"
                                            style="width: 0%"
                                        ></div>
                                    </div>
                                </div>

                                <!-- 額外統計 -->
                                <div class="perf-stats">
                                    <div class="perf-stat-item">
                                        <span class="perf-stat-label"
                                            >執行時間</span
                                        >
                                        <span
                                            class="perf-stat-value perf-uptime"
                                            id="perf-uptime"
                                            >--:--:--</span
                                        >
                                    </div>
                                    <div class="perf-stat-item">
                                        <span class="perf-stat-label"
                                            >DOM 節點</span
                                        >
                                        <span
                                            class="perf-stat-value perf-dom-nodes"
                                            id="perf-dom-nodes"
                                            >---</span
                                        >
                                    </div>
                                    <div class="perf-stat-item">
                                        <span class="perf-stat-label"
                                            >JS Heap</span
                                        >
                                        <span
                                            class="perf-stat-value perf-js-heap"
                                            id="perf-js-heap"
                                            >--- MB</span
                                        >
                                    </div>
                                    <div class="perf-stat-item">
                                        <span class="perf-stat-label"
                                            >頁面載入</span
                                        >
                                        <span
                                            class="perf-stat-value perf-load-time"
                                            id="perf-load-time"
                                            >--- ms</span
                                        >
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 新聞小工具 -->
                        <div
                            class="widget news-widget widget-size-1"
                            id="widget-news"
                            data-widget-size="1"
                            data-widget-type="news"
                        >
                            <div class="widget-controls">
                                <button
                                    class="widget-size-toggle"
                                    title="調整大小"
                                >
                                    1
                                </button>
                                <button
                                    class="widget-remove-btn"
                                    title="移除小工具"
                                >
                                    <i class="fa-solid fa-xmark"></i>
                                </button>
                            </div>
                            <div class="widget-header">頭條新聞</div>
                            <div class="widget-body">
                                <div class="news-item">
                                    <img
                                        src="https://placehold.co/100x100/333/fff?text=NEWS"
                                        alt="News"
                                    />
                                    <div class="news-item-info">
                                        這是一條模擬的新聞標題...
                                        <span>2 小時前</span>
                                    </div>
                                </div>
                                <div class="news-item">
                                    <img
                                        src="https://placehold.co/100x100/555/fff?text=TECH"
                                        alt="Tech"
                                    />
                                    <div class="news-item-info">
                                        關於網頁技術的最新進展...
                                        <span>3 小時前</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Metro 風格所有程式區域 -->
                    <div class="metro-area">
                        <div class="metro-header">所有程式</div>

                        <!-- 系統工具 -->
                        <div class="metro-category">
                            <div class="metro-category-title">系統工具</div>
                            <div class="metro-grid">
                                <div
                                    class="metro-tile tile-cyan"
                                    data-app="settings"
                                >
                                    <div class="metro-tile-icon">
                                        <i class="fa-solid fa-gear"></i>
                                    </div>
                                    <div class="metro-tile-label">設定</div>
                                </div>
                                <div
                                    class="metro-tile tile-blue"
                                    data-app="explorer"
                                >
                                    <div class="metro-tile-icon">
                                        <i class="fa-solid fa-folder"></i>
                                    </div>
                                    <div class="metro-tile-label">檔案總管</div>
                                </div>
                                <div
                                    class="metro-tile tile-green"
                                    data-app="calculator"
                                >
                                    <div class="metro-tile-icon">
                                        <i class="fa-solid fa-calculator"></i>
                                    </div>
                                    <div class="metro-tile-label">計算機</div>
                                </div>
                            </div>
                        </div>

                        <!-- 應用程式 -->
                        <div class="metro-category">
                            <div class="metro-category-title">應用程式</div>
                            <div class="metro-grid">
                                <div
                                    class="metro-tile wide tile-magenta"
                                    data-app="nagato"
                                >
                                    <div class="metro-tile-icon">
                                        <img
                                            src="assets/apps/icon/NS-V2.png"
                                            alt="長門櫻"
                                        />
                                    </div>
                                    <div class="metro-tile-label">長門櫻</div>
                                </div>
                                <div
                                    class="metro-tile tile-blue"
                                    data-app="browser"
                                >
                                    <div class="metro-tile-icon">
                                        <i class="fa-brands fa-edge"></i>
                                    </div>
                                    <div class="metro-tile-label">瀏覽器</div>
                                </div>
                                <div
                                    class="metro-tile tile-orange"
                                    data-app="store"
                                >
                                    <div class="metro-tile-icon">
                                        <i class="fa-solid fa-store"></i>
                                    </div>
                                    <div class="metro-tile-label">應用商店</div>
                                </div>
                            </div>
                        </div>

                        <!-- 工具 & 遊戲 -->
                        <div class="metro-category">
                            <div class="metro-category-title">更多</div>
                            <div class="metro-grid">
                                <div
                                    class="metro-tile tile-yellow"
                                    data-app="notepad"
                                >
                                    <div class="metro-tile-icon">
                                        <i class="fa-solid fa-file-lines"></i>
                                    </div>
                                    <div class="metro-tile-label">記事本</div>
                                </div>
                                <div
                                    class="metro-tile tile-green"
                                    data-app="terminal"
                                >
                                    <div class="metro-tile-icon">
                                        <i class="fa-solid fa-terminal"></i>
                                    </div>
                                    <div class="metro-tile-label">終端機</div>
                                </div>
                                <div
                                    class="metro-tile tile-orange"
                                    data-app="photos"
                                >
                                    <div class="metro-tile-icon">
                                        <i class="fa-solid fa-image"></i>
                                    </div>
                                    <div class="metro-tile-label">相簿</div>
                                </div>
                                <div
                                    class="metro-tile tile-pink"
                                    data-app="player"
                                >
                                    <div class="metro-tile-icon">
                                        <i class="fa-solid fa-circle-play"></i>
                                    </div>
                                    <div class="metro-tile-label">播放器</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 8. 右鍵選單 (新增) -->
                <div id="context-menu">
                    <div class="context-menu-item">
                        <i class="fa-solid fa-eye"></i> 檢視
                    </div>
                    <div class="context-menu-item">
                        <i class="fa-solid fa-arrow-down-a-z"></i> 排序方式
                    </div>
                    <div class="context-menu-item">
                        <i class="fa-solid fa-rotate-right"></i> 重新整理
                    </div>
                    <div class="context-menu-separator"></div>
                    <div class="context-menu-item">
                        <i class="fa-solid fa-folder-plus"></i> 新增
                    </div>
                    <div class="context-menu-separator"></div>
                    <div class="context-menu-item">
                        <i class="fa-solid fa-display"></i> 顯示設定
                    </div>
                    <div class="context-menu-item">
                        <i class="fa-solid fa-palette"></i> 個人化
                    </div>
                </div>
            </main>

            <!-- 4. 右側設定面板 (使用全域 Settings Panel) -->
            <div class="settings-panel">
                <div class="settings-header">
                    <h2 class="settings-title">系統設定</h2>
                </div>

                <div class="settings-section">
                    <h3 class="settings-section-title">顯示設定</h3>

                    <div class="setting-item">
                        <div class="setting-label">
                            <span>固定導航欄</span>
                            <span class="setting-description"
                                >保持導航欄在頂部固定</span
                            >
                        </div>
                        <div class="toggle-switch" id="headerFixed"></div>
                    </div>

                    <div class="setting-item">
                        <div class="setting-label">
                            <span>導航欄高度</span>
                            <span class="setting-description"
                                >調整頂部導航欄的高度</span
                            >
                        </div>
                        <div class="slider-control">
                            <div class="slider-value" id="headerHeightValue">
                                75px
                            </div>
                            <input
                                type="range"
                                class="slider-range"
                                id="headerHeight"
                                min="50"
                                max="100"
                                value="75"
                                step="5"
                            />
                            <div class="slider-marks">
                                <span data-value="50">小</span>
                                <span data-value="75">中</span>
                                <span data-value="100">大</span>
                            </div>
                        </div>
                    </div>

                    <div class="setting-item">
                        <div class="setting-label">
                            <span>側邊欄文字顯示</span>
                            <span class="setting-description"
                                >是否持續顯示側邊欄文字標題</span
                            >
                        </div>
                        <div
                            class="toggle-switch active"
                            id="sideNavTextVisible"
                        ></div>
                    </div>

                    <div class="setting-item">
                        <div class="setting-label">
                            <span>主題模式</span>
                            <span class="setting-description"
                                >切換深色/淺色模式</span
                            >
                        </div>
                        <div class="select-control">
                            <select id="themeMode">
                                <option value="dark">深色模式</option>
                                <option value="light">淺色模式</option>
                            </select>
                        </div>
                    </div>

                    <div class="setting-item">
                        <div class="setting-label">
                            <span>看板娘 (Live2D)</span>
                            <span class="setting-description">啟用或停用頁面上的 Live2D 看板娘</span>
                        </div>
                        <div class="toggle-switch" id="live2dToggle" role="switch" aria-checked="false" tabindex="0" aria-label="看板娘 (Live2D)"></div>
                    </div>

                    <div class="setting-item">
                        <div class="setting-label">
                            <span>背景樣式</span>
                            <span class="setting-description">選擇背景動畫樣式</span>
                        </div>
                        <div class="select-control">
                            <select id="backgroundStyle" title="背景樣式" aria-label="背景樣式">
                                <option value="dom">粒子風暴</option>
                                <option value="network">網格連線</option>
                                <option value="magnet">磁力連線</option>
                                <option value="star">宇宙星圜</option>
                                <option value="off">關閉</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <h3 class="settings-section-title">效能設定</h3>

                    <div class="setting-item">
                        <div class="setting-label">
                            <span>動畫強度</span>
                            <span class="setting-description"
                                >調整頁面動畫效果強度</span
                            >
                        </div>
                        <div class="slider-control">
                            <div class="slider-value" id="animationValue">
                                強
                            </div>
                            <input
                                type="range"
                                class="slider-range"
                                id="animationStrength"
                                min="0"
                                max="2"
                                value="2"
                                step="1"
                            />
                            <div class="slider-marks">
                                <span data-value="0">關</span>
                                <span data-value="1">低</span>
                                <span data-value="2">強</span>
                            </div>
                        </div>
                    </div>

                    <div class="setting-item fps-monitor">
                        <div class="setting-label">
                            <span>幀數監控</span>
                            <span class="setting-description"
                                >即時顯示頁面渲染幀率</span
                            >
                        </div>
                        <div class="fps-display">
                            <span class="fps-value" id="fpsValue">000</span>
                            <span class="fps-unit">FPS</span>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <h3 class="settings-section-title">音效設定</h3>

                    <div class="setting-item">
                        <div class="setting-label">
                            <span>音效開關</span>
                            <span class="setting-description"
                                >啟用/關閉互動音效</span
                            >
                        </div>
                        <div
                            class="toggle-switch active"
                            id="soundEnabled"
                        ></div>
                    </div>
                </div>
            </div>
        </div>

        <script src="../../assets/js/core.js"></script>
        <script src="../../assets/js/live2d-manager.js"></script>
        <script src="../../assets/js/navigation.js"></script>
        <script src="../../assets/js/animations.js"></script>

        <!-- Calc dependencies: jQuery (for the kernel), Big.js (arbitrary precision), and calculator kernel script -->
        <script
            defer
            src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"
        ></script>
        <script
            defer
            src="https://cdnjs.cloudflare.com/ajax/libs/big.js/6.2.1/big.min.js"
        ></script>

        <script>
            document.addEventListener("DOMContentLoaded", () => {
                // --- 0. 獲取 DOM 元素 ---
                // 修改：獲取模擬器容器
                const simulatorContainer = document.getElementById(
                    "simulator-container-main"
                );

                const bootLoader = document.getElementById("boot-loader");
                const desktop = document.getElementById("desktop");
                const taskbar = document.getElementById("taskbar");
                const startButton = document.getElementById("start-button");
                const startMenu = document.getElementById("start-menu");
                const taskbarTime = document.getElementById("taskbar-time");
                const timeEl = document.getElementById("time");
                const timeAmpmEl = timeEl.querySelector(".ampm");
                const timeValueEl = timeEl.querySelector(".time-value");
                const dateEl = document.getElementById("date");
                const calendarFlyout =
                    document.getElementById("calendar-flyout");
                const calendarGrid = document.getElementById("calendar-grid");
                const calendarMonthYear = document.getElementById(
                    "calendar-month-year"
                );
                const calendarPrev = document.getElementById("calendar-prev");
                const calendarNext = document.getElementById("calendar-next");
                const widgetsButton = document.getElementById("widgets-button");
                const widgetsPanel = document.getElementById("widgets-panel");
                const contextMenu = document.getElementById("context-menu");

                const windows = document.querySelectorAll(".window");
                // Keep a NodeList of pinned icons (static), but we will dynamically create temporary icons for apps opened
                const pinnedTaskbarIcons = document.querySelectorAll(
                    ".taskbar-icon[data-app][data-pinned]"
                );
                function getAllTaskbarIcons() {
                    return document.querySelectorAll(".taskbar-icon[data-app]");
                }
                const desktopIcons = document.querySelectorAll(
                    ".desktop-icon[data-app]"
                );

                let calendarDate = new Date();
                let activeWindow = null;
                let highestZIndex = 1000;

                class Calculator {
                    constructor(inputSelector, keysContainerSelector) {
                        this.eltSelector = inputSelector;
                        this.elt = document.querySelector(inputSelector);
                        this.num1 = null;
                        this.num2 = null;
                        this.keysContainer = document.querySelector(
                            keysContainerSelector
                        );
                        this.operator = 0;
                        this.preview = false;
                    }

                    get_num() {
                        return Big(this.elt.value);
                    }

                    number_key(key) {
                        if (!this.elt) return;
                        if (this.elt.value === "0" || this.preview) {
                            this.elt.value = "";
                            this.preview = false;
                        }
                        this.elt.value += key;
                        this.uncheck();
                    }

                    func_key(key) {
                        if (!this.elt) return;
                        if (!this.isCheck()) {
                            if (this.num1 != null) {
                                this.num2 = Big(this.elt.value);
                                this.num1 = Big(
                                    this._calc(
                                        this.num1,
                                        this.num2,
                                        this.operator
                                    )
                                );
                                this.elt.value = this.num1;
                                this.preview = true;
                            } else {
                                this.num1 = Big(this.elt.value);
                                this.elt.value = this.num1;
                                this.preview = true;
                            }
                        }
                        this.operator = key;
                    }

                    check(elt) {
                        this.uncheck();
                        if (elt) elt.classList.add("checked");
                    }

                    uncheck() {
                        if (!this.keysContainer) return;
                        for (const elt of this.keysContainer.children) {
                            elt.classList.remove("checked");
                        }
                    }

                    isCheck() {
                        if (!this.keysContainer) return false;
                        for (const elt of this.keysContainer.children) {
                            if (elt.classList.contains("checked")) return true;
                        }
                        return false;
                    }

                    point() {
                        if (!this.elt) return;
                        if (this.elt.value === "") this.elt.value = "0";
                        if (!this.elt.value.includes("."))
                            this.elt.value += ".";
                    }

                    square() {
                        if (!this.elt) return;
                        this.elt.value = (
                            Number(this.get_num().toString()) ** 2
                        ).toString();
                    }
                    squareRoot() {
                        if (!this.elt) return;
                        this.elt.value = Math.sqrt(
                            Number(this.get_num().toString())
                        );
                    }

                    backspace() {
                        if (!this.elt) return;
                        if (this.elt.value.length > 0) {
                            this.elt.value = this.elt.value.substring(
                                0,
                                this.elt.value.length - 1
                            );
                        }
                        if (this.elt.value === "") this.elt.value = "0";
                    }

                    clear_num() {
                        if (!this.elt) return;
                        this.elt.value = "0";
                        this.num1 = null;
                        this.num2 = null;
                        this.operator = 0;
                        this.uncheck();
                    }

                    eq() {
                        if (!this.elt) return true;
                        this.uncheck();
                        if (this.operator === 0) return true;
                        this.num2 = Big(this.elt.value);
                        var num = this._calc(
                            this.num1,
                            this.num2,
                            this.operator
                        );
                        this.clear_num();
                        if (num != null) {
                            this.elt.value = num;
                            return true;
                        }
                        // division by zero or other calculation error: show user-friendly error
                        try {
                            this.elt.value = "錯誤";
                            this.preview = true;
                            setTimeout(() => {
                                if (this.elt) this.elt.value = "0";
                            }, 1400);
                        } catch (e) {}
                        return false;
                    }

                    _calc(n1, n2, c) {
                        try {
                            switch (c) {
                                case 1:
                                    return n1.plus(n2).toString();
                                case 2:
                                    return n1.minus(n2).toString();
                                case 3:
                                    return n1.times(n2).toString();
                                case 4:
                                    return n2 != 0
                                        ? n1.div(n2).toString()
                                        : null;
                            }
                        } catch (err) {
                            console.error("Calculation error", err);
                            return null;
                        }
                    }
                }

                // --- Display settings: brightness + nightlight + navbar ---
                const displayBrightness =
                    document.getElementById("displayBrightness");
                const brightnessValue =
                    document.getElementById("brightnessValue");
                const nightLightToggle =
                    document.getElementById("nightLightToggle");
                const hideNavbarToggle =
                    document.getElementById("hideNavbarToggle");
                const pageHeader = document.querySelector("header");
                const mainWrapper = document.querySelector(".main-wrapper");
                const nightlightOverlay =
                    document.getElementById("nightlight-overlay");
                // Subpage controls
                const nightlightItem =
                    document.getElementById("nightlightItem");
                const nightlightSubpage = document.getElementById(
                    "nightlight-settings"
                );
                const nightlightBack =
                    document.getElementById("nightlight-back");
                const nightlightStrength =
                    document.getElementById("nightlightStrength");
                const nightlightStrengthValue = document.getElementById(
                    "nightlightStrengthValue"
                );
                const nightlightScheduleToggle = document.getElementById(
                    "nightlightScheduleToggle"
                );
                const nightlightSubToggle = document.getElementById(
                    "nightlightSubToggle"
                );
                const nightlightStartInput =
                    document.getElementById("nightlightStart");
                const nightlightEndInput =
                    document.getElementById("nightlightEnd");

                const DISPLAY_STORAGE_KEY = "webos_display_settings";
                const PAGE_ID =
                    window.location.pathname
                        .split("/")
                        .pop()
                        .replace(".html", "") || "";
                const PAGE_HIDE_KEY = "webos_hide_nav_" + PAGE_ID; // hide-navbar is per-page for nagato-sakura-webos

                function mapSliderToBrightness(val) {
                    // Map 0..100 slider to 0.6..1.2 brightness range
                    const v = parseFloat(val);
                    const min = 0.6;
                    const max = 1.2;
                    return (min + (v / 100) * (max - min)).toFixed(3);
                }

                function mapSliderToNightlightOpacity(val) {
                    const v = parseFloat(val);
                    const maxOpacity = 0.5; // maximum warm overlay alpha (increased for stronger effect)
                    return ((v / 100) * maxOpacity).toFixed(3);
                }

                function applyDisplaySettings(settings) {
                    const brightVal =
                        settings && typeof settings.brightness !== "undefined"
                            ? settings.brightness
                            : Number(displayBrightness.value || 70);
                    const night = settings && !!settings.nightLight;
                    const nightStrength =
                        settings &&
                        typeof settings.nightlightStrength !== "undefined"
                            ? settings.nightlightStrength
                            : nightlightStrength
                            ? Number(nightlightStrength.value)
                            : 50;
                    const scheduleEnabled =
                        settings && !!settings.nightlightScheduleEnabled;
                    const scheduleStart =
                        settings && settings.nightlightScheduleStart
                            ? settings.nightlightScheduleStart
                            : nightlightStartInput
                            ? nightlightStartInput.value
                            : "22:00";
                    const scheduleEnd =
                        settings && settings.nightlightScheduleEnd
                            ? settings.nightlightScheduleEnd
                            : nightlightEndInput
                            ? nightlightEndInput.value
                            : "06:00";

                    // Update UI controls
                    if (displayBrightness) {
                        displayBrightness.value = brightVal;
                        if (brightnessValue)
                            brightnessValue.textContent = `${brightVal}%`;
                        const bFactor = mapSliderToBrightness(brightVal);
                        document.documentElement.style.setProperty(
                            "--simulator-brightness",
                            bFactor
                        );
                    }

                    if (nightLightToggle && nightlightOverlay) {
                        if (night) {
                            nightLightToggle.classList.add("active");
                            nightLightToggle.setAttribute(
                                "aria-checked",
                                "true"
                            );
                            // use opacity 0.12 as a gentle warm overlay
                            nightlightOverlay.style.opacity = "1";
                            document.documentElement.style.setProperty(
                                "--nightlight-opacity",
                                mapSliderToNightlightOpacity(nightStrength)
                            );
                        } else {
                            nightLightToggle.classList.remove("active");
                            nightLightToggle.setAttribute(
                                "aria-checked",
                                "false"
                            );
                            nightlightOverlay.style.opacity = "0";
                            document.documentElement.style.setProperty(
                                "--nightlight-opacity",
                                "0"
                            );
                        }
                        // sync subpage toggle as well (if present)
                        if (nightlightSubToggle) {
                            if (night) {
                                nightlightSubToggle.classList.add("active");
                                nightlightSubToggle.setAttribute(
                                    "aria-checked",
                                    "true"
                                );
                            } else {
                                nightlightSubToggle.classList.remove("active");
                                nightlightSubToggle.setAttribute(
                                    "aria-checked",
                                    "false"
                                );
                            }
                        }
                    }

                    // Apply strength UI
                    if (nightlightStrength && nightlightStrengthValue) {
                        nightlightStrength.value = nightStrength;
                        nightlightStrengthValue.textContent = `${nightStrength}%`;
                        document.documentElement.style.setProperty(
                            "--nightlight-opacity",
                            mapSliderToNightlightOpacity(nightStrength)
                        );
                    }

                    // Schedule UI
                    if (nightlightScheduleToggle) {
                        if (scheduleEnabled) {
                            nightlightScheduleToggle.classList.add("active");
                            nightlightScheduleToggle.setAttribute(
                                "aria-checked",
                                "true"
                            );
                            if (nightlightStartInput && nightlightEndInput) {
                                nightlightStartInput.value = scheduleStart;
                                nightlightEndInput.value = scheduleEnd;
                            }
                            if (
                                document.getElementById(
                                    "nightlight-schedule-controls"
                                )
                            )
                                document.getElementById(
                                    "nightlight-schedule-controls"
                                ).style.display = "block";
                        } else {
                            nightlightScheduleToggle.classList.remove("active");
                            nightlightScheduleToggle.setAttribute(
                                "aria-checked",
                                "false"
                            );
                            if (
                                document.getElementById(
                                    "nightlight-schedule-controls"
                                )
                            )
                                document.getElementById(
                                    "nightlight-schedule-controls"
                                ).style.display = "none";
                        }
                    }

                    // Apply navbar visibility (scoped to this page)
                    const storedPageHide = localStorage.getItem(PAGE_HIDE_KEY);
                    let hideNav;
                    if (storedPageHide !== null) {
                        hideNav = storedPageHide === "true";
                    } else {
                        hideNav = settings && !!settings.hideNavbar;
                    }

                    if (hideNavbarToggle) {
                        if (hideNav) {
                            hideNavbarToggle.classList.add("active");
                            hideNavbarToggle.setAttribute(
                                "aria-checked",
                                "true"
                            );
                        } else {
                            hideNavbarToggle.classList.remove("active");
                            hideNavbarToggle.setAttribute(
                                "aria-checked",
                                "false"
                            );
                        }
                    }
                    applyNavbarVisibility(hideNav);
                }

                // 導航欄顯示/隱藏控制
                function applyNavbarVisibility(hide) {
                    if (pageHeader) {
                        if (hide) {
                            pageHeader.style.height = "0";
                            pageHeader.style.minHeight = "0";
                            pageHeader.style.overflow = "hidden";
                            pageHeader.style.padding = "0";
                            pageHeader.style.borderBottom = "none";
                        } else {
                            pageHeader.style.height = "";
                            pageHeader.style.minHeight = "";
                            pageHeader.style.overflow = "";
                            pageHeader.style.padding = "";
                            pageHeader.style.borderBottom = "";
                        }
                    }
                    // 調整主內容區的 margin-top
                    if (mainWrapper) {
                        mainWrapper.style.marginTop = hide ? "0" : "";
                        mainWrapper.style.minHeight = hide ? "100vh" : "";
                    }
                    // 更新 CSS 變數
                    document.documentElement.style.setProperty(
                        "--header-height",
                        hide ? "0px" : "60px"
                    );
                }

                function saveDisplaySettings() {
                    const settings = {
                        brightness: Number(
                            displayBrightness ? displayBrightness.value : 70
                        ),
                        nightLight: nightLightToggle
                            ? nightLightToggle.classList.contains("active")
                            : false,
                        nightlightStrength: nightlightStrength
                            ? Number(nightlightStrength.value)
                            : 50,
                        nightlightScheduleEnabled: nightlightScheduleToggle
                            ? nightlightScheduleToggle.classList.contains(
                                  "active"
                              )
                            : false,
                        nightlightScheduleStart: nightlightStartInput
                            ? nightlightStartInput.value
                            : "22:00",
                        nightlightScheduleEnd: nightlightEndInput
                            ? nightlightEndInput.value
                            : "06:00",
                        hideNavbar: hideNavbarToggle
                            ? hideNavbarToggle.classList.contains("active")
                            : false,
                    };
                    try {
                        localStorage.setItem(
                            DISPLAY_STORAGE_KEY,
                            JSON.stringify(settings)
                        );
                        // 存取 hideNavbar 為每頁設定，避免影響其他頁面
                        try {
                            localStorage.setItem(
                                PAGE_HIDE_KEY,
                                settings.hideNavbar ? "true" : "false"
                            );
                        } catch (e) {
                            /* ignore */
                        }
                    } catch (e) {
                        /* ignore */
                    }
                }

                // Initialize from localStorage
                try {
                    const saved = JSON.parse(
                        localStorage.getItem(DISPLAY_STORAGE_KEY) || "null"
                    );
                    applyDisplaySettings(saved || null);
                } catch (err) {
                    applyDisplaySettings(null);
                }
                // Apply schedule immediately on load in case scheduling should enable/disable nightlight
                try {
                    applyScheduleIfNeeded();
                } catch (e) {
                    /* ignore */
                }

                // Hook up brightness slider
                if (displayBrightness) {
                    displayBrightness.addEventListener("input", (e) => {
                        const val = e.target.value;
                        if (brightnessValue)
                            brightnessValue.textContent = `${val}%`;
                        const bFactor = mapSliderToBrightness(val);
                        document.documentElement.style.setProperty(
                            "--simulator-brightness",
                            bFactor
                        );
                        saveDisplaySettings();
                    });
                }

                // Hook up nightlight toggle
                if (nightLightToggle) {
                    nightLightToggle.addEventListener("click", (e) => {
                        const enabled =
                            nightLightToggle.classList.toggle("active");
                        nightLightToggle.setAttribute(
                            "aria-checked",
                            enabled ? "true" : "false"
                        );
                        if (nightlightOverlay) {
                            if (enabled) {
                                nightlightOverlay.style.opacity = "1";
                                const curr = nightlightStrength
                                    ? nightlightStrength.value
                                    : 50;
                                document.documentElement.style.setProperty(
                                    "--nightlight-opacity",
                                    mapSliderToNightlightOpacity(curr)
                                );
                                // sync sub toggle
                                if (nightlightSubToggle) {
                                    nightlightSubToggle.classList.add("active");
                                    nightlightSubToggle.setAttribute(
                                        "aria-checked",
                                        "true"
                                    );
                                }
                            } else {
                                nightlightOverlay.style.opacity = "0";
                                document.documentElement.style.setProperty(
                                    "--nightlight-opacity",
                                    "0"
                                );
                                // sync sub toggle
                                if (nightlightSubToggle) {
                                    nightlightSubToggle.classList.remove(
                                        "active"
                                    );
                                    nightlightSubToggle.setAttribute(
                                        "aria-checked",
                                        "false"
                                    );
                                }
                            }
                        }
                        saveDisplaySettings();
                    });
                    nightLightToggle.addEventListener("keydown", (e) => {
                        if (e.key === " " || e.key === "Enter") {
                            e.preventDefault();
                            nightLightToggle.click();
                        }
                    });
                }

                // Hook up navbar toggle
                if (hideNavbarToggle) {
                    hideNavbarToggle.addEventListener("click", (e) => {
                        const hidden =
                            hideNavbarToggle.classList.toggle("active");
                        hideNavbarToggle.setAttribute(
                            "aria-checked",
                            hidden ? "true" : "false"
                        );
                        applyNavbarVisibility(hidden);
                        saveDisplaySettings();
                    });
                    hideNavbarToggle.addEventListener("keydown", (e) => {
                        if (e.key === " " || e.key === "Enter") {
                            e.preventDefault();
                            hideNavbarToggle.click();
                        }
                    });
                }

                // Subpage toggle: synchronize with main nightLightToggle
                if (nightlightSubToggle) {
                    // initial sync
                    if (
                        nightLightToggle &&
                        nightLightToggle.classList.contains("active")
                    ) {
                        nightlightSubToggle.classList.add("active");
                        nightlightSubToggle.setAttribute(
                            "aria-checked",
                            "true"
                        );
                    }
                    nightlightSubToggle.addEventListener("click", () => {
                        const enabled =
                            nightlightSubToggle.classList.toggle("active");
                        nightlightSubToggle.setAttribute(
                            "aria-checked",
                            enabled ? "true" : "false"
                        );
                        // propagate to main toggle
                        if (nightLightToggle) {
                            if (enabled)
                                nightLightToggle.classList.add("active");
                            else nightLightToggle.classList.remove("active");
                            nightLightToggle.setAttribute(
                                "aria-checked",
                                enabled ? "true" : "false"
                            );
                        }
                        if (nightlightOverlay) {
                            if (enabled) {
                                nightlightOverlay.style.opacity = "1";
                                const curr = nightlightStrength
                                    ? nightlightStrength.value
                                    : 50;
                                document.documentElement.style.setProperty(
                                    "--nightlight-opacity",
                                    mapSliderToNightlightOpacity(curr)
                                );
                            } else {
                                nightlightOverlay.style.opacity = "0";
                                document.documentElement.style.setProperty(
                                    "--nightlight-opacity",
                                    "0"
                                );
                            }
                        }
                        saveDisplaySettings();
                    });
                    nightlightSubToggle.addEventListener("keydown", (e) => {
                        if (e.key === " " || e.key === "Enter") {
                            e.preventDefault();
                            nightlightSubToggle.click();
                        }
                    });
                }

                // Page switching helpers
                const settingsMenuItems = Array.from(
                    document.querySelectorAll(".settings-menu-item[data-page]")
                );
                const settingsPages = Array.from(
                    document.querySelectorAll(".settings-page")
                );
                function switchSettingsPage(pageId) {
                    // Hide other pages and subpages
                    settingsPages.forEach((p) => {
                        p.classList.remove("active");
                        p.style.display = "none";
                    });
                    const allSubpages = Array.from(
                        document.querySelectorAll(".settings-subpage")
                    );
                    allSubpages.forEach((s) => {
                        s.style.display = "none";
                        s.classList.remove("active");
                    });
                    settingsMenuItems.forEach((mi) =>
                        mi.classList.remove("active")
                    );
                    const target = document.getElementById(pageId);
                    if (target) {
                        target.classList.add("active");
                        target.style.display = "block";
                    }
                    const menuMatch = settingsMenuItems.find(
                        (mi) => mi.dataset.page === pageId
                    );
                    if (menuMatch) menuMatch.classList.add("active");
                    // Restore all sections in case a subpage hid them (e.g., background/font/nightlight)
                    try {
                        Array.from(
                            document.querySelectorAll(".setting-section")
                        ).forEach((s) => {
                            s.style.display = "block";
                            try {
                                const hdr = s.querySelector("h3");
                                if (hdr) hdr.style.display = "";
                            } catch (e) {}
                            try {
                                const items =
                                    s.querySelectorAll(".setting-item");
                                items.forEach((i) => {
                                    i.style.display = "";
                                });
                            } catch (e) {}
                        });
                    } catch (e) {}
                    // Ensure specific panels are closed (in case we navigated while they were open)
                    try {
                        const bgPanel = document.getElementById(
                            "personalization_background_panel"
                        );
                        if (bgPanel) {
                            bgPanel.style.display = "none";
                            bgPanel.classList.remove("active");
                        }
                    } catch (e) {}
                    try {
                        const fontPanel = document.getElementById(
                            "personalization_font_panel"
                        );
                        if (fontPanel) {
                            fontPanel.style.display = "none";
                            fontPanel.classList.remove("active");
                        }
                    } catch (e) {}
                    try {
                        const windowPanel = document.getElementById(
                            "personalization_window_panel"
                        );
                        if (windowPanel) {
                            windowPanel.style.display = "none";
                            windowPanel.classList.remove("active");
                        }
                    } catch (e) {}
                    try {
                        const nightPanel = document.getElementById(
                            "nightlight-settings"
                        );
                        if (nightPanel) nightPanel.style.display = "none";
                    } catch (e) {}
                }

                // Show / open Nightlight subpage when clicking the setting item (not the toggle)
                if (nightlightItem && nightlightSubpage) {
                    const displayPage = document.getElementById("page-display");
                    const displaySections = displayPage
                        ? Array.from(
                              displayPage.querySelectorAll(".setting-section")
                          )
                        : [];
                    function openNightlightSubpage() {
                        // Hide display's sections instead of the whole page (to keep subpage visible)
                        displaySections.forEach(
                            (s) => (s.style.display = "none")
                        );
                        nightlightSubpage.style.display = "block";
                        nightlightSubpage.classList.add("active");
                    }
                    function closeNightlightSubpage() {
                        nightlightSubpage.style.display = "none";
                        nightlightSubpage.classList.remove("active");
                        // Restore display sections
                        displaySections.forEach(
                            (s) => (s.style.display = "block")
                        );
                    }
                    nightlightItem.addEventListener("click", (e) => {
                        // if clicked on the toggle or on interactive elements inside, ignore — toggle handled separately
                        if (
                            e.target === nightLightToggle ||
                            nightLightToggle.contains(e.target)
                        )
                            return;
                        openNightlightSubpage();
                    });
                    nightlightItem.addEventListener("keydown", (e) => {
                        if (e.key === "Enter" || e.key === " ") {
                            e.preventDefault();
                            nightlightItem.click();
                        }
                    });
                    // Back button
                    if (nightlightBack) {
                        nightlightBack.addEventListener("click", (e) => {
                            e.preventDefault();
                            closeNightlightSubpage();
                        });
                    }
                }
                // Sidebar click: switch between settings pages
                settingsMenuItems.forEach((mi) => {
                    mi.addEventListener("click", (e) => {
                        const page = mi.dataset.page;
                        if (!page) return;
                        switchSettingsPage(page);
                    });
                    mi.addEventListener("keydown", (e) => {
                        if (e.key === "Enter" || e.key === " ") {
                            e.preventDefault();
                            mi.click();
                        }
                    });
                });
                // initialize with the display page selected
                try {
                    switchSettingsPage("page-display");
                } catch (e) {
                    /* ignore */
                }

                // Nightlight strength slider
                if (nightlightStrength) {
                    nightlightStrength.addEventListener("input", (e) => {
                        const val = e.target.value;
                        if (nightlightStrengthValue)
                            nightlightStrengthValue.textContent = `${val}%`;
                        const opacity = mapSliderToNightlightOpacity(val);
                        document.documentElement.style.setProperty(
                            "--nightlight-opacity",
                            opacity
                        );
                        // If toggle on, ensure overlay visible
                        if (
                            nightLightToggle &&
                            nightLightToggle.classList.contains("active")
                        ) {
                            nightlightOverlay.style.opacity = "1";
                        }
                        saveDisplaySettings();
                    });
                }

                // Schedule toggle & controls
                function isTimeInRange(startHHMM, endHHMM, now = new Date()) {
                    if (!startHHMM || !endHHMM) return false;
                    const [sh, sm] = startHHMM.split(":").map(Number);
                    const [eh, em] = endHHMM.split(":").map(Number);
                    const start = new Date(now);
                    start.setHours(sh, sm, 0, 0);
                    const end = new Date(now);
                    end.setHours(eh, em, 0, 0);
                    if (start.getTime() === end.getTime()) return true;
                    if (start < end) {
                        return now >= start && now <= end;
                    } else {
                        // wraps overnight
                        return now >= start || now <= end;
                    }
                }

                function applyScheduleIfNeeded() {
                    try {
                        const raw =
                            localStorage.getItem(DISPLAY_STORAGE_KEY) || "null";
                        const saved = JSON.parse(raw);
                        if (!saved) return;
                        const enabled = !!saved.nightlightScheduleEnabled;
                        const start = saved.nightlightScheduleStart;
                        const end = saved.nightlightScheduleEnd;
                        if (!enabled) return; // nothing to auto-apply
                        const nowShouldBeOn = isTimeInRange(
                            start,
                            end,
                            new Date()
                        );
                        if (
                            nightLightToggle &&
                            nightLightToggle.classList.contains("active") !==
                                nowShouldBeOn
                        ) {
                            if (nowShouldBeOn) {
                                nightLightToggle.classList.add("active");
                                nightLightToggle.setAttribute(
                                    "aria-checked",
                                    "true"
                                );
                                nightlightOverlay.style.opacity = "1";
                                // ensure CSS property set according to strength
                                const curr = nightlightStrength
                                    ? nightlightStrength.value
                                    : 50;
                                document.documentElement.style.setProperty(
                                    "--nightlight-opacity",
                                    mapSliderToNightlightOpacity(curr)
                                );
                                if (nightlightSubToggle) {
                                    nightlightSubToggle.classList.add("active");
                                    nightlightSubToggle.setAttribute(
                                        "aria-checked",
                                        "true"
                                    );
                                }
                                saveDisplaySettings();
                            } else {
                                nightLightToggle.classList.remove("active");
                                nightLightToggle.setAttribute(
                                    "aria-checked",
                                    "false"
                                );
                                nightlightOverlay.style.opacity = "0";
                                if (nightlightSubToggle) {
                                    nightlightSubToggle.classList.remove(
                                        "active"
                                    );
                                    nightlightSubToggle.setAttribute(
                                        "aria-checked",
                                        "false"
                                    );
                                }
                                saveDisplaySettings();
                            }
                        }
                    } catch (err) {
                        /* ignore errors */
                    }
                }

                if (nightlightScheduleToggle) {
                    nightlightScheduleToggle.addEventListener("click", () => {
                        const enabled =
                            nightlightScheduleToggle.classList.toggle("active");
                        nightlightScheduleToggle.setAttribute(
                            "aria-checked",
                            enabled ? "true" : "false"
                        );
                        if (
                            document.getElementById(
                                "nightlight-schedule-controls"
                            )
                        )
                            document.getElementById(
                                "nightlight-schedule-controls"
                            ).style.display = enabled ? "block" : "none";
                        saveDisplaySettings();
                        if (enabled) applyScheduleIfNeeded();
                    });
                    nightlightScheduleToggle.addEventListener(
                        "keydown",
                        (e) => {
                            if (e.key === " " || e.key === "Enter") {
                                e.preventDefault();
                                nightlightScheduleToggle.click();
                            }
                        }
                    );
                }

                if (nightlightStartInput)
                    nightlightStartInput.addEventListener("change", () => {
                        saveDisplaySettings();
                        if (
                            nightlightScheduleToggle &&
                            nightlightScheduleToggle.classList.contains(
                                "active"
                            )
                        )
                            applyScheduleIfNeeded();
                    });
                if (nightlightEndInput)
                    nightlightEndInput.addEventListener("change", () => {
                        saveDisplaySettings();
                        if (
                            nightlightScheduleToggle &&
                            nightlightScheduleToggle.classList.contains(
                                "active"
                            )
                        )
                            applyScheduleIfNeeded();
                    });

                // Check schedule every minute
                setInterval(applyScheduleIfNeeded, 60 * 1000);

                // --- Personalization (背景/主題/色彩/開始/工作列/字型) ---
                const PERSONALIZATION_STORAGE_KEY = "webos_personalization_v1";
                const personalizationControls = {
                    themeMode: document.getElementById(
                        "personalization_themeMode"
                    ),
                    accentColor: document.getElementById(
                        "personalization_accentColor"
                    ),
                    backgroundMode: document.getElementById(
                        "personalization_backgroundMode"
                    ),
                    bgColor: document.getElementById("personalization_bgColor"),
                    bgImageUrl: document.getElementById(
                        "personalization_bgImageUrl"
                    ),
                    bgVideoUrl: document.getElementById(
                        "personalization_bgVideoUrl"
                    ),
                    bgVideoUpload: document.getElementById(
                        "personalization_bgVideoUpload"
                    ),
                    bgVideoUploadFile: document.getElementById(
                        "personalization_bgVideoUploadFile"
                    ),
                    bgVideoThumbs: document.getElementById(
                        "personalization_bgVideoThumbs"
                    ),
                    bgReset: document.getElementById("personalization_bgReset"),
                    bgPreview: document.getElementById(
                        "personalization_bgPreview"
                    ),
                    bgBrightness: document.getElementById(
                        "personalization_bgBrightness"
                    ),
                    bgBrightnessValue: document.getElementById(
                        "personalization_bgBrightnessValue"
                    ),
                    bgGradientStart: document.getElementById(
                        "personalization_bgGradient_start"
                    ),
                    bgGradientEnd: document.getElementById(
                        "personalization_bgGradient_end"
                    ),
                    startShowSuggested: document.getElementById(
                        "personalization_startShowSuggested"
                    ),
                    startShowRecent: document.getElementById(
                        "personalization_startShowRecent"
                    ),
                    taskbarPosition: document.getElementById(
                        "personalization_taskbarPosition"
                    ),
                    taskbarIconSize: document.getElementById(
                        "personalization_taskbarIconSize"
                    ),
                    taskbarIconSizeValue: document.getElementById(
                        "personalization_taskbarIconSizeValue"
                    ),
                    fontSet: document.getElementById("personalization_fontSet"),
                    fontSetPanel: document.getElementById(
                        "personalization_fontSet_panel"
                    ),
                    // Prefer the main control if present, otherwise fallback to panel control
                    fontScale:
                        document.getElementById("personalization_fontScale") ||
                        document.getElementById(
                            "personalization_fontScale_panel"
                        ),
                    fontScalePanel: document.getElementById(
                        "personalization_fontScale_panel"
                    ),
                    fontScaleValue:
                        document.getElementById(
                            "personalization_fontScaleValue"
                        ) ||
                        document.getElementById(
                            "personalization_fontScaleValue_panel"
                        ),
                    // Window transparency controls
                    windowTransparent: document.getElementById(
                        "personalization_windowTransparent"
                    ),
                    windowOpacity: document.getElementById(
                        "personalization_windowOpacity"
                    ),
                    windowOpacityValue: document.getElementById(
                        "personalization_windowOpacityValue"
                    ),
                    windowOpacityItem: document.getElementById(
                        "personalization_windowOpacity_item"
                    ),
                    windowStyle: document.getElementById(
                        "personalization_windowStyle"
                    ),
                    windowStyleItem: document.getElementById(
                        "personalization_windowStyle_item"
                    ),
                    windowBlur: document.getElementById(
                        "personalization_windowBlur"
                    ),
                    windowBlurValue: document.getElementById(
                        "personalization_windowBlurValue"
                    ),
                    windowBlurItem: document.getElementById(
                        "personalization_windowBlur_item"
                    ),
                    // Window subpage controls
                    windowPanel: document.getElementById(
                        "personalization_window_panel"
                    ),
                    windowBack: document.getElementById(
                        "personalization_window_back"
                    ),
                    windowTransparentSub: document.getElementById(
                        "personalization_windowTransparentSub"
                    ),
                };

                // Remember last applied background (mode and value) so we don't re-run fades for identical values
                let _lastBackgroundMode = null;
                let _lastBackgroundValue = null;
                // If user uploads a local video via File -> ObjectURL, track it so we can revoke it on reset
                let _lastBackgroundVideoObjectUrl = null;

                const DEFAULT_PERSONALIZATION = {
                    theme: "dark",
                    accentColor:
                        getComputedStyle(document.documentElement)
                            .getPropertyValue("--primary-cyan")
                            .trim() || "#00d4ff",
                    backgroundMode: "default",
                    backgroundColor: "#0a0a0f",
                    backgroundImageURL: "",
                    backgroundVideoURL: "",
                    backgroundGradientStart: "#00ffff",
                    backgroundGradientEnd: "#ff69b4",
                    startSuggested: true,
                    startRecent: true,
                    taskbarPosition: "center",
                    taskbarIconSize: 24,
                    fontSet: "default",
                    fontScale: 100,
                    backgroundBrightness: 100,
                    windowTransparent: true,
                    windowOpacity: 90,
                    windowStyle: "transparent",
                    windowBlur: 20,
                };

                // Helper: Fade the background for a smooth appearance when switching to image backgrounds
                function fadeSetBackground(el, bgValue) {
                    if (!el) return;
                    try {
                        // Skip if the background hasn't actually changed (avoids unnecessary fade)
                        if (bgValue === _lastBackgroundValue) return;
                        // If document is not visible (e.g., tab background), avoid animation and set immediately
                        if (
                            typeof document !== "undefined" &&
                            document.hidden
                        ) {
                            el.style.background = bgValue;
                            _lastBackgroundValue = bgValue;
                            _lastBackgroundMode = "image";
                            return;
                        }
                        // Prefer to only fade the background layer (desktop-bg) or the desktop element itself
                        const prevTransition = el.style.transition || "";
                        // Ensure opacity transition is available
                        el.style.transition = prevTransition.includes("opacity")
                            ? prevTransition
                            : prevTransition +
                              (prevTransition ? ", " : "") +
                              "opacity 0.32s ease";
                        // fade out
                        el.style.opacity = "0";
                        // After the fade out completes (or short delay), apply the background and fade in
                        // Use a timeout small enough to let opacity animate out
                        setTimeout(() => {
                            el.style.background = bgValue;
                            // force reflow then fade back in
                            // eslint-disable-next-line no-unused-expressions
                            void el.offsetWidth;
                            el.style.opacity = "1";
                        }, 120);
                        // update cached value and mode (image)
                        _lastBackgroundValue = bgValue;
                        _lastBackgroundMode = "image";
                    } catch (e) {
                        try {
                            el.style.background = bgValue;
                            _lastBackgroundValue = bgValue;
                        } catch (err) {}
                    }
                }

                function applyPersonalizationSettings(settings) {
                    const s = Object.assign(
                        {},
                        DEFAULT_PERSONALIZATION,
                        settings || {}
                    );
                    // Theme
                    if (s.theme) {
                        document.documentElement.setAttribute(
                            "data-theme",
                            s.theme
                        );
                        // 根據主題模式重置相關 CSS 變數
                        if (s.theme === "light") {
                            document.documentElement.style.setProperty(
                                "--text",
                                "#1a1a1a"
                            );
                            document.documentElement.style.setProperty(
                                "--dark-bg",
                                "#f5f5f7"
                            );
                            document.documentElement.style.setProperty(
                                "--darker-bg",
                                "#e8e8ec"
                            );
                            document.documentElement.style.setProperty(
                                "--mica-bg",
                                "rgba(255, 255, 255, 0.85)"
                            );
                            document.documentElement.style.setProperty(
                                "--mica-bg-light",
                                "rgba(255, 255, 255, 0.9)"
                            );
                            document.documentElement.style.setProperty(
                                "--mica-bg-dark",
                                "rgba(245, 245, 247, 0.92)"
                            );
                            document.documentElement.style.setProperty(
                                "--card",
                                "rgba(0, 0, 0, 0.03)"
                            );
                            document.documentElement.style.setProperty(
                                "--bd",
                                "rgba(0, 0, 0, 0.1)"
                            );
                            document.documentElement.style.setProperty(
                                "--s3d",
                                "rgba(0, 0, 0, 0.15)"
                            );
                            document.documentElement.style.setProperty(
                                "--mm",
                                "rgba(0, 160, 200, 0.12)"
                            );
                            document.body.style.color = "#1a1a1a";
                        } else {
                            // 深色模式 - 恢復原始設定
                            document.documentElement.style.setProperty(
                                "--text",
                                "#e6e6e6"
                            );
                            document.documentElement.style.setProperty(
                                "--dark-bg",
                                "#0a0a0f"
                            );
                            document.documentElement.style.setProperty(
                                "--darker-bg",
                                "#050507"
                            );
                            document.documentElement.style.setProperty(
                                "--mica-bg",
                                "rgba(30, 30, 45, 0.7)"
                            );
                            document.documentElement.style.setProperty(
                                "--mica-bg-light",
                                "rgba(45, 45, 60, 0.7)"
                            );
                            document.documentElement.style.setProperty(
                                "--mica-bg-dark",
                                "rgba(20, 20, 30, 0.8)"
                            );
                            document.documentElement.style.setProperty(
                                "--card",
                                "rgba(255,255,255,0.03)"
                            );
                            document.documentElement.style.setProperty(
                                "--bd",
                                "rgba(0,0,0,0.2)"
                            );
                            document.documentElement.style.setProperty(
                                "--s3d",
                                "rgba(0,0,0,0.35)"
                            );
                            document.documentElement.style.setProperty(
                                "--mm",
                                "rgba(0,212,255,0.14)"
                            );
                            document.body.style.color = "#f0f0f0";
                        }
                    }
                    // Accent color
                    if (s.accentColor && s.accentColor !== "#00d4ff") {
                        // 只有當用戶設定了非預設的強調色時才覆蓋
                        document.documentElement.style.setProperty(
                            "--primary-cyan",
                            s.accentColor
                        );
                        try {
                            updateAccentPreviews(s.accentColor);
                        } catch (err) {}
                    } else {
                        // 恢復預設強調色
                        document.documentElement.style.setProperty(
                            "--primary-cyan",
                            "#00d4ff"
                        );
                        document.documentElement.style.setProperty(
                            "--primary-magenta",
                            "#ff0080"
                        );
                        try {
                            updateAccentPreviews("#00d4ff");
                        } catch (err) {}
                    }
                    // Background
                    const sc = simulatorContainer;
                    const deskEl = document.getElementById("desktop");
                    const desktopBgEl = document.getElementById("desktop-bg");
                    if (s.backgroundMode === "default") {
                        // 根據主題選擇預設背景
                        const bgDefaultDark =
                            "radial-gradient(ellipse at bottom, #0a192f 0%, #05080f 100%)";
                        const bgDefaultLight =
                            "linear-gradient(135deg, #e8f4f8 0%, #d4e6ed 50%, #c8dce6 100%)";
                        const bgDefault =
                            s.theme === "light"
                                ? bgDefaultLight
                                : bgDefaultDark;
                        if (desktopBgEl) {
                            if (
                                _lastBackgroundMode !== "default" ||
                                _lastBackgroundValue !== bgDefault
                            ) {
                                desktopBgEl.style.background = bgDefault;
                                _lastBackgroundMode = "default";
                                _lastBackgroundValue = bgDefault;
                            }
                            if (sc) sc.style.background = "none";
                            if (deskEl) deskEl.style.background = "none";
                        } else {
                            if (
                                sc &&
                                (_lastBackgroundMode !== "default" ||
                                    _lastBackgroundValue !== bgDefault)
                            ) {
                                sc.style.background = bgDefault;
                                _lastBackgroundMode = "default";
                                _lastBackgroundValue = bgDefault;
                            }
                            if (
                                deskEl &&
                                (_lastBackgroundMode !== "default" ||
                                    _lastBackgroundValue !== bgDefault)
                            ) {
                                deskEl.style.background = bgDefault;
                                _lastBackgroundMode = "default";
                                _lastBackgroundValue = bgDefault;
                            }
                        }
                    } else if (s.backgroundMode === "gradient") {
                        const gs = s.backgroundGradientStart || "#00ffff";
                        const ge = s.backgroundGradientEnd || "#ff69b4";
                        const bgG = `linear-gradient(135deg, ${gs} 0%, ${ge} 100%)`;
                        if (desktopBgEl) {
                            if (
                                _lastBackgroundMode !== "gradient" ||
                                _lastBackgroundValue !== bgG
                            ) {
                                desktopBgEl.style.background = bgG;
                                _lastBackgroundMode = "gradient";
                                _lastBackgroundValue = bgG;
                            }
                            if (sc) sc.style.background = "none";
                            if (deskEl) deskEl.style.background = "none";
                        } else {
                            if (
                                sc &&
                                (_lastBackgroundMode !== "gradient" ||
                                    _lastBackgroundValue !== bgG)
                            ) {
                                sc.style.background = bgG;
                                _lastBackgroundMode = "gradient";
                                _lastBackgroundValue = bgG;
                            }
                            if (
                                deskEl &&
                                (_lastBackgroundMode !== "gradient" ||
                                    _lastBackgroundValue !== bgG)
                            ) {
                                deskEl.style.background = bgG;
                                _lastBackgroundMode = "gradient";
                                _lastBackgroundValue = bgG;
                            }
                        }
                    } else if (s.backgroundMode === "solid") {
                        const bgSolid = s.backgroundColor || "#0a0a0f";
                        if (desktopBgEl) {
                            if (
                                _lastBackgroundMode !== "solid" ||
                                _lastBackgroundValue !== bgSolid
                            ) {
                                desktopBgEl.style.background = bgSolid;
                                _lastBackgroundMode = "solid";
                                _lastBackgroundValue = bgSolid;
                            }
                            if (sc) sc.style.background = "none";
                            if (deskEl) deskEl.style.background = "none";
                        } else {
                            if (
                                sc &&
                                (_lastBackgroundMode !== "solid" ||
                                    _lastBackgroundValue !== bgSolid)
                            ) {
                                sc.style.background = bgSolid;
                                _lastBackgroundMode = "solid";
                                _lastBackgroundValue = bgSolid;
                            }
                            if (
                                deskEl &&
                                (_lastBackgroundMode !== "solid" ||
                                    _lastBackgroundValue !== bgSolid)
                            ) {
                                deskEl.style.background = bgSolid;
                                _lastBackgroundMode = "solid";
                                _lastBackgroundValue = bgSolid;
                            }
                        }
                    } else if (
                        s.backgroundMode === "image" &&
                        s.backgroundImageURL
                    ) {
                        const bgImageUrl = `url('${s.backgroundImageURL}') center/cover no-repeat`;
                        if (desktopBgEl) {
                            fadeSetBackground(desktopBgEl, bgImageUrl);
                            if (sc) sc.style.background = "none";
                            if (deskEl) deskEl.style.background = "none";
                        } else if (deskEl) {
                            // Fallback: set desktop background directly without fading to avoid fading out UI elements
                            if (
                                _lastBackgroundMode !== "image" ||
                                _lastBackgroundValue !== bgImageUrl
                            ) {
                                deskEl.style.background = bgImageUrl;
                                _lastBackgroundMode = "image";
                                _lastBackgroundValue = bgImageUrl;
                            }
                            if (sc) sc.style.background = "none";
                        } else if (sc) {
                            // Fallback: just set the simulator container background (no fade)
                            if (
                                _lastBackgroundMode !== "image" ||
                                _lastBackgroundValue !== bgImageUrl
                            ) {
                                sc.style.background = bgImageUrl;
                                _lastBackgroundMode = "image";
                                _lastBackgroundValue = bgImageUrl;
                            }
                        }
                    } else if (
                        s.backgroundMode === "video" &&
                        s.backgroundVideoURL
                    ) {
                        const videoEl =
                            document.getElementById("desktop-video");
                        if (videoEl) {
                            try {
                                // If the value hasn't changed, do nothing
                                if (
                                    _lastBackgroundMode !== "video" ||
                                    _lastBackgroundValue !==
                                        s.backgroundVideoURL
                                ) {
                                    // Pause & clear src when switching types to avoid audio or network overlap
                                    try {
                                        if (!videoEl.paused) videoEl.pause();
                                    } catch (e) {}
                                    videoEl.src = s.backgroundVideoURL;
                                    videoEl.muted = true;
                                    videoEl.loop = true;
                                    videoEl.setAttribute("playsinline", "");
                                    // Ensure it updates brightness from var
                                    // Keep brightness controlled via CSS var --background-brightness
                                    videoEl.style.display = "";
                                    try {
                                        videoEl.play().catch((e) => {});
                                    } catch (e) {}
                                    // fade in video background
                                    void videoEl.offsetWidth; // reflow
                                    videoEl.style.opacity = "1";
                                    _lastBackgroundMode = "video";
                                    _lastBackgroundValue = s.backgroundVideoURL;
                                }
                            } catch (err) {
                                console.warn(
                                    "Failed to apply video background",
                                    err
                                );
                            }
                        }
                        if (desktopBgEl) desktopBgEl.style.background = "none";
                        if (sc) sc.style.background = "none";
                        if (deskEl) deskEl.style.background = "none";
                    } else {
                        // When mode is not video, hide the video element to avoid visual overlap and stop playback
                        const videoEl =
                            document.getElementById("desktop-video");
                        if (videoEl) {
                            try {
                                videoEl.style.opacity = "0";
                                setTimeout(() => {
                                    try {
                                        videoEl.pause();
                                        videoEl.removeAttribute("src");
                                        videoEl.load();
                                    } catch (e) {}
                                    videoEl.style.display = "none";
                                }, 300);
                            } catch (e) {}
                            // revoke any object URL used previously
                            try {
                                if (_lastBackgroundVideoObjectUrl) {
                                    URL.revokeObjectURL(
                                        _lastBackgroundVideoObjectUrl
                                    );
                                    _lastBackgroundVideoObjectUrl = null;
                                }
                            } catch (e) {}
                        }
                    }
                    // Ensure video is hidden when not using video mode (this runs regardless of which branch matched above)
                    if (s.backgroundMode !== "video") {
                        const videoEl =
                            document.getElementById("desktop-video");
                        if (videoEl) {
                            try {
                                videoEl.style.opacity = "0";
                                setTimeout(() => {
                                    try {
                                        videoEl.pause();
                                        videoEl.removeAttribute("src");
                                        videoEl.load();
                                    } catch (e) {}
                                    videoEl.style.display = "none";
                                }, 300);
                            } catch (e) {}
                            try {
                                if (_lastBackgroundVideoObjectUrl) {
                                    URL.revokeObjectURL(
                                        _lastBackgroundVideoObjectUrl
                                    );
                                    _lastBackgroundVideoObjectUrl = null;
                                }
                            } catch (e) {}
                            // Only clear the cached mode/value when we were previously using a video
                            // so that unrelated changes (eg. changing brightness or taskbar/icon sizes)
                            // don't cause the background to re-apply and trigger the fade animation.
                            if (_lastBackgroundMode === "video") {
                                _lastBackgroundMode = null;
                                _lastBackgroundValue = null;
                            }
                        }
                    }
                    // Update background preview in personalization panel
                    try {
                        const bp = document.getElementById(
                            "personalization_bgPreview"
                        );
                        if (bp) {
                            if (s.backgroundMode === "default") {
                                bp.style.background =
                                    "radial-gradient(ellipse at bottom, #0a192f 0%, #05080f 100%)";
                            } else if (s.backgroundMode === "gradient") {
                                const gs =
                                    s.backgroundGradientStart || "#00ffff";
                                const ge = s.backgroundGradientEnd || "#ff69b4";
                                bp.style.background = `linear-gradient(135deg, ${gs} 0%, ${ge} 100%)`;
                            } else if (s.backgroundMode === "solid") {
                                bp.style.background =
                                    s.backgroundColor || "#0a0a0f";
                            } else if (
                                s.backgroundMode === "image" &&
                                s.backgroundImageURL
                            ) {
                                bp.style.background = `url('${s.backgroundImageURL}') center/cover no-repeat`;
                            } else if (
                                s.backgroundMode === "video" &&
                                s.backgroundVideoURL
                            ) {
                                // For preview, try to use a small inline <video> element in the personalization preview
                                try {
                                    // remove any background image that might have been set
                                    bp.style.background = "none";
                                    let pv = document.getElementById(
                                        "personalization_bgPreviewVideo"
                                    );
                                    if (!pv) {
                                        pv = document.createElement("video");
                                        pv.id =
                                            "personalization_bgPreviewVideo";
                                        pv.className = "bg-preview-video";
                                        pv.setAttribute("muted", "");
                                        pv.setAttribute("playsinline", "");
                                        pv.setAttribute("loop", "");
                                        pv.setAttribute("preload", "metadata");
                                        pv.controls = false;
                                        pv.setAttribute("aria-hidden", "true");
                                        pv.style.display = "block";
                                        pv.style.opacity = "0";
                                        pv.style.transition =
                                            "opacity 180ms ease";
                                        pv.muted = true;
                                        pv.autoplay = true;
                                        pv.loop = true;
                                        pv.playsInline = true;
                                        pv.preload = "metadata";
                                        try {
                                            pv.crossOrigin = "anonymous";
                                        } catch (e) {}
                                        try {
                                            pv.style.borderRadius =
                                                bp.style.borderRadius || "6px";
                                        } catch (e) {}
                                        // clear any existing children and append the video
                                        while (bp.firstChild)
                                            bp.removeChild(bp.firstChild);
                                        bp.appendChild(pv);
                                    }
                                    // Update src and try to play
                                    if (pv.src !== s.backgroundVideoURL) {
                                        try {
                                            if (!pv.paused) pv.pause();
                                        } catch (e) {}
                                        pv.src = s.backgroundVideoURL;
                                        pv.load();
                                    }
                                    // If video can play, fade it in; otherwise show fallback bg
                                    pv.addEventListener(
                                        "canplay",
                                        function onceCanPlay() {
                                            try {
                                                pv.style.opacity = "1";
                                            } catch (e) {}
                                        },
                                        { once: true }
                                    );
                                    pv.addEventListener(
                                        "error",
                                        function onceError() {
                                            try {
                                                pv.style.opacity = "0";
                                                pv.pause();
                                            } catch (e) {}
                                            // fallback to neutral bg
                                            bp.style.background =
                                                "linear-gradient(90deg, #000000 0%, #111111 100%)";
                                        },
                                        { once: true }
                                    );
                                    try {
                                        pv.play().catch(() => {});
                                    } catch (e) {}
                                } catch (err) {
                                    // fallback to neutral bg if video preview fails
                                    bp.style.background =
                                        "linear-gradient(90deg, #000000 0%, #111111 100%)";
                                }
                                // Could add a small <video> preview element if desired - keep it simple for now.
                            }
                        }
                    } catch (err) {}
                    // Ensure video preview is removed/hidden when not in video mode
                    try {
                        if (s.backgroundMode !== "video") {
                            const pv = document.getElementById(
                                "personalization_bgPreviewVideo"
                            );
                            if (pv && pv.parentElement) {
                                try {
                                    pv.pause();
                                } catch (e) {}
                                try {
                                    pv.removeAttribute("src");
                                    pv.load();
                                } catch (e) {}
                                // remove video element entirely so background image remains visible when switching back
                                pv.parentElement.removeChild(pv);
                            }
                        }
                    } catch (err) {}
                    // Background brightness: apply to new desktop background layer and reflect in UI
                    try {
                        const bgBrightness =
                            typeof s.backgroundBrightness !== "undefined"
                                ? s.backgroundBrightness
                                : 100;
                        document.documentElement.style.setProperty(
                            "--background-brightness",
                            (bgBrightness / 100).toFixed(3)
                        );
                        // For better performance and smoother UI, control a dimming overlay instead of only using filter()
                        const overlayVal = 1 - bgBrightness / 100;
                        document.documentElement.style.setProperty(
                            "--background-overlay",
                            overlayVal.toFixed(3)
                        );
                        if (personalizationControls.bgBrightness) {
                            personalizationControls.bgBrightness.value =
                                bgBrightness;
                        }
                        if (personalizationControls.bgBrightnessValue) {
                            personalizationControls.bgBrightnessValue.textContent = `${bgBrightness}%`;
                        }
                    } catch (e) {
                        /* ignore */
                    }
                    // start menu suggested/recent
                    const recommendedList =
                        document.querySelector(".recommended-list");
                    if (recommendedList) {
                        recommendedList.style.display = s.startSuggested
                            ? ""
                            : "none";
                    }
                    // TODO: 'recent' may correspond to some UI; hide if present
                    const recentEls = document.querySelectorAll(
                        ".start-menu .recent-item"
                    );
                    recentEls.forEach(
                        (e) => (e.style.display = s.startRecent ? "" : "none")
                    );
                    // Taskbar position
                    const tb = taskbar;
                    tb.classList.remove("left", "center", "right");
                    tb.classList.add(s.taskbarPosition);
                    // Icon size
                    if (s.taskbarIconSize)
                        document.documentElement.style.setProperty(
                            "--taskbar-icon-size",
                            `${s.taskbarIconSize}px`
                        );
                    // Fonts
                    if (s.fontSet) {
                        if (s.fontSet === "default") {
                            document.documentElement.style.setProperty(
                                "--font-display",
                                "'Orbitron', monospace"
                            );
                            document.documentElement.style.setProperty(
                                "--font-body",
                                "'Rajdhani', sans-serif"
                            );
                            document.documentElement.style.setProperty(
                                "--font-ui",
                                "'Noto Sans TC', sans-serif"
                            );
                        } else if (s.fontSet === "system") {
                            document.documentElement.style.setProperty(
                                "--font-display",
                                'system-ui, -apple-system, "Segoe UI"'
                            );
                            document.documentElement.style.setProperty(
                                "--font-body",
                                'system-ui, -apple-system, "Segoe UI"'
                            );
                            document.documentElement.style.setProperty(
                                "--font-ui",
                                'system-ui, -apple-system, "Segoe UI"'
                            );
                        } else if (s.fontSet === "serif") {
                            document.documentElement.style.setProperty(
                                "--font-display",
                                "Georgia, serif"
                            );
                            document.documentElement.style.setProperty(
                                "--font-body",
                                "Georgia, serif"
                            );
                            document.documentElement.style.setProperty(
                                "--font-ui",
                                "Georgia, serif"
                            );
                        } else if (s.fontSet === "mono") {
                            document.documentElement.style.setProperty(
                                "--font-display",
                                "ui-monospace, SFMono-Regular, Menlo, Monaco, monospace"
                            );
                            document.documentElement.style.setProperty(
                                "--font-body",
                                "ui-monospace, SFMono-Regular, Menlo, Monaco, monospace"
                            );
                            document.documentElement.style.setProperty(
                                "--font-ui",
                                "ui-monospace, SFMono-Regular, Menlo, Monaco, monospace"
                            );
                        }
                    }
                    // font scale
                    if (s.fontScale) {
                        const scale = (s.fontScale / 100).toFixed(2);
                        document.documentElement.style.setProperty(
                            "--font-scale",
                            scale
                        );
                    }
                    // reflect values to controls
                    try {
                        if (personalizationControls.themeMode)
                            personalizationControls.themeMode.value = s.theme;
                        if (personalizationControls.accentColor)
                            personalizationControls.accentColor.value =
                                s.accentColor;
                        if (personalizationControls.backgroundMode)
                            personalizationControls.backgroundMode.value =
                                s.backgroundMode;
                        if (personalizationControls.bgColor)
                            personalizationControls.bgColor.value =
                                s.backgroundColor;
                        if (personalizationControls.bgImageUrl)
                            personalizationControls.bgImageUrl.value =
                                s.backgroundImageURL;
                        if (personalizationControls.taskbarPosition)
                            personalizationControls.taskbarPosition.value =
                                s.taskbarPosition;
                        if (personalizationControls.taskbarIconSize)
                            personalizationControls.taskbarIconSize.value =
                                s.taskbarIconSize;
                        if (personalizationControls.taskbarIconSizeValue)
                            personalizationControls.taskbarIconSizeValue.textContent =
                                s.taskbarIconSize + "px";
                        if (personalizationControls.fontSet)
                            personalizationControls.fontSet.value = s.fontSet;
                        if (personalizationControls.fontScale)
                            personalizationControls.fontScale.value =
                                s.fontScale;
                        if (personalizationControls.fontScaleValue)
                            personalizationControls.fontScaleValue.textContent =
                                s.fontScale + "%";
                        // Also set panel controls when available
                        const fsPanel = document.getElementById(
                            "personalization_fontSet_panel"
                        );
                        if (fsPanel) fsPanel.value = s.fontSet;
                        const fsScalePanel = document.getElementById(
                            "personalization_fontScale_panel"
                        );
                        if (fsScalePanel)
                            (fsScalePanel.value = s.fontScale),
                                document.getElementById(
                                    "personalization_fontScaleValue_panel"
                                ) &&
                                    (document.getElementById(
                                        "personalization_fontScaleValue_panel"
                                    ).textContent = s.fontScale + "%");
                        const bgModePanel = document.getElementById(
                            "personalization_backgroundMode"
                        );
                        if (bgModePanel) bgModePanel.value = s.backgroundMode;
                        const bgGsPanel = document.getElementById(
                            "personalization_bgGradient_start"
                        );
                        if (bgGsPanel)
                            bgGsPanel.value =
                                s.backgroundGradientStart || "#00ffff";
                        const bgGePanel = document.getElementById(
                            "personalization_bgGradient_end"
                        );
                        if (bgGePanel)
                            bgGePanel.value =
                                s.backgroundGradientEnd || "#ff69b4";
                        const bgColorPanel = document.getElementById(
                            "personalization_bgColor"
                        );
                        if (bgColorPanel)
                            bgColorPanel.value = s.backgroundColor;
                        const bgImagePanel = document.getElementById(
                            "personalization_bgImageUrl"
                        );
                        if (bgImagePanel)
                            bgImagePanel.value = s.backgroundImageURL;
                        const bgVideoPanel = document.getElementById(
                            "personalization_bgVideoUrl"
                        );
                        if (bgVideoPanel)
                            bgVideoPanel.value = s.backgroundVideoURL || "";
                    } catch (err) {
                        /* ignore UI update errors */
                    }
                    // show/hide bg controls depending on mode
                    try {
                        const mode = s.backgroundMode;
                        if (personalizationControls.bgColor)
                            personalizationControls.bgColor.style.display =
                                mode === "solid" ? "" : "none";
                        if (personalizationControls.bgImageUrl)
                            personalizationControls.bgImageUrl.style.display =
                                mode === "image" ? "" : "none";
                        if (personalizationControls.bgGradientStart)
                            personalizationControls.bgGradientStart.style.display =
                                mode === "gradient" ? "" : "none";
                        if (personalizationControls.bgGradientEnd)
                            personalizationControls.bgGradientEnd.style.display =
                                mode === "gradient" ? "" : "none";
                        const solidItem = document.getElementById(
                            "personalization_background_solid"
                        );
                        const imageItem = document.getElementById(
                            "personalization_background_image"
                        );
                        const gradientItem = document.getElementById(
                            "personalization_background_gradient"
                        );
                        const videoItem = document.getElementById(
                            "personalization_background_video"
                        );
                        if (solidItem)
                            solidItem.style.display =
                                mode === "solid" ? "flex" : "none";
                        if (imageItem)
                            imageItem.style.display =
                                mode === "image" ? "flex" : "none";
                        if (videoItem)
                            videoItem.style.display =
                                mode === "video" ? "flex" : "none";
                        if (gradientItem)
                            gradientItem.style.display =
                                mode === "gradient" ? "flex" : "none";
                        // reflect start menu toggles status
                        if (personalizationControls.startShowSuggested) {
                            if (s.startSuggested)
                                personalizationControls.startShowSuggested.classList.add(
                                    "active"
                                );
                            else
                                personalizationControls.startShowSuggested.classList.remove(
                                    "active"
                                );
                            personalizationControls.startShowSuggested.setAttribute(
                                "aria-checked",
                                s.startSuggested ? "true" : "false"
                            );
                        }
                        if (personalizationControls.startShowRecent) {
                            if (s.startRecent)
                                personalizationControls.startShowRecent.classList.add(
                                    "active"
                                );
                            else
                                personalizationControls.startShowRecent.classList.remove(
                                    "active"
                                );
                            personalizationControls.startShowRecent.setAttribute(
                                "aria-checked",
                                s.startRecent ? "true" : "false"
                            );
                        }
                    } catch (err) {
                        /* ignore */
                    }

                    // Window transparency settings
                    try {
                        const windowTransparent = s.windowTransparent !== false; // default true
                        const windowOpacity =
                            typeof s.windowOpacity !== "undefined"
                                ? s.windowOpacity
                                : 90;
                        const windowStyle = s.windowStyle || "transparent";
                        const windowBlur =
                            typeof s.windowBlur !== "undefined"
                                ? s.windowBlur
                                : 20;

                        // Apply window transparency CSS variables
                        if (windowTransparent) {
                            const opacityVal = windowOpacity / 100;
                            const isLight = s.theme === "light";

                            if (windowStyle === "transparent") {
                                // Pure transparent - no blur
                                document.documentElement.style.setProperty(
                                    "--window-bg",
                                    isLight
                                        ? `rgba(255, 255, 255, ${opacityVal})`
                                        : `rgba(25, 25, 40, ${opacityVal})`
                                );
                                document.documentElement.style.setProperty(
                                    "--window-backdrop",
                                    "none"
                                );
                            } else if (windowStyle === "acrylic") {
                                // Acrylic style - with blur and saturation, opacity directly controlled
                                document.documentElement.style.setProperty(
                                    "--window-bg",
                                    isLight
                                        ? `rgba(255, 255, 255, ${opacityVal})`
                                        : `rgba(25, 25, 40, ${opacityVal})`
                                );
                                document.documentElement.style.setProperty(
                                    "--window-backdrop",
                                    `blur(${windowBlur}px) saturate(180%)`
                                );
                            } else if (windowStyle === "mica") {
                                // Mica style - stronger saturation and contrast, opacity directly controlled
                                document.documentElement.style.setProperty(
                                    "--window-bg",
                                    isLight
                                        ? `rgba(243, 243, 243, ${opacityVal})`
                                        : `rgba(32, 32, 48, ${opacityVal})`
                                );
                                document.documentElement.style.setProperty(
                                    "--window-backdrop",
                                    `blur(${windowBlur}px) saturate(200%) contrast(1.05)`
                                );
                            }
                        } else {
                            // No transparency - solid opaque background
                            const isLight = s.theme === "light";
                            document.documentElement.style.setProperty(
                                "--window-bg",
                                isLight
                                    ? "rgb(255, 255, 255)"
                                    : "rgb(25, 25, 40)"
                            );
                            document.documentElement.style.setProperty(
                                "--window-backdrop",
                                "none"
                            );
                        }

                        // Update window transparency controls UI
                        if (personalizationControls.windowTransparent) {
                            if (windowTransparent)
                                personalizationControls.windowTransparent.classList.add(
                                    "active"
                                );
                            else
                                personalizationControls.windowTransparent.classList.remove(
                                    "active"
                                );
                            personalizationControls.windowTransparent.setAttribute(
                                "aria-checked",
                                windowTransparent ? "true" : "false"
                            );
                        }
                        // Also sync sub toggle in window panel
                        if (personalizationControls.windowTransparentSub) {
                            if (windowTransparent)
                                personalizationControls.windowTransparentSub.classList.add(
                                    "active"
                                );
                            else
                                personalizationControls.windowTransparentSub.classList.remove(
                                    "active"
                                );
                            personalizationControls.windowTransparentSub.setAttribute(
                                "aria-checked",
                                windowTransparent ? "true" : "false"
                            );
                        }
                        if (personalizationControls.windowOpacity)
                            personalizationControls.windowOpacity.value =
                                windowOpacity;
                        if (personalizationControls.windowOpacityValue)
                            personalizationControls.windowOpacityValue.textContent =
                                windowOpacity + "%";
                        if (personalizationControls.windowStyle)
                            personalizationControls.windowStyle.value =
                                windowStyle;
                        if (personalizationControls.windowBlur)
                            personalizationControls.windowBlur.value =
                                windowBlur;
                        if (personalizationControls.windowBlurValue)
                            personalizationControls.windowBlurValue.textContent =
                                windowBlur + "px";

                        // Show/hide related controls based on transparency toggle
                        if (personalizationControls.windowStyleItem)
                            personalizationControls.windowStyleItem.style.display =
                                windowTransparent ? "flex" : "none";
                        if (personalizationControls.windowOpacityItem)
                            personalizationControls.windowOpacityItem.style.display =
                                windowTransparent ? "flex" : "none";
                        // Show blur control only for acrylic/mica styles when transparency is enabled
                        if (personalizationControls.windowBlurItem) {
                            personalizationControls.windowBlurItem.style.display =
                                windowTransparent &&
                                (windowStyle === "acrylic" ||
                                    windowStyle === "mica")
                                    ? "flex"
                                    : "none";
                        }
                    } catch (err) {
                        /* ignore */
                    }

                    // Mirror to window-level controls (if present)
                    try {
                        const tmw = document.getElementById(
                            "personalization_themeMode_window"
                        );
                        if (tmw) tmw.value = s.theme;
                        const acw = document.getElementById(
                            "personalization_accentColor_window"
                        );
                        if (acw) acw.value = s.accentColor;
                        const bmw = document.getElementById(
                            "personalization_backgroundMode_window"
                        );
                        if (bmw) bmw.value = s.backgroundMode;
                        const bcw = document.getElementById(
                            "personalization_bgColor_window"
                        );
                        if (bcw) bcw.value = s.backgroundColor;
                        const biw = document.getElementById(
                            "personalization_bgImageUrl_window"
                        );
                        if (biw) biw.value = s.backgroundImageURL;
                        const taskSizeW = document.getElementById(
                            "personalization_taskbarIconSize_window"
                        );
                        if (taskSizeW) taskSizeW.value = s.taskbarIconSize;
                        const taskSizeValW = document.getElementById(
                            "personalization_taskbarIconSizeValue_window"
                        );
                        if (taskSizeValW)
                            taskSizeValW.textContent = s.taskbarIconSize + "px";
                    } catch (err) {
                        /* ignore */
                    }
                    // Also sync the general/select themeMode in main display settings if present
                    try {
                        const mainThemeSelect =
                            document.getElementById("themeMode");
                        if (mainThemeSelect) mainThemeSelect.value = s.theme;
                    } catch (err) {}
                }

                function savePersonalizationSettings(settings) {
                    try {
                        localStorage.setItem(
                            PERSONALIZATION_STORAGE_KEY,
                            JSON.stringify(settings)
                        );
                    } catch (e) {}
                }

                function loadPersonalizationSettings() {
                    try {
                        return JSON.parse(
                            localStorage.getItem(PERSONALIZATION_STORAGE_KEY) ||
                                "null"
                        );
                    } catch (e) {
                        return null;
                    }
                }

                // Attach events for personalization controls (only if present)
                if (personalizationControls.themeMode) {
                    personalizationControls.themeMode.addEventListener(
                        "change",
                        (e) => {
                            const s =
                                loadPersonalizationSettings() ||
                                DEFAULT_PERSONALIZATION;
                            s.theme = e.target.value;
                            // 當主題改變且背景模式為 default 時，強制重新計算背景
                            if (s.backgroundMode === "default") {
                                _lastBackgroundMode = null;
                                _lastBackgroundValue = null;
                            }
                            applyPersonalizationSettings(s);
                            savePersonalizationSettings(s);
                            // 同步主題設定到 navigation.js 使用的 localStorage key，確保頁面重新載入時主題一致
                            try {
                                localStorage.setItem("theme", e.target.value);
                            } catch (err) {}
                        }
                    );
                }
                if (personalizationControls.accentColor) {
                    personalizationControls.accentColor.addEventListener(
                        "input",
                        (e) => {
                            const s =
                                loadPersonalizationSettings() ||
                                DEFAULT_PERSONALIZATION;
                            s.accentColor = e.target.value;
                            applyPersonalizationSettings(s);
                            savePersonalizationSettings(s);
                            try {
                                updateAccentPreviews(e.target.value);
                            } catch (err) {}
                        }
                    );
                }

                // Accent color preview helper for main and window-level controls
                function updateAccentPreviews(color) {
                    try {
                        document.getElementById(
                            "personalization_accentColor_preview"
                        ).style.backgroundColor = color;
                    } catch (e) {}
                    try {
                        document.getElementById(
                            "personalization_accentColor_window_preview"
                        ).style.backgroundColor = color;
                    } catch (e) {}
                }
                if (personalizationControls.backgroundMode) {
                    personalizationControls.backgroundMode.addEventListener(
                        "change",
                        (e) => {
                            const s =
                                loadPersonalizationSettings() ||
                                DEFAULT_PERSONALIZATION;
                            s.backgroundMode = e.target.value;
                            // show/hide color or URL inputs
                            if (e.target.value === "solid") {
                                personalizationControls.bgColor.style.display =
                                    "";
                                personalizationControls.bgImageUrl.style.display =
                                    "none";
                            } else if (e.target.value === "image") {
                                personalizationControls.bgColor.style.display =
                                    "none";
                                personalizationControls.bgImageUrl.style.display =
                                    "";
                            } else if (e.target.value === "video") {
                                personalizationControls.bgColor.style.display =
                                    "none";
                                personalizationControls.bgImageUrl.style.display =
                                    "none";
                                // No direct main input for video here; the bgVideoUrl is available in the panel
                                try {
                                    const videoItem = document.getElementById(
                                        "personalization_background_video"
                                    );
                                    if (videoItem)
                                        videoItem.style.display = "flex";
                                } catch (e) {}
                            } else if (e.target.value === "gradient") {
                                personalizationControls.bgColor.style.display =
                                    "none";
                                personalizationControls.bgImageUrl.style.display =
                                    "none";
                                try {
                                    document.getElementById(
                                        "personalization_background_gradient"
                                    ).style.display = "flex";
                                } catch (e) {}
                            } else {
                                personalizationControls.bgColor.style.display =
                                    "none";
                                personalizationControls.bgImageUrl.style.display =
                                    "none";
                            }
                            // also control the background panel's specific sections
                            try {
                                const solidItem = document.getElementById(
                                    "personalization_background_solid"
                                );
                                const imageItem = document.getElementById(
                                    "personalization_background_image"
                                );
                                const gradientItem = document.getElementById(
                                    "personalization_background_gradient"
                                );
                                if (solidItem)
                                    solidItem.style.display =
                                        e.target.value === "solid"
                                            ? "flex"
                                            : "none";
                                if (imageItem)
                                    imageItem.style.display =
                                        e.target.value === "image"
                                            ? "flex"
                                            : "none";
                                if (gradientItem)
                                    gradientItem.style.display =
                                        e.target.value === "gradient"
                                            ? "flex"
                                            : "none";
                            } catch (err) {}
                            applyPersonalizationSettings(s);
                            savePersonalizationSettings(s);
                        }
                    );
                }
                if (personalizationControls.bgColor) {
                    personalizationControls.bgColor.addEventListener(
                        "input",
                        (e) => {
                            const s =
                                loadPersonalizationSettings() ||
                                DEFAULT_PERSONALIZATION;
                            s.backgroundColor = e.target.value;
                            s.backgroundMode = "solid";
                            personalizationControls.backgroundMode.value =
                                "solid";
                            applyPersonalizationSettings(s);
                            savePersonalizationSettings(s);
                        }
                    );
                }
                if (personalizationControls.bgGradientStart) {
                    personalizationControls.bgGradientStart.addEventListener(
                        "input",
                        (e) => {
                            const s =
                                loadPersonalizationSettings() ||
                                DEFAULT_PERSONALIZATION;
                            s.backgroundGradientStart = e.target.value;
                            s.backgroundMode = "gradient";
                            personalizationControls.backgroundMode.value =
                                "gradient";
                            applyPersonalizationSettings(s);
                            savePersonalizationSettings(s);
                        }
                    );
                }
                if (personalizationControls.bgGradientEnd) {
                    personalizationControls.bgGradientEnd.addEventListener(
                        "input",
                        (e) => {
                            const s =
                                loadPersonalizationSettings() ||
                                DEFAULT_PERSONALIZATION;
                            s.backgroundGradientEnd = e.target.value;
                            s.backgroundMode = "gradient";
                            personalizationControls.backgroundMode.value =
                                "gradient";
                            applyPersonalizationSettings(s);
                            savePersonalizationSettings(s);
                        }
                    );
                }
                if (personalizationControls.bgImageUrl) {
                    personalizationControls.bgImageUrl.addEventListener(
                        "change",
                        (e) => {
                            const s =
                                loadPersonalizationSettings() ||
                                DEFAULT_PERSONALIZATION;
                            s.backgroundImageURL = e.target.value;
                            s.backgroundMode = "image";
                            personalizationControls.backgroundMode.value =
                                "image";
                            applyPersonalizationSettings(s);
                            savePersonalizationSettings(s);
                        }
                    );
                }
                if (personalizationControls.bgReset) {
                    personalizationControls.bgReset.addEventListener(
                        "click",
                        () => {
                            const s = Object.assign(
                                {},
                                DEFAULT_PERSONALIZATION
                            );
                            applyPersonalizationSettings(s);
                            savePersonalizationSettings(s);
                        }
                    );
                }
                if (personalizationControls.taskbarPosition) {
                    personalizationControls.taskbarPosition.addEventListener(
                        "change",
                        (e) => {
                            const s =
                                loadPersonalizationSettings() ||
                                DEFAULT_PERSONALIZATION;
                            s.taskbarPosition = e.target.value;
                            applyPersonalizationSettings(s);
                            savePersonalizationSettings(s);
                        }
                    );
                }
                if (personalizationControls.taskbarIconSize) {
                    personalizationControls.taskbarIconSize.addEventListener(
                        "input",
                        (e) => {
                            const s =
                                loadPersonalizationSettings() ||
                                DEFAULT_PERSONALIZATION;
                            s.taskbarIconSize = Number(e.target.value);
                            personalizationControls.taskbarIconSizeValue.textContent =
                                s.taskbarIconSize + "px";
                            // Live preview only: apply settings but don't write to storage on every input event
                            applyPersonalizationSettings(s);
                        }
                    );
                    // Save final user preference on change (when slider released)
                    personalizationControls.taskbarIconSize.addEventListener(
                        "change",
                        (e) => {
                            const s =
                                loadPersonalizationSettings() ||
                                DEFAULT_PERSONALIZATION;
                            s.taskbarIconSize = Number(e.target.value);
                            savePersonalizationSettings(s);
                        }
                    );
                }
                if (personalizationControls.bgBrightness) {
                    // While the user is sliding, update both brightness filter and overlay for consistent visual feedback
                    personalizationControls.bgBrightness.addEventListener(
                        "input",
                        (e) => {
                            const s =
                                loadPersonalizationSettings() ||
                                DEFAULT_PERSONALIZATION;
                            const val = Number(e.target.value);
                            s.backgroundBrightness = val;
                            if (personalizationControls.bgBrightnessValue)
                                personalizationControls.bgBrightnessValue.textContent =
                                    val + "%";
                            // Update both CSS variables for consistent brightness effect during slider drag
                            document.documentElement.style.setProperty(
                                "--background-brightness",
                                (val / 100).toFixed(3)
                            );
                            document.documentElement.style.setProperty(
                                "--background-overlay",
                                (1 - val / 100).toFixed(3)
                            );
                            // Do not call applyPersonalizationSettings or save on every input to avoid reflows and localStorage churn
                        }
                    );
                    // On release/final change, update the filter and save so other code depending on the final value remains compatible
                    personalizationControls.bgBrightness.addEventListener(
                        "change",
                        (e) => {
                            const s =
                                loadPersonalizationSettings() ||
                                DEFAULT_PERSONALIZATION;
                            const val = Number(e.target.value);
                            s.backgroundBrightness = val;
                            if (personalizationControls.bgBrightnessValue)
                                personalizationControls.bgBrightnessValue.textContent =
                                    val + "%";
                            // set final filter (less frequent, avoids repeated repainting while dragging)
                            document.documentElement.style.setProperty(
                                "--background-brightness",
                                (val / 100).toFixed(3)
                            );
                            // keep overlay in sync
                            document.documentElement.style.setProperty(
                                "--background-overlay",
                                (1 - val / 100).toFixed(3)
                            );
                            applyPersonalizationSettings(s);
                            savePersonalizationSettings(s);
                        }
                    );
                }
                if (personalizationControls.fontSet) {
                    personalizationControls.fontSet.addEventListener(
                        "change",
                        (e) => {
                            const s =
                                loadPersonalizationSettings() ||
                                DEFAULT_PERSONALIZATION;
                            s.fontSet = e.target.value;
                            applyPersonalizationSettings(s);
                            savePersonalizationSettings(s);
                        }
                    );
                }
                if (personalizationControls.fontScale) {
                    personalizationControls.fontScale.addEventListener(
                        "input",
                        (e) => {
                            const s =
                                loadPersonalizationSettings() ||
                                DEFAULT_PERSONALIZATION;
                            s.fontScale = Number(e.target.value);
                            personalizationControls.fontScaleValue.textContent =
                                s.fontScale + "%";
                            // Live preview only; avoid saving on each slider move
                            applyPersonalizationSettings(s);
                        }
                    );
                    personalizationControls.fontScale.addEventListener(
                        "change",
                        (e) => {
                            const s =
                                loadPersonalizationSettings() ||
                                DEFAULT_PERSONALIZATION;
                            s.fontScale = Number(e.target.value);
                            savePersonalizationSettings(s);
                        }
                    );
                }

                // Window transparency controls
                if (personalizationControls.windowTransparent) {
                    personalizationControls.windowTransparent.addEventListener(
                        "click",
                        () => {
                            const s =
                                loadPersonalizationSettings() ||
                                DEFAULT_PERSONALIZATION;
                            s.windowTransparent = !s.windowTransparent;
                            applyPersonalizationSettings(s);
                            savePersonalizationSettings(s);
                        }
                    );
                }
                if (personalizationControls.windowOpacity) {
                    personalizationControls.windowOpacity.addEventListener(
                        "input",
                        (e) => {
                            const s =
                                loadPersonalizationSettings() ||
                                DEFAULT_PERSONALIZATION;
                            s.windowOpacity = Number(e.target.value);
                            if (personalizationControls.windowOpacityValue)
                                personalizationControls.windowOpacityValue.textContent =
                                    s.windowOpacity + "%";
                            applyPersonalizationSettings(s);
                        }
                    );
                    personalizationControls.windowOpacity.addEventListener(
                        "change",
                        (e) => {
                            const s =
                                loadPersonalizationSettings() ||
                                DEFAULT_PERSONALIZATION;
                            s.windowOpacity = Number(e.target.value);
                            savePersonalizationSettings(s);
                        }
                    );
                }
                if (personalizationControls.windowStyle) {
                    personalizationControls.windowStyle.addEventListener(
                        "change",
                        (e) => {
                            const s =
                                loadPersonalizationSettings() ||
                                DEFAULT_PERSONALIZATION;
                            s.windowStyle = e.target.value;
                            applyPersonalizationSettings(s);
                            savePersonalizationSettings(s);
                        }
                    );
                }
                if (personalizationControls.windowBlur) {
                    personalizationControls.windowBlur.addEventListener(
                        "input",
                        (e) => {
                            const s =
                                loadPersonalizationSettings() ||
                                DEFAULT_PERSONALIZATION;
                            s.windowBlur = Number(e.target.value);
                            if (personalizationControls.windowBlurValue)
                                personalizationControls.windowBlurValue.textContent =
                                    s.windowBlur + "px";
                            applyPersonalizationSettings(s);
                        }
                    );
                    personalizationControls.windowBlur.addEventListener(
                        "change",
                        (e) => {
                            const s =
                                loadPersonalizationSettings() ||
                                DEFAULT_PERSONALIZATION;
                            s.windowBlur = Number(e.target.value);
                            savePersonalizationSettings(s);
                        }
                    );
                }

                // Initialize personalization at startup
                try {
                    const savedPersonalization = loadPersonalizationSettings();
                    const settings =
                        savedPersonalization || DEFAULT_PERSONALIZATION;
                    applyPersonalizationSettings(settings);
                    // 同步主題設定到 navigation.js 使用的 localStorage key，確保兩個系統保持一致
                    if (settings.theme) {
                        try {
                            localStorage.setItem("theme", settings.theme);
                        } catch (err) {}
                    }
                } catch (err) {
                    /* ignore */
                }

                // Setup toggle controls for start suggestions & recent
                const pStartSuggested = document.getElementById(
                    "personalization_startShowSuggested"
                );
                const pStartRecent = document.getElementById(
                    "personalization_startShowRecent"
                );
                function syncStartToggles() {
                    const s =
                        loadPersonalizationSettings() ||
                        DEFAULT_PERSONALIZATION;
                    if (pStartSuggested) {
                        if (s.startSuggested)
                            pStartSuggested.classList.add("active");
                        else pStartSuggested.classList.remove("active");
                    }
                    if (pStartRecent) {
                        if (s.startRecent) pStartRecent.classList.add("active");
                        else pStartRecent.classList.remove("active");
                    }
                }
                if (pStartSuggested) {
                    pStartSuggested.addEventListener("click", () => {
                        const s =
                            loadPersonalizationSettings() ||
                            DEFAULT_PERSONALIZATION;
                        const enabled =
                            pStartSuggested.classList.toggle("active");
                        pStartSuggested.setAttribute(
                            "aria-checked",
                            enabled ? "true" : "false"
                        );
                        s.startSuggested = enabled;
                        applyPersonalizationSettings(s);
                        savePersonalizationSettings(s);
                    });
                }
                if (pStartRecent) {
                    pStartRecent.addEventListener("click", () => {
                        const s =
                            loadPersonalizationSettings() ||
                            DEFAULT_PERSONALIZATION;
                        const enabled = pStartRecent.classList.toggle("active");
                        pStartRecent.setAttribute(
                            "aria-checked",
                            enabled ? "true" : "false"
                        );
                        s.startRecent = enabled;
                        applyPersonalizationSettings(s);
                        savePersonalizationSettings(s);
                    });
                }
                syncStartToggles();

                // Window-level personalization controls: mirror behavior to main controls
                const themeModeWindow = document.getElementById(
                    "personalization_themeMode_window"
                );
                const accentColorWindow = document.getElementById(
                    "personalization_accentColor_window"
                );
                const bgModeWindow = document.getElementById(
                    "personalization_backgroundMode_window"
                );
                const bgColorWindow = document.getElementById(
                    "personalization_bgColor_window"
                );
                const bgImageUrlWindow = document.getElementById(
                    "personalization_bgImageUrl_window"
                );
                const taskbarIconSizeWindow = document.getElementById(
                    "personalization_taskbarIconSize_window"
                );
                const taskbarIconSizeValueWindow = document.getElementById(
                    "personalization_taskbarIconSizeValue_window"
                );
                // When window-level control changes, update the main control (and saved settings)
                function mirrorToMain(mainEl, val) {
                    if (!mainEl) return;
                    try {
                        if (
                            mainEl.tagName === "SELECT" ||
                            mainEl.tagName === "INPUT"
                        )
                            mainEl.value = val;
                        mainEl.dispatchEvent(new Event("input"));
                        mainEl.dispatchEvent(new Event("change"));
                    } catch (e) {}
                }
                if (themeModeWindow && personalizationControls.themeMode) {
                    themeModeWindow.addEventListener("change", (e) =>
                        mirrorToMain(
                            personalizationControls.themeMode,
                            e.target.value
                        )
                    );
                }
                if (accentColorWindow && personalizationControls.accentColor) {
                    accentColorWindow.addEventListener("input", (e) =>
                        mirrorToMain(
                            personalizationControls.accentColor,
                            e.target.value
                        )
                    );
                }
                if (bgModeWindow && personalizationControls.backgroundMode) {
                    bgModeWindow.addEventListener("change", (e) =>
                        mirrorToMain(
                            personalizationControls.backgroundMode,
                            e.target.value
                        )
                    );
                }
                if (bgColorWindow && personalizationControls.bgColor) {
                    bgColorWindow.addEventListener("input", (e) =>
                        mirrorToMain(
                            personalizationControls.bgColor,
                            e.target.value
                        )
                    );
                }
                if (bgImageUrlWindow && personalizationControls.bgImageUrl) {
                    bgImageUrlWindow.addEventListener("change", (e) =>
                        mirrorToMain(
                            personalizationControls.bgImageUrl,
                            e.target.value
                        )
                    );
                }
                if (
                    taskbarIconSizeWindow &&
                    personalizationControls.taskbarIconSize
                ) {
                    taskbarIconSizeWindow.addEventListener("input", (e) => {
                        mirrorToMain(
                            personalizationControls.taskbarIconSize,
                            e.target.value
                        );
                        if (taskbarIconSizeValueWindow)
                            taskbarIconSizeValueWindow.textContent =
                                e.target.value + "px";
                    });
                }

                // Sync the main themeMode select to personalization when user changes it
                const themeModeMainSelect =
                    document.getElementById("themeMode");
                if (themeModeMainSelect) {
                    themeModeMainSelect.addEventListener("change", (e) => {
                        const val = e.target.value;
                        if (personalizationControls.themeMode) {
                            personalizationControls.themeMode.value = val;
                            personalizationControls.themeMode.dispatchEvent(
                                new Event("change")
                            );
                        }
                    });
                }

                // --- Right-side settings panel: open/close panels (background, fonts) ---
                const personalizationSection =
                    document.querySelector(".setting-section h3") &&
                    document.querySelector(".setting-section h3").parentElement;
                const personalizationPage = document.getElementById(
                    "page-personalization"
                );
                const personalizationSections = personalizationPage
                    ? Array.from(
                          personalizationPage.querySelectorAll(
                              ".setting-section"
                          )
                      )
                    : [];
                // Find the whole setting-item (background) to act as the open button
                const bgSettingItem = Array.from(
                    document.querySelectorAll(".setting-item")
                ).find((el) => el.querySelector("#personalization_bgPreview"));
                const bgPanel = document.getElementById(
                    "personalization_background_panel"
                );
                const bgPanelBack = document.getElementById(
                    "personalization_background_back"
                );
                if (bgPanel) {
                    const localSection =
                        bgPanel.closest(".setting-section") ||
                        document.querySelector(".setting-section");
                    function hideLocalSettingItems() {
                        try {
                            const items = localSection.querySelectorAll(
                                ":scope > .setting-item"
                            );
                            if (items && items.length) {
                                items.forEach(
                                    (i) => (i.style.display = "none")
                                );
                                return;
                            }
                        } catch (e) {}
                        // Fallback: filter direct children
                        Array.from(localSection.children).forEach((c) => {
                            if (
                                c.classList &&
                                c.classList.contains("setting-item")
                            )
                                c.style.display = "none";
                        });
                        // Also hide the header/title if present
                        try {
                            const hdr = localSection.querySelector("h3");
                            if (hdr) hdr.style.display = "none";
                        } catch (e) {}
                    }
                    function showLocalSettingItems() {
                        try {
                            const items = localSection.querySelectorAll(
                                ":scope > .setting-item"
                            );
                            if (items && items.length) {
                                items.forEach(
                                    (i) => (i.style.display = "flex")
                                );
                                return;
                            }
                        } catch (e) {}
                        Array.from(localSection.children).forEach((c) => {
                            if (
                                c.classList &&
                                c.classList.contains("setting-item")
                            )
                                c.style.display = "flex";
                        });
                        // Also show the header/title if present
                        try {
                            const hdr = localSection.querySelector("h3");
                            if (hdr) hdr.style.display = "";
                        } catch (e) {}
                    }
                    function openBgPanel() {
                        // hide personalization page sections and show the panel (matches Nightlight behavior)
                        personalizationSections.forEach(
                            (s) => (s.style.display = "none")
                        );
                        bgPanel.style.display = "block";
                        bgPanel.classList.add("active");
                    }
                    function closeBgPanel() {
                        personalizationSections.forEach(
                            (s) => (s.style.display = "block")
                        );
                        bgPanel.style.display = "none";
                        bgPanel.classList.remove("active");
                    }
                    if (bgSettingItem) {
                        // Make the entire .setting-item clickable and keyboard-accessible
                        bgSettingItem.setAttribute("role", "button");
                        bgSettingItem.setAttribute("tabindex", "0");
                        bgSettingItem.addEventListener("click", (e) => {
                            if (
                                e.target &&
                                (e.target.tagName === "SELECT" ||
                                    e.target.tagName === "INPUT" ||
                                    e.target.tagName === "BUTTON")
                            )
                                return;
                            openBgPanel();
                        });
                        bgSettingItem.addEventListener("keydown", (e) => {
                            if (e.key === "Enter" || e.key === " ") {
                                e.preventDefault();
                                bgSettingItem.click();
                            }
                        });
                    }
                    if (bgPanelBack)
                        bgPanelBack.addEventListener("click", (e) => {
                            e.preventDefault();
                            closeBgPanel();
                        });
                    // (previous explicit edit button logic removed; using .setting-item clickable approach above)
                    // Setup thumbnail clicks and upload handlers inside bg panel
                    try {
                        // Populate thumbnails: use a hard-coded list of wallpaper images (do not use wallpaper_index.json)
                        async function loadWallpaperIndex() {
                            return [
                                "assets/wallpaper/NS-V5-2nd.jpg",
                                "assets/wallpaper/NS-V5-D.jpg",
                                "assets/wallpaper/NS-V5-E.jpg",
                                "assets/wallpaper/NS-V5-W.jpg",
                            ];
                        }
                        const thumbsContainer = document.getElementById(
                            "personalization_bgThumbs"
                        );
                        if (thumbsContainer) {
                            thumbsContainer.innerHTML = "";
                            // load wallpaper index (if available)
                            loadWallpaperIndex().then((list) => {
                                list.forEach((src) => {
                                    try {
                                        const thumb =
                                            document.createElement("div");
                                        thumb.className = "media-thumb-item";
                                        thumb.setAttribute("data-url", src);
                                        // 建立圖片元素
                                        const img =
                                            document.createElement("img");
                                        img.src = src;
                                        img.alt = src.split("/").pop();
                                        img.loading = "lazy";
                                        thumb.appendChild(img);
                                        // 建立檔名覆蓋層
                                        const overlay =
                                            document.createElement("div");
                                        overlay.className =
                                            "media-thumb-overlay";
                                        overlay.textContent = src
                                            .split("/")
                                            .pop();
                                        thumb.appendChild(overlay);
                                        thumbsContainer.appendChild(thumb);
                                        thumb.addEventListener(
                                            "click",
                                            (ev) => {
                                                // 更新選中狀態
                                                thumbsContainer
                                                    .querySelectorAll(
                                                        ".media-thumb-item"
                                                    )
                                                    .forEach((t) =>
                                                        t.classList.remove(
                                                            "selected"
                                                        )
                                                    );
                                                thumb.classList.add("selected");
                                                const url =
                                                    thumb.getAttribute(
                                                        "data-url"
                                                    );
                                                if (
                                                    personalizationControls.bgImageUrl
                                                ) {
                                                    personalizationControls.bgImageUrl.value =
                                                        url;
                                                    personalizationControls.bgImageUrl.dispatchEvent(
                                                        new Event("change")
                                                    );
                                                }
                                            }
                                        );
                                    } catch (e) {}
                                });
                            });
                        }
                        const uploadBtn = document.getElementById(
                            "personalization_bgUpload"
                        );
                        const uploadFile = document.getElementById(
                            "personalization_bgUploadFile"
                        );
                        if (uploadBtn && uploadFile) {
                            uploadBtn.addEventListener("click", () =>
                                uploadFile.click()
                            );
                            uploadFile.addEventListener("change", (e) => {
                                const f = e.target.files && e.target.files[0];
                                if (!f) return;
                                // Limit file size to avoid localStorage overflow (1.5MB)
                                const MAX_UPLOAD_BYTES = 1.5 * 1024 * 1024;
                                if (f.size > MAX_UPLOAD_BYTES) {
                                    alert(
                                        "圖片過大，請選擇小於 1.5MB 的檔案。"
                                    );
                                    return;
                                }
                                const reader = new FileReader();
                                reader.onload = function (ev) {
                                    if (personalizationControls.bgImageUrl) {
                                        personalizationControls.bgImageUrl.value =
                                            ev.target.result;
                                        personalizationControls.bgImageUrl.dispatchEvent(
                                            new Event("change")
                                        );
                                    }
                                };
                                reader.readAsDataURL(f);
                            });
                        }
                        // Video thumbnails & upload handlers
                        try {
                            async function loadVideoIndex() {
                                return [
                                    "assets/videos/NS-V5-D.mp4",
                                    "assets/videos/NS-V5-W.mp4",
                                ];
                            }
                            const vidsContainer = document.getElementById(
                                "personalization_bgVideoThumbs"
                            );
                            if (vidsContainer) {
                                vidsContainer.innerHTML = "";
                                loadVideoIndex().then((list) => {
                                    list.forEach((src) => {
                                        try {
                                            const thumb =
                                                document.createElement("div");
                                            thumb.className =
                                                "media-thumb-item";
                                            thumb.setAttribute("data-url", src);
                                            // Use a small preview poster using the first frame - fallback to a poster icon
                                            const vid =
                                                document.createElement("video");
                                            vid.src = src;
                                            vid.muted = true;
                                            vid.preload = "metadata";
                                            // Try to seek a little to get a frame (best-effort)
                                            vid.addEventListener(
                                                "loadeddata",
                                                () => {
                                                    try {
                                                        vid.currentTime =
                                                            Math.min(
                                                                0.1,
                                                                vid.duration ||
                                                                    0
                                                            );
                                                    } catch (e) {}
                                                }
                                            );
                                            thumb.appendChild(vid);
                                            // 建立影片類型標籤
                                            const badge =
                                                document.createElement("div");
                                            badge.className =
                                                "media-type-badge";
                                            badge.textContent = "影片";
                                            thumb.appendChild(badge);
                                            // 建立檔名覆蓋層
                                            const overlay =
                                                document.createElement("div");
                                            overlay.className =
                                                "media-thumb-overlay";
                                            overlay.textContent = src
                                                .split("/")
                                                .pop();
                                            thumb.appendChild(overlay);
                                            vidsContainer.appendChild(thumb);
                                            thumb.addEventListener(
                                                "click",
                                                () => {
                                                    // 更新選中狀態
                                                    vidsContainer
                                                        .querySelectorAll(
                                                            ".media-thumb-item"
                                                        )
                                                        .forEach((t) =>
                                                            t.classList.remove(
                                                                "selected"
                                                            )
                                                        );
                                                    thumb.classList.add(
                                                        "selected"
                                                    );
                                                    const url =
                                                        thumb.getAttribute(
                                                            "data-url"
                                                        );
                                                    if (
                                                        personalizationControls.bgVideoUrl
                                                    ) {
                                                        personalizationControls.bgVideoUrl.value =
                                                            url;
                                                        personalizationControls.bgVideoUrl.dispatchEvent(
                                                            new Event("change")
                                                        );
                                                    }
                                                }
                                            );
                                        } catch (e) {}
                                    });
                                });
                            }
                            const uploadVidBtn = document.getElementById(
                                "personalization_bgVideoUpload"
                            );
                            const uploadVidFile = document.getElementById(
                                "personalization_bgVideoUploadFile"
                            );
                            const resetVidBtn = document.getElementById(
                                "personalization_bgVideoReset"
                            );
                            if (uploadVidBtn && uploadVidFile) {
                                uploadVidBtn.addEventListener("click", () =>
                                    uploadVidFile.click()
                                );
                                uploadVidFile.addEventListener(
                                    "change",
                                    (e) => {
                                        const f =
                                            e.target.files && e.target.files[0];
                                        if (!f) return;
                                        const MAX_VIDEO_BYTES = 5 * 1024 * 1024; // 5MB
                                        if (f.size > MAX_VIDEO_BYTES) {
                                            alert(
                                                "影片過大，請選擇小於 5MB 的檔案。"
                                            );
                                            return;
                                        }
                                        // Use object URL for the video playback and apply it as personalization
                                        // Revoke previous uploaded object URL if present
                                        try {
                                            if (_lastBackgroundVideoObjectUrl) {
                                                URL.revokeObjectURL(
                                                    _lastBackgroundVideoObjectUrl
                                                );
                                                _lastBackgroundVideoObjectUrl =
                                                    null;
                                            }
                                        } catch (e) {}
                                        const urlObj = URL.createObjectURL(f);
                                        if (
                                            personalizationControls.bgVideoUrl
                                        ) {
                                            personalizationControls.bgVideoUrl.value =
                                                urlObj;
                                            personalizationControls.bgVideoUrl.dispatchEvent(
                                                new Event("change")
                                            );
                                        }
                                        // Store a reference in dataset so we can revoke later if needed
                                        uploadVidFile.dataset.objectUrl =
                                            urlObj;
                                        _lastBackgroundVideoObjectUrl = urlObj;
                                    }
                                );
                            }
                            if (resetVidBtn) {
                                resetVidBtn.addEventListener("click", () => {
                                    try {
                                        if (_lastBackgroundVideoObjectUrl) {
                                            URL.revokeObjectURL(
                                                _lastBackgroundVideoObjectUrl
                                            );
                                            _lastBackgroundVideoObjectUrl =
                                                null;
                                        }
                                    } catch (e) {}
                                    const s =
                                        loadPersonalizationSettings() ||
                                        DEFAULT_PERSONALIZATION;
                                    s.backgroundVideoURL = "";
                                    s.backgroundMode = "default";
                                    personalizationControls.backgroundMode.value =
                                        "default";
                                    applyPersonalizationSettings(s);
                                    savePersonalizationSettings(s);
                                });
                            }
                            // url field for background video
                            if (personalizationControls.bgVideoUrl) {
                                personalizationControls.bgVideoUrl.addEventListener(
                                    "change",
                                    (e) => {
                                        const s =
                                            loadPersonalizationSettings() ||
                                            DEFAULT_PERSONALIZATION;
                                        s.backgroundVideoURL = e.target.value;
                                        s.backgroundMode = "video";
                                        personalizationControls.backgroundMode.value =
                                            "video";
                                        applyPersonalizationSettings(s);
                                        savePersonalizationSettings(s);
                                    }
                                );
                            }
                        } catch (err) {
                            /* ignore video initialization errors */
                        }
                    } catch (err) {
                        /* ignore */
                    }
                }

                // Window Style subpage open/close (similar to nightlight subpage)
                const windowStyleItem =
                    document.getElementById("windowStyleItem");
                const windowPanel = document.getElementById(
                    "personalization_window_panel"
                );
                const windowBackBtn = document.getElementById(
                    "personalization_window_back"
                );
                const windowTransparentMain = document.getElementById(
                    "personalization_windowTransparent"
                );
                const windowTransparentSub = document.getElementById(
                    "personalization_windowTransparentSub"
                );
                if (windowPanel && windowStyleItem) {
                    function openWindowPanel() {
                        personalizationSections.forEach(
                            (s) => (s.style.display = "none")
                        );
                        windowPanel.style.display = "block";
                        windowPanel.classList.add("active");
                    }
                    function closeWindowPanel() {
                        personalizationSections.forEach(
                            (s) => (s.style.display = "block")
                        );
                        windowPanel.style.display = "none";
                        windowPanel.classList.remove("active");
                    }
                    windowStyleItem.addEventListener("click", (e) => {
                        // if clicked on the toggle, don't open panel - toggle is handled separately
                        if (
                            e.target === windowTransparentMain ||
                            (windowTransparentMain &&
                                windowTransparentMain.contains(e.target))
                        )
                            return;
                        openWindowPanel();
                    });
                    windowStyleItem.addEventListener("keydown", (e) => {
                        if (e.key === "Enter" || e.key === " ") {
                            e.preventDefault();
                            windowStyleItem.click();
                        }
                    });
                    if (windowBackBtn)
                        windowBackBtn.addEventListener("click", (e) => {
                            e.preventDefault();
                            closeWindowPanel();
                        });

                    // Sync sub toggle with main toggle
                    if (windowTransparentSub) {
                        windowTransparentSub.addEventListener("click", () => {
                            const s =
                                loadPersonalizationSettings() ||
                                DEFAULT_PERSONALIZATION;
                            s.windowTransparent = !s.windowTransparent;
                            applyPersonalizationSettings(s);
                            savePersonalizationSettings(s);
                        });
                    }
                }

                // Font subpage open/close
                const fontPanel = document.getElementById(
                    "personalization_font_panel"
                );
                const fontBackBtn = document.getElementById(
                    "personalization_font_back"
                );
                const fontPanelSet = document.getElementById(
                    "personalization_fontSet_panel"
                );
                const fontPanelScale = document.getElementById(
                    "personalization_fontScale_panel"
                );
                const fontSetMain = document.getElementById(
                    "personalization_fontSet"
                );
                const fontEditBtn = null; // no dedicated edit; open via clicking the main '字型' item
                if (fontPanel) {
                    // Use `personalizationSections` (defined earlier) to hide the page sections while showing the subpage
                    function openFontPanel() {
                        personalizationSections.forEach(
                            (s) => (s.style.display = "none")
                        );
                        fontPanel.style.display = "block";
                        fontPanel.classList.add("active");
                    }
                    function closeFontPanel() {
                        personalizationSections.forEach(
                            (s) => (s.style.display = "block")
                        );
                        fontPanel.style.display = "none";
                        fontPanel.classList.remove("active");
                    }
                    if (fontBackBtn)
                        fontBackBtn.addEventListener("click", (e) => {
                            e.preventDefault();
                            closeFontPanel();
                        });
                    // Open font panel when clicking the main font control area
                    const fontItem = Array.from(
                        document.querySelectorAll(".setting-item")
                    ).find((el) =>
                        el.querySelector("#personalization_fontSet")
                    );
                    if (fontItem) {
                        fontItem.addEventListener("click", (e) => {
                            // ignore clicks on the select itself - only open when clicking label area
                            if (
                                e.target &&
                                (e.target.tagName === "SELECT" ||
                                    e.target.tagName === "INPUT" ||
                                    e.target.tagName === "BUTTON")
                            )
                                return;
                            openFontPanel();
                        });
                    }
                    // Mirror panel controls to main set
                    if (fontPanelSet && fontSetMain) {
                        fontPanelSet.addEventListener("change", (e) => {
                            fontSetMain.value = e.target.value;
                            fontSetMain.dispatchEvent(new Event("change"));
                        });
                    }
                    // When the panel scale changes, update the displayed value if present and
                    // ensure the personalization flow triggers (the main control reference may be absent)
                    if (fontPanelScale) {
                        fontPanelScale.addEventListener("input", (e) => {
                            // Update displayed value (either main value element or panel value element)
                            const valEl =
                                document.getElementById(
                                    "personalization_fontScaleValue"
                                ) ||
                                document.getElementById(
                                    "personalization_fontScaleValue_panel"
                                );
                            if (valEl) valEl.textContent = e.target.value + "%";
                            // Trigger the generic handler if it exists on personalizationControls.fontScale
                            if (
                                personalizationControls.fontScale &&
                                personalizationControls.fontScale !==
                                    fontPanelScale
                            ) {
                                personalizationControls.fontScale.value =
                                    e.target.value;
                                personalizationControls.fontScale.dispatchEvent(
                                    new Event("input")
                                );
                            } else if (!personalizationControls.fontScale) {
                                // No main control - call the same handler logic directly to save/apply
                                // If there is no separate "main" control, handle applying and saving here.
                                const s =
                                    loadPersonalizationSettings() ||
                                    DEFAULT_PERSONALIZATION;
                                s.fontScale = Number(e.target.value);
                                applyPersonalizationSettings(s);
                                savePersonalizationSettings(s);
                            }
                        });
                    }
                }

                // Mirror background panel controls to main controls when changed
                const bgMode = document.getElementById(
                    "personalization_backgroundMode"
                );
                const bgModeMain = document.getElementById(
                    "personalization_backgroundMode"
                );
                if (bgMode) {
                    bgMode.addEventListener("change", (e) => {
                        // the main control is the same ID, dispatch will update
                        bgMode.dispatchEvent(new Event("change"));
                    });
                }

                // Global drag/resize state (one set of handlers for all windows)
                // Implementation notes:
                // - Uses `actionState` to track the current operation (drag/resize)
                // - Pointer events are supported via pointerdown/pointermove/pointerup
                // - requestAnimationFrame is used to throttle DOM updates for smoother dragging/resizing
                // - When resizing from 'left' or 'top', the opposite edge (right/bottom) is anchored
                //   to prevent the window from shifting its position unexpectedly.
                const actionState = {
                    type: null, // 'drag' | 'resize'
                    windowEl: null,
                    startX: 0,
                    startY: 0,
                    startLeft: 0,
                    startTop: 0,
                    startWidth: 0,
                    startHeight: 0,
                    direction: "",
                    pointerId: null,
                    captureTarget: null,
                    restoreOnDrag: false,
                };

                // ========== 現代化開機序列 ==========
                function initBootSequence() {
                    const bootLoader = document.getElementById("boot-loader");
                    const progressFill =
                        document.getElementById("bootProgressFill");
                    const progressLabel =
                        document.getElementById("bootProgressLabel");
                    const progressPercent = document.getElementById(
                        "bootProgressPercent"
                    );
                    const particlesContainer =
                        document.getElementById("bootParticles");

                    // 創建粒子效果
                    function createBootParticles() {
                        if (!particlesContainer) return;
                        for (let i = 0; i < 30; i++) {
                            const particle = document.createElement("div");
                            particle.className = "boot-particle";
                            particle.style.left = `${Math.random() * 100}%`;
                            particle.style.animationDelay = `${
                                Math.random() * 5
                            }s`;
                            particle.style.animationDuration = `${
                                5 + Math.random() * 5
                            }s`;
                            particlesContainer.appendChild(particle);
                        }
                    }

                    // 更新進度
                    function updateProgress(percent, label) {
                        if (progressFill)
                            progressFill.style.width = `${percent}%`;
                        if (progressPercent)
                            progressPercent.textContent = `${percent}%`;
                        if (progressLabel) progressLabel.textContent = label;
                    }

                    // 初始化粒子
                    createBootParticles();

                    // 系統啟動進度序列
                    const bootSteps = [
                        { delay: 200, label: "初始化系統...", progress: 5 },
                        { delay: 500, label: "載入核心模組...", progress: 15 },
                        { delay: 900, label: "偵測硬體設備...", progress: 30 },
                        { delay: 1300, label: "掛載檔案系統...", progress: 45 },
                        { delay: 1700, label: "載入驅動程式...", progress: 60 },
                        { delay: 2100, label: "初始化網路...", progress: 75 },
                        {
                            delay: 2500,
                            label: "載入使用者介面...",
                            progress: 90,
                        },
                        { delay: 2900, label: "系統準備就緒", progress: 100 },
                    ];

                    // 執行進度序列
                    bootSteps.forEach(({ delay, label, progress }) => {
                        setTimeout(() => {
                            updateProgress(progress, label);
                        }, delay);
                    });

                    // 完成開機動畫
                    setTimeout(() => {
                        if (bootLoader) {
                            bootLoader.classList.add("fade-out");
                            setTimeout(() => {
                                bootLoader.remove();
                            }, 800);
                        }
                    }, 3500);
                }

                // --- 2. 時間與日期 ---
                function updateTime() {
                    const now = new Date();
                    // Manual 12-hour formatting with localized AM/PM labels (午前/午後).
                    const hours24 = now.getHours();
                    const minutes = now.getMinutes();
                    const isAM = hours24 < 12;
                    const ampmLabel = isAM ? "午前" : "午後";
                    // Convert to 12-hour clock (show 12 instead of 0)
                    let hours12 = hours24 % 12;
                    if (hours12 === 0) hours12 = 12;
                    const hh = String(hours12).padStart(2, "0");
                    const mm = String(minutes).padStart(2, "0");
                    // Update the separate elements so we can style them independently and keep spacing consistent.
                    if (timeAmpmEl) timeAmpmEl.textContent = ampmLabel;
                    if (timeValueEl) timeValueEl.textContent = `${hh}:${mm}`;
                    // Keep the date in zh-TW format as before.
                    dateEl.textContent = now.toLocaleDateString("zh-TW");
                }
                setInterval(updateTime, 1000);
                updateTime();

                // --- 3. 日曆 ---
                function renderCalendar() {
                    calendarGrid.innerHTML = "";
                    const year = calendarDate.getFullYear();
                    const month = calendarDate.getMonth();
                    calendarMonthYear.textContent = `${year}年 ${month + 1}月`;

                    // 星期
                    const days = ["日", "一", "二", "三", "四", "五", "六"];
                    days.forEach((day) => {
                        const cell = document.createElement("div");
                        cell.classList.add("calendar-cell", "day-name");
                        cell.textContent = day;
                        calendarGrid.appendChild(cell);
                    });

                    const firstDay = new Date(year, month, 1).getDay();
                    const daysInMonth = new Date(year, month + 1, 0).getDate();
                    const daysInPrevMonth = new Date(year, month, 0).getDate();
                    const today = new Date();

                    // 上個月的日期（填充開頭空白）
                    for (let i = firstDay - 1; i >= 0; i--) {
                        const cell = document.createElement("div");
                        cell.classList.add("calendar-cell", "other-month");
                        cell.textContent = daysInPrevMonth - i;
                        calendarGrid.appendChild(cell);
                    }

                    // 這個月的日期
                    for (let i = 1; i <= daysInMonth; i++) {
                        const cell = document.createElement("div");
                        cell.classList.add("calendar-cell");
                        cell.textContent = i;
                        if (
                            i === today.getDate() &&
                            month === today.getMonth() &&
                            year === today.getFullYear()
                        ) {
                            cell.classList.add("today");
                        }
                        calendarGrid.appendChild(cell);
                    }

                    // 下個月的日期（填充至固定6行，共42格）
                    const totalCells = 42; // 6行 x 7列
                    const currentCells = firstDay + daysInMonth;
                    const remainingCells = totalCells - currentCells;
                    for (let i = 1; i <= remainingCells; i++) {
                        const cell = document.createElement("div");
                        cell.classList.add("calendar-cell", "other-month");
                        cell.textContent = i;
                        calendarGrid.appendChild(cell);
                    }
                }
                calendarPrev.addEventListener("click", () => {
                    calendarDate.setMonth(calendarDate.getMonth() - 1);
                    renderCalendar();
                });
                calendarNext.addEventListener("click", () => {
                    calendarDate.setMonth(calendarDate.getMonth() + 1);
                    renderCalendar();
                });
                taskbarTime.addEventListener("click", (e) => {
                    e.stopPropagation();
                    calendarFlyout.classList.toggle("show");
                    startMenu.classList.remove("show");
                    // 全螢幕模式下不關閉小工具面板
                    if (!widgetsPanel.classList.contains("fullscreen")) {
                        closeWidgetsPanel();
                    }
                });

                // Helper function to close widgets panel and reset its state
                function closeWidgetsPanel() {
                    widgetsPanel.classList.remove("show");
                    widgetsPanel.classList.remove("fullscreen");
                    widgetsPanel.classList.remove("collapsed");
                    // Reset fullscreen button icon
                    const widgetsFsBtn = document.getElementById(
                        "widgets-fullscreen-btn"
                    );
                    if (widgetsFsBtn) {
                        const icon = widgetsFsBtn.querySelector("i");
                        if (icon) {
                            icon.classList.remove("fa-compress");
                            icon.classList.add("fa-expand");
                        }
                        widgetsFsBtn.title = "全螢幕";
                    }
                    // Reset collapse button
                    const widgetsColBtn = document.getElementById(
                        "widgets-collapse-btn"
                    );
                    if (widgetsColBtn) {
                        widgetsColBtn.title = "收合小工具";
                    }
                }

                // --- 4. 開始功能表 ---
                startButton.addEventListener("click", (e) => {
                    e.stopPropagation();
                    startMenu.classList.toggle("show");
                    calendarFlyout.classList.remove("show");
                    // 全螢幕模式下不關閉小工具面板（作為桌面使用）
                    if (!widgetsPanel.classList.contains("fullscreen")) {
                        closeWidgetsPanel();
                    }
                });

                // --- 5. 小工具面板 ---
                widgetsButton.addEventListener("click", (e) => {
                    e.stopPropagation();
                    // 如果在全螢幕模式，點擊會退出全螢幕並關閉面板
                    if (widgetsPanel.classList.contains("fullscreen")) {
                        closeWidgetsPanel();
                    } else {
                        widgetsPanel.classList.toggle("show");
                    }
                    startMenu.classList.remove("show");
                    calendarFlyout.classList.remove("show");
                });

                // --- 5.1 小工具全螢幕按鈕 ---
                const widgetsFullscreenBtn = document.getElementById(
                    "widgets-fullscreen-btn"
                );
                const widgetsSettingsBtn = document.getElementById(
                    "widgets-settings-btn"
                );
                const widgetsCollapseBtn = document.getElementById(
                    "widgets-collapse-btn"
                );

                if (widgetsFullscreenBtn) {
                    widgetsFullscreenBtn.addEventListener("click", (e) => {
                        e.stopPropagation();
                        const isEnteringFullscreen =
                            !widgetsPanel.classList.contains("fullscreen");
                        widgetsPanel.classList.toggle("fullscreen");

                        // 進入全螢幕時最小化所有視窗
                        if (isEnteringFullscreen) {
                            minimizeAllWindows();
                        }

                        // 退出全螢幕時重置收合狀態
                        if (!widgetsPanel.classList.contains("fullscreen")) {
                            widgetsPanel.classList.remove("collapsed");
                            if (widgetsCollapseBtn) {
                                widgetsCollapseBtn.title = "收合小工具";
                            }
                        }
                        // 更新圖示
                        const icon = widgetsFullscreenBtn.querySelector("i");
                        if (widgetsPanel.classList.contains("fullscreen")) {
                            icon.classList.remove("fa-expand");
                            icon.classList.add("fa-compress");
                            widgetsFullscreenBtn.title = "退出全螢幕";
                        } else {
                            icon.classList.remove("fa-compress");
                            icon.classList.add("fa-expand");
                            widgetsFullscreenBtn.title = "全螢幕";
                        }
                    });
                }

                // 最小化所有視窗的輔助函數
                function minimizeAllWindows() {
                    const allWindows =
                        document.querySelectorAll(".window.show");
                    allWindows.forEach((win) => {
                        const appId = win.dataset.app;
                        if (appId) {
                            win.classList.add("minimized");
                            win.classList.remove("show", "active");
                            // 更新任務欄圖標狀態
                            const tbIcon = document.getElementById(
                                `taskbar-icon-${appId}`
                            );
                            if (tbIcon) {
                                tbIcon.classList.remove("active-app");
                                tbIcon.classList.add("open-app");
                                tbIcon.setAttribute("aria-pressed", "false");
                            }
                        }
                    });
                    // 清除活躍視窗
                    if (activeWindow) {
                        activeWindow = null;
                        updateTaskbarActive(null);
                    }
                }

                // --- 5.1.1 小工具收合按鈕 ---
                if (widgetsCollapseBtn) {
                    widgetsCollapseBtn.addEventListener("click", (e) => {
                        e.stopPropagation();
                        widgetsPanel.classList.toggle("collapsed");
                        // 更新提示文字
                        if (widgetsPanel.classList.contains("collapsed")) {
                            widgetsCollapseBtn.title = "展開小工具";
                        } else {
                            widgetsCollapseBtn.title = "收合小工具";
                        }
                    });
                }

                // --- 5.2 小工具設定按鈕 ---
                if (widgetsSettingsBtn) {
                    widgetsSettingsBtn.addEventListener("click", (e) => {
                        e.stopPropagation();
                        // 開啟設定視窗
                        openWindow("settings");
                        // 全螢幕模式下不關閉小工具面板（類似 Win10 平板模式）
                        if (!widgetsPanel.classList.contains("fullscreen")) {
                            closeWidgetsPanel();
                        }
                    });
                }

                // --- 5.2.0 小工具狀態保存/載入功能 ---
                const WIDGETS_STATE_KEY = "webos_widgets_state_v2";

                // 可用的小工具類型定義 (全域，供載入和新增功能共用)
                const widgetTemplates = {
                    weather: {
                        name: "天氣",
                        icon: "fa-cloud-sun",
                        create: (id, size) => {
                            const widget = document.createElement("div");
                            widget.className = `widget weather-widget widget-size-${
                                size || 3
                            }`;
                            widget.id = id || "widget-weather-" + Date.now();
                            widget.dataset.widgetSize = String(size || 3);
                            widget.dataset.widgetType = "weather";
                            widget.innerHTML = `
                            <div class="widget-controls">
                                <button class="widget-size-toggle" title="調整大小">${
                                    size || 3
                                }</button>
                                <button class="widget-remove-btn" title="移除小工具"><i class="fa-solid fa-xmark"></i></button>
                            </div>
                            <div class="widget-header">天氣 <span class="small weather-location">台北市</span></div>
                            <div class="widget-body">
                                <div class="weather-controls">
                                    <input type="text" aria-label="城市" placeholder="城市 (例如：Taipei / 台北)" />
                                    <button aria-label="刷新天氣" title="刷新"><i class="fa-solid fa-rotate-right"></i></button>
                                    <button aria-label="使用定位" title="使用定位"><i class="fa-solid fa-location-crosshairs"></i></button>
                                </div>
                                <div class="weather-main">
                                    <div class="weather-visual"><i class="fa-solid fa-cloud-sun"></i></div>
                                    <div class="weather-info">
                                        <div class="temp">--°C</div>
                                        <div class="desc">點擊刷新獲取天氣</div>
                                        <div class="meta"><span class="weather-humidity"></span> <span class="weather-feels"></span> <span class="weather-updated" style="margin-left:8px;color:#9aa; font-size:0.7rem"></span></div>
                                    </div>
                                </div>
                                <div class="weather-forecast"></div>
                            </div>
                        `;
                            return widget;
                        },
                    },
                    performance: {
                        name: "效能監控",
                        icon: "fa-chart-line",
                        create: (id, size) => {
                            const widget = document.createElement("div");
                            widget.className = `widget performance-widget widget-size-${
                                size || 3
                            }`;
                            widget.id =
                                id || "widget-performance-" + Date.now();
                            widget.dataset.widgetSize = String(size || 3);
                            widget.dataset.widgetType = "performance";
                            widget.innerHTML = `
                            <div class="widget-controls">
                                <button class="widget-size-toggle" title="調整大小">${
                                    size || 3
                                }</button>
                                <button class="widget-remove-btn" title="移除小工具"><i class="fa-solid fa-xmark"></i></button>
                            </div>
                            <div class="widget-header"><i class="fa-solid fa-chart-line"></i> 效能監控</div>
                            <div class="widget-body">
                                <div class="perf-section">
                                    <div class="perf-label">
                                        <span class="perf-label-title"><i class="fa-solid fa-microchip"></i> CPU</span>
                                        <span class="perf-label-value">---%</span>
                                    </div>
                                    <div class="perf-bar"><div class="perf-bar-fill cpu" style="width: 0%"></div></div>
                                </div>
                                <div class="perf-section">
                                    <div class="perf-label">
                                        <span class="perf-label-title"><i class="fa-solid fa-memory"></i> 記憶體</span>
                                        <span class="perf-label-value">--- MB</span>
                                    </div>
                                    <div class="perf-bar"><div class="perf-bar-fill memory" style="width: 0%"></div></div>
                                </div>
                                <div class="perf-section">
                                    <div class="perf-label">
                                        <span class="perf-label-title"><i class="fa-solid fa-gauge-high"></i> FPS</span>
                                        <span class="perf-label-value">-- fps</span>
                                    </div>
                                    <div class="perf-bar"><div class="perf-bar-fill fps" style="width: 0%"></div></div>
                                </div>
                                <div class="perf-stats">
                                    <div class="perf-stat-item">
                                        <span class="perf-stat-label">執行時間</span>
                                        <span class="perf-stat-value perf-uptime">--:--:--</span>
                                    </div>
                                    <div class="perf-stat-item">
                                        <span class="perf-stat-label">DOM 節點</span>
                                        <span class="perf-stat-value perf-dom-nodes">---</span>
                                    </div>
                                    <div class="perf-stat-item">
                                        <span class="perf-stat-label">JS Heap</span>
                                        <span class="perf-stat-value perf-js-heap">--- MB</span>
                                    </div>
                                    <div class="perf-stat-item">
                                        <span class="perf-stat-label">頁面載入</span>
                                        <span class="perf-stat-value perf-load-time">--- ms</span>
                                    </div>
                                </div>
                            </div>
                        `;
                            return widget;
                        },
                    },
                    news: {
                        name: "新聞",
                        icon: "fa-newspaper",
                        create: (id, size) => {
                            const widget = document.createElement("div");
                            widget.className = `widget news-widget widget-size-${
                                size || 2
                            }`;
                            widget.id = id || "widget-news-" + Date.now();
                            widget.dataset.widgetSize = String(size || 2);
                            widget.dataset.widgetType = "news";
                            widget.innerHTML = `
                            <div class="widget-controls">
                                <button class="widget-size-toggle" title="調整大小">${
                                    size || 2
                                }</button>
                                <button class="widget-remove-btn" title="移除小工具"><i class="fa-solid fa-xmark"></i></button>
                            </div>
                            <div class="widget-header">頭條新聞</div>
                            <div class="widget-body">
                                <div class="news-item">
                                    <img src="https://placehold.co/100x100/333/fff?text=NEWS" alt="News">
                                    <div class="news-item-info">
                                        這是一條模擬的新聞標題...
                                        <span>剛剛</span>
                                    </div>
                                </div>
                                <div class="news-item">
                                    <img src="https://placehold.co/100x100/555/fff?text=TECH" alt="Tech">
                                    <div class="news-item-info">
                                        關於網頁技術的最新進展...
                                        <span>1 小時前</span>
                                    </div>
                                </div>
                            </div>
                        `;
                            return widget;
                        },
                    },
                    clock: {
                        name: "時鐘",
                        icon: "fa-clock",
                        create: (id, size) => {
                            const widget = document.createElement("div");
                            widget.className = `widget clock-widget widget-size-${
                                size || 1
                            }`;
                            widget.id = id || "widget-clock-" + Date.now();
                            widget.dataset.widgetSize = String(size || 1);
                            widget.dataset.widgetType = "clock";
                            widget.innerHTML = `
                            <div class="widget-controls">
                                <button class="widget-size-toggle" title="調整大小">${
                                    size || 1
                                }</button>
                                <button class="widget-remove-btn" title="移除小工具"><i class="fa-solid fa-xmark"></i></button>
                            </div>
                            <div class="widget-header"><i class="fa-solid fa-clock"></i> 時鐘</div>
                            <div class="widget-body" style="display: flex; align-items: center; justify-content: center;">
                                <div style="font-family: var(--font-display); font-size: 1.8rem; color: var(--primary-cyan);" class="clock-display">--:--:--</div>
                            </div>
                        `;
                            // 啟動時鐘更新
                            const clockDisplay =
                                widget.querySelector(".clock-display");
                            function updateClock() {
                                const now = new Date();
                                clockDisplay.textContent =
                                    now.toLocaleTimeString("zh-TW", {
                                        hour12: false,
                                    });
                            }
                            updateClock();
                            setInterval(updateClock, 1000);
                            return widget;
                        },
                    },
                };

                // 保存小工具狀態
                function saveWidgetsState() {
                    const widgetsContent =
                        document.querySelector(".widgets-content");
                    if (!widgetsContent) return;

                    const widgets = widgetsContent.querySelectorAll(".widget");
                    const state = [];

                    widgets.forEach((widget) => {
                        const id = widget.id;
                        const size = parseInt(widget.dataset.widgetSize) || 2;
                        const type = widget.dataset.widgetType || "";
                        if (id) {
                            state.push({ id, size, type });
                        }
                    });

                    try {
                        localStorage.setItem(
                            WIDGETS_STATE_KEY,
                            JSON.stringify(state)
                        );
                    } catch (e) {
                        console.warn("無法保存小工具狀態:", e);
                    }
                }

                // 載入小工具狀態
                function loadWidgetsState() {
                    const widgetsContent =
                        document.querySelector(".widgets-content");
                    if (!widgetsContent) return;

                    try {
                        const raw = localStorage.getItem(WIDGETS_STATE_KEY);
                        if (!raw) return; // 沒有保存的狀態，使用預設 HTML

                        const state = JSON.parse(raw);
                        if (!Array.isArray(state)) return;

                        // 建立現有 DOM 元素的映射
                        const existingWidgets = {};
                        widgetsContent
                            .querySelectorAll(".widget")
                            .forEach((widget) => {
                                if (widget.id) {
                                    existingWidgets[widget.id] = widget;
                                }
                            });

                        // 收集狀態中存在的小工具 ID
                        const stateWidgetIds = new Set(
                            state.map((item) => item.id)
                        );

                        // 移除不在狀態中的小工具（已被用戶刪除的）
                        Object.keys(existingWidgets).forEach((id) => {
                            if (!stateWidgetIds.has(id)) {
                                existingWidgets[id].remove();
                                delete existingWidgets[id];
                            }
                        });

                        // 根據保存的狀態重建/更新小工具
                        state.forEach((item) => {
                            let widget = existingWidgets[item.id];

                            // 如果小工具不存在於 DOM 中，需要動態創建
                            if (
                                !widget &&
                                item.type &&
                                widgetTemplates[item.type]
                            ) {
                                widget = widgetTemplates[item.type].create(
                                    item.id,
                                    item.size
                                );
                                existingWidgets[item.id] = widget;
                            }

                            if (widget) {
                                // 更新大小
                                widget.classList.remove(
                                    "widget-size-1",
                                    "widget-size-2",
                                    "widget-size-3"
                                );
                                widget.classList.add(
                                    `widget-size-${item.size}`
                                );
                                widget.dataset.widgetSize = item.size;

                                // 更新按鈕文字
                                const sizeBtn = widget.querySelector(
                                    ".widget-size-toggle"
                                );
                                if (sizeBtn) {
                                    sizeBtn.textContent = item.size;
                                }

                                // 移動到正確位置（按照狀態中的順序）
                                widgetsContent.appendChild(widget);
                                // 初始化從狀態恢復的小工具
                                try {
                                    if (
                                        widget.classList.contains(
                                            "weather-widget"
                                        ) &&
                                        typeof window.initWeatherWidget ===
                                            "function"
                                    )
                                        window.initWeatherWidget(widget);
                                    if (
                                        widget.classList.contains(
                                            "performance-widget"
                                        ) &&
                                        typeof window.initPerfWidget ===
                                            "function"
                                    )
                                        window.initPerfWidget(widget);
                                } catch (e) {
                                    console.warn(
                                        "init restored widget failed",
                                        e
                                    );
                                }
                            }
                        });
                    } catch (e) {
                        console.warn("無法載入小工具狀態:", e);
                    }
                }

                // 頁面載入時載入小工具狀態
                loadWidgetsState();

                // 初始化預設時鐘小工具（如果存在）
                (function initDefaultClockWidget() {
                    const clockWidget = document.getElementById("widget-clock");
                    if (!clockWidget) return;

                    const clockDisplay =
                        clockWidget.querySelector(".clock-display");
                    if (!clockDisplay) return;

                    function updateClock() {
                        const now = new Date();
                        clockDisplay.textContent = now.toLocaleTimeString(
                            "zh-TW",
                            { hour12: false }
                        );
                    }
                    updateClock();
                    setInterval(updateClock, 1000);
                })();

                // --- 5.2.1 小工具大小切換功能 ---
                (function initWidgetSizeToggle() {
                    const widgetsContent =
                        document.querySelector(".widgets-content");
                    if (!widgetsContent) return;

                    // 處理大小切換按鈕點擊
                    widgetsContent.addEventListener("click", (e) => {
                        const sizeBtn = e.target.closest(".widget-size-toggle");
                        if (!sizeBtn) return;

                        e.stopPropagation();
                        e.preventDefault();

                        const widget = sizeBtn.closest(".widget");
                        if (!widget) return;

                        // 獲取當前大小
                        let currentSize =
                            parseInt(widget.dataset.widgetSize) || 2;

                        // 循環切換大小: 1 -> 2 -> 3 -> 1
                        let newSize = currentSize >= 3 ? 1 : currentSize + 1;

                        // 移除舊的大小類別
                        widget.classList.remove(
                            "widget-size-1",
                            "widget-size-2",
                            "widget-size-3"
                        );

                        // 添加新的大小類別
                        widget.classList.add(`widget-size-${newSize}`);
                        widget.dataset.widgetSize = newSize;

                        // 更新按鈕文字
                        sizeBtn.textContent = newSize;

                        // 保存狀態
                        saveWidgetsState();
                    });

                    // 處理移除按鈕點擊
                    widgetsContent.addEventListener("click", (e) => {
                        const removeBtn =
                            e.target.closest(".widget-remove-btn");
                        if (!removeBtn) return;

                        e.stopPropagation();
                        e.preventDefault();

                        const widget = removeBtn.closest(".widget");
                        if (!widget) return;

                        // 移除小工具（帶淡出動畫）
                        widget.style.transition =
                            "opacity 0.3s ease, transform 0.3s ease";
                        widget.style.opacity = "0";
                        widget.style.transform = "scale(0.9)";

                        setTimeout(() => {
                            // 記錄已移除的小工具
                            const removedWidgets = JSON.parse(
                                localStorage.getItem("webos_removed_widgets") ||
                                    "[]"
                            );
                            if (
                                widget.dataset.widgetType &&
                                !removedWidgets.includes(
                                    widget.dataset.widgetType
                                )
                            ) {
                                removedWidgets.push(widget.dataset.widgetType);
                                localStorage.setItem(
                                    "webos_removed_widgets",
                                    JSON.stringify(removedWidgets)
                                );
                            }

                            // 清理 widget 內可能存在的 interval
                            try {
                                if (widget._weatherInterval) {
                                    clearInterval(widget._weatherInterval);
                                    widget._weatherInterval = null;
                                }
                                if (widget._perfInterval) {
                                    clearInterval(widget._perfInterval);
                                    widget._perfInterval = null;
                                }
                            } catch (e) {}

                            widget.remove();
                            saveWidgetsState();
                        }, 300);
                    });
                })();

                // --- 5.2.1.1 小工具新增功能 ---
                (function initWidgetAdd() {
                    const addBtn = document.getElementById("widgets-add-btn");
                    const widgetsContent =
                        document.querySelector(".widgets-content");
                    const widgetsPanel =
                        document.getElementById("widgets-panel");
                    if (!addBtn || !widgetsContent) return;

                    // 使用全域定義的 widgetTemplates

                    // 創建新增小工具選單
                    let addMenu = null;

                    function createAddMenu() {
                        if (addMenu) {
                            addMenu.remove();
                        }

                        addMenu = document.createElement("div");
                        addMenu.className = "widget-add-menu";
                        addMenu.style.cssText = `
                        position: absolute;
                        top: 50px;
                        right: 15px;
                        background: var(--mica-bg-dark);
                        backdrop-filter: blur(20px);
                        border: 1px solid rgba(255, 255, 255, 0.15);
                        border-radius: 8px;
                        padding: 8px 0;
                        min-width: 180px;
                        z-index: 100;
                        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
                    `;

                        // 標題
                        const title = document.createElement("div");
                        title.style.cssText = `
                        padding: 8px 16px;
                        color: var(--primary-cyan);
                        font-size: 0.85rem;
                        font-weight: 600;
                        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                        margin-bottom: 4px;
                    `;
                        title.textContent = "新增小工具";
                        addMenu.appendChild(title);

                        // 小工具選項
                        Object.entries(widgetTemplates).forEach(
                            ([type, config]) => {
                                const item = document.createElement("div");
                                item.style.cssText = `
                            padding: 10px 16px;
                            cursor: pointer;
                            display: flex;
                            align-items: center;
                            gap: 10px;
                            color: #fff;
                            font-size: 0.9rem;
                            transition: background 0.2s ease;
                        `;
                                item.innerHTML = `<i class="fa-solid ${config.icon}" style="width: 20px; text-align: center; color: var(--primary-cyan);"></i>${config.name}`;

                                item.addEventListener("mouseenter", () => {
                                    item.style.background =
                                        "rgba(0, 212, 255, 0.2)";
                                });
                                item.addEventListener("mouseleave", () => {
                                    item.style.background = "transparent";
                                });

                                item.addEventListener("click", () => {
                                    const newWidget = config.create();
                                    newWidget.style.opacity = "0";
                                    newWidget.style.transform =
                                        "translateY(10px)";
                                    widgetsContent.appendChild(newWidget);

                                    // 初始化剛新增的小工具（支援天氣與效能監控）
                                    try {
                                        if (
                                            newWidget.classList.contains(
                                                "weather-widget"
                                            ) &&
                                            typeof window.initWeatherWidget ===
                                                "function"
                                        )
                                            window.initWeatherWidget(newWidget);
                                        if (
                                            newWidget.classList.contains(
                                                "performance-widget"
                                            ) &&
                                            typeof window.initPerfWidget ===
                                                "function"
                                        )
                                            window.initPerfWidget(newWidget);
                                    } catch (e) {
                                        console.warn("init widget failed", e);
                                    }

                                    // 從已移除列表中移除
                                    const removedWidgets = JSON.parse(
                                        localStorage.getItem(
                                            "webos_removed_widgets"
                                        ) || "[]"
                                    );
                                    const idx = removedWidgets.indexOf(type);
                                    if (idx > -1) {
                                        removedWidgets.splice(idx, 1);
                                        localStorage.setItem(
                                            "webos_removed_widgets",
                                            JSON.stringify(removedWidgets)
                                        );
                                    }

                                    // 淡入動畫
                                    requestAnimationFrame(() => {
                                        newWidget.style.transition =
                                            "opacity 0.3s ease, transform 0.3s ease";
                                        newWidget.style.opacity = "1";
                                        newWidget.style.transform =
                                            "translateY(0)";
                                    });

                                    // 自動捲動到新增的小工具
                                    setTimeout(() => {
                                        newWidget.scrollIntoView({
                                            behavior: "smooth",
                                            block: "end",
                                        });
                                    }, 100);

                                    saveWidgetsState();
                                    // 不關閉選單，讓使用者可以繼續新增
                                });

                                addMenu.appendChild(item);
                            }
                        );

                        widgetsPanel.appendChild(addMenu);

                        // 點擊外部關閉
                        setTimeout(() => {
                            document.addEventListener(
                                "click",
                                closeAddMenuOnClickOutside
                            );
                        }, 0);
                    }

                    function closeAddMenu() {
                        if (addMenu) {
                            addMenu.remove();
                            addMenu = null;
                        }
                        document.removeEventListener(
                            "click",
                            closeAddMenuOnClickOutside
                        );
                    }

                    function closeAddMenuOnClickOutside(e) {
                        if (
                            addMenu &&
                            !addMenu.contains(e.target) &&
                            e.target !== addBtn &&
                            !addBtn.contains(e.target)
                        ) {
                            closeAddMenu();
                        }
                    }

                    addBtn.addEventListener("click", (e) => {
                        e.stopPropagation();
                        if (addMenu) {
                            closeAddMenu();
                        } else {
                            createAddMenu();
                        }
                    });
                })();

                // --- 5.2.2 小工具拖曳排序功能 ---
                (function initWidgetDragSort() {
                    const widgetsContent =
                        document.querySelector(".widgets-content");
                    if (!widgetsContent) return;

                    let draggedWidget = null;
                    let placeholder = null;
                    let longPressTimer = null;
                    let isDragging = false;
                    let startY = 0;
                    let offsetY = 0;
                    let baseTopOffset = 0; // 基準 top 偏移量（top:0 時 widget 的實際 Y 位置）
                    const LONG_PRESS_DURATION = 500; // 長按 500ms 啟動拖曳

                    // 獲取所有可拖曳的小工具
                    function getWidgets() {
                        return widgetsContent.querySelectorAll(".widget");
                    }

                    // 創建佔位元素
                    function createPlaceholder(height) {
                        const el = document.createElement("div");
                        el.className = "widget-drag-placeholder";
                        el.style.height = height + "px";
                        return el;
                    }

                    // 開始拖曳
                    function startDrag(widget) {
                        isDragging = true;
                        draggedWidget = widget;

                        // 在插入 placeholder 之前獲取 widget 的確切位置（這是我們要保持的位置）
                        const rect = widget.getBoundingClientRect();

                        // 獲取 widgetsContent 容器的位置
                        const containerRect =
                            widgetsContent.getBoundingClientRect();

                        // offsetY: 滑鼠在 widget 內的相對位置
                        offsetY = startY - rect.top;

                        // 創建佔位元素
                        placeholder = createPlaceholder(rect.height);
                        widget.parentNode.insertBefore(placeholder, widget);

                        // 設定拖曳樣式
                        widget.classList.add("dragging");
                        widget.style.position = "absolute";
                        widget.style.margin = "0";
                        widget.style.width = rect.width + "px";
                        widget.style.left =
                            rect.left - containerRect.left + "px";

                        // 先設定 top:0，獲取基準位置
                        widget.style.top = "0px";
                        widget.style.zIndex = "1000";
                        widget.style.pointerEvents = "none";

                        // 獲取 top:0 時的實際 Y 位置，這就是基準偏移量
                        const zeroRect = widget.getBoundingClientRect();
                        baseTopOffset = zeroRect.top;

                        // 計算需要的 top 值使 widget 保持在原來的位置 (rect.top)
                        const neededTop = rect.top - baseTopOffset;
                        widget.style.top = neededTop + "px";

                        document.body.style.cursor = "grabbing";
                    }

                    // 移動拖曳中的小工具
                    function moveDrag(clientY) {
                        if (!isDragging || !draggedWidget) return;

                        // 計算目標 Y 位置（視窗座標）
                        const targetY = clientY - offsetY;

                        // 轉換為 top 值：目標位置 - 基準偏移量
                        const newTop = targetY - baseTopOffset;

                        // 更新位置
                        draggedWidget.style.top = newTop + "px";

                        // 自動滾動
                        const contentRect =
                            widgetsContent.getBoundingClientRect();
                        const scrollThreshold = 50;
                        const scrollSpeed = 10;

                        if (clientY < contentRect.top + scrollThreshold) {
                            widgetsContent.scrollTop -= scrollSpeed;
                        } else if (
                            clientY >
                            contentRect.bottom - scrollThreshold
                        ) {
                            widgetsContent.scrollTop += scrollSpeed;
                        }

                        // 檢測目標位置
                        const widgets = Array.from(getWidgets()).filter(
                            (w) => w !== draggedWidget
                        );

                        // 如果沒有其他小工具，直接返回
                        if (widgets.length === 0) return;

                        // 找到應該插入的位置
                        let insertBefore = null;

                        for (const widget of widgets) {
                            if (widget === placeholder) continue;

                            const rect = widget.getBoundingClientRect();
                            const midY = rect.top + rect.height / 2;

                            if (clientY < midY) {
                                insertBefore = widget;
                                break;
                            }
                        }

                        // 如果 insertBefore 為 null，表示要放到最後
                        // 否則插入到 insertBefore 之前
                        if (insertBefore) {
                            if (
                                placeholder.nextElementSibling !== insertBefore
                            ) {
                                widgetsContent.insertBefore(
                                    placeholder,
                                    insertBefore
                                );
                            }
                        } else {
                            // 放到最後
                            const lastWidget = widgets[widgets.length - 1];
                            if (
                                lastWidget &&
                                lastWidget !== placeholder &&
                                placeholder.previousElementSibling !==
                                    lastWidget
                            ) {
                                widgetsContent.appendChild(placeholder);
                            }
                        }
                    }

                    // 結束拖曳
                    function endDrag() {
                        if (!isDragging || !draggedWidget) return;

                        // 將小工具移到佔位元素的位置
                        if (placeholder && placeholder.parentNode) {
                            placeholder.parentNode.insertBefore(
                                draggedWidget,
                                placeholder
                            );
                            placeholder.parentNode.removeChild(placeholder);
                        }

                        // 重置樣式
                        draggedWidget.classList.remove("dragging");
                        draggedWidget.style.position = "";
                        draggedWidget.style.margin = ""; // 重置 margin
                        draggedWidget.style.width = "";
                        draggedWidget.style.left = "";
                        draggedWidget.style.top = "";
                        draggedWidget.style.zIndex = "";
                        draggedWidget.style.pointerEvents = "";

                        document.body.style.cursor = "";

                        draggedWidget = null;
                        placeholder = null;
                        isDragging = false;

                        // 保存狀態
                        saveWidgetsState();
                    }

                    // 取消拖曳
                    function cancelDrag() {
                        if (longPressTimer) {
                            clearTimeout(longPressTimer);
                            longPressTimer = null;
                        }
                        if (isDragging) {
                            endDrag();
                        }
                    }

                    // 滑鼠事件
                    widgetsContent.addEventListener("mousedown", (e) => {
                        const widget = e.target.closest(".widget");
                        if (!widget) return;

                        // 如果點擊的是輸入框、按鈕、控制按鈕群組，不啟動拖曳
                        if (
                            e.target.tagName === "INPUT" ||
                            e.target.tagName === "BUTTON" ||
                            e.target.closest("button") ||
                            e.target.closest(".widget-controls")
                        ) {
                            return;
                        }

                        startY = e.clientY;

                        longPressTimer = setTimeout(() => {
                            startDrag(widget);
                        }, LONG_PRESS_DURATION);
                    });

                    document.addEventListener("mousemove", (e) => {
                        // 如果還在長按等待中，檢查是否移動太多
                        if (
                            longPressTimer &&
                            Math.abs(e.clientY - startY) > 10
                        ) {
                            clearTimeout(longPressTimer);
                            longPressTimer = null;
                        }

                        if (isDragging) {
                            e.preventDefault();
                            moveDrag(e.clientY);
                        }
                    });

                    document.addEventListener("mouseup", () => {
                        cancelDrag();
                    });

                    // 觸控事件 (支援行動裝置)
                    widgetsContent.addEventListener(
                        "touchstart",
                        (e) => {
                            const widget = e.target.closest(".widget");
                            if (!widget) return;

                            // 如果點擊的是輸入框、按鈕、控制按鈕群組，不啟動拖曳
                            if (
                                e.target.tagName === "INPUT" ||
                                e.target.tagName === "BUTTON" ||
                                e.target.closest("button") ||
                                e.target.closest(".widget-controls")
                            ) {
                                return;
                            }

                            const touch = e.touches[0];
                            startY = touch.clientY;

                            longPressTimer = setTimeout(() => {
                                startDrag(widget);
                                // 震動回饋 (如果支援)
                                if (navigator.vibrate) {
                                    navigator.vibrate(50);
                                }
                            }, LONG_PRESS_DURATION);
                        },
                        { passive: true }
                    );

                    document.addEventListener(
                        "touchmove",
                        (e) => {
                            if (!isDragging) {
                                // 如果還在長按等待中，檢查是否移動太多
                                if (longPressTimer) {
                                    const touch = e.touches[0];
                                    if (Math.abs(touch.clientY - startY) > 10) {
                                        clearTimeout(longPressTimer);
                                        longPressTimer = null;
                                    }
                                }
                                return;
                            }

                            e.preventDefault();
                            const touch = e.touches[0];
                            moveDrag(touch.clientY);
                        },
                        { passive: false }
                    );

                    document.addEventListener("touchend", () => {
                        cancelDrag();
                    });

                    document.addEventListener("touchcancel", () => {
                        cancelDrag();
                    });
                })();

                // --- 5.3 Metro 磚塊點擊事件 ---
                const metroTiles = document.querySelectorAll(
                    ".metro-tile[data-app]"
                );
                metroTiles.forEach((tile) => {
                    tile.addEventListener("click", (e) => {
                        e.stopPropagation();
                        const appName = tile.dataset.app;
                        if (appName) {
                            openWindow(appName);
                            // 保持小工具面板開啟，類似 Win10 平板模式
                        }
                    });
                });

                // --- 6. 全域點擊 (隱藏彈窗) ---
                // 修改：只在模擬器容器內點擊時觸發
                simulatorContainer.addEventListener("click", (e) => {
                    if (
                        !startMenu.contains(e.target) &&
                        e.target !== startButton
                    ) {
                        startMenu.classList.remove("show");
                    }
                    if (
                        !calendarFlyout.contains(e.target) &&
                        e.target !== taskbarTime
                    ) {
                        calendarFlyout.classList.remove("show");
                    }
                    // 全螢幕模式下不關閉小工具面板（作為桌面使用）
                    if (
                        !widgetsPanel.contains(e.target) &&
                        e.target !== widgetsButton &&
                        !widgetsPanel.classList.contains("fullscreen")
                    ) {
                        closeWidgetsPanel();
                    }
                    contextMenu.classList.remove("show");
                    // Hide start menu context if visible
                    const startCtx =
                        document.getElementById("start-context-menu");
                    if (startCtx) startCtx.classList.remove("show");
                });
                // 點擊模擬器外部也隱藏
                document.addEventListener("click", (e) => {
                    if (!simulatorContainer.contains(e.target)) {
                        startMenu.classList.remove("show");
                        calendarFlyout.classList.remove("show");
                        // 全螢幕模式下不關閉小工具面板
                        if (!widgetsPanel.classList.contains("fullscreen")) {
                            closeWidgetsPanel();
                        }
                        contextMenu.classList.remove("show");
                        const startCtx2 =
                            document.getElementById("start-context-menu");
                        if (startCtx2) startCtx2.classList.remove("show");
                    }
                });

                // --- 6.1 點擊非視窗區域時取消活躍視窗 (像 Windows 一樣) ---
                // 桌面點擊
                desktop.addEventListener("mousedown", (e) => {
                    // 如果點擊的是桌面本身（不是桌面上的應用圖示）
                    if (
                        e.target === desktop ||
                        e.target.closest(".desktop-icon")
                    ) {
                        clearActiveWindow();
                    }
                });

                // 工作列點擊 (排除會開啟視窗的按鈕)
                taskbar.addEventListener("mousedown", (e) => {
                    const target = e.target;
                    const taskbarIcon = target.closest(
                        ".taskbar-icon[data-app]"
                    );
                    // 如果不是點擊應用圖示，則清除活躍視窗
                    if (!taskbarIcon) {
                        clearActiveWindow();
                    }
                });

                // 小工具面板點擊
                widgetsPanel.addEventListener("mousedown", (e) => {
                    // 只在點擊小工具面板內部非視窗區域時清除
                    if (!e.target.closest(".window")) {
                        clearActiveWindow();
                    }
                });

                // 開始選單點擊
                startMenu.addEventListener("mousedown", (e) => {
                    clearActiveWindow();
                });

                // 日曆彈窗點擊
                calendarFlyout.addEventListener("mousedown", (e) => {
                    clearActiveWindow();
                });

                // --- 7. 右鍵選單 ---
                // 桌面右鍵選單由 desktopManager 處理，這裡只處理開始功能表

                // Start-menu body right-click: open a start-specific context menu (positioned at mouse location)
                const startMenuBodyEl = document.querySelector(
                    "#start-menu .start-menu-body"
                );
                const startContextMenu =
                    document.getElementById("start-context-menu");
                if (startMenuBodyEl && startContextMenu) {
                    startMenuBodyEl.addEventListener("contextmenu", (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        // Position relative to the simulator container (same as desktop context menu)
                        const containerRect =
                            simulatorContainer.getBoundingClientRect();
                        let styleTop = e.clientY - containerRect.top;
                        let styleLeft = e.clientX - containerRect.left;

                        const menuWidth = startContextMenu.offsetWidth || 220;
                        const menuHeight = startContextMenu.offsetHeight || 100;

                        if (
                            styleLeft + menuWidth >
                            simulatorContainer.clientWidth
                        ) {
                            styleLeft =
                                simulatorContainer.clientWidth - menuWidth;
                            if (styleLeft < 0) styleLeft = 0;
                        }
                        if (
                            styleTop + menuHeight >
                            simulatorContainer.clientHeight
                        ) {
                            styleTop =
                                simulatorContainer.clientHeight - menuHeight;
                            if (styleTop < 0) styleTop = 0;
                        }

                        startContextMenu.style.left = `${styleLeft}px`;
                        startContextMenu.style.top = `${styleTop}px`;
                        startContextMenu.classList.add("show");
                        // ensure we hide the global desktop context menu
                        contextMenu.classList.remove("show");
                    });

                    // Close it when clicking the Start menu header or anywhere else inside the start menu but not the menu itself
                    startMenu.addEventListener("click", (e) => {
                        if (!startContextMenu.contains(e.target))
                            startContextMenu.classList.remove("show");
                    });
                }

                // --- 7.5 工具列點擊反饋動畫 ---

                // 創建漣漪效果
                function createRipple(element, event) {
                    // 移除現有的漣漪效果
                    const existingRipple = element.querySelector(".ripple");
                    if (existingRipple) {
                        existingRipple.remove();
                    }

                    const ripple = document.createElement("span");
                    ripple.classList.add("ripple");

                    const rect = element.getBoundingClientRect();
                    const size = Math.max(rect.width, rect.height);
                    const x = event.clientX - rect.left - size / 2;
                    const y = event.clientY - rect.top - size / 2;

                    ripple.style.width = ripple.style.height = `${size}px`;
                    ripple.style.left = `${x}px`;
                    ripple.style.top = `${y}px`;

                    element.appendChild(ripple);

                    // 動畫結束後移除漣漪元素
                    ripple.addEventListener("animationend", () => {
                        ripple.remove();
                    });
                }

                // 添加彈跳效果
                function addClickBounce(element) {
                    element.classList.remove("click-bounce");
                    // 觸發 reflow 以重新啟動動畫
                    void element.offsetWidth;
                    element.classList.add("click-bounce");

                    element.addEventListener(
                        "animationend",
                        () => {
                            element.classList.remove("click-bounce");
                        },
                        { once: true }
                    );
                }

                // 為所有任務欄圖標綁定點擊動畫效果 (使用事件委派)
                taskbar.addEventListener("click", (e) => {
                    const icon = e.target.closest(".taskbar-icon");
                    if (icon) {
                        createRipple(icon, e);
                        addClickBounce(icon);
                    }
                });

                // --- 8. 視窗管理 ---

                // 8.1 設為活躍
                function focusWindow(windowEl) {
                    // If the window is minimized, restore it first
                    if (windowEl && windowEl.classList.contains("minimized")) {
                        openWindow(windowEl.dataset.app);
                        return;
                    }
                    if (activeWindow === windowEl) return;

                    // Demote previous active window to the top of inactive stack
                    if (activeWindow) {
                        activeWindow.classList.remove("active");
                        highestZIndex++;
                        activeWindow.style.zIndex = highestZIndex;
                    }
                    windows.forEach((w) => w.classList.remove("active"));

                    activeWindow = windowEl;
                    activeWindow.classList.add("active");

                    // Promote new active window to the dedicated active layer (3000)
                    // This ensures it is above snap-preview (2000) but snap-preview is above inactive windows (1000+)
                    activeWindow.style.zIndex = 3000;

                    updateTaskbarActive(activeWindow.dataset.app);
                }

                // 8.1.1 清除活躍視窗 (點擊桌面、工作列、小工具等非視窗區域時)
                function clearActiveWindow() {
                    if (activeWindow) {
                        activeWindow.classList.remove("active");
                        highestZIndex++;
                        activeWindow.style.zIndex = highestZIndex;
                        activeWindow = null;
                        updateTaskbarActive(null);
                    }
                }

                // 8.2 更新任務欄
                function updateTaskbarActive(appId) {
                    getAllTaskbarIcons().forEach((icon) => {
                        // Update active-app state (foreground)
                        const isActive = icon.dataset.app === appId;
                        icon.classList.toggle("active-app", isActive);
                        // Accessibility: set aria-pressed for the taskbar button to reflect active state
                        icon.setAttribute("aria-pressed", String(!!isActive));
                        // Update open-app based on whether the window is currently showing (foreground),
                        // or minimized (app still running in background). Treat minimized windows as open-app.
                        const winEl = document.getElementById(
                            `window-${icon.dataset.app}`
                        );
                        if (
                            winEl &&
                            (winEl.classList.contains("show") ||
                                winEl.classList.contains("minimized"))
                        ) {
                            icon.classList.add("open-app");
                        } else {
                            icon.classList.remove("open-app");
                        }
                    });
                }

                // Utility: ensure a taskbar icon exists for an app. If not, create a temporary icon for running (non-pinned) apps.
                function createTaskbarIconIfMissing(appId) {
                    if (!appId) return null;
                    let existing = document.getElementById(
                        `taskbar-icon-${appId}`
                    );
                    if (existing) return existing;
                    const centerGroup = document.querySelector(
                        "#taskbar .taskbar-group.center"
                    );
                    if (!centerGroup) return null;
                    const el = document.createElement("div");
                    el.className = "taskbar-icon";
                    el.id = `taskbar-icon-${appId}`;
                    el.dataset.app = appId;
                    el.setAttribute("role", "button");
                    el.setAttribute("tabindex", "0");
                    el.setAttribute("aria-pressed", "false");
                    // mark as temporary (not pinned) so it can be removed on close
                    el.setAttribute("data-temporary", "true");
                    // Choose proper icon markup (use image for nagato, otherwise FA icons)
                    switch (appId) {
                        case "nagato":
                            el.innerHTML = `<img src="assets/apps/icon/NS-V2.png" alt="長門櫻" class="app-icon-img icon-nagato" loading="lazy">`;
                            el.title = "長門櫻";
                            break;
                        case "settings":
                            el.innerHTML = `<i class="fa-solid fa-gear icon-settings"></i>`;
                            el.title = "設定";
                            break;
                        case "explorer":
                            el.innerHTML = `<i class="fa-solid fa-folder icon-explorer"></i>`;
                            el.title = "檔案總管";
                            break;
                        case "browser":
                            el.innerHTML = `<i class="fa-brands fa-edge icon-edge"></i>`;
                            el.title = "瀏覽器";
                            break;
                        case "store":
                            el.innerHTML = `<i class="fa-solid fa-store icon-store"></i>`;
                            el.title = "應用商店";
                            break;
                        case "calculator":
                            el.innerHTML = `<i class="fa-solid fa-calculator icon-calculator"></i>`;
                            el.title = "計算機";
                            break;
                        case "notepad":
                            el.innerHTML = `<i class="fa-solid fa-file-lines icon-notepad"></i>`;
                            el.title = "記事本";
                            break;
                        case "terminal":
                            el.innerHTML = `<i class="fa-solid fa-terminal icon-terminal"></i>`;
                            el.title = "終端機";
                            break;
                        case "photos":
                            el.innerHTML = `<i class="fa-solid fa-image icon-photos"></i>`;
                            el.title = "相簿";
                            break;
                        case "player":
                            el.innerHTML = `<i class="fa-solid fa-circle-play icon-player"></i>`;
                            el.title = "播放器";
                            break;
                        default:
                            el.innerHTML = `<i class="fa-solid fa-square"></i>`;
                            el.title = appId;
                            break;
                    }
                    // Insert icons before the right side of center group (i.e., append to center by default)
                    centerGroup.appendChild(el);
                    return el;
                }

                // 8.3 開啟視窗
                function openWindow(appId) {
                    const windowEl = document.getElementById(`window-${appId}`);
                    if (!windowEl) return;
                    const wasMinimized =
                        windowEl.classList.contains("minimized");
                    windowEl.classList.add("show");
                    windowEl.classList.remove("minimized");
                    // Taskbar icon should be marked as open (background/foreground)
                    let tbIcon = document.getElementById(
                        `taskbar-icon-${appId}`
                    );
                    if (!tbIcon) tbIcon = createTaskbarIconIfMissing(appId);
                    if (tbIcon) tbIcon.classList.add("open-app");
                    // If the window has not been placed yet (no inline position), center it within the desktop
                    // only when it is not maximized/snapped. This prevents re-centering restorations.
                    try {
                        const desktopEl = document.getElementById("desktop");
                        const taskbarEl = document.getElementById("taskbar");
                        if (
                            desktopEl &&
                            taskbarEl &&
                            !windowEl.dataset.placed &&
                            !windowEl.dataset.isSnapped &&
                            !windowEl.dataset.isMaximized
                        ) {
                            // Ensure the window is shown first so offsetWidth/offsetHeight are reliable
                            const tbHeight = taskbarEl.offsetHeight || 0;
                            const containerWidth = desktopEl.clientWidth;
                            const containerHeight =
                                desktopEl.clientHeight - tbHeight;
                            const winWidth =
                                windowEl.offsetWidth ||
                                parseFloat(
                                    window.getComputedStyle(windowEl).width
                                ) ||
                                400;
                            const winHeight =
                                windowEl.offsetHeight ||
                                parseFloat(
                                    window.getComputedStyle(windowEl).height
                                ) ||
                                300;
                            let left = Math.max(
                                0,
                                Math.round((containerWidth - winWidth) / 2)
                            );
                            let top = Math.max(
                                0,
                                Math.round((containerHeight - winHeight) / 2)
                            );
                            // If the window was created with top/left inline, don't override
                            const hasInlineLeft =
                                windowEl.style.left &&
                                windowEl.style.left !== "" &&
                                windowEl.style.left !== "auto";
                            const hasInlineTop =
                                windowEl.style.top &&
                                windowEl.style.top !== "" &&
                                windowEl.style.top !== "auto";
                            if (!hasInlineLeft)
                                windowEl.style.left = `${left}px`;
                            if (!hasInlineTop) windowEl.style.top = `${top}px`;
                            // Mark placed so future opens do not re-center
                            windowEl.dataset.placed = "true";
                        }
                    } catch (err) {
                        console.error("Failed to auto-center window", err);
                    }
                    focusWindow(windowEl);

                    if (appId === "browser") {
                        const iframe = windowEl.querySelector("iframe");
                        // By default, when opening the browser, use the user-customized url if available
                        const desired = (
                            document.getElementById("browser-url-input")
                                ?.value ||
                            iframe.src ||
                            ""
                        ).trim();
                        const urlToSet =
                            !desired || desired === "about:blank"
                                ? "https://amanoshizukikun.github.io/"
                                : desired;
                        // If we are restoring from minimized state, avoid forcing a reload or pushing history
                        setBrowserUrl(urlToSet, !wasMinimized);
                        // Ensure iframe is visible as it uses the 'show' class to display in Edge-like UI
                        iframe.classList.add("show");
                    }
                    if (appId === "nagato") {
                        // Focus input and refresh messages when opening the assistant
                        setTimeout(() => {
                            const inputEl =
                                document.getElementById("nagato-input");
                            if (inputEl) {
                                inputEl.focus({ preventScroll: true });
                            }
                            try {
                                renderNagatoMessages();
                            } catch (e) {}
                        }, 50);
                    }
                    if (appId === "calculator") {
                        const calcInput = document.getElementById("calc-input");
                        if (calcInput) {
                            // Delay slightly so that the window becomes focusable first
                            setTimeout(() => {
                                calcInput.focus({ preventScroll: true });
                            }, 0);
                        }
                    }
                }

                // 8.4 關閉視窗
                function closeWindow(appId) {
                    const windowEl = document.getElementById(`window-${appId}`);
                    if (windowEl) {
                        windowEl.classList.remove("show");
                    }

                    // 如果是播放器，停止播放
                    if (
                        appId === "player" &&
                        typeof playerApp !== "undefined"
                    ) {
                        playerApp.stop();
                    }

                    const tbIconClose = document.getElementById(
                        `taskbar-icon-${appId}`
                    );
                    if (tbIconClose) {
                        // If temporary (creator-created) icon, remove it when the app closes
                        if (tbIconClose.hasAttribute("data-temporary")) {
                            tbIconClose.remove();
                        } else {
                            // pinned: just clear state
                            tbIconClose.classList.remove("active-app");
                            tbIconClose.classList.remove("open-app");
                            tbIconClose.setAttribute("aria-pressed", "false");
                        }
                    }
                    if (activeWindow === windowEl) {
                        activeWindow = null;
                        // If there are other visible windows, focus the top-most (highest z-index)
                        const visibleWindows = Array.from(
                            document.querySelectorAll(".window.show")
                        ).filter(
                            (w) =>
                                !w.classList.contains("minimized") &&
                                w !== windowEl
                        );
                        if (visibleWindows.length > 0) {
                            visibleWindows.sort(
                                (a, b) =>
                                    (parseInt(b.style.zIndex, 10) || 0) -
                                    (parseInt(a.style.zIndex, 10) || 0)
                            );
                            focusWindow(visibleWindows[0]);
                        }
                    }
                }

                // 8.5 最小化視窗
                function minimizeWindow(appId) {
                    const windowEl = document.getElementById(`window-${appId}`);
                    if (windowEl) {
                        windowEl.classList.add("minimized");
                        windowEl.classList.remove("show", "active");
                        // Keep the taskbar icon as open (app still running in background). Remove 'active-app'.
                        const tbIconMin = document.getElementById(
                            `taskbar-icon-${appId}`
                        );
                        if (tbIconMin) {
                            tbIconMin.classList.remove("active-app");
                            tbIconMin.classList.add("open-app"); // keep as open while minimized
                            tbIconMin.setAttribute("aria-pressed", "false");
                        }
                    }
                    if (activeWindow === windowEl) {
                        activeWindow = null;
                    }
                    // Update taskbar icons to ensure active state is consistent
                    updateTaskbarActive(null);
                }

                // 8.6 最大化/還原 視窗
                function maximizeWindow(appId) {
                    const windowEl = document.getElementById(`window-${appId}`);
                    if (windowEl) {
                        if (!windowEl.dataset.isMaximized) {
                            const cs = window.getComputedStyle(windowEl);
                            windowEl.dataset.oldX =
                                windowEl.style.left || cs.left;
                            windowEl.dataset.oldY =
                                windowEl.style.top || cs.top;
                            windowEl.dataset.oldW =
                                windowEl.style.width || cs.width;
                            windowEl.dataset.oldH =
                                windowEl.style.height || cs.height;

                            windowEl.style.left = "0";
                            windowEl.style.top = "0";
                            windowEl.style.width = "100%";
                            // 高度 100% 減去任務欄高度 (相對於 .simulator-container)
                            windowEl.style.height = `calc(100% - ${taskbar.offsetHeight}px)`;
                            windowEl.dataset.isMaximized = "true";
                        } else {
                            // 還原
                            windowEl.style.left =
                                windowEl.dataset.oldX || "100px";
                            windowEl.style.top =
                                windowEl.dataset.oldY || "100px";
                            windowEl.style.width =
                                windowEl.dataset.oldW || "700px";
                            windowEl.style.height =
                                windowEl.dataset.oldH || "500px";
                            windowEl.dataset.isMaximized = "";
                        }
                        focusWindow(windowEl);
                    }
                }

                // 8.7 Snap windows to left/right or corners
                function snapWindow(windowEl, mode) {
                    if (!windowEl) return;
                    // save previous rect if not already saved
                    if (!windowEl.dataset.oldW) {
                        const cs = window.getComputedStyle(windowEl);
                        windowEl.dataset.oldX = windowEl.style.left || cs.left;
                        windowEl.dataset.oldY = windowEl.style.top || cs.top;
                        windowEl.dataset.oldW =
                            windowEl.style.width || cs.width;
                        windowEl.dataset.oldH =
                            windowEl.style.height || cs.height;
                    }
                    const contentBoxWidth = desktop.clientWidth;
                    const contentBoxHeight = desktop.clientHeight;
                    const taskbarHeight = taskbar.offsetHeight;
                    let newLeft = 0;
                    let newTop = 0;
                    let newWidth = windowEl.offsetWidth;
                    let newHeight = contentBoxHeight - taskbarHeight;

                    switch (mode) {
                        case "left":
                            newLeft = 0;
                            newWidth = Math.floor(contentBoxWidth / 2);
                            break;
                        case "right":
                            newLeft = Math.ceil(contentBoxWidth / 2);
                            newWidth = Math.floor(contentBoxWidth / 2);
                            break;
                        case "left-top":
                            newLeft = 0;
                            newTop = 0;
                            newWidth = Math.floor(contentBoxWidth / 2);
                            newHeight = Math.floor(
                                (contentBoxHeight - taskbarHeight) / 2
                            );
                            break;
                        case "right-top":
                            newLeft = Math.ceil(contentBoxWidth / 2);
                            newTop = 0;
                            newWidth = Math.floor(contentBoxWidth / 2);
                            newHeight = Math.floor(
                                (contentBoxHeight - taskbarHeight) / 2
                            );
                            break;
                        case "left-bottom":
                            newLeft = 0;
                            newTop = Math.ceil(
                                (contentBoxHeight - taskbarHeight) / 2
                            );
                            newWidth = Math.floor(contentBoxWidth / 2);
                            newHeight = Math.floor(
                                (contentBoxHeight - taskbarHeight) / 2
                            );
                            break;
                        case "right-bottom":
                            newLeft = Math.ceil(contentBoxWidth / 2);
                            newTop = Math.ceil(
                                (contentBoxHeight - taskbarHeight) / 2
                            );
                            newWidth = Math.floor(contentBoxWidth / 2);
                            newHeight = Math.floor(
                                (contentBoxHeight - taskbarHeight) / 2
                            );
                            break;
                        default:
                            return;
                    }

                    windowEl.style.left = `${newLeft}px`;
                    windowEl.style.top = `${newTop}px`;
                    windowEl.style.width = `${newWidth}px`;
                    windowEl.style.height = `${newHeight}px`;
                    // mark snapped state
                    windowEl.dataset.isSnapped = mode;
                    // ensure not maximized
                    windowEl.dataset.isMaximized = "";
                    focusWindow(windowEl);
                }

                // --- 9. 視窗事件綁定 (拖動, 調整大小, 控制按鈕) ---
                windows.forEach((windowEl) => {
                    const header = windowEl.querySelector(".window-header");
                    const appId = windowEl.dataset.app;

                    // 9.1 點擊視窗時設為 Active
                    windowEl.addEventListener(
                        "mousedown",
                        () => {
                            focusWindow(windowEl);
                        },
                        true
                    );
                    windowEl.addEventListener(
                        "pointerdown",
                        (e) => {
                            focusWindow(windowEl);
                        },
                        true
                    );

                    // 9.2 拖動 (使用全域 actionState)
                    header.addEventListener("mousedown", (e) => {
                        // ignore if the click comes from a resize handle that sits above the header
                        if (
                            e.target.closest &&
                            e.target.closest(".resize-handle")
                        )
                            return;
                        if (e.target.closest(".window-control-btn")) return;
                        // If the window is maximized, we no longer restore immediately on mousedown.
                        // Instead, enable restore-on-drag: only when user moves the cursor beyond a
                        // small threshold (i.e. starts to drag) do we restore and continue dragging.
                        actionState.restoreOnDrag =
                            windowEl.dataset.isMaximized === "true";
                        // Restore if window was snapped
                        if (windowEl.dataset.isSnapped) {
                            const cs = window.getComputedStyle(windowEl);
                            const oldX =
                                parseFloat(windowEl.dataset.oldX) ||
                                parseFloat(cs.left) ||
                                100;
                            const oldY =
                                parseFloat(windowEl.dataset.oldY) ||
                                parseFloat(cs.top) ||
                                100;
                            const oldW =
                                parseFloat(windowEl.dataset.oldW) ||
                                windowEl.offsetWidth;
                            const oldH =
                                parseFloat(windowEl.dataset.oldH) ||
                                windowEl.offsetHeight;
                            windowEl.style.width = `${oldW}px`;
                            windowEl.style.height = `${oldH}px`;
                            windowEl.style.left = `${oldX}px`;
                            windowEl.style.top = `${oldY}px`;
                            windowEl.dataset.isSnapped = "";
                        }
                        // If window was snapped (left/right), restoring to previous size so dragging feels natural
                        if (windowEl.dataset.isSnapped) {
                            const cs = window.getComputedStyle(windowEl);
                            const oldX =
                                parseFloat(windowEl.dataset.oldX) ||
                                parseFloat(cs.left) ||
                                100;
                            const oldY =
                                parseFloat(windowEl.dataset.oldY) ||
                                parseFloat(cs.top) ||
                                100;
                            const oldW =
                                parseFloat(windowEl.dataset.oldW) ||
                                windowEl.offsetWidth;
                            const oldH =
                                parseFloat(windowEl.dataset.oldH) ||
                                windowEl.offsetHeight;
                            windowEl.style.width = `${oldW}px`;
                            windowEl.style.height = `${oldH}px`;
                            windowEl.style.left = `${oldX}px`;
                            windowEl.style.top = `${oldY}px`;
                            windowEl.dataset.isSnapped = "";
                        }
                        focusWindow(windowEl);
                        const rect = windowEl.getBoundingClientRect();
                        const parentRect = desktop.getBoundingClientRect();
                        const parentStyle = window.getComputedStyle(desktop);
                        const parentPaddingLeft =
                            parseFloat(parentStyle.paddingLeft) || 0;
                        const parentPaddingTop =
                            parseFloat(parentStyle.paddingTop) || 0;
                        const parentOriginX =
                            parentRect.left + parentPaddingLeft;
                        const parentOriginY = parentRect.top + parentPaddingTop;

                        actionState.type = "drag";
                        actionState.windowEl = windowEl;
                        actionState.startX = e.clientX;
                        actionState.startY = e.clientY;
                        // Prefer explicit style.left/style.top if present, otherwise compute from rect
                        const explicitLeft = parseFloat(windowEl.style.left);
                        const explicitTop = parseFloat(windowEl.style.top);
                        actionState.startLeft = Number.isFinite(explicitLeft)
                            ? explicitLeft
                            : rect.left - parentOriginX;
                        actionState.startTop = Number.isFinite(explicitTop)
                            ? explicitTop
                            : rect.top - parentOriginY;
                        actionState.pointerId = e.pointerId || null;
                        actionState.captureTarget = header || e.target || null;

                        // prevent text selection during drag
                        document.body.style.userSelect = "none";
                        try {
                            if (e.pointerId)
                                (header.setPointerCapture &&
                                    header.setPointerCapture(e.pointerId)) ||
                                    (e.target.setPointerCapture &&
                                        e.target.setPointerCapture(
                                            e.pointerId
                                        ));
                        } catch (err) {}
                        e.preventDefault();
                    });
                    header.addEventListener("pointerdown", (e) => {
                        // ignore if the pointerdown originates from a resize handle
                        if (
                            e.target.closest &&
                            e.target.closest(".resize-handle")
                        )
                            return;
                        if (e.target.closest(".window-control-btn")) return;
                        // same as mouse handler: delay restore until actual drag occurs
                        actionState.restoreOnDrag =
                            windowEl.dataset.isMaximized === "true";
                        focusWindow(windowEl);
                        const rect = windowEl.getBoundingClientRect();
                        const parentRect = desktop.getBoundingClientRect();
                        const parentStyle = window.getComputedStyle(desktop);
                        const parentPaddingLeft =
                            parseFloat(parentStyle.paddingLeft) || 0;
                        const parentPaddingTop =
                            parseFloat(parentStyle.paddingTop) || 0;
                        const parentOriginX =
                            parentRect.left + parentPaddingLeft;
                        const parentOriginY = parentRect.top + parentPaddingTop;

                        actionState.type = "drag";
                        actionState.windowEl = windowEl;
                        actionState.startX = e.clientX;
                        actionState.startY = e.clientY;
                        const explicitLeft2 = parseFloat(windowEl.style.left);
                        const explicitTop2 = parseFloat(windowEl.style.top);
                        actionState.startLeft = Number.isFinite(explicitLeft2)
                            ? explicitLeft2
                            : rect.left - parentOriginX;
                        actionState.startTop = Number.isFinite(explicitTop2)
                            ? explicitTop2
                            : rect.top - parentOriginY;

                        // prevent text selection during drag
                        document.body.style.userSelect = "none";
                        try {
                            if (e.pointerId)
                                e.target.setPointerCapture &&
                                    e.target.setPointerCapture(e.pointerId);
                        } catch (err) {}
                        e.preventDefault();
                    });
                    // Double-click header toggles maximize
                    header.addEventListener("dblclick", (e) => {
                        if (e.target.closest(".window-control-btn")) return;
                        maximizeWindow(appId);
                    });

                    // 9.3 調整大小 (使用 resizewin 函數)
                    windowEl
                        .querySelectorAll(".resize-handle")
                        .forEach((handle) => {
                            const direction =
                                Array.from(handle.classList).find(
                                    (c) => c.length <= 2
                                ) || "";
                            let arg = "";
                            if (direction === "n") arg = "top";
                            else if (direction === "s") arg = "bottom";
                            else if (direction === "e") arg = "right";
                            else if (direction === "w") arg = "left";
                            else if (direction === "nw") arg = "top-left";
                            else if (direction === "ne") arg = "top-right";
                            else if (direction === "sw") arg = "bottom-left";
                            else if (direction === "se") arg = "bottom-right";

                            handle.addEventListener("mousedown", (e) => {
                                focusWindow(windowEl);
                                e.stopPropagation();
                                document.body.style.userSelect = "none";
                                resizewin(windowEl, arg, handle, e);
                                e.preventDefault();
                            });
                            handle.addEventListener("pointerdown", (e) => {
                                focusWindow(windowEl);
                                e.stopPropagation();
                                document.body.style.userSelect = "none";
                                resizewin(windowEl, arg, handle, e);
                                e.preventDefault();
                            });
                        });
                    // 9.4 Snap layout option handlers
                    const snapOptions = windowEl.querySelectorAll(
                        ".snap-layout-option"
                    );
                    if (snapOptions && snapOptions.length) {
                        snapOptions.forEach((opt, i) => {
                            opt.addEventListener("click", (e) => {
                                e.stopPropagation();
                                switch (i) {
                                    case 0:
                                        snapWindow(windowEl, "left-top");
                                        break;
                                    case 1:
                                        snapWindow(windowEl, "right-top");
                                        break;
                                    case 2:
                                        snapWindow(windowEl, "left-bottom");
                                        break;
                                    case 3:
                                        snapWindow(windowEl, "right-bottom");
                                        break;
                                }
                            });
                        });
                    }

                    // Note: mousemove and mouseup handlers are added globally once below

                    // 9.5 全域 MouseUp handled globally below

                    // 9.6 控制按鈕
                    windowEl
                        .querySelector(".close")
                        .addEventListener("click", () => closeWindow(appId));
                    windowEl
                        .querySelector(".minimize")
                        .addEventListener("click", () => minimizeWindow(appId));
                    windowEl
                        .querySelector(".maximize")
                        .addEventListener("click", () => maximizeWindow(appId));
                });

                // Global mouse handlers for drag/resize (single listener for all windows)
                // Use RAF to throttle updates and support pointer events to avoid stuck state / missing mouseup

                /**
                 * - Uses a local `state` to capture start geometry and pointer start coordinates
                 * - Throttles layout updates with requestAnimationFrame to reduce layout thrashing
                 * - Anchors the opposite edge (right/bottom) when resizing from left/top to avoid
                 *   the window 'jumping' or 'sliding' unexpectedly
                 * - Supports mouse, touch and pointer events (pointer capture when supported)
                 */
                function resizewin(win, arg, resizeElt, ev) {
                    const desktop = document.getElementById("desktop");
                    const desktopRect = desktop.getBoundingClientRect();
                    const taskbar = document.getElementById("taskbar");
                    const taskbarHeight = taskbar ? taskbar.offsetHeight : 0;
                    const startRect = win.getBoundingClientRect();
                    const explicitLeft = parseFloat(win.style.left);
                    const explicitTop = parseFloat(win.style.top);
                    const startLeft = Number.isFinite(explicitLeft)
                        ? explicitLeft
                        : startRect.left - desktopRect.left;
                    const startTop = Number.isFinite(explicitTop)
                        ? explicitTop
                        : startRect.top - desktopRect.top;
                    const state = {
                        startX: null,
                        startY: null,
                        startLeft: startLeft,
                        startTop: startTop,
                        startWidth: startRect.width,
                        startHeight: startRect.height,
                        rightEdge: startLeft + startRect.width,
                        bottomEdge: startTop + startRect.height,
                        currentX: null,
                        currentY: null,
                        rafId: null,
                        pointerId: null,
                        captureTarget: null,
                    };

                    function applyResize() {
                        if (
                            state.currentX === null ||
                            state.currentY === null ||
                            state.startX === null
                        )
                            return;
                        const minWidth = win.dataset.minWidth
                            ? parseFloat(win.dataset.minWidth)
                            : 400;
                        const minHeight = win.dataset.minHeight
                            ? parseFloat(win.dataset.minHeight)
                            : 300;
                        const dx = state.currentX - state.startX;
                        const dy = state.currentY - state.startY;

                        let newLeft = state.startLeft;
                        let newTop = state.startTop;
                        let newWidth = state.startWidth;
                        let newHeight = state.startHeight;
                        const viewW = desktop.clientWidth;
                        const viewH = desktop.clientHeight;

                        // Horizontal
                        if (arg.indexOf("right") !== -1 || arg === "right") {
                            newWidth = Math.max(
                                minWidth,
                                Math.min(
                                    viewW - state.startLeft,
                                    state.startWidth + dx
                                )
                            );
                        }
                        if (arg.indexOf("left") !== -1 || arg === "left") {
                            // anchor right edge
                            let candidateLeft = state.startLeft + dx;
                            candidateLeft = Math.max(
                                0,
                                Math.min(
                                    candidateLeft,
                                    state.rightEdge - minWidth
                                )
                            );
                            newLeft = candidateLeft;
                            newWidth = state.rightEdge - newLeft;
                        }

                        // Vertical
                        if (arg.indexOf("bottom") !== -1 || arg === "bottom") {
                            newHeight = Math.max(
                                minHeight,
                                Math.min(
                                    viewH - state.startTop,
                                    state.startHeight + dy
                                )
                            );
                        }
                        if (arg.indexOf("top") !== -1 || arg === "top") {
                            let candidateTop = state.startTop + dy;
                            candidateTop = Math.max(
                                0,
                                Math.min(
                                    candidateTop,
                                    state.bottomEdge - minHeight
                                )
                            );
                            newTop = candidateTop;
                            newHeight = state.bottomEdge - newTop;
                        }

                        // clamp to view
                        if (newLeft + newWidth > viewW)
                            newWidth = Math.max(minWidth, viewW - newLeft);
                        if (newTop + newHeight > viewH)
                            newHeight = Math.max(minHeight, viewH - newTop);

                        win.style.left = `${newLeft}px`;
                        win.style.top = `${newTop}px`;
                        win.style.width = `${newWidth}px`;
                        win.style.height = `${newHeight}px`;
                    }

                    function tick() {
                        if (state.rafId) return;
                        state.rafId = requestAnimationFrame(() => {
                            state.rafId = null;
                            applyResize();
                        });
                    }

                    function moveHandler(e) {
                        if (e.type.match("mouse")) {
                            state.currentX = e.clientX;
                            state.currentY = e.clientY;
                        } else if (e.type.match("touch")) {
                            state.currentX = e.touches[0].clientX;
                            state.currentY = e.touches[0].clientY;
                        } else if (e.type.match("pointer")) {
                            state.currentX = e.clientX;
                            state.currentY = e.clientY;
                        }
                        tick();
                    }

                    function up_f() {
                        // release pointer capture if any
                        try {
                            if (
                                state.captureTarget &&
                                state.pointerId &&
                                state.captureTarget.releasePointerCapture
                            )
                                state.captureTarget.releasePointerCapture(
                                    state.pointerId
                                );
                        } catch (err) {}
                        // remove handlers
                        document.onmousedown = null;
                        document.ontouchstart = null;
                        document.onmousemove = null;
                        document.ontouchmove = null;
                        document.ontouchcancel = null;
                        if (window.PointerEvent) {
                            document.removeEventListener(
                                "pointermove",
                                moveHandler
                            );
                            document.removeEventListener("pointerup", up_f);
                            document.removeEventListener("pointercancel", up_f);
                        }
                        // cancel RAF
                        if (state.rafId) {
                            cancelAnimationFrame(state.rafId);
                            state.rafId = null;
                        }
                        document.body.style.cursor = "auto";
                        document.body.style.userSelect = "";
                        try {
                            if (resizeElt && resizeElt._resizeState)
                                delete resizeElt._resizeState;
                        } catch (err) {}
                    }

                    // set start positions from the event if provided (mousemove/pointerdown/touchstart)
                    if (ev) {
                        if (ev.type && ev.type.indexOf("touch") !== -1) {
                            state.startX =
                                ev.touches && ev.touches[0]
                                    ? ev.touches[0].clientX
                                    : ev.clientX;
                            state.startY =
                                ev.touches && ev.touches[0]
                                    ? ev.touches[0].clientY
                                    : ev.clientY;
                        } else {
                            state.startX = ev.clientX;
                            state.startY = ev.clientY;
                            state.pointerId = ev.pointerId || null;
                            state.captureTarget =
                                resizeElt || ev.target || null;
                            try {
                                if (
                                    ev.pointerId &&
                                    resizeElt &&
                                    resizeElt.setPointerCapture
                                )
                                    resizeElt.setPointerCapture(ev.pointerId);
                            } catch (err) {}
                            // Prevent text selection while resizing
                            document.body.style.userSelect = "none";
                        }
                    }

                    // bind move events
                    document.onmousemove = moveHandler;
                    document.ontouchmove = moveHandler;
                    if (window.PointerEvent) {
                        document.addEventListener("pointermove", moveHandler);
                        document.addEventListener("pointerup", up_f);
                        document.addEventListener("pointercancel", up_f);
                    }

                    // Touch / mouse cleanup
                    document.onmouseup = up_f;
                    document.ontouchend = up_f;
                    document.ontouchcancel = up_f;

                    // reflect cursor style
                    document.body.style.cursor = window.getComputedStyle(
                        resizeElt,
                        null
                    ).cursor;

                    // The mousedown caller should set state.startX/startY to the initial pointer values and set pointer capture
                    // We expose the `state` through the element for the mousedown caller to populate these values and capture pointer.
                    resizeElt._resizeState = state;
                }

                // Allow windows to be dragged partially under the taskbar for improved dragging space
                const DRAG_UNDER_TASKBAR = 40; // px; how many pixels of overlap are allowed under taskbar
                // Off-screen allowance: this value is configurable via the settings slider (see #offscreenRatio)
                // Default to 90% to allow windows to be dragged more freely off-screen
                let OFFSCREEN_ALLOW_RATIO = 0.9; // ratio (0-1)
                // Hook settings slider if present to change this value dynamically
                try {
                    const _offscreenSlider =
                        document.getElementById("offscreenRatio");
                    const _offscreenValue = document.getElementById(
                        "offscreenRatioValue"
                    );
                    if (_offscreenSlider && _offscreenValue) {
                        const saved = localStorage.getItem("offscreenRatio");
                        if (saved !== null && !Number.isNaN(Number(saved))) {
                            _offscreenSlider.value = String(Number(saved));
                        }
                        OFFSCREEN_ALLOW_RATIO =
                            Number(_offscreenSlider.value) / 100;
                        _offscreenValue.textContent = `${_offscreenSlider.value}%`;
                        _offscreenSlider.addEventListener("input", (e) => {
                            const v = Number(e.target.value);
                            OFFSCREEN_ALLOW_RATIO = v / 100;
                            _offscreenValue.textContent = `${v}%`;
                        });
                        _offscreenSlider.addEventListener("change", (e) => {
                            localStorage.setItem(
                                "offscreenRatio",
                                String(Number(e.target.value))
                            );
                        });
                    }
                } catch (err) {
                    console.error(err);
                }
                let rafId = null;
                // create snap preview element and append to desktop
                let snapPreview = document.getElementById("snap-preview");
                // Hover timer for snap/ maximize preview (wait to show preview to avoid accidental snaps)
                // Delay (ms) before showing the preview while dragging near the edges
                const SNAP_HOVER_DELAY = 30; // 30ms per user's request
                let snapHoverTimer = null;
                let snapHoverMode = "";

                function setSnapHoverMode(mode) {
                    // Cancel any pending timer if mode changed
                    if (!mode) {
                        if (snapHoverTimer) {
                            clearTimeout(snapHoverTimer);
                            snapHoverTimer = null;
                        }
                        snapHoverMode = "";
                        hideSnapPreview();
                        return;
                    }
                    // If same mode and already showing, do nothing
                    if (
                        mode === snapHoverMode &&
                        snapPreview &&
                        snapPreview.classList.contains("show")
                    )
                        return;
                    // If different mode, reset timer
                    if (snapHoverTimer) {
                        clearTimeout(snapHoverTimer);
                        snapHoverTimer = null;
                    }
                    // Start timer to show the preview after SNAP_HOVER_DELAY
                    const desiredMode = mode;
                    snapHoverTimer = setTimeout(() => {
                        snapHoverTimer = null;
                        snapHoverMode = desiredMode;
                        showSnapPreview(desiredMode);
                    }, SNAP_HOVER_DELAY);
                }
                if (!snapPreview) {
                    snapPreview = document.createElement("div");
                    snapPreview.id = "snap-preview";
                    // Append to simulator container (parent of desktop) to avoid being trapped in desktop's lower z-index stacking context
                    // Windows are also children of simulator container (or siblings of desktop), so this allows correct interleaving.
                    const container =
                        document.querySelector(".simulator-container") ||
                        document.body;
                    container.appendChild(snapPreview);
                }
                function requestApply() {
                    if (!rafId)
                        rafId = requestAnimationFrame(() => {
                            rafId = null;
                            applyActionState();
                        });
                }
                function cancelApply() {
                    if (rafId) {
                        cancelAnimationFrame(rafId);
                        rafId = null;
                    }
                }
                function applyActionState() {
                    if (!actionState.type || !actionState.windowEl) return;
                    const windowEl = actionState.windowEl;
                    const parentRect = desktop.getBoundingClientRect();
                    const parentStyle = window.getComputedStyle(desktop);
                    const parentPaddingLeft =
                        parseFloat(parentStyle.paddingLeft) || 0;
                    const parentPaddingTop =
                        parseFloat(parentStyle.paddingTop) || 0;
                    const parentOriginX = parentRect.left + parentPaddingLeft;
                    const parentOriginY = parentRect.top + parentPaddingTop;
                    const contentBoxWidth = desktop.clientWidth;
                    const contentBoxHeight = desktop.clientHeight;
                    const taskbarHeight = taskbar.offsetHeight;

                    if (actionState.type === "drag") {
                        const clientX =
                            actionState.currentX ||
                            actionState.lastMouseX ||
                            actionState.startX;
                        const clientY =
                            actionState.currentY ||
                            actionState.lastMouseY ||
                            actionState.startY;
                        const dx = clientX - actionState.startX;
                        const dy = clientY - actionState.startY;
                        // If the window was maximized and the user started dragging (not just clicking),
                        // perform a restore to the previous size and continue the drag from there.
                        if (
                            actionState.restoreOnDrag &&
                            actionState.windowEl &&
                            actionState.windowEl.dataset.isMaximized === "true"
                        ) {
                            // threshold to avoid accidental restores on small pointer jitter
                            const restoreThreshold = 6; // px
                            if (
                                Math.abs(dx) > restoreThreshold ||
                                Math.abs(dy) > restoreThreshold
                            ) {
                                const wEl = actionState.windowEl;
                                const rect = wEl.getBoundingClientRect();
                                const parentRect =
                                    desktop.getBoundingClientRect();
                                const parentStyle =
                                    window.getComputedStyle(desktop);
                                const parentPaddingLeft =
                                    parseFloat(parentStyle.paddingLeft) || 0;
                                const parentPaddingTop =
                                    parseFloat(parentStyle.paddingTop) || 0;
                                const parentOriginX =
                                    parentRect.left + parentPaddingLeft;
                                const parentOriginY =
                                    parentRect.top + parentPaddingTop;
                                const pointerX = clientX;
                                const pointerY = clientY;
                                const relX =
                                    (pointerX - rect.left) / rect.width;
                                const relY =
                                    (pointerY - rect.top) / rect.height;
                                const oldW =
                                    parseFloat(wEl.dataset.oldW) || 700;
                                const oldH =
                                    parseFloat(wEl.dataset.oldH) || 500;
                                // Calculate new left/top so pointer remains over same relative point
                                let newLeft =
                                    pointerX - parentOriginX - relX * oldW;
                                let newTop =
                                    pointerY - parentOriginY - relY * oldH;
                                const maxLeft = desktop.clientWidth - oldW;
                                const maxTop =
                                    desktop.clientHeight -
                                    taskbar.offsetHeight -
                                    oldH;
                                if (newLeft < 0) newLeft = 0;
                                if (newTop < 0) newTop = 0;
                                if (newLeft > maxLeft) newLeft = maxLeft;
                                if (newTop > maxTop) newTop = maxTop;
                                // Apply restoration and ensure metrics are updated for subsequent drag
                                wEl.style.width = `${oldW}px`;
                                wEl.style.height = `${oldH}px`;
                                wEl.style.left = `${newLeft}px`;
                                wEl.style.top = `${newTop}px`;
                                wEl.dataset.isMaximized = "";
                                actionState.restoreOnDrag = false;
                                // Update start positions for smooth dragging
                                actionState.startLeft = newLeft;
                                actionState.startTop = newTop;
                                actionState.startX = clientX;
                                actionState.startY = clientY;
                                // Recompute dx/dy to reflect the new start position (so the immediate movement continues applying correctly)
                                // No reassign of dx/dy here; let subsequent applyActionState loop pick up new deltas
                            }
                        }
                        let newLeft = actionState.startLeft + dx;
                        let newTop = actionState.startTop + dy;
                        // clamp to desktop bounds, but allow partial off-screen movement when not maximized
                        if (windowEl.dataset.isMaximized === "true") {
                            // For maximized windows, keep them fully inside the desktop bounds
                            if (newLeft < 0) newLeft = 0;
                            if (newTop < 0) newTop = 0;
                            if (
                                newLeft + windowEl.offsetWidth >
                                contentBoxWidth
                            )
                                newLeft =
                                    contentBoxWidth - windowEl.offsetWidth;
                            if (
                                newTop + windowEl.offsetHeight >
                                contentBoxHeight - taskbarHeight
                            )
                                newTop =
                                    contentBoxHeight -
                                    taskbarHeight -
                                    windowEl.offsetHeight;
                        } else {
                            // Non-maximized: allow partially off-screen horizontally and bottom, but not above header (top < 0)
                            const offX = Math.round(
                                windowEl.offsetWidth * OFFSCREEN_ALLOW_RATIO
                            );
                            const offY = Math.round(
                                windowEl.offsetHeight * OFFSCREEN_ALLOW_RATIO
                            );
                            const minLeft = -offX;
                            const maxLeft =
                                contentBoxWidth - windowEl.offsetWidth + offX;
                            const minTop = 0; // prevent moving above header (desktop top)
                            const maxTop =
                                contentBoxHeight -
                                taskbarHeight -
                                windowEl.offsetHeight +
                                offY;

                            if (newLeft < minLeft) newLeft = minLeft;
                            if (newLeft > maxLeft) newLeft = maxLeft;
                            if (newTop < minTop) newTop = minTop;
                            if (newTop > maxTop) newTop = maxTop;
                        }
                        windowEl.style.left = `${newLeft}px`;
                        windowEl.style.top = `${newTop}px`;

                        // Show snap preview while dragging (not when maximized)
                        // NOTE: Use pointer position (cursor) rather than window position so snap triggers
                        // when the mouse is dragged near edges, reducing accidental snaps when the
                        // window itself visually touches the edge because of size/offset.
                        const snapThreshold = 24; // px distance to edge to show preview
                        const cornerThreshold = 120; // px for corner area
                        let previewMode = "";
                        // Use pointer coordinates (clientX/Y) as primary input for snap detection.
                        const parentRectLocal = desktop.getBoundingClientRect();
                        const parentStyleLocal =
                            window.getComputedStyle(desktop);
                        const parentPaddingLeftLocal =
                            parseFloat(parentStyleLocal.paddingLeft) || 0;
                        const parentPaddingTopLocal =
                            parseFloat(parentStyleLocal.paddingTop) || 0;
                        const originXLocal =
                            parentRectLocal.left + parentPaddingLeftLocal;
                        const originYLocal =
                            parentRectLocal.top + parentPaddingTopLocal;
                        const pointerX = clientX - originXLocal; // local to desktop
                        const pointerY = clientY - originYLocal; // local to desktop
                        // Check corners and top first
                        if (
                            pointerY <= snapThreshold &&
                            pointerX <= cornerThreshold
                        ) {
                            previewMode = "left-top";
                        } else if (
                            pointerY <= snapThreshold &&
                            pointerX >= contentBoxWidth - cornerThreshold
                        ) {
                            previewMode = "right-top";
                        } else if (pointerY <= snapThreshold) {
                            previewMode = "max";
                        } else if (
                            pointerY >=
                                contentBoxHeight -
                                    taskbarHeight -
                                    snapThreshold &&
                            pointerX <= cornerThreshold
                        ) {
                            // bottom-left corner
                            previewMode = "left-bottom";
                        } else if (
                            pointerY >=
                                contentBoxHeight -
                                    taskbarHeight -
                                    snapThreshold &&
                            pointerX >= contentBoxWidth - cornerThreshold
                        ) {
                            // bottom-right corner
                            previewMode = "right-bottom";
                        } else if (pointerX <= snapThreshold) {
                            previewMode = "left";
                        } else if (
                            pointerX >=
                            contentBoxWidth - snapThreshold
                        ) {
                            previewMode = "right";
                        } else {
                            previewMode = "";
                        }
                        if (previewMode) setSnapHoverMode(previewMode);
                        else setSnapHoverMode("");
                    }
                    // Resize logic moved to resizewin function
                }
                document.addEventListener("mousemove", (e) => {
                    if (!actionState.type || !actionState.windowEl) return;
                    actionState.lastMouseX = e.clientX;
                    actionState.lastMouseY = e.clientY;
                    actionState.currentX = e.clientX;
                    actionState.currentY = e.clientY;
                    requestApply();
                    e.preventDefault();
                });

                // Pointer move uses the same logic as mousemove for better capture across devices
                document.addEventListener("pointermove", (e) => {
                    if (!actionState.type || !actionState.windowEl) return;
                    actionState.lastMouseX = e.clientX;
                    actionState.lastMouseY = e.clientY;
                    actionState.currentX = e.clientX;
                    actionState.currentY = e.clientY;
                    requestApply();
                    e.preventDefault();
                });

                function clearActionState(e) {
                    cancelApply();
                    const hadAction = !!actionState.type;
                    // If there's a pending hover timer, cancel it
                    if (
                        typeof snapHoverTimer !== "undefined" &&
                        snapHoverTimer
                    ) {
                        clearTimeout(snapHoverTimer);
                        snapHoverTimer = null;
                    }
                    // Determine whether a snap preview is currently visible (and what mode)
                    const previewShown =
                        snapPreview && snapPreview.classList.contains("show");
                    const previewMode =
                        previewShown && snapPreview.dataset
                            ? snapPreview.dataset.mode
                            : "";
                    // If drag ended, evaluate snap based on preview being displayed
                    if (
                        hadAction &&
                        actionState.type === "drag" &&
                        actionState.windowEl
                    ) {
                        const windowEl = actionState.windowEl;
                        const contentBoxWidth = desktop.clientWidth;
                        const contentBoxHeight = desktop.clientHeight;
                        const taskbarHeight = taskbar.offsetHeight;
                        const left =
                            parseFloat(windowEl.style.left) ||
                            windowEl.offsetLeft ||
                            0;
                        const top =
                            parseFloat(windowEl.style.top) ||
                            windowEl.offsetTop ||
                            0;
                        const width = windowEl.offsetWidth;
                        const height = windowEl.offsetHeight;
                        // Use pointer position for final snap detection (less false positives)
                        const parentRect = desktop.getBoundingClientRect();
                        const parentStyle = window.getComputedStyle(desktop);
                        const parentPaddingLeft =
                            parseFloat(parentStyle.paddingLeft) || 0;
                        const parentPaddingTop =
                            parseFloat(parentStyle.paddingTop) || 0;
                        const originX = parentRect.left + parentPaddingLeft;
                        const originY = parentRect.top + parentPaddingTop;
                        const clientX =
                            actionState.currentX ||
                            actionState.lastMouseX ||
                            actionState.startX;
                        const clientY =
                            actionState.currentY ||
                            actionState.lastMouseY ||
                            actionState.startY;
                        const pointerX = clientX - originX; // pointer relative to desktop
                        const pointerY = clientY - originY; // pointer relative to desktop
                        const threshold = 24; // px threshold to consider snapped by pointer

                        // Only perform snap/maximize if the hover preview was actually shown
                        if (previewShown && previewMode) {
                            const appId = windowEl.dataset.app;
                            switch (previewMode) {
                                case "max":
                                    maximizeWindow(appId);
                                    break;
                                case "left":
                                case "right":
                                case "left-top":
                                case "right-top":
                                case "left-bottom":
                                case "right-bottom":
                                    snapWindow(windowEl, previewMode);
                                    break;
                            }
                        }
                        // Hide the preview once we acted
                        if (previewShown) hideSnapPreview();
                    }
                    // try to release pointer capture if used
                    try {
                        if (
                            actionState.captureTarget &&
                            actionState.pointerId &&
                            actionState.captureTarget.releasePointerCapture
                        ) {
                            actionState.captureTarget.releasePointerCapture(
                                actionState.pointerId
                            );
                        }
                    } catch (err) {}
                    if (actionState.type) {
                        actionState.type = null;
                        actionState.windowEl = null;
                        actionState.direction = "";
                        actionState.startX = null;
                        actionState.startY = null;
                        actionState.startLeft = null;
                        actionState.startTop = null;
                        actionState.startWidth = null;
                        actionState.startHeight = null;
                        actionState.currentX = null;
                        actionState.currentX = null;
                        actionState.currentY = null;
                        // Clear any hover-mode state
                        if (
                            typeof snapHoverTimer !== "undefined" &&
                            snapHoverTimer
                        ) {
                            clearTimeout(snapHoverTimer);
                            snapHoverTimer = null;
                        }
                        snapHoverMode = "";
                        // Ensure preview hidden as part of cleanup
                        hideSnapPreview();
                    }
                    // re-enable user selection and clear any selection left over from a drag
                    // Only do this if we actually had an active action (drag/resize)
                    // Determine whether the event target is an editable element (input/textarea/contenteditable)
                    const target = e && e.target;
                    const isEditable =
                        target &&
                        ((target.matches &&
                            target.matches("input, textarea")) ||
                            target.isContentEditable ||
                            (target.closest &&
                                target.closest(
                                    "input, textarea, [contenteditable]"
                                )));
                    // Only clear selection if we had an active action (drag/resize) OR the mouseup occurred outside an editable element
                    if (hadAction || !isEditable) {
                        document.body.style.userSelect = "";
                        const sel =
                            window.getSelection && window.getSelection();
                        if (sel && sel.removeAllRanges) sel.removeAllRanges();
                    }
                    actionState.pointerId = null;
                    actionState.captureTarget = null;
                }

                // --- Snap preview helpers ---
                function showSnapPreview(mode) {
                    if (!snapPreview) return;
                    const contentBoxWidth = desktop.clientWidth;
                    const contentBoxHeight = desktop.clientHeight;
                    const taskbarHeight = taskbar.offsetHeight;
                    let left = 0,
                        top = 0,
                        width = contentBoxWidth,
                        height = contentBoxHeight - taskbarHeight;
                    switch (mode) {
                        case "max":
                            left = 0;
                            top = 0;
                            width = contentBoxWidth;
                            height = contentBoxHeight - taskbarHeight;
                            break;
                        case "left":
                            left = 0;
                            top = 0;
                            width = Math.floor(contentBoxWidth / 2);
                            height = contentBoxHeight - taskbarHeight;
                            break;
                        case "right":
                            left = Math.ceil(contentBoxWidth / 2);
                            top = 0;
                            width = Math.floor(contentBoxWidth / 2);
                            height = contentBoxHeight - taskbarHeight;
                            break;
                        case "left-top":
                            left = 0;
                            top = 0;
                            width = Math.floor(contentBoxWidth / 2);
                            height = Math.floor(
                                (contentBoxHeight - taskbarHeight) / 2
                            );
                            break;
                        case "right-top":
                            left = Math.ceil(contentBoxWidth / 2);
                            top = 0;
                            width = Math.floor(contentBoxWidth / 2);
                            height = Math.floor(
                                (contentBoxHeight - taskbarHeight) / 2
                            );
                            break;
                        case "left-bottom":
                            left = 0;
                            top = Math.ceil(
                                (contentBoxHeight - taskbarHeight) / 2
                            );
                            width = Math.floor(contentBoxWidth / 2);
                            height = Math.floor(
                                (contentBoxHeight - taskbarHeight) / 2
                            );
                            break;
                        case "right-bottom":
                            left = Math.ceil(contentBoxWidth / 2);
                            top = Math.ceil(
                                (contentBoxHeight - taskbarHeight) / 2
                            );
                            width = Math.floor(contentBoxWidth / 2);
                            height = Math.floor(
                                (contentBoxHeight - taskbarHeight) / 2
                            );
                            break;
                    }
                    snapPreview.style.left = `${left}px`;
                    snapPreview.style.top = `${top}px`;
                    snapPreview.style.width = `${width}px`;
                    snapPreview.style.height = `${height}px`;
                    snapPreview.classList.add("show");
                    snapPreview.dataset.mode = mode;
                }
                function hideSnapPreview() {
                    if (!snapPreview) return;
                    snapPreview.classList.remove("show");
                    snapPreview.dataset.mode = "";
                }
                document.addEventListener("mouseup", (e) => {
                    clearActionState(e);
                });
                document.addEventListener("pointerup", (e) => {
                    clearActionState(e);
                });
                document.addEventListener("pointercancel", (e) => {
                    clearActionState(e);
                });
                window.addEventListener("blur", () => {
                    clearActionState();
                });

                // --- 9.5 桌面圖示系統 (支援名稱排序/自訂排序) ---
                const desktopManager = {
                    // 狀態
                    sortMode: "custom", // 'name' 或 'custom'
                    iconPositions: {}, // { appId: { col, row } }
                    draggedIcon: null,
                    dragPreview: null,
                    gridIndicator: null,
                    isDragging: false,
                    startX: 0,
                    startY: 0,
                    offsetX: 0,
                    offsetY: 0,

                    // 格子設定
                    grid: {
                        cellWidth: 90,
                        cellHeight: 100,
                        padding: 20,
                        gap: 5,
                    },

                    init() {
                        const desktop = document.getElementById("desktop");
                        this.gridIndicator = desktop.querySelector(
                            ".desktop-grid-indicator"
                        );

                        // 載入設定
                        this.loadSettings();

                        // 初始化圖示位置
                        this.initIconPositions();

                        // 綁定事件
                        this.bindEvents();

                        // 初始化右鍵選單
                        this.initContextMenu();

                        // 套用排序
                        this.applySortMode();
                    },

                    getMaxCols() {
                        const desktop = document.getElementById("desktop");
                        return Math.floor(
                            (desktop.clientWidth - this.grid.padding * 2) /
                                (this.grid.cellWidth + this.grid.gap)
                        );
                    },

                    getMaxRows() {
                        const desktop = document.getElementById("desktop");
                        const taskbarHeight = 48;
                        return Math.floor(
                            (desktop.clientHeight -
                                this.grid.padding * 2 -
                                taskbarHeight) /
                                (this.grid.cellHeight + this.grid.gap)
                        );
                    },

                    // 計算格子的像素座標
                    getPixelPosition(col, row) {
                        return {
                            x:
                                this.grid.padding +
                                col * (this.grid.cellWidth + this.grid.gap) +
                                (this.grid.cellWidth - 80) / 2,
                            y:
                                this.grid.padding +
                                row * (this.grid.cellHeight + this.grid.gap) +
                                (this.grid.cellHeight - 90) / 2,
                        };
                    },

                    // 從像素座標計算格子位置（基於滑鼠在哪個格子區域內）
                    getGridFromPixel(clientX, clientY) {
                        const desktop = document.getElementById("desktop");
                        const rect = desktop.getBoundingClientRect();
                        const relX = clientX - rect.left - this.grid.padding;
                        const relY = clientY - rect.top - this.grid.padding;

                        // 使用 floor 讓滑鼠在格子內就選中該格子
                        let col = Math.floor(
                            relX / (this.grid.cellWidth + this.grid.gap)
                        );
                        let row = Math.floor(
                            relY / (this.grid.cellHeight + this.grid.gap)
                        );

                        col = Math.max(0, Math.min(col, this.getMaxCols() - 1));
                        row = Math.max(0, Math.min(row, this.getMaxRows() - 1));

                        return { col, row };
                    },

                    // 檢查格子是否被佔用
                    isGridOccupied(col, row, excludeApp = null) {
                        for (const [appId, pos] of Object.entries(
                            this.iconPositions
                        )) {
                            if (
                                appId !== excludeApp &&
                                pos.col === col &&
                                pos.row === row
                            ) {
                                return appId;
                            }
                        }
                        return null;
                    },

                    // 找到最近的空位
                    findNearestEmpty(col, row, excludeApp = null) {
                        // 如果目標位置是空的，直接返回
                        if (!this.isGridOccupied(col, row, excludeApp)) {
                            return { col, row };
                        }

                        // 螺旋搜尋最近的空位
                        const maxCols = this.getMaxCols();
                        const maxRows = this.getMaxRows();

                        for (
                            let distance = 1;
                            distance < Math.max(maxCols, maxRows);
                            distance++
                        ) {
                            for (let dc = -distance; dc <= distance; dc++) {
                                for (let dr = -distance; dr <= distance; dr++) {
                                    if (
                                        Math.abs(dc) !== distance &&
                                        Math.abs(dr) !== distance
                                    )
                                        continue;
                                    const nc = col + dc;
                                    const nr = row + dr;
                                    if (
                                        nc >= 0 &&
                                        nc < maxCols &&
                                        nr >= 0 &&
                                        nr < maxRows
                                    ) {
                                        if (
                                            !this.isGridOccupied(
                                                nc,
                                                nr,
                                                excludeApp
                                            )
                                        ) {
                                            return { col: nc, row: nr };
                                        }
                                    }
                                }
                            }
                        }
                        return { col, row };
                    },

                    // 初始化圖示位置
                    initIconPositions() {
                        const icons = document.querySelectorAll(
                            ".desktop-icon[data-app]"
                        );
                        const maxRows = this.getMaxRows();

                        icons.forEach((icon, index) => {
                            const appId = icon.dataset.app;
                            if (!this.iconPositions[appId]) {
                                // 預設排列：由上到下，由左到右
                                const col = Math.floor(index / maxRows);
                                const row = index % maxRows;
                                this.iconPositions[appId] = { col, row };
                            }
                        });
                    },

                    // 套用圖示位置
                    applyIconPositions() {
                        const icons = document.querySelectorAll(
                            ".desktop-icon[data-app]"
                        );
                        icons.forEach((icon) => {
                            const appId = icon.dataset.app;
                            const pos = this.iconPositions[appId];
                            if (pos) {
                                const { x, y } = this.getPixelPosition(
                                    pos.col,
                                    pos.row
                                );
                                icon.style.left = x + "px";
                                icon.style.top = y + "px";
                            }
                        });
                    },

                    // 套用排序模式
                    applySortMode() {
                        if (this.sortMode === "name") {
                            this.sortByName();
                        }
                        this.applyIconPositions();
                        this.updateContextMenuState();
                    },

                    // 名稱排序
                    sortByName() {
                        const icons = [
                            ...document.querySelectorAll(
                                ".desktop-icon[data-app]"
                            ),
                        ];
                        const maxRows = this.getMaxRows();

                        // 取得名稱並排序
                        const sorted = icons
                            .map((icon) => ({
                                appId: icon.dataset.app,
                                name:
                                    icon.querySelector("span")?.textContent ||
                                    icon.dataset.app,
                            }))
                            .sort((a, b) =>
                                a.name.localeCompare(b.name, "zh-TW")
                            );

                        // 重新分配位置
                        sorted.forEach((item, index) => {
                            const col = Math.floor(index / maxRows);
                            const row = index % maxRows;
                            this.iconPositions[item.appId] = { col, row };
                        });
                    },

                    // 對齊到格線
                    alignToGrid() {
                        const icons = [
                            ...document.querySelectorAll(
                                ".desktop-icon[data-app]"
                            ),
                        ];
                        const maxRows = this.getMaxRows();
                        const occupied = new Set();

                        icons.forEach((icon, index) => {
                            const appId = icon.dataset.app;
                            // 找下一個空位
                            let col = 0,
                                row = 0;
                            while (occupied.has(`${col},${row}`)) {
                                row++;
                                if (row >= maxRows) {
                                    row = 0;
                                    col++;
                                }
                            }
                            occupied.add(`${col},${row}`);
                            this.iconPositions[appId] = { col, row };
                        });

                        this.applyIconPositions();
                        this.saveSettings();
                    },

                    // 綁定事件
                    bindEvents() {
                        const desktop = document.getElementById("desktop");

                        // 圖示事件
                        document
                            .querySelectorAll(".desktop-icon[data-app]")
                            .forEach((icon) => {
                                icon.addEventListener("pointerdown", (e) =>
                                    this.onPointerDown(e, icon)
                                );
                                icon.addEventListener("click", (e) =>
                                    this.onClick(e, icon)
                                );
                            });

                        // 全域事件
                        document.addEventListener("pointermove", (e) =>
                            this.onPointerMove(e)
                        );
                        document.addEventListener("pointerup", (e) =>
                            this.onPointerUp(e)
                        );

                        // 桌面點擊
                        desktop.addEventListener("click", (e) => {
                            if (
                                e.target === desktop ||
                                e.target.classList.contains(
                                    "desktop-grid-indicator"
                                )
                            ) {
                                this.clearSelection();
                            }
                        });

                        // 桌面右鍵
                        desktop.addEventListener("contextmenu", (e) => {
                            if (
                                e.target === desktop ||
                                e.target.closest(".desktop-icon")
                            ) {
                                e.preventDefault();
                                this.showContextMenu(e.clientX, e.clientY);
                            }
                        });
                    },

                    // 右鍵選單
                    initContextMenu() {
                        const menu = document.getElementById(
                            "desktop-context-menu"
                        );

                        // 排序選項
                        menu.querySelectorAll("[data-sort]").forEach((item) => {
                            item.addEventListener("click", () => {
                                this.sortMode = item.dataset.sort;
                                this.applySortMode();
                                this.saveSettings();
                                this.hideContextMenu();
                            });
                        });

                        // 重新整理
                        document
                            .getElementById("desktop-refresh")
                            ?.addEventListener("click", () => {
                                this.applySortMode();
                                this.hideContextMenu();
                            });

                        // 對齊格線
                        document
                            .getElementById("desktop-align-grid")
                            ?.addEventListener("click", () => {
                                this.alignToGrid();
                                this.hideContextMenu();
                            });

                        // 點擊其他地方關閉選單
                        document.addEventListener("click", (e) => {
                            if (!e.target.closest(".desktop-context-menu")) {
                                this.hideContextMenu();
                            }
                        });
                    },

                    showContextMenu(x, y) {
                        const menu = document.getElementById(
                            "desktop-context-menu"
                        );
                        const container = document.getElementById(
                            "simulator-container-main"
                        );

                        // 隱藏舊的右鍵選單
                        document
                            .getElementById("context-menu")
                            ?.classList.remove("show");
                        document
                            .getElementById("start-context-menu")
                            ?.classList.remove("show");

                        // 計算相對於容器的位置
                        const containerRect = container.getBoundingClientRect();
                        let left = x - containerRect.left;
                        let top = y - containerRect.top;

                        // 先顯示選單以取得尺寸
                        menu.style.visibility = "hidden";
                        menu.classList.add("show");
                        const menuWidth = menu.offsetWidth;
                        const menuHeight = menu.offsetHeight;

                        // 邊界檢查
                        if (left + menuWidth > container.clientWidth) {
                            left = container.clientWidth - menuWidth - 5;
                        }
                        if (top + menuHeight > container.clientHeight - 48) {
                            top = container.clientHeight - menuHeight - 53;
                        }
                        if (left < 5) left = 5;
                        if (top < 5) top = 5;

                        menu.style.left = left + "px";
                        menu.style.top = top + "px";
                        menu.style.visibility = "visible";

                        this.updateContextMenuState();
                    },

                    hideContextMenu() {
                        document
                            .getElementById("desktop-context-menu")
                            ?.classList.remove("show");
                    },

                    updateContextMenuState() {
                        document
                            .querySelectorAll("[data-sort]")
                            .forEach((item) => {
                                item.classList.toggle(
                                    "active",
                                    item.dataset.sort === this.sortMode
                                );
                            });
                    },

                    // 選取
                    onClick(e, icon) {
                        if (this.isDragging) return;
                        e.stopPropagation();
                        if (!e.ctrlKey) this.clearSelection();
                        icon.classList.toggle("selected");
                    },

                    clearSelection() {
                        document
                            .querySelectorAll(".desktop-icon.selected")
                            .forEach((i) => i.classList.remove("selected"));
                    },

                    // 拖動開始
                    onPointerDown(e, icon) {
                        if (e.button !== 0) return;
                        if (this.sortMode === "name") return; // 名稱排序不能拖動

                        e.preventDefault();

                        const rect = icon.getBoundingClientRect();
                        this.startX = e.clientX;
                        this.startY = e.clientY;
                        this.offsetX = e.clientX - rect.left;
                        this.offsetY = e.clientY - rect.top;
                        this.draggedIcon = icon;
                        this.isDragging = false;

                        icon.setPointerCapture(e.pointerId);
                    },

                    // 拖動中
                    onPointerMove(e) {
                        if (!this.draggedIcon) return;

                        const dx = e.clientX - this.startX;
                        const dy = e.clientY - this.startY;

                        if (
                            !this.isDragging &&
                            (Math.abs(dx) > 5 || Math.abs(dy) > 5)
                        ) {
                            this.isDragging = true;
                            this.startDrag(e);
                        }

                        if (this.isDragging) {
                            this.updateDrag(e);
                        }
                    },

                    // 拖動結束
                    onPointerUp(e) {
                        if (!this.draggedIcon) return;

                        if (this.isDragging) {
                            this.endDrag(e);
                        }

                        this.draggedIcon = null;
                        this.isDragging = false;
                    },

                    startDrag(e) {
                        const icon = this.draggedIcon;
                        const container = document.getElementById(
                            "simulator-container-main"
                        );
                        const containerRect = container.getBoundingClientRect();
                        const appId = icon.dataset.app;

                        // 拖動時清除所有其他圖標的選取狀態
                        this.clearSelection();

                        // 保存所有圖示的原始位置快照
                        this.originalPositions = {};
                        for (const [id, pos] of Object.entries(
                            this.iconPositions
                        )) {
                            this.originalPositions[id] = { ...pos };
                        }
                        this.draggedAppId = appId;
                        this.lastTargetCol = -1;
                        this.lastTargetRow = -1;

                        icon.classList.add("dragging");

                        // 創建拖動預覽
                        this.dragPreview = icon.cloneNode(true);
                        this.dragPreview.className =
                            "desktop-icon desktop-drag-preview";
                        this.dragPreview.style.left =
                            e.clientX -
                            containerRect.left -
                            this.offsetX +
                            "px";
                        this.dragPreview.style.top =
                            e.clientY - containerRect.top - this.offsetY + "px";
                        this.dragPreview.style.width = "80px";
                        this.dragPreview.style.height = "90px";
                        container.appendChild(this.dragPreview);

                        // 顯示格子指示器
                        this.gridIndicator.style.display = "block";
                        this.updateGridIndicator(e);
                    },

                    updateDrag(e) {
                        const container = document.getElementById(
                            "simulator-container-main"
                        );
                        const containerRect = container.getBoundingClientRect();

                        // 更新預覽位置
                        if (this.dragPreview) {
                            this.dragPreview.style.left =
                                e.clientX -
                                containerRect.left -
                                this.offsetX +
                                "px";
                            this.dragPreview.style.top =
                                e.clientY -
                                containerRect.top -
                                this.offsetY +
                                "px";
                        }

                        // 更新格子指示器並即時預覽交換
                        this.updateGridIndicator(e);
                        this.previewSwap(e);
                    },

                    updateGridIndicator(e) {
                        const { col, row } = this.getGridFromPixel(
                            e.clientX,
                            e.clientY
                        );

                        // 格子指示器顯示整個格子區域
                        this.gridIndicator.style.left =
                            this.grid.padding +
                            col * (this.grid.cellWidth + this.grid.gap) +
                            "px";
                        this.gridIndicator.style.top =
                            this.grid.padding +
                            row * (this.grid.cellHeight + this.grid.gap) +
                            "px";
                        this.gridIndicator.style.width =
                            this.grid.cellWidth + "px";
                        this.gridIndicator.style.height =
                            this.grid.cellHeight + "px";
                    },

                    // 從原始位置快照中查找佔用指定格子的圖示
                    getOriginalOccupant(col, row) {
                        for (const [appId, pos] of Object.entries(
                            this.originalPositions
                        )) {
                            if (
                                appId !== this.draggedAppId &&
                                pos.col === col &&
                                pos.row === row
                            ) {
                                return appId;
                            }
                        }
                        return null;
                    },

                    // 即時預覽交換位置
                    previewSwap(e) {
                        const { col, row } = this.getGridFromPixel(
                            e.clientX,
                            e.clientY
                        );

                        // 如果目標位置沒有變化，不做任何處理
                        if (
                            col === this.lastTargetCol &&
                            row === this.lastTargetRow
                        )
                            return;

                        this.lastTargetCol = col;
                        this.lastTargetRow = row;

                        // 先恢復所有圖示到原始位置
                        for (const [appId, pos] of Object.entries(
                            this.originalPositions
                        )) {
                            this.iconPositions[appId] = { ...pos };
                        }

                        // 從原始位置查找目標格子的佔用者
                        const occupiedBy = this.getOriginalOccupant(col, row);

                        if (occupiedBy) {
                            // 有圖示佔用目標位置，執行交換預覽
                            // 將佔用者移到拖動者的原始位置
                            const draggedOriginalPos =
                                this.originalPositions[this.draggedAppId];
                            this.iconPositions[occupiedBy] = {
                                ...draggedOriginalPos,
                            };
                        }

                        // 更新被拖動圖示的位置
                        this.iconPositions[this.draggedAppId] = { col, row };

                        // 套用預覽位置（帶動畫）
                        this.applyIconPositionsAnimated(this.draggedAppId);
                    },

                    // 套用位置（帶動畫，排除正在拖動的圖示）
                    applyIconPositionsAnimated(excludeAppId) {
                        const icons = document.querySelectorAll(
                            ".desktop-icon[data-app]"
                        );
                        icons.forEach((icon) => {
                            const appId = icon.dataset.app;
                            if (appId === excludeAppId) return; // 跳過正在拖動的

                            const pos = this.iconPositions[appId];
                            if (pos) {
                                const { x, y } = this.getPixelPosition(
                                    pos.col,
                                    pos.row
                                );
                                icon.style.transition =
                                    "left 0.15s ease, top 0.15s ease";
                                icon.style.left = x + "px";
                                icon.style.top = y + "px";
                            }
                        });
                    },

                    endDrag(e) {
                        const icon = this.draggedIcon;
                        const appId = icon.dataset.app;

                        icon.classList.remove("dragging");

                        // 移除預覽
                        if (this.dragPreview) {
                            this.dragPreview.remove();
                            this.dragPreview = null;
                        }

                        // 隱藏指示器
                        this.gridIndicator.style.display = "none";

                        // 計算最終目標格子
                        const { col, row } = this.getGridFromPixel(
                            e.clientX,
                            e.clientY
                        );

                        // 從原始位置快照找出佔用者
                        const occupiedBy = this.getOriginalOccupant(col, row);

                        // 先恢復所有位置到原始狀態
                        for (const [id, pos] of Object.entries(
                            this.originalPositions
                        )) {
                            this.iconPositions[id] = { ...pos };
                        }

                        if (occupiedBy) {
                            // 交換位置
                            const draggedOriginalPos =
                                this.originalPositions[appId];
                            this.iconPositions[occupiedBy] = {
                                ...draggedOriginalPos,
                            };
                            this.iconPositions[appId] = { col, row };
                        } else {
                            // 直接移動到新位置
                            this.iconPositions[appId] = { col, row };
                        }

                        // 移除過渡動畫
                        const icons = document.querySelectorAll(
                            ".desktop-icon[data-app]"
                        );
                        icons.forEach((i) => (i.style.transition = ""));

                        // 套用最終位置並儲存
                        this.applyIconPositions();
                        this.saveSettings();

                        // 清理
                        this.originalPositions = null;
                        this.draggedAppId = null;
                        this.lastTargetCol = -1;
                        this.lastTargetRow = -1;
                    },

                    // 儲存設定
                    saveSettings() {
                        try {
                            localStorage.setItem(
                                "desktop_settings",
                                JSON.stringify({
                                    sortMode: this.sortMode,
                                    positions: this.iconPositions,
                                })
                            );
                        } catch (e) {
                            console.warn("無法儲存桌面設定:", e);
                        }
                    },

                    // 載入設定
                    loadSettings() {
                        try {
                            const data =
                                localStorage.getItem("desktop_settings");
                            if (data) {
                                const settings = JSON.parse(data);
                                this.sortMode = settings.sortMode || "custom";
                                this.iconPositions = settings.positions || {};
                            }
                        } catch (e) {
                            console.warn("無法載入桌面設定:", e);
                        }
                    },
                };

                // 初始化桌面管理器
                desktopManager.init();

                // --- 10. 應用程式開啟邏輯 ---

                // 10.1 從桌面圖示開啟 (雙擊)
                desktopIcons.forEach((icon) => {
                    icon.addEventListener("dblclick", () => {
                        openWindow(icon.dataset.app);
                        // 開啟視窗後取消桌面圖示的選取狀態
                        desktopManager.clearSelection();
                    });
                });

                // 10.2 從任務欄圖示開啟/切換
                // We use event delegation so dynamically created temporary icons are handled too.
                const taskbarCenterGroup = document.querySelector(
                    "#taskbar .taskbar-group.center"
                );
                if (taskbarCenterGroup) {
                    taskbarCenterGroup.addEventListener("click", (e) => {
                        const icon = e.target.closest(".taskbar-icon");
                        if (!icon) return;
                        const appId = icon.dataset.app;
                        const windowEl = document.getElementById(
                            `window-${appId}`
                        );
                        if (!windowEl) return;
                        if (windowEl.classList.contains("minimized")) {
                            openWindow(appId);
                        } else if (
                            windowEl.classList.contains("show") &&
                            windowEl.classList.contains("active")
                        ) {
                            minimizeWindow(appId);
                        } else if (windowEl.classList.contains("show")) {
                            focusWindow(windowEl);
                        } else {
                            openWindow(appId);
                        }
                    });
                    // keyboard accessibility: handle Enter/Space on focused icon
                    taskbarCenterGroup.addEventListener("keydown", (e) => {
                        const icon =
                            e.target.closest &&
                            e.target.closest(".taskbar-icon")
                                ? e.target.closest(".taskbar-icon")
                                : null;
                        if (!icon) return;
                        if (e.key === "Enter" || e.key === " ") {
                            e.preventDefault();
                            icon.click();
                        }
                    });
                }

                // 10.3 從開始功能表開啟
                startMenu
                    .querySelectorAll(".app-icon[data-app]")
                    .forEach((icon) => {
                        icon.addEventListener("click", () => {
                            // 如果剛剛完成拖動，不開啟視窗
                            if (pinnedAppsManager.wasDragging) return;
                            openWindow(icon.dataset.app);
                            startMenu.classList.remove("show");
                        });
                    });

                // --- 10.4 開始功能表釘選圖示拖動排序 ---
                const pinnedAppsManager = {
                    container: document.querySelector(".pinned-apps"),
                    draggedIcon: null,
                    dragPreview: null,
                    isDragging: false,
                    wasDragging: false, // 新增：標記是否剛剛完成拖動
                    startX: 0,
                    startY: 0,
                    offsetX: 0,
                    offsetY: 0,
                    STORAGE_KEY: "pinned_apps_order_v1",

                    init() {
                        if (!this.container) return;
                        this.loadOrder();
                        this.bindEvents();
                    },

                    bindEvents() {
                        const icons = this.container.querySelectorAll(
                            ".app-icon[data-app]"
                        );
                        icons.forEach((icon) => {
                            icon.addEventListener("pointerdown", (e) =>
                                this.onPointerDown(e, icon)
                            );
                        });
                        document.addEventListener("pointermove", (e) =>
                            this.onPointerMove(e)
                        );
                        document.addEventListener("pointerup", (e) =>
                            this.onPointerUp(e)
                        );
                    },

                    onPointerDown(e, icon) {
                        if (e.button !== 0) return; // 只處理左鍵
                        e.preventDefault();

                        const rect = icon.getBoundingClientRect();
                        this.startX = e.clientX;
                        this.startY = e.clientY;
                        this.offsetX = e.clientX - rect.left;
                        this.offsetY = e.clientY - rect.top;
                        this.draggedIcon = icon;
                        this.isDragging = false;

                        icon.setPointerCapture(e.pointerId);
                    },

                    onPointerMove(e) {
                        if (!this.draggedIcon) return;

                        const dx = e.clientX - this.startX;
                        const dy = e.clientY - this.startY;

                        // 開始拖動判定 (移動超過 5px)
                        if (
                            !this.isDragging &&
                            (Math.abs(dx) > 5 || Math.abs(dy) > 5)
                        ) {
                            this.isDragging = true;
                            this.startDrag(e);
                        }

                        if (this.isDragging) {
                            this.updateDrag(e);
                        }
                    },

                    onPointerUp(e) {
                        if (!this.draggedIcon) return;

                        if (this.isDragging) {
                            this.endDrag(e);
                            // 標記剛剛完成拖動，防止觸發 click 開啟視窗
                            this.wasDragging = true;
                            // 延遲重置標記，確保 click 事件能檢查到
                            setTimeout(() => {
                                this.wasDragging = false;
                            }, 100);
                        }

                        this.draggedIcon = null;
                        this.isDragging = false;
                    },

                    startDrag(e) {
                        const icon = this.draggedIcon;
                        icon.classList.add("dragging");

                        // 創建拖動預覽
                        this.dragPreview = icon.cloneNode(true);
                        this.dragPreview.className = "pinned-app-drag-preview";
                        this.dragPreview.style.left =
                            e.clientX - this.offsetX + "px";
                        this.dragPreview.style.top =
                            e.clientY - this.offsetY + "px";
                        this.dragPreview.style.width = icon.offsetWidth + "px";
                        document.body.appendChild(this.dragPreview);
                    },

                    updateDrag(e) {
                        // 更新預覽位置
                        if (this.dragPreview) {
                            this.dragPreview.style.left =
                                e.clientX - this.offsetX + "px";
                            this.dragPreview.style.top =
                                e.clientY - this.offsetY + "px";
                        }

                        // 尋找拖動目標位置
                        const target = this.getDropTarget(e.clientX, e.clientY);

                        // 清除所有 drag-over 狀態
                        this.container
                            .querySelectorAll(".app-icon")
                            .forEach((icon) => {
                                icon.classList.remove("drag-over");
                            });

                        // 設置目標圖示的 drag-over 狀態
                        if (target && target !== this.draggedIcon) {
                            target.classList.add("drag-over");
                        }
                    },

                    getDropTarget(x, y) {
                        const icons = this.container.querySelectorAll(
                            ".app-icon[data-app]"
                        );
                        for (const icon of icons) {
                            if (icon === this.draggedIcon) continue;
                            const rect = icon.getBoundingClientRect();
                            if (
                                x >= rect.left &&
                                x <= rect.right &&
                                y >= rect.top &&
                                y <= rect.bottom
                            ) {
                                return icon;
                            }
                        }
                        return null;
                    },

                    endDrag(e) {
                        const icon = this.draggedIcon;
                        icon.classList.remove("dragging");

                        // 移除預覽
                        if (this.dragPreview) {
                            this.dragPreview.remove();
                            this.dragPreview = null;
                        }

                        // 清除所有 drag-over 狀態
                        this.container
                            .querySelectorAll(".app-icon")
                            .forEach((i) => {
                                i.classList.remove("drag-over");
                            });

                        // 找到目標位置並交換
                        const target = this.getDropTarget(e.clientX, e.clientY);
                        if (target && target !== icon) {
                            this.swapIcons(icon, target);
                            this.saveOrder();
                        }
                    },

                    swapIcons(icon1, icon2) {
                        const icons = Array.from(
                            this.container.querySelectorAll(
                                ".app-icon[data-app]"
                            )
                        );
                        const index1 = icons.indexOf(icon1);
                        const index2 = icons.indexOf(icon2);

                        if (index1 < index2) {
                            // icon1 在 icon2 前面，將 icon1 插入到 icon2 後面
                            this.container.insertBefore(
                                icon1,
                                icon2.nextSibling
                            );
                        } else {
                            // icon1 在 icon2 後面，將 icon1 插入到 icon2 前面
                            this.container.insertBefore(icon1, icon2);
                        }
                    },

                    saveOrder() {
                        try {
                            const icons = this.container.querySelectorAll(
                                ".app-icon[data-app]"
                            );
                            const order = Array.from(icons).map(
                                (icon) => icon.dataset.app
                            );
                            localStorage.setItem(
                                this.STORAGE_KEY,
                                JSON.stringify(order)
                            );
                        } catch (e) {
                            console.warn("無法儲存釘選圖示順序:", e);
                        }
                    },

                    loadOrder() {
                        try {
                            const data = localStorage.getItem(this.STORAGE_KEY);
                            if (!data) return;

                            const order = JSON.parse(data);
                            if (!Array.isArray(order)) return;

                            // 根據儲存的順序重新排列圖示
                            const icons = this.container.querySelectorAll(
                                ".app-icon[data-app]"
                            );
                            const iconMap = new Map();
                            icons.forEach((icon) =>
                                iconMap.set(icon.dataset.app, icon)
                            );

                            // 按照順序重新插入
                            order.forEach((appId) => {
                                const icon = iconMap.get(appId);
                                if (icon) {
                                    this.container.appendChild(icon);
                                }
                            });

                            // 將未在順序中的圖示添加到末尾
                            icons.forEach((icon) => {
                                if (!order.includes(icon.dataset.app)) {
                                    this.container.appendChild(icon);
                                }
                            });
                        } catch (e) {
                            console.warn("無法載入釘選圖示順序:", e);
                        }
                    },
                };

                // 初始化釘選圖示管理器
                pinnedAppsManager.init();
                // Bind click action to start menu '開始設定' context item
                const startMenuSettingsItem = document.getElementById(
                    "start-menu-settings"
                );
                if (startMenuSettingsItem) {
                    startMenuSettingsItem.addEventListener("click", () => {
                        openWindow("settings");
                        // close start menu and its context menu
                        startMenu.classList.remove("show");
                        startMenuSettingsItem
                            .closest("#start-context-menu")
                            .classList.remove("show");
                    });
                }

                // --- 11. 長門櫻 (模擬的對話助理，功能增強) ---
                const nagatoWindow = document.getElementById("window-nagato");
                const nagatoMessages =
                    nagatoWindow.querySelector(".nagato-messages");
                const nagatoInput = nagatoWindow.querySelector("#nagato-input");
                const nagatoSend = nagatoWindow.querySelector("#nagato-send");
                const NAGATO_KEY = "nagato_conversation_v1";

                // Load conversation from localStorage and render
                function loadNagatoConversation() {
                    try {
                        const raw = localStorage.getItem(NAGATO_KEY);
                        if (!raw) return [];
                        const parsed = JSON.parse(raw);
                        if (!Array.isArray(parsed)) return [];
                        return parsed;
                    } catch (e) {
                        return [];
                    }
                }
                function saveNagatoConversation(arr) {
                    try {
                        localStorage.setItem(NAGATO_KEY, JSON.stringify(arr));
                    } catch (e) {
                        console.warn(e);
                    }
                }
                function renderNagatoMessages() {
                    let list = loadNagatoConversation();
                    // Seed a friendly greeting if no previous conversation found
                    if (!list || !list.length) {
                        list = [
                            {
                                role: "ai",
                                text: "主人您好！我叫長門櫻，您的專屬女僕。請問您有什麼需要長門櫻為您效勞的嗎？",
                                ts: Date.now(),
                            },
                        ];
                        saveNagatoConversation(list);
                    }
                    nagatoMessages.innerHTML = "";
                    list.forEach((msg) => {
                        const el = document.createElement("div");
                        el.classList.add(
                            "message",
                            msg.role === "user" ? "user" : "ai"
                        );
                        el.textContent = msg.text;
                        nagatoMessages.appendChild(el);
                    });
                    nagatoMessages.scrollTop = nagatoMessages.scrollHeight;
                }

                function showTypingIndicator() {
                    const typing = document.createElement("div");
                    typing.classList.add("message", "ai", "typing");
                    typing.innerHTML =
                        '<span class="typing-dots"><span></span><span></span><span></span></span>';
                    typing.id = "nagato-typing";
                    nagatoMessages.appendChild(typing);
                    nagatoMessages.scrollTop = nagatoMessages.scrollHeight;
                }
                function hideTypingIndicator() {
                    const el = document.getElementById("nagato-typing");
                    if (el) el.remove();
                }

                function generateNagatoResponse(userText) {
                    const txt = userText.toLowerCase();
                    if (/^(hi|hello|嘿|嗨|你好|您 好)/i.test(userText)) {
                        return "主人您好！請問您有什麼需要長門櫻為您效勞的嗎？";
                    }
                    if (txt.includes("時間")) {
                        const now = new Date();
                        const hh = String(now.getHours()).padStart(2, "0");
                        const mm = String(now.getMinutes()).padStart(2, "0");
                        return `主人現在是 ${hh}:${mm}`;
                    }
                    if (txt.includes("日期"))
                        return `今天是 ${new Date().toLocaleDateString(
                            "zh-TW"
                        )}`;
                    if (txt.includes("開啟") && txt.includes("設定"))
                        return "好的，即將開啟設定。";
                    if (txt.includes("開啟") && txt.includes("瀏覽"))
                        return "好的，正在開啟瀏覽器。";
                    if (txt.includes("我的網站") || txt.includes("網站"))
                        return "你可以查看你的網站: https://amanoshizukikun.github.io/";
                    if (txt.includes("幫助"))
                        return '我能提供時間、日期、打開應用程式，或簡單回答一般問題。你可以試試說 "告訴我今天的時間"。';
                    // fallback: summarize / echo back a short reply
                    const truncated =
                        userText.length > 120
                            ? userText.slice(0, 117) + "…"
                            : userText;
                    return `收到："${truncated}"。你想要我怎麼處理？`;
                }

                function appendNagatoMessage(role, text) {
                    const el = document.createElement("div");
                    el.classList.add(
                        "message",
                        role === "user" ? "user" : "ai"
                    );
                    el.textContent = text;
                    nagatoMessages.appendChild(el);
                    nagatoMessages.scrollTop = nagatoMessages.scrollHeight;
                }

                function sendNagatoMessage() {
                    const message = nagatoInput.value.trim();
                    if (!message) return;
                    // store
                    const conv = loadNagatoConversation();
                    conv.push({ role: "user", text: message, ts: Date.now() });
                    saveNagatoConversation(conv);

                    appendNagatoMessage("user", message);
                    nagatoInput.value = "";
                    showTypingIndicator();

                    // Simulate AI latency based on message length
                    const delay = Math.min(1400 + message.length * 5, 2200);
                    setTimeout(() => {
                        hideTypingIndicator();
                        const resp = generateNagatoResponse(message);
                        appendNagatoMessage("ai", resp);
                        // store AI response
                        const conv2 = loadNagatoConversation();
                        conv2.push({ role: "ai", text: resp, ts: Date.now() });
                        saveNagatoConversation(conv2);
                        // optionally include quick actions
                        addNagatoQuickActions(resp);
                    }, delay);
                }

                function addNagatoQuickActions(respText) {
                    // remove previous suggestions
                    nagatoMessages
                        .querySelectorAll(".message-suggestions")
                        .forEach((el) => el.remove());
                    // Suggest a couple quick actions based on the response
                    const container = document.createElement("div");
                    container.className = "message-suggestions";
                    // Basic actions
                    const suggestions = [
                        {
                            label: "開啟設定",
                            action: () => openWindow("settings"),
                        },
                        {
                            label: "開啟瀏覽器",
                            action: () => openWindow("browser"),
                        },
                        {
                            label: "顯示時間",
                            action: () => {
                                sendNagatoMessageFromBtn("現在時間是多少？");
                            },
                        },
                    ];
                    suggestions.forEach((s) => {
                        const b = document.createElement("button");
                        b.className = "suggestion-btn";
                        b.textContent = s.label;
                        b.addEventListener("click", (e) => {
                            e.stopPropagation();
                            s.action();
                        });
                        container.appendChild(b);
                    });
                    nagatoMessages.appendChild(container);
                    nagatoMessages.scrollTop = nagatoMessages.scrollHeight;
                }

                function sendNagatoMessageFromBtn(text) {
                    nagatoInput.value = text;
                    sendNagatoMessage();
                }

                // Event bindings
                nagatoSend.addEventListener("click", sendNagatoMessage);
                nagatoInput.addEventListener("keydown", (e) => {
                    if (e.key === "Enter" && !e.shiftKey) {
                        e.preventDefault();
                        sendNagatoMessage();
                    }
                });
                // Auto-resize textarea for better UX
                function autoResizeNagatoInput() {
                    nagatoInput.style.height = "auto";
                    nagatoInput.style.height = nagatoInput.scrollHeight + "px";
                }
                nagatoInput.addEventListener("input", autoResizeNagatoInput);
                autoResizeNagatoInput();
                // initialize messages
                renderNagatoMessages();
                // Bind clear button
                const nagatoClearBtn = document.getElementById("nagato-clear");
                if (nagatoClearBtn) {
                    nagatoClearBtn.addEventListener("click", () => {
                        if (!confirm("確認要清除長門櫻的聊天紀錄嗎？")) return;
                        saveNagatoConversation([]);
                        renderNagatoMessages();
                    });
                }

                // --- 12. 初始化 ---
                // Calculator initialization and enhancements
                try {
                    // instantiate app calculator (if element exists)
                    if (document.querySelector("#win-calc")) {
                        window.appCalculator = new Calculator(
                            "#calc-input",
                            "#win-calc>.keyb"
                        );
                    }
                    // Make calc buttons accessible and attach keyboard (Enter/Space) handlers
                    document.querySelectorAll("#win-calc .b").forEach((btn) => {
                        btn.setAttribute("role", "button");
                        btn.setAttribute("tabindex", "0");
                        if (!btn.hasAttribute("aria-label"))
                            btn.setAttribute(
                                "aria-label",
                                btn.textContent.trim()
                            );
                        btn.addEventListener("keydown", (e) => {
                            if (e.key === "Enter" || e.key === " ") {
                                e.preventDefault();
                                btn.click();
                            }
                        });
                    });

                    // Global keyboard handler while calculator is focused/active
                    document.addEventListener("keydown", (e) => {
                        try {
                            const active = activeWindow; // var from earlier
                            if (!active || active.id !== "window-calculator")
                                return;
                            if (!window.appCalculator) return;
                            const key = e.key;
                            if (/^[0-9]$/.test(key)) {
                                window.appCalculator.number_key(Number(key));
                                e.preventDefault();
                                return;
                            }
                            if (key === ".") {
                                window.appCalculator.point();
                                e.preventDefault();
                                return;
                            }
                            if (key === "+" || key === "-") {
                                window.appCalculator.func_key(
                                    key === "+" ? 1 : 2
                                );
                                // set visual checked
                                const el = document.querySelector(
                                    key === "+"
                                        ? "#win-calc>.keyb>.jia"
                                        : "#win-calc>.keyb>.jian"
                                );
                                if (el) window.appCalculator.check(el);
                                e.preventDefault();
                                return;
                            }
                            if (key === "*" || key === "x" || key === "X") {
                                window.appCalculator.func_key(3);
                                const el = document.querySelector(
                                    "#win-calc>.keyb>.cheng"
                                );
                                if (el) window.appCalculator.check(el);
                                e.preventDefault();
                                return;
                            }
                            if (key === "/") {
                                window.appCalculator.func_key(4);
                                const el = document.querySelector(
                                    "#win-calc>.keyb>.chu"
                                );
                                if (el) window.appCalculator.check(el);
                                e.preventDefault();
                                return;
                            }
                            if (key === "Enter" || key === "=") {
                                window.appCalculator.eq();
                                e.preventDefault();
                                return;
                            }
                            if (key === "Backspace") {
                                window.appCalculator.backspace();
                                e.preventDefault();
                                return;
                            }
                            if (key === "Escape") {
                                window.appCalculator.clear_num();
                                e.preventDefault();
                                return;
                            }
                        } catch (error) {
                            console.error(
                                "Calculator keyboard handler error",
                                error
                            );
                        }
                    });
                } catch (err) {
                    console.warn("Calculator init failed", err);
                }
                initBootSequence();
                renderCalendar();
                // Ensure taskbar icon states (open-app / active-app) are synced to current windows
                function syncTaskbarWithWindows() {
                    getAllTaskbarIcons().forEach((icon) => {
                        const appId = icon.dataset.app;
                        const winEl = document.getElementById(
                            `window-${appId}`
                        );
                        // Keep open-app if showing or minimized
                        if (
                            winEl &&
                            (winEl.classList.contains("show") ||
                                winEl.classList.contains("minimized"))
                        ) {
                            icon.classList.add("open-app");
                        } else {
                            icon.classList.remove("open-app");
                        }
                        if (winEl && winEl.classList.contains("active")) {
                            icon.classList.add("active-app");
                            icon.setAttribute("aria-pressed", "true");
                        } else {
                            icon.classList.remove("active-app");
                            icon.setAttribute("aria-pressed", "false");
                        }
                    });
                }
                syncTaskbarWithWindows();
                // 全域初始化 (背景、導航)
                // 注意：此頁面有自己的開機畫面，不需要顯示過場動畫
                if (
                    typeof Core !== "undefined" &&
                    typeof Core.initBackground === "function"
                )
                    Core.initBackground();
                if (
                    typeof Navigation !== "undefined" &&
                    typeof Navigation.init === "function"
                )
                    Navigation.init();
                // 跳過 Animations.init() 以避免顯示過場動畫

                // 處理窗口大小變化 (用於最大化視窗)
                // 監聽 window resize 事件，以確保在瀏覽器大小變化時，最大化的視窗能正確調整高度
                window.addEventListener("resize", () => {
                    document
                        .querySelectorAll('.window[data-is-maximized="true"]')
                        .forEach((window) => {
                            window.style.height = `calc(100% - ${taskbar.offsetHeight}px)`;
                        });
                });

                // --- Browser Favorites (最愛/書籤) ---
                const favoritesKey = "sim_favorites_v1";
                const favoritesBar = document.getElementById("favorites-bar");
                const browserBack = document.getElementById("browser-back");
                const browserForward =
                    document.getElementById("browser-forward");
                const browserRefresh =
                    document.getElementById("browser-refresh");
                const browserUrlInput =
                    document.getElementById("browser-url-input");
                const bookmarkToggle =
                    document.getElementById("bookmark-toggle");
                const browserWindow = document.getElementById("window-browser");
                const browserIframe = browserWindow.querySelector("iframe");

                // Basic history implemented client-side (for navigation via this UI only)
                let browserHistory = [];
                let browserHistoryIndex = -1;

                const defaultFavorites = [
                    {
                        title: "我的網站",
                        url: "https://amanoshizukikun.github.io/",
                    },
                ];

                function loadFavorites() {
                    try {
                        const raw = localStorage.getItem(favoritesKey);
                        if (!raw) return defaultFavorites.slice();
                        const parsed = JSON.parse(raw);
                        if (!Array.isArray(parsed))
                            return defaultFavorites.slice();
                        return parsed;
                    } catch (e) {
                        console.warn("Failed to load favorites", e);
                        return defaultFavorites.slice();
                    }
                }

                function saveFavorites(list) {
                    try {
                        localStorage.setItem(
                            favoritesKey,
                            JSON.stringify(list)
                        );
                    } catch (e) {
                        console.warn("Failed to save favorites", e);
                    }
                }

                function renderFavorites() {
                    const list = loadFavorites();
                    favoritesBar.innerHTML = "";
                    list.forEach((item) => {
                        const el = document.createElement("div");
                        el.className = "fav-item";
                        el.setAttribute("role", "button");
                        el.setAttribute("tabindex", "0");
                        el.setAttribute("title", item.url);
                        el.innerHTML = `<img class="favicon" src="https://www.google.com/s2/favicons?sz=64&domain_url=${encodeURIComponent(
                            item.url
                        )}" alt=""> <span class="title">${item.title}</span>`;
                        el.addEventListener("click", (e) => {
                            e.preventDefault();
                            openWindow("browser");
                            setBrowserUrl(item.url, true);
                        });
                        el.addEventListener("keydown", (e) => {
                            if (e.key === "Enter") el.click();
                        });
                        favoritesBar.appendChild(el);
                    });
                }

                function isFavorite(url) {
                    const list = loadFavorites();
                    return list.some((item) => item.url === url);
                }

                function addFavorite(obj) {
                    if (!obj || !obj.url) return;
                    const list = loadFavorites();
                    if (list.some((i) => i.url === obj.url)) return;
                    list.unshift(obj);
                    saveFavorites(list);
                    renderFavorites();
                }

                function removeFavoriteByUrl(url) {
                    let list = loadFavorites();
                    list = list.filter((i) => i.url !== url);
                    saveFavorites(list);
                    renderFavorites();
                }

                function setBrowserUrl(url, pushHistory = true) {
                    if (!url) return;
                    // Ensure protocol for local relative paths
                    // Normalize the urls to absolute for a robust comparison
                    const normalize = (u) => {
                        try {
                            return new URL(u, window.location.href).href;
                        } catch (e) {
                            return u;
                        }
                    };
                    const normalized = normalize(url);
                    const current = browserIframe ? browserIframe.src : "";
                    // If the normalized URL is the same as current iframe src, avoid resetting it (prevents reload/reset when restoring from minimized state)
                    if (current && normalized === current) {
                        // Still update UI states
                        browserUrlInput.value = url;
                        updateNavigationButtons();
                        updateBookmarkButton(url);
                        return;
                    }
                    browserUrlInput.value = url;
                    browserIframe.src = url;
                    // Show iframe (Edge style uses .show class)
                    browserIframe.classList.add("show");
                    // Add to internal history
                    if (pushHistory) {
                        // If we navigate to a new URL while not at the end of history, discard the forward
                        if (browserHistoryIndex < browserHistory.length - 1) {
                            browserHistory = browserHistory.slice(
                                0,
                                browserHistoryIndex + 1
                            );
                        }
                        browserHistory.push(url);
                        browserHistoryIndex = browserHistory.length - 1;
                    }
                    updateNavigationButtons();
                    updateBookmarkButton(url);
                }

                function updateNavigationButtons() {
                    browserBack.classList.toggle(
                        "disabled",
                        browserHistoryIndex <= 0
                    );
                    browserForward.classList.toggle(
                        "disabled",
                        browserHistoryIndex >= browserHistory.length - 1
                    );
                    // Add a11y attributes
                    browserBack.setAttribute(
                        "aria-disabled",
                        String(browserHistoryIndex <= 0)
                    );
                    browserForward.setAttribute(
                        "aria-disabled",
                        String(browserHistoryIndex >= browserHistory.length - 1)
                    );
                }

                browserBack.addEventListener("click", () => {
                    if (browserHistoryIndex <= 0) return;
                    browserHistoryIndex -= 1;
                    setBrowserUrl(browserHistory[browserHistoryIndex], false);
                });
                browserForward.addEventListener("click", () => {
                    if (browserHistoryIndex >= browserHistory.length - 1)
                        return;
                    browserHistoryIndex += 1;
                    setBrowserUrl(browserHistory[browserHistoryIndex], false);
                });
                browserRefresh.addEventListener("click", () => {
                    try {
                        browserIframe.contentWindow.location.reload();
                    } catch (e) {
                        browserIframe.src = browserUrlInput.value;
                    }
                });

                bookmarkToggle.addEventListener("click", () => {
                    const url = browserUrlInput.value;
                    if (!url) return;
                    if (isFavorite(url)) removeFavoriteByUrl(url);
                    else
                        addFavorite({
                            title: url
                                .replace(/https?:\/\//, "")
                                .replace(/\/.*$/, ""),
                            url: url,
                        });
                    updateBookmarkButton(url);
                });

                function updateBookmarkButton(url) {
                    const icon = bookmarkToggle.querySelector("i");
                    if (isFavorite(url)) {
                        icon.classList.remove("fa-regular");
                        icon.classList.add("fa-solid");
                        bookmarkToggle.setAttribute("aria-pressed", "true");
                    }
                    // Not favorite -> show regular style
                    if (!isFavorite(url)) {
                        icon.classList.remove("fa-solid");
                        icon.classList.add("fa-regular");
                        bookmarkToggle.setAttribute("aria-pressed", "false");
                    }
                }

                // Initialize: render favorites and load default homepage if needed
                renderFavorites();
                // If the iframe is blank, set a friendly default
                const initialUrl = "https://amanoshizukikun.github.io/";
                if (
                    browserIframe &&
                    (browserIframe.src === "about:blank" || !browserIframe.src)
                ) {
                    setBrowserUrl(initialUrl, true);
                } else if (
                    browserIframe &&
                    browserIframe.src &&
                    browserIframe.src !== "about:blank"
                ) {
                    setBrowserUrl(browserIframe.src, true);
                }

                // When the browser window receives focus (is opened/activated), update bookmark status for current URL
                // Hook into openWindow by wrapping a reference to previous openWindow behavior is already used. We'll listen for focus changes.
                document.addEventListener("click", (e) => {
                    // If a browser taskbar icon was clicked and it's showing then update
                    const openIcon = document.getElementById(
                        "taskbar-icon-browser"
                    );
                    if (openIcon && openIcon.classList.contains("open-app")) {
                        updateBookmarkButton(browserUrlInput.value);
                    }
                });

                // Allow pressing Enter on url input to open
                browserUrlInput.addEventListener("keydown", (e) => {
                    if (e.key === "Enter") {
                        const url = browserUrlInput.value.trim() || initialUrl;
                        setBrowserUrl(url, true);
                    }
                });
                // Ensure clicking or mousedown on the URL input doesn't let parent handlers steal focus
                browserUrlInput.addEventListener("mousedown", (e) => {
                    // Prevent any simulator-level click handlers from hiding menus or stealing focus
                    e.stopPropagation();
                });
                browserUrlInput.addEventListener("click", (e) => {
                    e.stopPropagation();
                    browserUrlInput.focus();
                });

                // 監聽 iframe 獲得焦點時，將瀏覽器視窗設為前台
                // 由於 iframe 內部點擊不會冒泡，使用 window blur 事件檢測
                window.addEventListener("blur", () => {
                    // 當主視窗失去焦點時，檢查是否是因為 iframe 獲得焦點
                    setTimeout(() => {
                        if (document.activeElement === browserIframe) {
                            // iframe 獲得焦點，將瀏覽器視窗設為活躍
                            if (
                                browserWindow &&
                                browserWindow.classList.contains("show")
                            ) {
                                focusWindow(browserWindow);
                            }
                        }
                    }, 0);
                });

                // 使用 focusin 事件監聽 iframe 焦點（某些瀏覽器支援）
                browserIframe.addEventListener("focus", () => {
                    if (
                        browserWindow &&
                        browserWindow.classList.contains("show")
                    ) {
                        focusWindow(browserWindow);
                    }
                });
            });
        </script>

        <!-- Weather widget script (supports multiple instances) -->
        <script>
            (function () {
                const DEFAULT_CITY = "台北";
                const CACHE_KEY = "webos_weather_cache_v1";
                const CACHE_TTL = 10 * 60 * 1000; // 10 minutes

                function _getCache() {
                    try {
                        return JSON.parse(localStorage.getItem(CACHE_KEY));
                    } catch (e) {
                        return null;
                    }
                }
                function _setCache(city, data) {
                    try {
                        localStorage.setItem(
                            CACHE_KEY,
                            JSON.stringify({ city, ts: Date.now(), data })
                        );
                    } catch (e) {}
                }
                function _checkCache(city) {
                    const c = _getCache();
                    if (!c || c.city !== city) return null;
                    if (Date.now() - c.ts > CACHE_TTL) return null;
                    return c.data;
                }

                async function fetchWeatherData(city) {
                    const wttrUrl = `https://wttr.in/${encodeURIComponent(
                        city
                    )}?format=j1`;
                    try {
                        const resp = await fetch(wttrUrl);
                        if (resp.ok) {
                            return await resp.json();
                        }
                        const fallback = `https://api.allorigins.win/raw?url=${encodeURIComponent(
                            wttrUrl
                        )}`;
                        const alt = await fetch(fallback);
                        if (alt.ok) return await alt.json();
                        throw new Error("無法從 wttr.in 獲取資料");
                    } catch (e) {
                        try {
                            const fallback = `https://api.allorigins.win/raw?url=${encodeURIComponent(
                                wttrUrl
                            )}`;
                            const alt = await fetch(fallback);
                            if (alt.ok) return await alt.json();
                        } catch (err) {}
                        throw e;
                    }
                }

                function getIconForDesc(desc) {
                    if (!desc) return "fa-cloud-sun";
                    const d = desc.toLowerCase();
                    if (
                        d.includes("rain") ||
                        d.includes("雨") ||
                        d.includes("shower") ||
                        d.includes("drizzle") ||
                        d.includes("thunder")
                    )
                        return "fa-cloud-showers-heavy";
                    if (
                        d.includes("snow") ||
                        d.includes("snow") ||
                        d.includes("flake") ||
                        d.includes("雪")
                    )
                        return "fa-snowflake";
                    if (
                        d.includes("cloud") ||
                        d.includes("cloudy") ||
                        d.includes("多雲") ||
                        d.includes("陰")
                    )
                        return "fa-cloud";
                    if (
                        d.includes("clear") ||
                        d.includes("sun") ||
                        d.includes("晴") ||
                        d.includes("晴時")
                    )
                        return "fa-sun";
                    if (
                        d.includes("mist") ||
                        d.includes("fog") ||
                        d.includes("霧")
                    )
                        return "fa-smog";
                    return "fa-cloud-sun";
                }

                function renderToWidget(widget, data, city) {
                    try {
                        const current =
                            data.current_condition && data.current_condition[0];
                        const nearest =
                            (data.nearest_area && data.nearest_area[0]) || null;
                        const locName =
                            nearest &&
                            nearest.areaName &&
                            nearest.areaName[0] &&
                            nearest.areaName[0].value
                                ? nearest.areaName[0].value
                                : city;
                        const weatherLocSpan =
                            widget.querySelector(".widget-header .small") ||
                            widget.querySelector(".weather-location");
                        const weatherIcon =
                            widget.querySelector(".weather-visual i");
                        const weatherTemp = widget.querySelector(".temp");
                        const weatherDesc = widget.querySelector(".desc");
                        const weatherHumidity =
                            widget.querySelector(".weather-humidity") ||
                            widget.querySelector(".meta span:nth-child(1)");
                        const weatherFeels =
                            widget.querySelector(".weather-feels") ||
                            widget.querySelector(".meta span:nth-child(2)");
                        const weatherForecast =
                            widget.querySelector(".weather-forecast");
                        const weatherUpdatedElem =
                            widget.querySelector(".weather-updated") ||
                            widget.querySelector("#weather-updated");

                        if (weatherLocSpan) weatherLocSpan.innerText = locName;
                        const desc =
                            (current &&
                                current.weatherDesc &&
                                current.weatherDesc[0] &&
                                current.weatherDesc[0].value) ||
                            "";
                        const iconClass = getIconForDesc(desc);
                        if (weatherIcon)
                            weatherIcon.className = `fa-solid ${iconClass}`;
                        if (weatherTemp)
                            weatherTemp.innerText = `${current.temp_C}°C`;
                        if (weatherDesc) weatherDesc.innerText = desc;
                        if (weatherHumidity)
                            weatherHumidity.innerText = `濕度: ${current.humidity}%`;
                        if (weatherFeels)
                            weatherFeels.innerText = `體感: ${current.FeelsLikeC}°C`;

                        if (weatherForecast) {
                            weatherForecast.innerHTML = "";
                            if (Array.isArray(data.weather)) {
                                for (
                                    let i = 0;
                                    i < data.weather.length && i < 3;
                                    i++
                                ) {
                                    const d = data.weather[i];
                                    const date = d.date;
                                    const high = d.maxtempC;
                                    const low = d.mintempC;
                                    const midday =
                                        d.hourly &&
                                        d.hourly[4] &&
                                        d.hourly[4].weatherDesc &&
                                        d.hourly[4].weatherDesc[0] &&
                                        d.hourly[4].weatherDesc[0].value
                                            ? d.hourly[4].weatherDesc[0].value
                                            : "";
                                    const ic = getIconForDesc(midday);
                                    const item = document.createElement("div");
                                    item.className = "forecast-item";
                                    item.innerHTML = `
                                <div class="date">${date}</div>
                                <div class="icon"><i class="fa-solid ${ic}"></i></div>
                                <div class="temp">${high}° / ${low}°</div>
                                <div class="desc" style="font-size:0.8rem;color:#bbb">${midday}</div>
                            `;
                                    weatherForecast.appendChild(item);
                                }
                            }
                        }

                        if (weatherUpdatedElem) {
                            try {
                                weatherUpdatedElem.innerText =
                                    "更新: " + new Date().toLocaleTimeString();
                            } catch (e) {}
                        }
                    } catch (e) {
                        const weatherDesc = widget.querySelector(".desc");
                        const weatherForecast =
                            widget.querySelector(".weather-forecast");
                        if (weatherDesc)
                            weatherDesc.innerText = "解析資料時發生錯誤";
                        if (weatherForecast) weatherForecast.innerHTML = "";
                    }
                }

                async function updateWeatherForWidget(widget, city) {
                    const input = widget.querySelector(
                        '.weather-controls input[type="text"]'
                    );
                    const refreshBtn = widget.querySelector(
                        '.weather-controls button[aria-label="刷新天氣"], .weather-controls button'
                    );
                    const descEl = widget.querySelector(".desc");
                    if (!city && input) city = input.value.trim();
                    if (!city) city = DEFAULT_CITY;
                    if (descEl) descEl.innerText = "載入中...";
                    if (refreshBtn) {
                        refreshBtn.disabled = true;
                        refreshBtn.style.opacity = "0.6";
                        const ic = refreshBtn.querySelector("i");
                        if (ic) ic.classList.add("fa-spin");
                    }
                    try {
                        const cached = _checkCache(city);
                        let data = cached;
                        if (!data) {
                            data = await fetchWeatherData(city);
                            _setCache(city, data);
                        }
                        renderToWidget(widget, data, city);
                    } catch (e) {
                        console.error(e);
                        if (descEl) descEl.innerText = "無法獲取天氣資料";
                        const forecast =
                            widget.querySelector(".weather-forecast");
                        if (forecast) forecast.innerHTML = "";
                    }
                    if (refreshBtn) {
                        refreshBtn.disabled = false;
                        refreshBtn.style.opacity = "1";
                        const ic = refreshBtn.querySelector("i");
                        if (ic) ic.classList.remove("fa-spin");
                    }
                }

                async function detectLocationAndUpdateWidget(widget) {
                    if (!navigator.geolocation) {
                        return updateWeatherForWidget(widget, DEFAULT_CITY);
                    }
                    const descEl = widget.querySelector(".desc");
                    if (descEl) descEl.innerText = "獲取定位中...";
                    navigator.geolocation.getCurrentPosition(
                        async (pos) => {
                            try {
                                const { latitude, longitude } = pos.coords;
                                const nomUrl = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${latitude}&lon=${longitude}`;
                                const r = await fetch(nomUrl);
                                if (r.ok) {
                                    const rjson = await r.json();
                                    const city =
                                        rjson.address.city ||
                                        rjson.address.town ||
                                        rjson.address.village ||
                                        rjson.address.county ||
                                        rjson.address.state ||
                                        DEFAULT_CITY;
                                    const input = widget.querySelector(
                                        '.weather-controls input[type="text"]'
                                    );
                                    if (input) input.value = city;
                                    updateWeatherForWidget(widget, city);
                                } else {
                                    updateWeatherForWidget(
                                        widget,
                                        DEFAULT_CITY
                                    );
                                }
                            } catch (e) {
                                updateWeatherForWidget(widget, DEFAULT_CITY);
                            }
                        },
                        (err) => {
                            updateWeatherForWidget(widget, DEFAULT_CITY);
                        },
                        { timeout: 8000 }
                    );
                }

                // Initialize a single weather widget (bind events and start auto-refresh)
                function initWeatherWidget(widget) {
                    if (!widget) return;
                    // Avoid double-init
                    if (widget._weatherInited) return;
                    widget._weatherInited = true;

                    const input = widget.querySelector(
                        '.weather-controls input[type="text"]'
                    );
                    const refreshBtn = widget.querySelector(
                        '.weather-controls button[aria-label="刷新天氣"]'
                    );
                    const geoBtn = widget.querySelector(
                        '.weather-controls button[aria-label="使用定位"]'
                    );

                    if (input) {
                        input.value = input.value || DEFAULT_CITY;
                        input.addEventListener("keydown", (e) => {
                            if (e.key === "Enter")
                                updateWeatherForWidget(
                                    widget,
                                    input.value.trim()
                                );
                        });
                    }

                    if (refreshBtn) {
                        refreshBtn.addEventListener("click", () => {
                            updateWeatherForWidget(
                                widget,
                                (input && input.value.trim()) || DEFAULT_CITY
                            );
                        });
                    }
                    if (geoBtn) {
                        geoBtn.addEventListener("click", () => {
                            detectLocationAndUpdateWidget(widget);
                        });
                    }

                    // Try to load from cache or fetch once
                    const cache = _getCache();
                    const city =
                        cache && cache.city
                            ? cache.city
                            : (input && input.value) || DEFAULT_CITY;
                    const cached = _checkCache(city);
                    if (cached) {
                        renderToWidget(widget, cached, city);
                    } else {
                        updateWeatherForWidget(widget, city);
                    }

                    // Auto refresh timer (per-widget)
                    try {
                        widget._weatherInterval = setInterval(() => {
                            updateWeatherForWidget(
                                widget,
                                (input && input.value.trim()) || DEFAULT_CITY
                            );
                        }, CACHE_TTL);
                    } catch (e) {}
                }

                // Auto-init existing weather widgets
                document
                    .querySelectorAll(".weather-widget")
                    .forEach((w) => initWeatherWidget(w));

                // Expose init function so dynamically created widgets can be initialized
                window.initWeatherWidget = initWeatherWidget;
            })();
        </script>

        <!-- Performance Monitor Widget Script (supports multiple instances) -->
        <script>
            (function () {
                "use strict";

                // Page start time
                const pageStartTime = performance.timeOrigin || Date.now();

                // FPS calculation variables (global)
                let frameCount = 0;
                let lastFpsTime = performance.now();
                let currentFps = 0;

                // CPU estimation variables
                let lastFrameTime = performance.now();
                let frameTimes = [];
                const MAX_FRAME_SAMPLES = 60;

                // Start FPS loop
                function fpsLoop(timestamp) {
                    frameCount++;
                    const frameDelta = timestamp - lastFrameTime;
                    lastFrameTime = timestamp;
                    frameTimes.push(frameDelta);
                    if (frameTimes.length > MAX_FRAME_SAMPLES)
                        frameTimes.shift();

                    const elapsed = timestamp - lastFpsTime;
                    if (elapsed >= 1000) {
                        currentFps = Math.round((frameCount * 1000) / elapsed);
                        frameCount = 0;
                        lastFpsTime = timestamp;
                    }
                    requestAnimationFrame(fpsLoop);
                }
                requestAnimationFrame(fpsLoop);

                function updateBarStatus(barEl, value, thresholds) {
                    if (!barEl) return;
                    barEl.classList.remove("warning", "critical");
                    if (value >= thresholds.critical)
                        barEl.classList.add("critical");
                    else if (value >= thresholds.warning)
                        barEl.classList.add("warning");
                }

                function formatUptime(ms) {
                    const totalSeconds = Math.floor(ms / 1000);
                    const hours = Math.floor(totalSeconds / 3600);
                    const minutes = Math.floor((totalSeconds % 3600) / 60);
                    const seconds = totalSeconds % 60;
                    return `${hours.toString().padStart(2, "0")}:${minutes
                        .toString()
                        .padStart(2, "0")}:${seconds
                        .toString()
                        .padStart(2, "0")}`;
                }

                // Compute metrics (shared)
                function computeMetrics() {
                    let cpuEstimate = 0;
                    if (frameTimes.length > 10) {
                        const avgFrameTime =
                            frameTimes.reduce((a, b) => a + b, 0) /
                            frameTimes.length;
                        const targetFrameTime = 16.67;
                        cpuEstimate = Math.min(
                            100,
                            Math.round(
                                (avgFrameTime / targetFrameTime) * 30 +
                                    Math.random() * 10
                            )
                        );
                        cpuEstimate = Math.max(5, Math.min(100, cpuEstimate));
                    }

                    let memoryUsed = 0;
                    let memoryPercent = 0;
                    let jsHeapUsed = 0;
                    if (performance.memory) {
                        jsHeapUsed =
                            performance.memory.usedJSHeapSize / (1024 * 1024);
                        const jsHeapLimit =
                            performance.memory.jsHeapSizeLimit / (1024 * 1024);
                        memoryPercent = Math.round(
                            (jsHeapUsed / jsHeapLimit) * 100
                        );
                        memoryUsed = jsHeapUsed;
                    } else {
                        const domCount =
                            document.getElementsByTagName("*").length;
                        memoryUsed = Math.round(
                            domCount * 0.01 + 20 + Math.random() * 5
                        );
                        memoryPercent = Math.min(
                            100,
                            Math.round(memoryUsed / 2)
                        );
                        jsHeapUsed = memoryUsed;
                    }

                    const uptime = Date.now() - pageStartTime;
                    const domNodes = document.getElementsByTagName("*").length;

                    return {
                        cpuEstimate,
                        memoryUsed,
                        memoryPercent,
                        jsHeapUsed,
                        uptime,
                        domNodes,
                        currentFps,
                    };
                }

                // Update a single performance widget
                function updatePerfForWidget(widget) {
                    if (!widget) return;
                    const metrics = computeMetrics();

                    // find sections by label
                    const sections = Array.from(
                        widget.querySelectorAll(".perf-section")
                    );
                    sections.forEach((sec) => {
                        const titleEl = sec.querySelector(".perf-label-title");
                        const valueEl = sec.querySelector(".perf-label-value");
                        const barFill = sec.querySelector(".perf-bar-fill");
                        if (!titleEl) return;
                        const t = titleEl.textContent || "";
                        if (t.includes("CPU") || t.includes("微")) {
                            if (valueEl)
                                valueEl.textContent = `${metrics.cpuEstimate}%`;
                            if (barFill) {
                                barFill.style.width = `${metrics.cpuEstimate}%`;
                                updateBarStatus(barFill, metrics.cpuEstimate, {
                                    warning: 70,
                                    critical: 90,
                                });
                            }
                        } else if (t.includes("記憶")) {
                            if (valueEl)
                                valueEl.textContent = `${Math.round(
                                    metrics.memoryUsed
                                )} MB`;
                            if (barFill) {
                                barFill.style.width = `${Math.min(
                                    100,
                                    metrics.memoryPercent
                                )}%`;
                                updateBarStatus(
                                    barFill,
                                    metrics.memoryPercent,
                                    { warning: 60, critical: 80 }
                                );
                            }
                        } else if (t.includes("FPS")) {
                            if (valueEl)
                                valueEl.textContent = `${metrics.currentFps} fps`;
                            if (barFill) {
                                const fpsPercent = Math.min(
                                    100,
                                    Math.round((metrics.currentFps / 60) * 100)
                                );
                                barFill.style.width = `${fpsPercent}%`;
                                barFill.classList.remove("warning", "critical");
                                if (metrics.currentFps < 30)
                                    barFill.classList.add("critical");
                                else if (metrics.currentFps < 50)
                                    barFill.classList.add("warning");
                            }
                        }
                    });

                    // Directly set perf stat elements (prefer class-based selectors)
                    try {
                        const uptimeEl = widget.querySelector(".perf-uptime");
                        if (uptimeEl)
                            uptimeEl.textContent = formatUptime(metrics.uptime);
                        const domNodesElLocal =
                            widget.querySelector(".perf-dom-nodes");
                        if (domNodesElLocal)
                            domNodesElLocal.textContent =
                                metrics.domNodes.toLocaleString();
                        const jsHeapElLocal =
                            widget.querySelector(".perf-js-heap");
                        if (jsHeapElLocal)
                            jsHeapElLocal.textContent = `${Math.round(
                                metrics.jsHeapUsed
                            )} MB`;
                        const loadTimeElLocal =
                            widget.querySelector(".perf-load-time");
                        if (loadTimeElLocal) {
                            if (
                                performance.timing &&
                                performance.timing.loadEventEnd
                            ) {
                                const loadTime =
                                    performance.timing.loadEventEnd -
                                    performance.timing.navigationStart;
                                loadTimeElLocal.textContent =
                                    loadTime > 0 ? `${loadTime} ms` : "---";
                            } else if (performance.getEntriesByType) {
                                const navEntries =
                                    performance.getEntriesByType("navigation");
                                if (navEntries.length > 0)
                                    loadTimeElLocal.textContent = `${Math.round(
                                        navEntries[0].loadEventEnd
                                    )} ms`;
                            }
                        }
                    } catch (e) {}

                    // Fallback: perf-stats by label matching (legacy)
                    const statItems = Array.from(
                        widget.querySelectorAll(".perf-stat-item")
                    );
                    statItems.forEach((item) => {
                        const label = (
                            item.querySelector(".perf-stat-label")
                                ?.textContent || ""
                        ).trim();
                        const valEl = item.querySelector(".perf-stat-value");
                        if (!label || !valEl) return;
                        if (
                            label.includes("執行時間") &&
                            !item.querySelector(".perf-uptime")
                        )
                            valEl.textContent = formatUptime(metrics.uptime);
                        else if (
                            label.includes("DOM") &&
                            !item.querySelector(".perf-dom-nodes")
                        )
                            valEl.textContent =
                                metrics.domNodes.toLocaleString();
                        else if (
                            label.includes("JS Heap") &&
                            !item.querySelector(".perf-js-heap")
                        )
                            valEl.textContent = `${Math.round(
                                metrics.jsHeapUsed
                            )} MB`;
                        else if (
                            label.includes("載入") &&
                            !item.querySelector(".perf-load-time")
                        ) {
                            if (
                                performance.timing &&
                                performance.timing.loadEventEnd
                            ) {
                                const loadTime =
                                    performance.timing.loadEventEnd -
                                    performance.timing.navigationStart;
                                valEl.textContent =
                                    loadTime > 0 ? `${loadTime} ms` : "---";
                            } else if (performance.getEntriesByType) {
                                const navEntries =
                                    performance.getEntriesByType("navigation");
                                if (navEntries.length > 0)
                                    valEl.textContent = `${Math.round(
                                        navEntries[0].loadEventEnd
                                    )} ms`;
                            }
                        }
                    });
                }

                function initPerfWidget(widget) {
                    if (!widget) return;
                    if (widget._perfInited) return;
                    widget._perfInited = true;

                    // Initial update
                    updatePerfForWidget(widget);

                    // periodic update
                    widget._perfInterval = setInterval(() => {
                        updatePerfForWidget(widget);
                    }, 1000);
                }

                // Auto-init existing performance widgets
                document
                    .querySelectorAll(".performance-widget")
                    .forEach((w) => initPerfWidget(w));
                window.initPerfWidget = initPerfWidget;
            })();
        </script>

        <script>
            // About page helpers: populate info & actions
            (function () {
                function formatDateTime(d) {
                    if (!d) return "--";
                    const opts = {
                        year: "numeric",
                        month: "2-digit",
                        day: "2-digit",
                        hour: "2-digit",
                        minute: "2-digit",
                    };
                    return new Intl.DateTimeFormat("zh-TW", opts).format(d);
                }

                document.addEventListener("DOMContentLoaded", () => {
                    const verEl = document.getElementById("about-version");
                    const version = verEl ? verEl.textContent.trim() : "v?";
                    const buildDateEl =
                        document.getElementById("about-build-date");
                    const bootTimeEl =
                        document.getElementById("about-boot-time");
                    const browserEl = document.getElementById("about-browser");
                    const resolutionEl =
                        document.getElementById("about-resolution");
                    const langEl = document.getElementById("about-language");
                    // About page no longer exposes copy/check buttons; Update page handles updates.
                    const updateCheckBtn =
                        document.getElementById("update-check-btn");
                    const updateOpenReleaseBtn = document.getElementById(
                        "update-open-release-btn"
                    );
                    const updateAutoToggle =
                        document.getElementById("update-auto-toggle");
                    const updateLatestVersionEl = document.getElementById(
                        "update-latest-version"
                    );
                    const updateReleaseNotesEl = document.getElementById(
                        "update-release-notes"
                    );
                    const updateLastCheckedEl = document.getElementById(
                        "update-last-checked"
                    );
                    const updateStatusEl =
                        document.getElementById("update-status");
                    // updateStatus handled as updateStatusEl for the Update page

                    // populate system info
                    if (browserEl)
                        browserEl.textContent =
                            navigator.userAgent ||
                            navigator.appVersion ||
                            "未知瀏覽器";
                    if (resolutionEl)
                        resolutionEl.textContent = `${window.screen.width} x ${window.screen.height}`;
                    if (langEl)
                        langEl.textContent =
                            navigator.language ||
                            navigator.languages[0] ||
                            "未知";

                    // set boot time as page load origin
                    try {
                        const timeOrigin =
                            performance.timeOrigin ||
                            performance.timing?.navigationStart ||
                            Date.now();
                        const d = new Date(timeOrigin);
                        if (bootTimeEl)
                            bootTimeEl.textContent = formatDateTime(d);
                    } catch (e) {
                        if (bootTimeEl) bootTimeEl.textContent = "--";
                    }

                    // About page no longer provides copy version functionality; handled in Update page if needed.

                    // Update helper: get latest release from GitHub
                    async function fetchLatestRelease(repo) {
                        const res = await fetch(
                            `https://api.github.com/repos/${repo}/releases/latest`
                        );
                        if (!res.ok) throw new Error(`HTTP ${res.status}`);
                        const data = await res.json();
                        return data;
                    }

                    async function doCheckUpdatesUI(opts = {}) {
                        // opts: { repo, currentVersion, btn, statusEl, latestEl, releaseNotesEl, openBtn, lastCheckedEl }
                        const {
                            repo,
                            currentVersion,
                            btn,
                            statusEl,
                            latestEl,
                            releaseNotesEl,
                            openBtn,
                            lastCheckedEl,
                        } = opts;
                        if (!repo) return null;
                        const uiBtn = btn;
                        if (uiBtn) {
                            uiBtn.disabled = true;
                            uiBtn._prevText = uiBtn.textContent;
                            uiBtn.textContent = "檢查中...";
                        }
                        if (statusEl)
                            statusEl.textContent =
                                "正在查詢 GitHub Releases...";
                        try {
                            const data = await fetchLatestRelease(repo);
                            const latestTag = data.tag_name || data.name || "";
                            const htmlUrl =
                                data.html_url ||
                                `https://github.com/${repo}/releases`;
                            if (latestEl)
                                latestEl.textContent =
                                    latestTag || "無發行內容";
                            if (releaseNotesEl)
                                releaseNotesEl.textContent = data.body
                                    ? data.body.trim()
                                    : "無發布說明";
                            if (openBtn) {
                                openBtn.disabled = false;
                                openBtn.onclick = () =>
                                    window.open(htmlUrl, "_blank", "noopener");
                            }
                            if (latestTag && latestTag !== currentVersion) {
                                if (statusEl)
                                    statusEl.innerHTML = `有新版本可用：${latestTag} · <a href="${htmlUrl}" target="_blank" rel="noopener">檢視</a>`;
                            } else {
                                if (statusEl)
                                    statusEl.textContent = `已是最新版本 (${currentVersion})`;
                            }
                            if (lastCheckedEl)
                                lastCheckedEl.textContent = formatDateTime(
                                    new Date()
                                );
                            // Return data
                            return { success: true, data };
                        } catch (err) {
                            if (statusEl)
                                statusEl.textContent =
                                    "檢查更新失敗（可能被 GitHub API 限制或無網路）";
                            console.warn("check updates error", err);
                            return { success: false, error: err };
                        } finally {
                            if (uiBtn) {
                                uiBtn.disabled = false;
                                uiBtn.textContent =
                                    uiBtn._prevText || "檢查更新";
                            }
                        }
                    }

                    // About page no longer has an update button; Update page controls handle check/update UI.

                    // Hook up Update page controls: button and auto toggle
                    // Get current version for update page
                    const updateCurrentVersionEl = document.getElementById(
                        "update-current-version"
                    );
                    const currentVersionText = updateCurrentVersionEl
                        ? updateCurrentVersionEl.textContent.trim()
                        : version;
                    // Ensure initial state for open button
                    if (updateOpenReleaseBtn)
                        updateOpenReleaseBtn.disabled = true;
                    if (updateCheckBtn) {
                        updateCheckBtn.addEventListener("click", async () => {
                            await doCheckUpdatesUI({
                                repo: "AmanoShizukikun/AmanoShizukikun.github.io",
                                currentVersion: currentVersionText,
                                btn: updateCheckBtn,
                                statusEl: updateStatusEl,
                                latestEl: updateLatestVersionEl,
                                releaseNotesEl: updateReleaseNotesEl,
                                openBtn: updateOpenReleaseBtn,
                                lastCheckedEl: updateLastCheckedEl,
                            });
                        });
                    }

                    // Auto-check toggle
                    const AUTO_KEY = "webos_update_auto_check_v1";
                    function getAutoCheck() {
                        try {
                            return (
                                JSON.parse(
                                    localStorage.getItem(AUTO_KEY) || "null"
                                ) || {
                                    enabled: false,
                                    interval: 86400000,
                                    lastChecked: null,
                                }
                            );
                        } catch (e) {
                            return {
                                enabled: false,
                                interval: 86400000,
                                lastChecked: null,
                            };
                        }
                    }
                    function setAutoCheck(obj) {
                        try {
                            localStorage.setItem(AUTO_KEY, JSON.stringify(obj));
                        } catch (e) {}
                    }
                    // Restore toggle
                    if (updateAutoToggle) {
                        const obj = getAutoCheck();
                        if (obj.enabled) {
                            updateAutoToggle.classList.add("active");
                            updateAutoToggle.setAttribute(
                                "aria-checked",
                                "true"
                            );
                        }
                        updateAutoToggle.addEventListener("click", () => {
                            const enabled =
                                updateAutoToggle.classList.toggle("active");
                            updateAutoToggle.setAttribute(
                                "aria-checked",
                                enabled ? "true" : "false"
                            );
                            setAutoCheck(
                                Object.assign(getAutoCheck(), { enabled })
                            );
                            if (enabled) {
                                /* immediate check on enable */ if (
                                    updateCheckBtn
                                )
                                    updateCheckBtn.click();
                            }
                        });
                        updateAutoToggle.addEventListener("keydown", (e) => {
                            if (e.key === " " || e.key === "Enter") {
                                e.preventDefault();
                                updateAutoToggle.click();
                            }
                        });
                    }

                    // Auto check interval scheduler (every 5 minutes ping to test if lastChecked expired)
                    setInterval(async () => {
                        const obj = getAutoCheck();
                        if (!obj.enabled) return;
                        const last = obj.lastChecked
                            ? new Date(obj.lastChecked).getTime()
                            : 0;
                        const now = Date.now();
                        if (now - last > (obj.interval || 86400000)) {
                            if (updateCheckBtn) await updateCheckBtn.click();
                            obj.lastChecked = new Date().toISOString();
                            setAutoCheck(obj);
                        }
                    }, 5 * 60 * 1000);
                });
            })();

            // ========== 記事本應用 ==========
            const notepadApp = {
                currentFile: null,
                isModified: false,

                init() {
                    const editor = document.getElementById("notepad-editor");
                    const fileInput =
                        document.getElementById("notepad-file-input");

                    if (editor) {
                        // 監聽內容變化
                        editor.addEventListener("input", () => {
                            this.isModified = true;
                            this.updateTitle();
                            this.updateStatus();
                        });

                        // 監聯游標位置
                        editor.addEventListener("keyup", () =>
                            this.updateStatus()
                        );
                        editor.addEventListener("click", () =>
                            this.updateStatus()
                        );

                        // 鍵盤快捷鍵
                        editor.addEventListener("keydown", (e) => {
                            if (e.ctrlKey || e.metaKey) {
                                switch (e.key.toLowerCase()) {
                                    case "s":
                                        e.preventDefault();
                                        this.saveFile();
                                        break;
                                    case "o":
                                        e.preventDefault();
                                        this.openFile();
                                        break;
                                    case "n":
                                        e.preventDefault();
                                        this.newFile();
                                        break;
                                }
                            }
                        });
                    }

                    if (fileInput) {
                        fileInput.addEventListener("change", (e) => {
                            const file = e.target.files[0];
                            if (file) this.loadFile(file);
                        });
                    }
                },

                newFile() {
                    if (
                        this.isModified &&
                        !confirm("目前文件尚未儲存，確定要新增嗎？")
                    )
                        return;
                    const editor = document.getElementById("notepad-editor");
                    if (editor) editor.innerHTML = "";
                    this.currentFile = null;
                    this.isModified = false;
                    this.updateTitle();
                    this.updateStatus();
                },

                openFile() {
                    const input = document.getElementById("notepad-file-input");
                    if (input) input.click();
                },

                loadFile(file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const editor =
                            document.getElementById("notepad-editor");
                        if (editor) {
                            editor.innerText = e.target.result;
                            this.currentFile = file.name;
                            this.isModified = false;
                            this.updateTitle();
                            this.updateStatus();
                        }
                    };
                    reader.readAsText(file);
                },

                saveFile() {
                    const editor = document.getElementById("notepad-editor");
                    if (!editor) return;

                    const content = editor.innerText;
                    const blob = new Blob([content], { type: "text/plain" });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = this.currentFile || "未命名.txt";
                    a.click();
                    URL.revokeObjectURL(url);

                    this.isModified = false;
                    this.updateTitle();
                },

                undo() {
                    document.execCommand("undo");
                },
                redo() {
                    document.execCommand("redo");
                },
                cut() {
                    document.execCommand("cut");
                },
                copy() {
                    document.execCommand("copy");
                },
                paste() {
                    navigator.clipboard
                        .readText()
                        .then((text) => {
                            document.execCommand("insertText", false, text);
                        })
                        .catch(() => {
                            alert("無法存取剪貼簿，請使用 Ctrl+V");
                        });
                },
                selectAll() {
                    const editor = document.getElementById("notepad-editor");
                    if (editor) {
                        const range = document.createRange();
                        range.selectNodeContents(editor);
                        const sel = window.getSelection();
                        sel.removeAllRanges();
                        sel.addRange(range);
                    }
                },
                find() {
                    const searchTerm = prompt("請輸入要搜尋的文字：");
                    if (searchTerm) {
                        const editor =
                            document.getElementById("notepad-editor");
                        if (editor) {
                            const text = editor.innerText;
                            const index = text.indexOf(searchTerm);
                            if (index >= 0) {
                                alert(`找到 "${searchTerm}" 於位置 ${index}`);
                            } else {
                                alert("找不到指定的文字");
                            }
                        }
                    }
                },

                updateTitle() {
                    const titleEl = document.querySelector(
                        "#window-notepad .window-title span"
                    );
                    if (titleEl) {
                        const fileName = this.currentFile || "未命名";
                        titleEl.textContent = `記事本 - ${fileName}${
                            this.isModified ? " *" : ""
                        }`;
                    }
                },

                updateStatus() {
                    const editor = document.getElementById("notepad-editor");
                    const lineColEl =
                        document.getElementById("notepad-line-col");
                    const charCountEl =
                        document.getElementById("notepad-char-count");

                    if (editor && lineColEl && charCountEl) {
                        const text = editor.innerText;
                        const selection = window.getSelection();

                        let line = 1,
                            col = 1;
                        if (selection.rangeCount > 0) {
                            const range = selection.getRangeAt(0);
                            const preCaretRange = range.cloneRange();
                            preCaretRange.selectNodeContents(editor);
                            preCaretRange.setEnd(
                                range.endContainer,
                                range.endOffset
                            );
                            const textBefore = preCaretRange.toString();
                            line = textBefore.split("\n").length;
                            col = textBefore.split("\n").pop().length + 1;
                        }

                        lineColEl.textContent = `行 ${line}, 列 ${col}`;
                        charCountEl.textContent = `${text.length} 字元`;
                    }
                },
            };

            // ========== 終端機應用 ==========
            const terminalApp = {
                init() {
                    const input = document.getElementById("terminal-input");
                    if (!input) return;

                    input.addEventListener("keyup", (e) => {
                        if (e.keyCode === 13) {
                            this.executeCommand(input.value.trim());
                            input.value = "";
                        }
                    });
                },

                executeCommand(cmd) {
                    if (!cmd) return;

                    const output = document.getElementById("terminal-output");
                    const prompt = document.getElementById("terminal-prompt");
                    if (!output || !prompt) return;

                    // Echo command
                    output.textContent += `\n${prompt.textContent} ${cmd}\n`;

                    const parts = cmd.toLowerCase().split(" ");
                    const command = parts[0];

                    let result = "";
                    switch (command) {
                        case "help":
                            result =
                                "可用命令: help, cls, echo, date, time, ver";
                            break;
                        case "cls":
                            output.textContent = "";
                            return;
                        case "echo":
                            result = parts.slice(1).join(" ");
                            break;
                        case "date":
                            result = new Date().toLocaleDateString("zh-TW");
                            break;
                        case "time":
                            result = new Date().toLocaleTimeString("zh-TW");
                            break;
                        case "ver":
                            result = "Nagato Sakura Terminal [版本 1.0.0]";
                            break;
                        default:
                            result = `'${command}' 不是內部或外部命令。`;
                    }

                    if (result) {
                        output.textContent += result + "\n";
                    }

                    // Auto scroll
                    const terminal = document.getElementById("win-terminal");
                    if (terminal) terminal.scrollTop = terminal.scrollHeight;
                },
            };

            // ========== 相簿應用 (Metro 風格 + 拖動支援 + 自動排版) ==========
            const photosApp = {
                selectedPhoto: null,
                viewMode: "medium",
                currentFolder: "all",
                draggedItem: null,
                lastClickTime: 0,
                lastClickItem: null,
                wallpapers: [
                    "NS-V5-2nd.jpg",
                    "NS-V5-D.jpg",
                    "NS-V5-E.jpg",
                    "NS-V5-W.jpg",
                ],

                init() {
                    const uploadInput =
                        document.getElementById("photo-upload-input");
                    if (uploadInput) {
                        uploadInput.addEventListener("change", (e) => {
                            const files = e.target.files;
                            if (files) {
                                Array.from(files).forEach((file) => {
                                    this.addPhoto(file);
                                });
                            }
                        });
                    }

                    // 初始化側邊欄點擊
                    this.initSidebar();

                    // 載入 wallpaper 資料夾圖片
                    this.loadWallpapers();

                    // 初始化拖動功能
                    this.initDragAndDrop();

                    // 監聽視窗大小變化以重新排版
                    const grid = document.getElementById("photos-grid");
                    if (grid) {
                        new ResizeObserver(() => this.layout()).observe(grid);
                    }
                    window.addEventListener("resize", () => this.layout());
                },

                initSidebar() {
                    const sidebarItems = document.querySelectorAll(
                        ".photos-sidebar-item"
                    );
                    sidebarItems.forEach((item) => {
                        item.addEventListener("click", () => {
                            sidebarItems.forEach((i) =>
                                i.classList.remove("active")
                            );
                            item.classList.add("active");
                            this.currentFolder = item.dataset.folder;
                        });
                    });
                },

                loadWallpapers() {
                    const grid = document.getElementById("photos-grid");
                    if (!grid) return;

                    this.wallpapers.forEach((filename, index) => {
                        const imgSrc = `assets/wallpaper/${filename}`;
                        this.createPhotoItem(
                            grid,
                            imgSrc,
                            `桌布 ${index + 1}`,
                            filename
                        );
                    });
                    setTimeout(() => this.layout(), 100);
                },

                createPhotoItem(grid, imgSrc, alt, filename) {
                    const photoItem = document.createElement("div");
                    photoItem.className = "photo-item";
                    photoItem.dataset.src = imgSrc;
                    photoItem.dataset.filename = filename || "unknown";
                    photoItem.setAttribute("draggable", "true");

                    photoItem.innerHTML = `
                    <img src="${imgSrc}" alt="${alt}" draggable="false" onerror="this.closest('.photo-item').style.display='none'" loading="lazy">
                    <div class="photo-overlay">
                        <div class="photo-info">
                            <span class="photo-name">${filename || alt}</span>
                            <div class="photo-actions">
                                <button class="photo-action-btn" onclick="event.stopPropagation(); photosApp.viewPhoto(this.closest('.photo-item'))" title="檢視">
                                    <i class="fa-solid fa-eye"></i>
                                </button>
                                <button class="photo-action-btn" onclick="event.stopPropagation(); photosApp.setAsWallpaper(this.closest('.photo-item'))" title="設為桌布">
                                    <i class="fa-solid fa-desktop"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                    // 點擊選取 + 雙擊預覽
                    photoItem.addEventListener("click", (e) => {
                        const now = Date.now();
                        if (
                            this.lastClickItem === photoItem &&
                            now - this.lastClickTime < 300
                        ) {
                            // 雙擊 - 開啟預覽
                            this.viewPhoto(photoItem);
                        } else {
                            // 單擊 - 選取
                            this.selectPhoto(photoItem);
                        }
                        this.lastClickTime = now;
                        this.lastClickItem = photoItem;
                    });

                    // 圖片載入後重新排版
                    const img = photoItem.querySelector("img");
                    if (img) {
                        img.onload = () => this.layout();
                    }

                    grid.appendChild(photoItem);
                    return photoItem;
                },

                // Masonry 瀑布流排版核心邏輯
                layout() {
                    const grid = document.getElementById("photos-grid");
                    if (!grid) return;

                    const items = Array.from(
                        grid.querySelectorAll(".photo-item")
                    );
                    const gridWidth = grid.clientWidth;

                    let columns = 4;
                    if (this.viewMode === "large") columns = 3;
                    if (this.viewMode === "small") columns = 5;
                    if (gridWidth < 800) columns = 3;
                    if (gridWidth < 500) columns = 2;

                    const gap = 12;
                    const columnWidth =
                        (gridWidth - (columns - 1) * gap) / columns;
                    const columnHeights = new Array(columns).fill(0);

                    items.forEach((item) => {
                        item.style.width = `${columnWidth}px`;

                        let minHeight = Infinity;
                        let minIndex = 0;
                        for (let i = 0; i < columns; i++) {
                            if (columnHeights[i] < minHeight) {
                                minHeight = columnHeights[i];
                                minIndex = i;
                            }
                        }

                        item.style.left = `${minIndex * (columnWidth + gap)}px`;
                        item.style.top = `${minHeight}px`;

                        const height = item.offsetHeight;
                        columnHeights[minIndex] += height + gap;
                    });

                    grid.style.height = `${Math.max(...columnHeights)}px`;
                },

                initDragAndDrop() {
                    const grid = document.getElementById("photos-grid");
                    if (!grid) return;

                    let dragSrcEl = null;
                    let lastSwapTarget = null;

                    // 使用事件委派處理拖曳
                    grid.addEventListener("dragstart", (e) => {
                        const item = e.target.closest(".photo-item");
                        if (!item) {
                            e.preventDefault();
                            return;
                        }

                        dragSrcEl = item;
                        lastSwapTarget = null;

                        // 延遲添加樣式，讓拖曳圖像正常顯示
                        setTimeout(() => {
                            item.classList.add("dragging");
                        }, 0);

                        e.dataTransfer.effectAllowed = "move";
                        e.dataTransfer.setData(
                            "text/plain",
                            item.dataset.filename || ""
                        );

                        // 設定拖曳圖像
                        if (e.dataTransfer.setDragImage) {
                            const rect = item.getBoundingClientRect();
                            e.dataTransfer.setDragImage(
                                item,
                                e.clientX - rect.left,
                                e.clientY - rect.top
                            );
                        }
                    });

                    grid.addEventListener("dragover", (e) => {
                        e.preventDefault();
                        e.dataTransfer.dropEffect = "move";

                        if (!dragSrcEl) return;

                        const item = e.target.closest(".photo-item");
                        if (!item || item === dragSrcEl) return;

                        // 只要進入目標元素就立即交換，不需要等過半
                        if (lastSwapTarget !== item) {
                            // 交換 DOM 位置
                            const items = Array.from(
                                grid.querySelectorAll(".photo-item")
                            );
                            const srcIdx = items.indexOf(dragSrcEl);
                            const targetIdx = items.indexOf(item);

                            if (srcIdx < targetIdx) {
                                grid.insertBefore(dragSrcEl, item.nextSibling);
                            } else {
                                grid.insertBefore(dragSrcEl, item);
                            }

                            lastSwapTarget = item;
                            this.layout();
                        }
                    });

                    grid.addEventListener("drop", (e) => {
                        e.preventDefault();
                    });

                    grid.addEventListener("dragend", (e) => {
                        if (dragSrcEl) {
                            dragSrcEl.classList.remove("dragging");
                        }
                        dragSrcEl = null;
                        lastSwapTarget = null;
                        this.layout();
                    });
                },

                selectPhoto(photoItem) {
                    document
                        .querySelectorAll(".photo-item.selected")
                        .forEach((p) => p.classList.remove("selected"));
                    photoItem.classList.add("selected");
                    this.selectedPhoto = photoItem;
                },

                setViewMode(mode) {
                    this.viewMode = mode;
                    const grid = document.getElementById("photos-grid");
                    if (!grid) return;

                    document
                        .querySelectorAll(".photos-view-toggle .photos-btn")
                        .forEach((btn) => btn.classList.remove("active"));
                    if (event && event.target) {
                        const btn = event.target.closest(".photos-btn");
                        if (btn) btn.classList.add("active");
                    }

                    this.layout();
                },

                uploadPhoto() {
                    const input = document.getElementById("photo-upload-input");
                    if (input) input.click();
                },

                addPhoto(file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const grid = document.getElementById("photos-grid");
                        if (!grid) return;
                        this.createPhotoItem(
                            grid,
                            e.target.result,
                            file.name,
                            file.name
                        );
                        setTimeout(() => this.layout(), 100);
                    };
                    reader.readAsDataURL(file);
                },

                // 進階圖片預覽 (支援縮放、拖曳)
                viewPhoto(photoItem) {
                    this.selectedPhoto = photoItem;
                    const imgSrc = photoItem.dataset.src;
                    const photos = Array.from(
                        document.querySelectorAll("#photos-grid .photo-item")
                    ).filter((p) => p.style.display !== "none");
                    let currentIndex = photos.indexOf(photoItem);

                    // 縮放與拖曳狀態
                    let scale = 1;
                    let posX = 0,
                        posY = 0;
                    let isDragging = false;
                    let startX = 0,
                        startY = 0;
                    let lastPosX = 0,
                        lastPosY = 0;

                    const modal = document.createElement("div");
                    modal.className = "photo-viewer-modal";
                    modal.style.cssText =
                        "position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.95);display:flex;align-items:center;justify-content:center;z-index:10000;backdrop-filter:blur(10px);overflow:hidden;";

                    // 圖片容器
                    const imgContainer = document.createElement("div");
                    imgContainer.style.cssText =
                        "position:relative;display:flex;align-items:center;justify-content:center;width:100%;height:100%;cursor:grab;";

                    const img = document.createElement("img");
                    img.src = imgSrc;
                    img.style.cssText =
                        "max-width:90%;max-height:90%;object-fit:contain;border-radius:8px;box-shadow:0 20px 50px rgba(0,0,0,0.5);transition:transform 0.1s ease-out;user-select:none;pointer-events:none;";
                    img.draggable = false;

                    const updateTransform = () => {
                        img.style.transform = `translate(${posX}px, ${posY}px) scale(${scale})`;
                    };

                    const resetView = () => {
                        scale = 1;
                        posX = 0;
                        posY = 0;
                        updateTransform();
                    };

                    const loadImage = (index) => {
                        if (index < 0 || index >= photos.length) return;
                        currentIndex = index;
                        resetView();
                        img.src = photos[currentIndex].dataset.src;
                        indexDisplay.textContent = `${currentIndex + 1} / ${
                            photos.length
                        }`;
                    };

                    // 滾輪縮放
                    imgContainer.addEventListener(
                        "wheel",
                        (e) => {
                            e.preventDefault();
                            const delta = e.deltaY > 0 ? -0.1 : 0.1;
                            const newScale = Math.max(
                                0.5,
                                Math.min(5, scale + delta)
                            );

                            // 以滑鼠位置為中心縮放
                            const rect = imgContainer.getBoundingClientRect();
                            const mouseX =
                                e.clientX - rect.left - rect.width / 2;
                            const mouseY =
                                e.clientY - rect.top - rect.height / 2;

                            const scaleRatio = newScale / scale;
                            posX = mouseX - (mouseX - posX) * scaleRatio;
                            posY = mouseY - (mouseY - posY) * scaleRatio;

                            scale = newScale;
                            updateTransform();
                        },
                        { passive: false }
                    );

                    // 滑鼠拖曳
                    imgContainer.addEventListener("mousedown", (e) => {
                        if (e.button !== 0) return; // 只處理左鍵
                        if (e.target.closest("button")) return; // 忽略按鈕點擊

                        isDragging = true;
                        startX = e.clientX;
                        startY = e.clientY;
                        lastPosX = posX;
                        lastPosY = posY;
                        imgContainer.style.cursor = "grabbing";
                        img.style.transition = "none";
                    });

                    document.addEventListener("mousemove", handleMouseMove);
                    document.addEventListener("mouseup", handleMouseUp);

                    function handleMouseMove(e) {
                        if (!isDragging) return;
                        const dx = e.clientX - startX;
                        const dy = e.clientY - startY;
                        posX = lastPosX + dx;
                        posY = lastPosY + dy;
                        updateTransform();
                    }

                    function handleMouseUp() {
                        if (isDragging) {
                            isDragging = false;
                            imgContainer.style.cursor = "grab";
                            img.style.transition = "transform 0.1s ease-out";
                        }
                    }

                    // 工具列
                    const toolbar = document.createElement("div");
                    toolbar.style.cssText =
                        "position:fixed;bottom:30px;left:50%;transform:translateX(-50%);display:flex;gap:12px;padding:12px 20px;background:rgba(30,30,30,0.9);border-radius:12px;border:1px solid rgba(255,255,255,0.1);backdrop-filter:blur(10px);";

                    const createBtn = (icon, title, onClick) => {
                        const btn = document.createElement("button");
                        btn.innerHTML = `<i class="fa-solid fa-${icon}"></i>`;
                        btn.title = title;
                        btn.style.cssText =
                            "width:40px;height:40px;border:none;border-radius:8px;background:rgba(255,255,255,0.1);color:#fff;font-size:1rem;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;justify-content:center;";
                        btn.onmouseover = () =>
                            (btn.style.background = "rgba(255,255,255,0.2)");
                        btn.onmouseout = () =>
                            (btn.style.background = "rgba(255,255,255,0.1)");
                        btn.onclick = onClick;
                        return btn;
                    };

                    // 上一張
                    const prevBtn = createBtn("chevron-left", "上一張", () => {
                        loadImage(
                            (currentIndex - 1 + photos.length) % photos.length
                        );
                    });

                    // 縮小
                    const zoomOutBtn = createBtn("minus", "縮小", () => {
                        scale = Math.max(0.5, scale - 0.2);
                        updateTransform();
                    });

                    // 重置
                    const resetBtn = createBtn("expand", "重置", resetView);

                    // 縮放顯示
                    const zoomDisplay = document.createElement("span");
                    zoomDisplay.style.cssText =
                        "color:#fff;font-size:0.9rem;display:flex;align-items:center;min-width:50px;justify-content:center;";
                    zoomDisplay.textContent = "100%";

                    // 放大
                    const zoomInBtn = createBtn("plus", "放大", () => {
                        scale = Math.min(5, scale + 0.2);
                        updateTransform();
                    });

                    // 下一張
                    const nextBtn = createBtn("chevron-right", "下一張", () => {
                        loadImage((currentIndex + 1) % photos.length);
                    });

                    // 分隔線
                    const separator = document.createElement("div");
                    separator.style.cssText =
                        "width:1px;background:rgba(255,255,255,0.2);margin:0 4px;";

                    // 設為桌布
                    const wallpaperBtn = createBtn(
                        "desktop",
                        "設為桌布",
                        () => {
                            this.setAsWallpaper(photos[currentIndex]);
                        }
                    );

                    // 索引顯示
                    const indexDisplay = document.createElement("span");
                    indexDisplay.style.cssText =
                        "color:#fff;font-size:0.9rem;display:flex;align-items:center;min-width:60px;justify-content:center;";
                    indexDisplay.textContent = `${currentIndex + 1} / ${
                        photos.length
                    }`;

                    toolbar.append(
                        prevBtn,
                        zoomOutBtn,
                        zoomDisplay,
                        resetBtn,
                        zoomInBtn,
                        nextBtn,
                        separator.cloneNode(),
                        wallpaperBtn,
                        separator.cloneNode(),
                        indexDisplay
                    );

                    // 更新縮放顯示
                    const updateZoomDisplay = () => {
                        zoomDisplay.textContent = `${Math.round(scale * 100)}%`;
                    };

                    const originalUpdateTransform = updateTransform;
                    const newUpdateTransform = () => {
                        originalUpdateTransform();
                        updateZoomDisplay();
                    };

                    // 替換 updateTransform
                    imgContainer.addEventListener("wheel", updateZoomDisplay);
                    zoomOutBtn.addEventListener("click", updateZoomDisplay);
                    zoomInBtn.addEventListener("click", updateZoomDisplay);
                    resetBtn.addEventListener("click", () =>
                        setTimeout(updateZoomDisplay, 10)
                    );

                    // 關閉按鈕
                    const closeBtn = document.createElement("button");
                    closeBtn.innerHTML = '<i class="fa-solid fa-xmark"></i>';
                    closeBtn.style.cssText =
                        "position:fixed;top:20px;right:20px;width:48px;height:48px;border:none;border-radius:12px;background:rgba(255,255,255,0.1);color:#fff;font-size:1.5rem;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(10px);";
                    closeBtn.onmouseover = () =>
                        (closeBtn.style.background = "rgba(255,0,100,0.6)");
                    closeBtn.onmouseout = () =>
                        (closeBtn.style.background = "rgba(255,255,255,0.1)");

                    const closeModal = () => {
                        document.removeEventListener(
                            "mousemove",
                            handleMouseMove
                        );
                        document.removeEventListener("mouseup", handleMouseUp);
                        document.removeEventListener("keydown", handleKeyboard);
                        modal.remove();
                    };

                    closeBtn.onclick = closeModal;

                    // 鍵盤控制
                    const handleKeyboard = (e) => {
                        switch (e.key) {
                            case "Escape":
                                closeModal();
                                break;
                            case "ArrowLeft":
                                prevBtn.click();
                                break;
                            case "ArrowRight":
                                nextBtn.click();
                                break;
                            case "+":
                            case "=":
                                zoomInBtn.click();
                                break;
                            case "-":
                                zoomOutBtn.click();
                                break;
                            case "0":
                                resetBtn.click();
                                break;
                        }
                    };
                    document.addEventListener("keydown", handleKeyboard);

                    // 點擊背景關閉 (但拖曳時不關閉)
                    let clickStartOnBg = false;
                    modal.addEventListener("mousedown", (e) => {
                        clickStartOnBg =
                            e.target === modal || e.target === imgContainer;
                    });
                    modal.addEventListener("mouseup", (e) => {
                        if (
                            clickStartOnBg &&
                            (e.target === modal || e.target === imgContainer) &&
                            !isDragging &&
                            scale === 1 &&
                            posX === 0 &&
                            posY === 0
                        ) {
                            closeModal();
                        }
                        clickStartOnBg = false;
                    });

                    imgContainer.appendChild(img);
                    modal.appendChild(imgContainer);
                    modal.appendChild(toolbar);
                    modal.appendChild(closeBtn);

                    document.body.appendChild(modal);
                },

                setAsWallpaper(photoItem) {
                    const imgSrc = photoItem.dataset.src;
                    const bgEl = document.getElementById("desktop-bg");
                    if (bgEl) {
                        bgEl.style.backgroundImage = `url(${imgSrc})`;
                        bgEl.style.backgroundSize = "cover";
                        bgEl.style.backgroundPosition = "center";
                    }
                },

                toggleFavorite() {
                    if (this.selectedPhoto) {
                        this.selectedPhoto.classList.toggle("favorite");
                        const heartBtn = document.querySelector(
                            '.photos-toolbar-group .photos-btn[onclick*="toggleFavorite"] i'
                        );
                        if (heartBtn) {
                            heartBtn.classList.toggle("fa-regular");
                            heartBtn.classList.toggle("fa-solid");
                        }
                    }
                },

                deletePhoto() {
                    const selectedPhotos = document.querySelectorAll(
                        ".photo-item.selected"
                    );
                    if (selectedPhotos.length === 0) {
                        alert("請先選取要刪除的照片");
                        return;
                    }
                    if (
                        confirm(`確定要刪除 ${selectedPhotos.length} 張照片嗎?`)
                    ) {
                        selectedPhotos.forEach((p) => p.remove());
                        this.selectedPhoto = null;
                        this.layout();
                    }
                },

                viewSlideshow() {
                    const photos = Array.from(
                        document.querySelectorAll("#photos-grid .photo-item")
                    ).filter((p) => p.style.display !== "none");
                    if (photos.length === 0) {
                        alert("沒有可播放的照片");
                        return;
                    }

                    let currentIndex = 0;
                    let interval = null;
                    let isPaused = false;

                    const modal = document.createElement("div");
                    modal.style.cssText =
                        "position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.98);display:flex;align-items:center;justify-content:center;z-index:10000;";

                    const img = document.createElement("img");
                    img.style.cssText =
                        "max-width:90%;max-height:85%;object-fit:contain;transition:opacity 0.5s;border-radius:8px;";

                    const updateImage = () => {
                        img.style.opacity = "0";
                        setTimeout(() => {
                            img.src = photos[currentIndex].dataset.src;
                            img.style.opacity = "1";
                            indexDisplay.textContent = `${currentIndex + 1} / ${
                                photos.length
                            }`;
                        }, 250);
                    };

                    updateImage();

                    // 底部控制列
                    const controls = document.createElement("div");
                    controls.style.cssText =
                        "position:fixed;bottom:30px;left:50%;transform:translateX(-50%);display:flex;gap:12px;padding:12px 20px;background:rgba(30,30,30,0.9);border-radius:12px;border:1px solid rgba(255,255,255,0.1);backdrop-filter:blur(10px);";

                    const createBtn = (icon, title, onClick) => {
                        const btn = document.createElement("button");
                        btn.innerHTML = `<i class="fa-solid fa-${icon}"></i>`;
                        btn.title = title;
                        btn.style.cssText =
                            "width:40px;height:40px;border:none;border-radius:8px;background:rgba(255,255,255,0.1);color:#fff;font-size:1rem;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;justify-content:center;";
                        btn.onmouseover = () =>
                            (btn.style.background = "rgba(0,212,255,0.3)");
                        btn.onmouseout = () =>
                            (btn.style.background = "rgba(255,255,255,0.1)");
                        btn.onclick = onClick;
                        return btn;
                    };

                    const prevBtn = createBtn("backward-step", "上一張", () => {
                        currentIndex =
                            (currentIndex - 1 + photos.length) % photos.length;
                        updateImage();
                    });

                    const playPauseBtn = createBtn("pause", "暫停/播放", () => {
                        isPaused = !isPaused;
                        playPauseBtn.innerHTML = `<i class="fa-solid fa-${
                            isPaused ? "play" : "pause"
                        }"></i>`;
                        if (isPaused) {
                            clearInterval(interval);
                        } else {
                            interval = setInterval(() => {
                                currentIndex =
                                    (currentIndex + 1) % photos.length;
                                updateImage();
                            }, 4000);
                        }
                    });

                    const nextBtn = createBtn("forward-step", "下一張", () => {
                        currentIndex = (currentIndex + 1) % photos.length;
                        updateImage();
                    });

                    const indexDisplay = document.createElement("span");
                    indexDisplay.style.cssText =
                        "color:#fff;font-size:0.9rem;display:flex;align-items:center;min-width:60px;justify-content:center;";
                    indexDisplay.textContent = `1 / ${photos.length}`;

                    controls.append(
                        prevBtn,
                        playPauseBtn,
                        nextBtn,
                        indexDisplay
                    );

                    // 關閉按鈕
                    const closeBtn = document.createElement("button");
                    closeBtn.innerHTML = '<i class="fa-solid fa-xmark"></i>';
                    closeBtn.style.cssText =
                        "position:fixed;top:20px;right:20px;width:48px;height:48px;border:none;border-radius:12px;background:rgba(255,255,255,0.1);color:#fff;font-size:1.5rem;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;justify-content:center;";
                    closeBtn.onmouseover = () =>
                        (closeBtn.style.background = "rgba(255,0,100,0.6)");
                    closeBtn.onmouseout = () =>
                        (closeBtn.style.background = "rgba(255,255,255,0.1)");

                    const stopSlideshow = () => {
                        if (interval) {
                            clearInterval(interval);
                            interval = null;
                        }
                        document.removeEventListener("keydown", handleKeyPress);
                        modal.remove();
                    };

                    closeBtn.onclick = stopSlideshow;

                    const handleKeyPress = (e) => {
                        switch (e.key) {
                            case "Escape":
                                stopSlideshow();
                                break;
                            case "ArrowLeft":
                                prevBtn.click();
                                break;
                            case "ArrowRight":
                                nextBtn.click();
                                break;
                            case " ":
                                e.preventDefault();
                                playPauseBtn.click();
                                break;
                        }
                    };
                    document.addEventListener("keydown", handleKeyPress);

                    modal.onclick = (e) => {
                        if (e.target === modal) stopSlideshow();
                    };

                    modal.appendChild(img);
                    modal.appendChild(controls);
                    modal.appendChild(closeBtn);

                    document.body.appendChild(modal);

                    interval = setInterval(() => {
                        currentIndex = (currentIndex + 1) % photos.length;
                        updateImage();
                    }, 4000);
                },

                rotateLeft() {
                    if (this.selectedPhoto) {
                        const img = this.selectedPhoto.querySelector("img");
                        const currentRotation = parseInt(
                            img.dataset.rotation || 0
                        );
                        const newRotation = (currentRotation - 90) % 360;
                        img.style.transform = `rotate(${newRotation}deg)`;
                        img.dataset.rotation = newRotation;
                    }
                },

                rotateRight() {
                    if (this.selectedPhoto) {
                        const img = this.selectedPhoto.querySelector("img");
                        const currentRotation = parseInt(
                            img.dataset.rotation || 0
                        );
                        const newRotation = (currentRotation + 90) % 360;
                        img.style.transform = `rotate(${newRotation}deg)`;
                        img.dataset.rotation = newRotation;
                    }
                },
            };

            // ========== 播放器應用 ==========
            const playerApp = {
                video: null,

                init() {
                    this.video = document.getElementById("player-video");
                    const fileInput =
                        document.getElementById("player-file-input");
                    const volumeSlider =
                        document.getElementById("player-volume");
                    const progressBar =
                        document.getElementById("player-progress");

                    if (!this.video) return;

                    // File input
                    if (fileInput) {
                        fileInput.addEventListener("change", (e) => {
                            const file = e.target.files[0];
                            if (file) {
                                const url = URL.createObjectURL(file);
                                this.video.src = url;
                                document
                                    .getElementById("player-overlay")
                                    .classList.add("hidden");
                                this.video.play();
                            }
                        });
                    }

                    // Volume control
                    if (volumeSlider) {
                        volumeSlider.addEventListener("input", (e) => {
                            this.video.volume = e.target.value / 100;
                            this.updateVolumeIcon();
                        });
                    }

                    // Progress bar
                    if (progressBar) {
                        progressBar.addEventListener("input", (e) => {
                            const time =
                                (e.target.value / 100) * this.video.duration;
                            this.video.currentTime = time;
                        });
                    }

                    // Update time and progress
                    this.video.addEventListener("timeupdate", () => {
                        this.updateTime();
                        this.updateProgress();
                    });

                    // Update play button
                    this.video.addEventListener("play", () => {
                        const btn = document.getElementById("player-play-btn");
                        if (btn)
                            btn.innerHTML = '<i class="fa-solid fa-pause"></i>';
                    });

                    this.video.addEventListener("pause", () => {
                        const btn = document.getElementById("player-play-btn");
                        if (btn)
                            btn.innerHTML = '<i class="fa-solid fa-play"></i>';
                    });
                },

                openFile() {
                    const input = document.getElementById("player-file-input");
                    if (input) input.click();
                },

                togglePlay() {
                    if (!this.video) return;
                    if (this.video.paused) {
                        this.video.play();
                    } else {
                        this.video.pause();
                    }
                },

                stop() {
                    if (!this.video) return;
                    this.video.pause();
                    this.video.currentTime = 0;
                },

                seekBackward() {
                    if (!this.video) return;
                    this.video.currentTime = Math.max(
                        0,
                        this.video.currentTime - 10
                    );
                },

                seekForward() {
                    if (!this.video) return;
                    this.video.currentTime = Math.min(
                        this.video.duration,
                        this.video.currentTime + 10
                    );
                },

                toggleMute() {
                    if (!this.video) return;
                    this.video.muted = !this.video.muted;
                    this.updateVolumeIcon();
                },

                toggleFullscreen() {
                    const container = document.querySelector(
                        ".player-video-container"
                    );
                    if (!container) return;

                    if (!document.fullscreenElement) {
                        container.requestFullscreen().catch((err) => {
                            console.error(
                                "Error attempting to enable fullscreen:",
                                err
                            );
                        });
                    } else {
                        document.exitFullscreen();
                    }
                },

                updateTime() {
                    if (!this.video) return;
                    const current = this.formatTime(this.video.currentTime);
                    const duration = this.formatTime(this.video.duration);
                    const timeEl = document.getElementById("player-time");
                    if (timeEl) timeEl.textContent = `${current} / ${duration}`;
                },

                updateProgress() {
                    if (!this.video) return;
                    const progressBar =
                        document.getElementById("player-progress");
                    if (progressBar && this.video.duration) {
                        const percent =
                            (this.video.currentTime / this.video.duration) *
                            100;
                        progressBar.value = percent;
                    }
                },

                updateVolumeIcon() {
                    if (!this.video) return;
                    const btn = document.getElementById("player-volume-btn");
                    if (!btn) return;

                    if (this.video.muted || this.video.volume === 0) {
                        btn.innerHTML =
                            '<i class="fa-solid fa-volume-xmark"></i>';
                    } else if (this.video.volume < 0.5) {
                        btn.innerHTML =
                            '<i class="fa-solid fa-volume-low"></i>';
                    } else {
                        btn.innerHTML =
                            '<i class="fa-solid fa-volume-high"></i>';
                    }
                },

                formatTime(seconds) {
                    if (!seconds || isNaN(seconds)) return "00:00";
                    const mins = Math.floor(seconds / 60);
                    const secs = Math.floor(seconds % 60);
                    return `${mins.toString().padStart(2, "0")}:${secs
                        .toString()
                        .padStart(2, "0")}`;
                },
            };

            // 初始化新應用
            document.addEventListener("DOMContentLoaded", () => {
                notepadApp.init();
                terminalApp.init();
                photosApp.init();
                playerApp.init();
            });
        </script>
    </body>
</html>
